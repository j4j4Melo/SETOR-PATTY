<html lang="pt-BR"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#2e7d32">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>REX - Setor Patty | Painel Executivo</title>
    
    <!-- Chart.js 4 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- ApexCharts para gráficos dinâmicos -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.2/dist/apexcharts.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <!-- Popper.js e Tippy.js -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Tippy Themes -->
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css">
    <!-- Font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    
    <style>
        /* ===== VARIÁVEIS E TEMA ===== */
        :root {
            --primary: #2e7d32;
            --primary-dark: #1b5e20;
            --primary-light: #e8f5e8;
            --primary-soft: rgba(46, 125, 96, 0.08);
            --success: #06d6a0;
            --success-light: #e6fff5;
            --danger: #ef476f;
            --danger-light: #ffe6ec;
            --warning: #ffd166;
            --warning-light: #fff3e0;
            --info: #4cc9f0;
            --info-light: #e6f0ff;
            --dark: #1e293b;
            --dark-gray: #475569;
            --medium-gray: #e2e8f0;
            --light-gray: #f1f5f9;
            --white: #ffffff;
            
            /* Sombras */
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.03);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.05);
            --shadow-lg: 0 8px 30px rgba(0,0,0,0.08);
            --shadow-xl: 0 20px 40px -12px rgba(0,0,0,0.15);
            
            /* Bordas */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            
            /* Transições */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
            
            /* Tema Light (padrão) */
            --bg-body: #f8fafc;
            --bg-card: var(--white);
            --text-primary: var(--dark);
            --text-secondary: var(--dark-gray);
            --border-color: var(--medium-gray);
            --hover-bg: var(--light-gray);
            
            /* Layout */
            --sidebar-width: 260px;
            --sidebar-collapsed-width: 70px;
            --header-height: 70px;
            --footer-height: 50px;
        }

        /* Tema Dark */
        [data-theme="dark"] {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --hover-bg: #2d3a4f;
            --light-gray: #2d3a4f;
            --primary-light: rgba(46, 125, 96, 0.2);
            --success-light: rgba(6, 214, 160, 0.2);
            --danger-light: rgba(239, 71, 111, 0.2);
            --warning-light: rgba(255, 209, 102, 0.2);
            --info-light: rgba(76, 201, 240, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-body);
            min-height: 100vh;
            color: var(--text-primary);
            transition: background var(--transition-normal), color var(--transition-normal);
            line-height: 1.5;
            font-size: 14px;
            overflow-x: hidden;
            width: 100%;
            position: relative;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
        }

        /* ===== LAYOUT PRINCIPAL ===== */
        .app-container {
            display: flex;
            min-height: 100vh;
            width: 100%;
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-card);
            border-right: 1px solid var(--border-color);
            padding: 24px 16px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            transition: all var(--transition-normal);
            z-index: 1000;
            box-shadow: var(--shadow-md);
            left: 0;
            top: 0;
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
        }

        .sidebar-header {
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 24px;
            transition: all var(--transition-normal);
        }

        .sidebar-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .sidebar-header h2 i {
            font-size: 24px;
            min-width: 24px;
        }

        .sidebar-header p {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
            white-space: nowrap;
        }

        .sidebar.collapsed .sidebar-header h2 span,
        .sidebar.collapsed .sidebar-header p {
            display: none;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 4px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            transition: all var(--transition-fast);
            cursor: pointer;
            white-space: nowrap;
        }

        .nav-link:hover {
            background: var(--hover-bg);
            color: var(--primary);
        }

        .nav-link.active {
            background: var(--primary-light);
            color: var(--primary);
            font-weight: 600;
        }

        .nav-link i {
            width: 20px;
            font-size: 16px;
            min-width: 20px;
        }

        .sidebar.collapsed .nav-link span {
            display: none;
        }

        .theme-toggle {
            margin-top: 32px;
            padding: 16px 0;
            border-top: 1px solid var(--border-color);
        }

        .theme-btn {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 13px;
            transition: all var(--transition-fast);
        }

        .theme-btn:hover {
            background: var(--hover-bg);
        }

        .sidebar.collapsed .theme-btn span {
            display: none;
        }

        /* Botão toggle sidebar para mobile */
        .menu-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            z-index: 1001;
            box-shadow: var(--shadow-lg);
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px 24px;
            transition: margin var(--transition-normal);
            width: 100%;
            max-width: calc(100% - var(--sidebar-width));
        }

        .main-content.expanded {
            margin-left: var(--sidebar-collapsed-width);
            max-width: calc(100% - var(--sidebar-collapsed-width));
        }

        /* ===== HEADER ===== */
        .header {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            width: 100%;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .header-title h1 {
            font-size: clamp(18px, 4vw, 24px);
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .header-title h1 i {
            color: var(--primary);
        }

        .header-title p {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
            flex-wrap: wrap;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .update-log {
            background: var(--light-gray);
            padding: 6px 12px;
            border-radius: 40px;
            font-size: 11px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .btn-group {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 6px 12px;
            border-radius: 40px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all var(--transition-fast);
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .btn i {
            font-size: 12px;
        }

        .btn:hover {
            background: var(--hover-bg);
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-primary {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        /* ===== FILTROS ===== */
        .filters-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            width: 100%;
        }

        .filters-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
        }

        .period-group {
            display: flex;
            gap: 2px;
            background: var(--light-gray);
            padding: 3px;
            border-radius: 40px;
            flex-wrap: wrap;
        }

        .period-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 40px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            background: transparent;
            color: var(--text-secondary);
            transition: all var(--transition-fast);
            white-space: nowrap;
        }

        .period-btn:hover {
            color: var(--primary);
        }

        .period-btn.active {
            background: var(--primary);
            color: white;
        }

        .date-range {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .date-input {
            display: flex;
            align-items: center;
            gap: 4px;
            background: var(--light-gray);
            padding: 4px 10px;
            border-radius: 40px;
            font-size: 11px;
        }

        .date-input input {
            border: none;
            background: transparent;
            font-size: 11px;
            width: 100px;
            padding: 4px;
            color: var(--text-primary);
        }

        .filter-select {
            min-width: 140px;
        }

        .filter-select select {
            width: 100%;
            padding: 6px 28px 6px 12px;
            border-radius: 40px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            font-size: 11px;
            color: var(--text-primary);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%232e7d32' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
        }

        .global-search {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .global-search input {
            width: 100%;
            padding: 6px 12px 6px 32px;
            border-radius: 40px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            font-size: 11px;
            color: var(--text-primary);
        }

        .global-search i {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 12px;
        }

        /* ===== ALERTAS INTELIGENTES ===== */
        .alerts-section {
            margin-bottom: 20px;
            width: 100%;
        }

        .alerts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
        }

        .alert-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 14px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: flex-start;
            gap: 10px;
            animation: slideIn var(--transition-normal);
        }

        .alert-card.warning {
            border-left: 4px solid var(--warning);
        }

        .alert-card.danger {
            border-left: 4px solid var(--danger);
        }

        .alert-card.success {
            border-left: 4px solid var(--success);
        }

        .alert-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .alert-icon.warning {
            background: var(--warning-light);
            color: var(--warning);
        }

        .alert-icon.danger {
            background: var(--danger-light);
            color: var(--danger);
        }

        .alert-icon.success {
            background: var(--success-light);
            color: var(--success);
        }

        .alert-content {
            flex: 1;
            min-width: 0;
        }

        .alert-title {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .alert-desc {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;
            word-wrap: break-word;
        }

        .alert-desc strong {
            color: var(--primary);
        }

        .alert-time {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* ===== KPIS ===== */
        .kpi-section {
            margin-bottom: 20px;
            width: 100%;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .kpi-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 16px;
            border: 1px solid var(--border-color);
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }

        .kpi-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .kpi-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .kpi-icon.primary {
            background: var(--primary-light);
            color: var(--primary);
        }

        .kpi-icon.success {
            background: var(--success-light);
            color: var(--success);
        }

        .kpi-icon.danger {
            background: var(--danger-light);
            color: var(--danger);
        }

        .kpi-icon.info {
            background: var(--info-light);
            color: var(--info);
        }

        .kpi-icon.warning {
            background: var(--warning-light);
            color: var(--warning);
        }

        .kpi-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .kpi-main {
            display: flex;
            align-items: baseline;
            gap: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .kpi-value {
            font-size: clamp(18px, 4vw, 24px);
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .kpi-sub {
            font-size: 10px;
            color: var(--text-secondary);
            background: var(--light-gray);
            padding: 2px 6px;
            border-radius: 30px;
        }

        .kpi-footer {
            font-size: 11px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }

        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--light-gray);
            border-radius: 10px;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 10px;
            transition: width var(--transition-normal);
        }

        /* ===== GRÁFICOS ===== */
        .charts-section {
            margin-bottom: 20px;
            width: 100%;
        }

        .charts-grid-2col,
        .charts-grid-3col {
            display: grid;
            gap: 12px;
            margin-bottom: 12px;
        }

        .charts-grid-2col {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .charts-grid-3col {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .chart-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
            border: 1px solid var(--border-color);
            width: 100%;
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .chart-header h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chart-header h3 i {
            color: var(--primary);
        }

        .chart-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .chart-action-btn {
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 11px;
            transition: all var(--transition-fast);
        }

        .chart-action-btn:hover {
            background: var(--hover-bg);
            color: var(--primary);
        }

        .chart-action-btn select {
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 11px;
        }

        .chart-wrapper {
            min-height: 280px;
            position: relative;
            width: 100%;
        }

        /* ===== TRENDS CARD ===== */
        .trends-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            width: 100%;
        }

        .trends-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .trends-header h3 {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .trends-header h3 i {
            color: var(--primary);
        }

        .trends-legend {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .trends-legend span {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
        }

        .trends-legend span span {
            width: 10px;
            height: 10px;
            border-radius: 3px;
        }

        .trends-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        @media (max-width: 1200px) {
            .trends-metrics {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .trends-metrics {
                grid-template-columns: 1fr;
            }
        }

        .metric-card {
            background: var(--light-gray);
            border-radius: var(--radius-md);
            padding: 14px;
            cursor: pointer;
            transition: all var(--transition-fast);
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            background: var(--primary-light);
        }

        .metric-label {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .metric-sub {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .metric-tip {
            font-size: 9px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .performance-analysis {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 16px;
        }

        @media (max-width: 768px) {
            .performance-analysis {
                grid-template-columns: 1fr;
            }
        }

        /* ===== RANKINGS ===== */
        .rankings-section {
            margin-bottom: 20px;
            width: 100%;
        }

        .rankings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 12px;
        }

        .ranking-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
            border: 1px solid var(--border-color);
        }

        .ranking-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .ranking-header i {
            width: 32px;
            height: 32px;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .ranking-header h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }

        .podium {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 16px 8px;
            background: linear-gradient(180deg, var(--primary-light) 0%, transparent 100%);
            border-radius: var(--radius-md);
            flex-wrap: wrap;
        }

        .podium-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            min-width: 70px;
        }

        .podium-1 { order: 2; transform: scale(1.05); }
        .podium-2 { order: 1; }
        .podium-3 { order: 3; }

        .podium-medal {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 6px;
            box-shadow: var(--shadow-md);
        }

        .podium-1 .podium-medal { background: linear-gradient(135deg, #FFD700, #FFA500); }
        .podium-2 .podium-medal { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); }
        .podium-3 .podium-medal { background: linear-gradient(135deg, #CD7F32, #B87333); }

        .podium-name {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .podium-value {
            font-size: 11px;
            color: var(--primary);
            background: var(--bg-card);
            padding: 4px 8px;
            border-radius: 30px;
            box-shadow: var(--shadow-sm);
        }

        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: var(--light-gray);
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
        }

        .ranking-item:hover {
            transform: translateX(4px);
            background: var(--primary-light);
        }

        .ranking-pos {
            width: 24px;
            height: 24px;
            background: var(--bg-card);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 11px;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .ranking-pos.top-1 { background: linear-gradient(135deg, #FFD700, #FFA500); color: white; }
        .ranking-pos.top-2 { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); color: white; }
        .ranking-pos.top-3 { background: linear-gradient(135deg, #CD7F32, #B87333); color: white; }

        .ranking-info {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            min-width: 0;
        }

        .ranking-name {
            font-weight: 600;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .ranking-stats {
            font-size: 11px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        /* ===== TABELA ===== */
        .table-section {
            margin-bottom: 20px;
            width: 100%;
        }

        .table-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
            border: 1px solid var(--border-color);
            width: 100%;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .table-header h2 {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .table-header h2 i {
            color: var(--primary);
        }

        .badge {
            padding: 4px 10px;
            border-radius: 30px;
            font-size: 10px;
            font-weight: 600;
            white-space: nowrap;
        }

        .badge-primary {
            background: var(--primary-light);
            color: var(--primary);
        }

        .badge-success {
            background: var(--success-light);
            color: var(--success);
        }

        .badge-warning {
            background: var(--warning-light);
            color: var(--warning);
        }

        .badge-danger {
            background: var(--danger-light);
            color: var(--danger);
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--radius-sm);
            max-height: 500px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            min-width: 1000px;
        }

        th {
            background: var(--light-gray);
            padding: 12px 8px;
            position: sticky;
            top: 0;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            z-index: 10;
        }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        tr:hover {
            background: var(--primary-light);
        }

        .store-name {
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
        }

        .valor-positivo {
            color: var(--success);
            font-weight: 600;
        }

        .valor-negativo {
            color: var(--danger);
            font-weight: 600;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 30px;
            font-size: 10px;
            font-weight: 600;
            display: inline-block;
            white-space: nowrap;
        }

        .status-success {
            background: var(--success-light);
            color: var(--success);
        }

        .status-danger {
            background: var(--danger-light);
            color: var(--danger);
        }

        .status-neutral {
            background: var(--light-gray);
            color: var(--text-secondary);
        }

        /* ===== ANOTAÇÕES ===== */
        .notes-section {
            margin-bottom: 20px;
            width: 100%;
        }

        .notes-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
            border: 1px solid var(--border-color);
        }

        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .notes-header h3 {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .notes-header h3 i {
            color: var(--primary);
        }

        .btn-add-note {
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .notes-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .note-item {
            padding: 12px;
            background: var(--light-gray);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--primary);
        }

        .note-text {
            font-size: 12px;
            margin-bottom: 6px;
            word-wrap: break-word;
        }

        .note-meta {
            font-size: 10px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* ===== FOOTER ===== */
        .footer {
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* ===== MODAL ===== */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            overflow-y: auto;
        }

        .modal-content {
            background: var(--bg-card);
            margin: 5% auto;
            padding: 20px;
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 600px;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            color: var(--primary);
            font-size: 18px;
            font-weight: 600;
        }

        .close {
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            transition: color var(--transition-fast);
        }

        .close:hover {
            color: var(--danger);
        }

        /* ===== LOADING ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--light-gray);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== MOBILE TOGGLE BUTTON ===== */
        .menu-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            z-index: 1001;
            box-shadow: var(--shadow-lg);
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        /* ===== RESPONSIVIDADE ===== */
        @media (max-width: 1200px) {
            :root {
                --sidebar-width: 220px;
            }
        }

        @media (max-width: 992px) {
            .menu-toggle {
                display: flex;
            }

            .sidebar {
                transform: translateX(-100%);
                box-shadow: var(--shadow-xl);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .sidebar.collapsed {
                width: var(--sidebar-width);
            }

            .sidebar.collapsed .sidebar-header h2 span,
            .sidebar.collapsed .sidebar-header p,
            .sidebar.collapsed .nav-link span {
                display: inline;
            }

            .main-content {
                margin-left: 0 !important;
                max-width: 100% !important;
                padding: 12px;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-info {
                width: 100%;
                justify-content: space-between;
            }

            .filters-row {
                flex-direction: column;
                align-items: stretch;
            }

            .period-group {
                width: 100%;
                justify-content: center;
            }

            .global-search {
                width: 100%;
            }

            .trends-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .trends-legend {
                width: 100%;
                justify-content: flex-start;
            }

            .ranking-info {
                flex-direction: column;
                align-items: flex-start;
            }

            .ranking-stats {
                white-space: normal;
            }
        }

        @media (max-width: 480px) {
            .btn-group {
                width: 100%;
                justify-content: center;
            }

            .btn {
                flex: 1;
                justify-content: center;
            }

            .kpi-main {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            .kpi-sub {
                align-self: flex-start;
            }

            .date-input {
                width: 100%;
            }

            .date-input input {
                width: 100%;
            }

            .filter-select {
                width: 100%;
            }
        }

        /* ===== CHROME CAST / TV OPTIMIZATIONS ===== */
        @media (min-width: 1920px) {
            :root {
                --sidebar-width: 300px;
            }

            html, body {
                font-size: 16px;
            }

            .main-content {
                padding: 24px 32px;
            }

            .kpi-value {
                font-size: 28px;
            }

            .metric-value {
                font-size: 24px;
            }
        }

        /* Touch optimizations */
        @media (hover: none) and (pointer: coarse) {
            .btn, .nav-link, .kpi-card, .ranking-item, .store-name {
                cursor: default;
                -webkit-tap-highlight-color: var(--primary-soft);
            }

            .btn:active, .nav-link:active, .kpi-card:active {
                transform: scale(0.98);
            }
        }

        /* Print styles */
        @media print {
            .sidebar, .menu-toggle, .btn-group, .filters-section, .alerts-section, .notes-section, .footer {
                display: none !important;
            }

            .main-content {
                margin-left: 0 !important;
                padding: 0 !important;
            }

            .chart-card, .trends-card, .ranking-card, .table-card {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar de Navegação -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>
                    <i class="fas fa-chart-line"></i>
                    <span>REX Patty</span>
                </h2>
                <p>Painel Executivo</p>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" onclick="mudarView('visao-geral')">
                        <i class="fas fa-home"></i>
                        <span>Visão Geral</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="mudarView('performance')">
                        <i class="fas fa-trophy"></i>
                        <span>Performance ADM</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="mudarView('canais')">
                        <i class="fas fa-chart-pie"></i>
                        <span>Análise de Canais</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="mudarView('tendencias')">
                        <i class="fas fa-chart-line"></i>
                        <span>Tendências</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="mudarView('detalhado')">
                        <i class="fas fa-table"></i>
                        <span>Detalhado</span>
                    </a>
                </li>
            </ul>
            
            <div class="theme-toggle">
                <button class="theme-btn" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                    <span>Modo Escuro</span>
                </button>
            </div>
        </div>

        <!-- Botão toggle para mobile -->
        <button class="menu-toggle" id="menuToggle" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Conteúdo Principal -->
        <div class="main-content" id="mainContent">
            <!-- Header -->
            <div class="header">
                <div class="header-content">
                    <div class="header-title">
                        <h1>
                            <i class="fas fa-store-alt"></i>
                            REX - Setor Patty
                        </h1>
                        <p>
                            <i class="fas fa-store"></i>
                            <span id="totalLojasHeader">31</span> Lojas em operação
                            <i class="fas fa-circle" style="font-size: 4px;"></i>
                            <i class="far fa-calendar"></i>
                            <span id="headerPeriod">Fevereiro 2026</span>
                        </p>
                    </div>
                    <div class="header-info">
                        <div class="update-log" data-tippy-content="Última sincronização">
                            <i class="far fa-clock"></i>
                            <span id="dataAtualizacao">21/02/2026, 13:43:38</span>
                        </div>
                        <div class="btn-group">
                            <button class="btn" onclick="limparDadosSalvos()" data-tippy-content="Limpar dados">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()" data-tippy-content="Importar planilha">
                                <i class="fas fa-upload"></i>
                            </button>
                            <button class="btn btn-danger" onclick="exportarPDF()" data-tippy-content="Exportar PDF">
                                <i class="fas fa-file-pdf"></i>
                            </button>
                            <button class="btn btn-success" onclick="exportarExcel()" data-tippy-content="Exportar Excel">
                                <i class="fas fa-file-excel"></i>
                            </button>
                            <button class="btn" onclick="exportarHTML()" data-tippy-content="Salvar HTML">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" onchange="processarPlanilha(this)" style="display: none;">
                    </div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="filters-section">
                <div class="filters-row" style="margin-bottom: 12px;">
                    <div class="period-group">
                        <button class="period-btn active" onclick="setPeriodo('hoje')">Hoje</button>
                        <button class="period-btn" onclick="setPeriodo('ontem')">Ontem</button>
                        <button class="period-btn" onclick="setPeriodo('7d')">7d</button>
                        <button class="period-btn" onclick="setPeriodo('15d')">15d</button>
                        <button class="period-btn" onclick="setPeriodo('30d')">30d</button>
                        <button class="period-btn" onclick="setPeriodo('mes')">Mês</button>
                        <button class="period-btn" onclick="setPeriodo('custom')">Período</button>
                    </div>
                    <div class="date-range" id="dateRangeInputs" style="display: none;">
                        <div class="date-input">
                            <span>De:</span>
                            <input type="date" id="dataInicio" onchange="atualizarPorData()">
                        </div>
                        <div class="date-input">
                            <span>Até:</span>
                            <input type="date" id="dataFim" onchange="atualizarPorData()">
                        </div>
                    </div>
                </div>
                
                <div class="filters-row">
                    <div class="filter-select">
                        <select id="admFilter" onchange="aplicarFiltros()">
                            <option value="">Todos os ADMs</option>
                        </select>
                    </div>
                    <div class="filter-select">
                        <select id="statusFilter" onchange="aplicarFiltros()">
                            <option value="">Todos os status</option>
                            <option value="SIM">✅ Meta OK</option>
                            <option value="NÃO">❌ Abaixo da meta</option>
                            <option value="FECHADA">🔴 Fechada</option>
                        </select>
                    </div>
                    <div class="filter-select">
                        <select id="lojaFilter" onchange="aplicarFiltros()">
                            <option value="">Todas as Lojas</option>
                        </select>
                    </div>
                    <div class="global-search">
                        <i class="fas fa-search"></i>
                        <input type="text" id="globalSearch" placeholder="Buscar loja ou ADM..." onkeyup="buscarGlobal()">
                    </div>
                </div>
            </div>

            <!-- Alertas Inteligentes -->
            <div class="alerts-section" id="alertsSection">
                <div class="alerts-grid" id="alertsGrid"></div>
            </div>

            <!-- Visões Dinâmicas -->
            <div id="visao-geral" class="view active">
                <!-- KPIs Principais -->
                <div class="kpi-section">
                    <div class="kpi-grid">
                        <div class="kpi-card" onclick="filtrarPorStatus('')">
                            <div class="kpi-header">
                                <div class="kpi-icon primary"><i class="fas fa-dollar-sign"></i></div>
                                <span class="kpi-label">Faturamento</span>
                            </div>
                            <div class="kpi-main">
                                <span class="kpi-value" id="totalFaturamento">R$ 24.479,55</span>
                            </div>
                            <div class="kpi-footer" id="crescimentoPeriodo">
                                <i class="fas fa-chart-line"></i> vs período anterior
                            </div>
                        </div>

                        <div class="kpi-card" onclick="filtrarPorStatus('')">
                            <div class="kpi-header">
                                <div class="kpi-icon success"><i class="fas fa-bullseye"></i></div>
                                <span class="kpi-label">Meta</span>
                            </div>
                            <div class="kpi-main">
                                <span class="kpi-value" id="totalMeta">R$ 132.855,00</span>
                                <span class="kpi-sub" id="metasAtingidas">0/31</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressoMeta" style="width: 18.4%;"></div>
                            </div>
                        </div>

                        <div class="kpi-card" onclick="filtrarPorStatus('')">
                            <div class="kpi-header">
                                <div class="kpi-icon danger"><i class="fas fa-balance-scale"></i></div>
                                <span class="kpi-label">Diferença</span>
                            </div>
                            <div class="kpi-main">
                                <span class="kpi-value" id="totalDiferenca">- R$ 108.375,45</span>
                            </div>
                            <div class="kpi-footer" id="diferencaText">-81.6% da meta</div>
                        </div>

                        <div class="kpi-card" onclick="filtrarPorStatus('')">
                            <div class="kpi-header">
                                <div class="kpi-icon info"><i class="fas fa-chart-line"></i></div>
                                <span class="kpi-label">Ticket Médio</span>
                            </div>
                            <div class="kpi-main">
                                <span class="kpi-value" id="ticketMedio">R$ 19,15</span>
                            </div>
                            <div class="kpi-footer" id="ticketPeriodo">hoje</div>
                        </div>
                    </div>
                </div>

                <!-- Comparativos -->
                <div class="kpi-section">
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <div class="kpi-icon warning"><i class="fas fa-chart-line"></i></div>
                                <span class="kpi-label">vs Ontem</span>
                            </div>
                            <div class="kpi-main">
                                <span class="kpi-value" id="comparativoOntem">R$ 24.479</span>
                            </div>
                            <div class="kpi-footer" id="variacaoOntem">+0.0%</div>
                        </div>

                        <div class="kpi-card">
                            <div class="kpi-header">
                                <div class="kpi-icon warning"><i class="fas fa-calendar-week"></i></div>
                                <span class="kpi-label">vs Semana Ant.</span>
                            </div>
                            <div class="kpi-main">
                                <span class="kpi-value" id="comparativoSemana">R$ 24.479</span>
                            </div>
                            <div class="kpi-footer" id="variacaoSemana">+0.0%</div>
                        </div>

                        <div class="kpi-card">
                            <div class="kpi-header">
                                <div class="kpi-icon warning"><i class="fas fa-calendar-alt"></i></div>
                                <span class="kpi-label">vs Mês Ant.</span>
                            </div>
                            <div class="kpi-main">
                                <span class="kpi-value" id="comparativoMes">R$ 24.479</span>
                            </div>
                            <div class="kpi-footer" id="variacaoMes">+0.0%</div>
                        </div>

                        <div class="kpi-card">
                            <div class="kpi-header">
                                <div class="kpi-icon warning"><i class="fas fa-calendar"></i></div>
                                <span class="kpi-label">vs Ano Ant.</span>
                            </div>
                            <div class="kpi-main">
                                <span class="kpi-value" id="comparativoAno">R$ 24.479</span>
                            </div>
                            <div class="kpi-footer" id="variacaoAno">+0.0%</div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos Principais -->
                <div class="charts-section">
                    <div class="charts-grid-2col">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3><i class="fas fa-chart-pie"></i> Distribuição por Canal</h3>
                                <div class="chart-actions">
                                    <button class="chart-action-btn" onclick="exportarGrafico('canalPie')"><i class="fas fa-download"></i></button>
                                    <select class="chart-action-btn" id="tipoCanal" onchange="mudarTipoCanal()">
                                        <option value="doughnut">Rosca</option>
                                        <option value="pie">Pizza</option>
                                        <option value="bar">Barras</option>
                                    </select>
                                </div>
                            </div>
                            <div class="chart-wrapper" id="canalPieChart"></div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <h3><i class="fas fa-chart-bar"></i> Top 10 Faturamento</h3>
                                <div class="chart-actions">
                                    <button class="chart-action-btn" onclick="exportarGrafico('top10')"><i class="fas fa-download"></i></button>
                                    <select class="chart-action-btn" id="tipoTop10" onchange="mudarTipoTop10()">
                                        <option value="bar">Vertical</option>
                                        <option value="horizontal">Horizontal</option>
                                        <option value="line">Linha</option>
                                    </select>
                                </div>
                            </div>
                            <div class="chart-wrapper" id="top10Chart"></div>
                        </div>
                    </div>
                </div>

                <!-- Rankings -->
                <div class="rankings-section">
                    <div class="rankings-grid">
                        <div class="ranking-card">
                            <div class="ranking-header">
                                <i class="fas fa-trophy"></i>
                                <h3>Ranking Faturamento</h3>
                                <span class="badge badge-primary">ADMs</span>
                            </div>
                            <div class="podium" id="podiumFaturamento"></div>
                            <div class="ranking-list" id="listaFaturamento"></div>
                        </div>

                        <div class="ranking-card">
                            <div class="ranking-header">
                                <i class="fas fa-chart-line"></i>
                                <h3>Ranking Performance</h3>
                                <span class="badge badge-primary">% Meta</span>
                            </div>
                            <div class="podium" id="podiumPerformance"></div>
                            <div class="ranking-list" id="listaPerformance"></div>
                        </div>
                    </div>
                </div>

                <!-- Anotações -->
                <div class="notes-section">
                    <div class="notes-card">
                        <div class="notes-header">
                            <h3><i class="fas fa-pen"></i> Anotações Estratégicas</h3>
                            <button class="btn-add-note" onclick="adicionarNota()">
                                <i class="fas fa-plus"></i> Adicionar nota
                            </button>
                        </div>
                        <div class="notes-list" id="notesList"></div>
                    </div>
                </div>
            </div>

            <div id="performance" class="view" style="display: none;">
                <div class="charts-grid-2col">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-bar"></i> Faturamento por ADM</h3>
                            <div class="chart-actions">
                                <select class="chart-action-btn" id="tipoAdmFaturamento" onchange="mudarTipoAdmFaturamento()">
                                    <option value="bar">Barras</option>
                                    <option value="horizontal">Horizontal</option>
                                    <option value="line">Linha</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-wrapper" id="admFaturamentoChart"></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-percent"></i> % Meta por ADM</h3>
                            <div class="chart-actions">
                                <select class="chart-action-btn" id="tipoAdmMeta" onchange="mudarTipoAdmMeta()">
                                    <option value="bar">Barras</option>
                                    <option value="horizontal">Horizontal</option>
                                    <option value="line">Linha</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-wrapper" id="admMetaChart"></div>
                    </div>
                </div>
            </div>

            <div id="canais" class="view" style="display: none;">
                <div class="charts-grid-2col">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-pie"></i> Distribuição por Canal</h3>
                            <div class="chart-actions">
                                <select class="chart-action-btn" id="tipoCanalDetalhado" onchange="mudarTipoCanalDetalhado()">
                                    <option value="pie">Pizza</option>
                                    <option value="donut">Rosca</option>
                                    <option value="bar">Barras</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-wrapper" id="canaisDetalhadoChart"></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-line"></i> Evolução por Canal</h3>
                            <div class="chart-actions">
                                <select class="chart-action-btn" id="tipoEvolucao" onchange="mudarTipoEvolucao()">
                                    <option value="line">Linha</option>
                                    <option value="area">Área</option>
                                    <option value="bar">Barras</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-wrapper" id="canaisEvolucaoChart"></div>
                    </div>
                </div>
            </div>

            <div id="tendencias" class="view" style="display: none;">
                <!-- Card de Tendências Rico e Explicativo -->
                <div class="trends-card">
                    <div class="trends-header">
                        <h3><i class="fas fa-chart-line" style="color: var(--primary);"></i> Análise de Tendências e Projeções</h3>
                        <div class="trends-legend">
                            <span><span style="background: #2e7d32;"></span> Venda Real (histórico)</span>
                            <span><span style="background: #ffd166;"></span> Projeção (tendência calculada)</span>
                            <span><span style="background: #4cc9f0;"></span> Meta Diária (objetivo)</span>
                        </div>
                    </div>

                    <!-- Gráfico Principal com explicação -->
                    <div class="chart-wrapper" id="evolucaoProjecaoChart" style="height: 320px;"></div>
                    
                    <!-- Explicação da Tendência -->
                    <div style="background: var(--light-gray); border-radius: var(--radius-md); padding: 12px; margin: 16px 0; font-size: 12px; line-height: 1.6;">
                        <i class="fas fa-info-circle" style="color: var(--primary); margin-right: 6px;"></i>
                        <strong>O que este gráfico mostra:</strong> A linha verde representa o faturamento real dos últimos 15 dias. 
                        A linha amarela tracejada é a <strong>projeção baseada na tendência atual</strong> (calculada por regressão linear). 
                        A linha azul pontilhada é a <strong>meta diária média</strong> necessária para atingir o objetivo do mês.
                        <span id="tendenciaExplicacaoDetalhada" style="display: block; margin-top: 8px; color: var(--text-secondary);">
                            📈 Tendência atual: <strong id="tendenciaTextoDetalhado">estável</strong> · 
                            Confiabilidade: <strong id="confiabilidadeTextoDetalhado">baixa</strong> (quanto maior, mais precisa a projeção)
                        </span>
                    </div>

                    <!-- Métricas com casas decimais corrigidas -->
                    <div class="trends-metrics">
                        <div class="metric-card" onclick="mostrarDetalheMetrica('crescimento')">
                            <div class="metric-label"><i class="fas fa-arrow-up" style="color: var(--success);"></i> Crescimento Diário</div>
                            <div class="metric-value" id="crescimentoDiario">+2,3%</div>
                            <div class="metric-sub" id="detalheCrescimento">vs média R$ 100.163,49</div>
                            <div class="metric-tip" style="font-size: 9px; color: var(--text-secondary); margin-top: 4px;">
                                <i class="far fa-question-circle"></i> Variação média por dia
                            </div>
                        </div>
                        <div class="metric-card" onclick="mostrarDetalheMetrica('projecao')">
                            <div class="metric-label"><i class="fas fa-bullseye" style="color: var(--warning);"></i> Projeção Final Mês</div>
                            <div class="metric-value" id="projecaoFinalMes">R$ 2.472.776,12</div>
                            <div class="metric-sub" id="detalheProjecao">vs Meta: +50,9% · 92% realizado</div>
                            <div class="metric-tip" style="font-size: 9px; color: var(--text-secondary); margin-top: 4px;">
                                <i class="far fa-question-circle"></i> Valor estimado para 30 dias
                            </div>
                        </div>
                        <div class="metric-card" onclick="mostrarDetalheMetrica('melhorDia')">
                            <div class="metric-label"><i class="fas fa-calendar-week" style="color: var(--info);"></i> Melhor Dia</div>
                            <div class="metric-value" id="melhorDia">Sexta</div>
                            <div class="metric-sub" id="detalheMelhorDia">média R$ 3.757,82 · 17% acima</div>
                            <div class="metric-tip" style="font-size: 9px; color: var(--text-secondary); margin-top: 4px;">
                                <i class="far fa-question-circle"></i> Dia com maior média de vendas
                            </div>
                        </div>
                        <div class="metric-card" onclick="mostrarDetalheMetrica('confiabilidade')">
                            <div class="metric-label"><i class="fas fa-chart-line" style="color: var(--primary);"></i> Confiabilidade</div>
                            <div class="metric-value" id="confiabilidade">10%</div>
                            <div class="metric-sub" id="detalheConfiabilidade">R² = 0,10 · tendência fraca</div>
                            <div class="metric-tip" style="font-size: 9px; color: var(--text-secondary); margin-top: 4px;">
                                <i class="far fa-question-circle"></i> Quanto maior, mais confiável a projeção
                            </div>
                        </div>
                    </div>

                    <!-- Alertas de Tendência -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px;" id="alertasTendencia"></div>

                    <!-- Análise detalhada com explicações -->
                    <div class="performance-analysis">
                        <div style="background: var(--light-gray); border-radius: var(--radius-md); padding: 16px;">
                            <div style="font-size: 13px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-tachometer-alt" style="color: var(--primary);"></i> Performance vs Meta
                                <span class="badge" id="statusPerformance" style="margin-left: auto;">Próximo da meta</span>
                            </div>
                            <div style="height: 8px; background: var(--medium-gray); border-radius: 4px; margin-bottom: 12px;">
                                <div class="progress-fill" id="progressoPerformance" style="width: 92%; background: var(--success);"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 12px; flex-wrap: wrap; margin-bottom: 8px;">
                                <span>Meta Atingida: <strong id="metaAtingidaPercentual">92%</strong></span>
                                <span>Faltam: <strong id="faltamMeta">8%</strong></span>
                            </div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;" id="explicacaoPerformance">
                                <i class="fas fa-info-circle"></i> Para atingir a meta mensal, precisa de <strong id="necessarioDiario">R$ 27.350,53/dia</strong> nos próximos dias.
                            </div>
                            <div style="margin-top: 12px; font-size: 11px; color: var(--text-secondary);" id="diasRestantes">
                                <i class="far fa-calendar-alt"></i> 12 dias úteis restantes (22 totais)
                            </div>
                        </div>

                        <div style="background: var(--light-gray); border-radius: var(--radius-md); padding: 16px;">
                            <div style="font-size: 13px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-chart-pie" style="color: var(--warning);"></i> Distribuição da Projeção
                            </div>
                            <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 150px;">
                                    <div style="margin-bottom: 8px;">
                                        <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px;">
                                            <span>Realizado</span> <span id="realizadoPercentual">92%</span>
                                        </div>
                                        <div style="height: 6px; background: var(--medium-gray); border-radius: 3px;">
                                            <div class="progress-fill" id="progressoRealizado" style="width: 92%; background: var(--primary);"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px;">
                                            <span>A Realizar</span> <span id="aRealizarPercentual">8%</span>
                                        </div>
                                        <div style="height: 6px; background: var(--medium-gray); border-radius: 3px;">
                                            <div class="progress-fill" id="progressoARealizar" style="width: 8%; background: var(--warning);"></div>
                                        </div>
                                    </div>
                                </div>
                                <div style="text-align: center; min-width: 100px;">
                                    <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="valorProjetado">R$ 2.472,8k</div>
                                    <div style="font-size: 10px; color: var(--text-secondary);">Projeção vs Meta</div>
                                    <div style="font-size: 11px; margin-top: 4px;" id="statusProjecao" class="trend-up">▲ Acima da meta</div>
                                </div>
                            </div>
                            <div style="margin-top: 12px; font-size: 11px; color: var(--text-secondary);" id="explicacaoProjecao">
                                <i class="fas fa-info-circle"></i> Projeção baseada na tendência dos últimos 15 dias. 
                                <span id="confiabilidadeExplicacao">Confiabilidade baixa - acompanhar de perto.</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos Adicionais com explicações -->
                <div class="charts-grid-2col">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-line"></i> Projeção de Vendas (30 dias)</h3>
                            <div class="chart-actions">
                                <button class="chart-action-btn" onclick="exportarGrafico('projecao')"><i class="fas fa-download"></i></button>
                                <select class="chart-action-btn" id="tipoProjecao" onchange="mudarTipoProjecao()">
                                    <option value="linear">Linear (tendência)</option>
                                    <option value="media">Média Móvel (suavizada)</option>
                                    <option value="otimista">Otimista (+20%)</option>
                                    <option value="pessimista">Pessimista (-20%)</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-wrapper" id="projecaoChart">
                            <div style="height: 100%; display: flex; align-items: center; justify-content: center; color: var(--text-secondary);">
                                <i class="fas fa-spinner fa-spin"></i> Calculando projeções...
                            </div>
                        </div>
                        <div style="margin-top: 12px; font-size: 11px; color: var(--text-secondary); background: var(--light-gray); padding: 8px; border-radius: var(--radius-sm);">
                            <i class="fas fa-info-circle"></i> 
                            <span id="projecaoExplicacao">Projeção linear: segue a tendência atual. Média móvel: suaviza oscilações. Cenários otimista/pessimista: variação de ±20%.</span>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-calendar-alt"></i> Sazonalidade (análise por dia)</h3>
                            <div class="chart-actions">
                                <button class="chart-action-btn" onclick="exportarGrafico('sazonalidade')"><i class="fas fa-download"></i></button>
                                <select class="chart-action-btn" id="tipoSazonalidade" onchange="mudarTipoSazonalidade()">
                                    <option value="media">Média por Dia</option>
                                    <option value="total">Total por Dia</option>
                                    <option value="comparativo">vs Meta</option>
                                    <option value="percentual">% do Total</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-wrapper" id="sazonalidadeChart"></div>
                        <div style="margin-top: 12px; font-size: 11px; color: var(--text-secondary); background: var(--light-gray); padding: 8px; border-radius: var(--radius-sm);">
                            <i class="fas fa-info-circle"></i> 
                            <span id="sazonalidadeExplicacao">Segunda-feira tem média 15% abaixo da média semanal. Sexta-feira é o melhor dia.</span>
                        </div>
                    </div>
                </div>

                <!-- Análise de Correlação e Horário -->
                <div class="charts-grid-2col" style="margin-top: 12px;">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-scatter"></i> Correlação: Cupons vs Faturamento</h3>
                            <div class="chart-actions">
                                <button class="chart-action-btn" onclick="exportarGrafico('correlacao')"><i class="fas fa-download"></i></button>
                                <select class="chart-action-btn" id="tipoCorrelacao" onchange="mudarTipoCorrelacao()">
                                    <option value="scatter">Dispersão</option>
                                    <option value="line">Linha de Tendência</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-wrapper" id="correlacaoChart"></div>
                        <div style="margin-top: 12px; font-size: 11px; color: var(--text-secondary);" id="correlacaoInfo">
                            <i class="fas fa-info-circle"></i> Correlação: <strong>0,85</strong> (forte) · A cada 10 cupons, R$ 192 em vendas
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-clock"></i> Horário de Pico</h3>
                            <div class="chart-actions">
                                <button class="chart-action-btn" onclick="exportarGrafico('horario')"><i class="fas fa-download"></i></button>
                                <select class="chart-action-btn" id="tipoHorario" onchange="mudarTipoHorario()">
                                    <option value="line">Linha</option>
                                    <option value="bar">Barras</option>
                                    <option value="area">Área</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-wrapper" id="horarioChart"></div>
                        <div style="margin-top: 12px; font-size: 11px; color: var(--text-secondary);" id="horarioInfo">
                            <i class="fas fa-info-circle"></i> Pico às <strong>12h</strong> (R$ 3.240) · Ticket médio maior às <strong>20h</strong> (R$ 28,50)
                        </div>
                    </div>
                </div>
            </div>

            <div id="detalhado" class="view" style="display: none;">
                <!-- Alertas da Tabela -->
                <div class="alerts-section">
                    <div class="alerts-grid" id="tabelaAlertas"></div>
                </div>

                <div class="table-section">
                    <div class="table-card">
                        <div class="table-header">
                            <h2><i class="fas fa-list"></i> Detalhamento de Vendas</h2>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span class="badge badge-primary" id="registrosCount">31</span>
                                <select class="chart-action-btn" id="alertaTipo" onchange="filtrarPorAlerta()">
                                    <option value="">Todos os registros</option>
                                    <option value="critico">⚠️ Alertas Críticos</option>
                                    <option value="atencao">⚡ Em Atenção</option>
                                    <option value="bom">✅ Performance Boa</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table id="mainTable">
                                <thead>
                                    <tr>
                                        <th onclick="ordenarTabela(0)">Data</th>
                                        <th onclick="ordenarTabela(1)">Loja</th>
                                        <th onclick="ordenarTabela(2)">ADM</th>
                                        <th onclick="ordenarTabela(3)">Início</th>
                                        <th onclick="ordenarTabela(4)">Fim</th>
                                        <th onclick="ordenarTabela(5)">Cupons</th>
                                        <th onclick="ordenarTabela(6)">Faturamento</th>
                                        <th onclick="ordenarTabela(7)">Meta</th>
                                        <th onclick="ordenarTabela(8)">Diferença</th>
                                        <th onclick="ordenarTabela(9)">%</th>
                                        <th onclick="ordenarTabela(10)">Status</th>
                                        <th>Alerta</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer">
                <p>© 2026 REX - Setor Patty | Ragazzo! Tudo que é gostoso</p>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="storeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalStoreName">Carregando...</h2>
                <span class="close" onclick="document.getElementById('storeModal').style.display='none'">×</span>
            </div>
            <div style="max-height: 400px; overflow-y: auto;">
                <table style="min-width: 100%;">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Faturamento</th>
                            <th>Meta</th>
                            <th>%</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="modalTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="dados-permanentes" style="display: none;">{"dadosCompletos":[],"dataAtualizacao":"","notas":[]}</div>

    <script>
        // ========== MAPEAMENTO DAS LOJAS ==========
        const lojaNomes = {
            5: "ANTONIO AGU", 10: "OSASCO PLAZA", 28: "SHOPPING TAMBORÉ", 31: "AUGUSTA",
            63: "SHOPPING ITAPECERICA", 69: "PERUS", 73: "BRIGADEIRO JARDINS", 82: "TEODORO SAMPAIO",
            86: "REX RAFAEL DE BARROS", 90: "SHOPPING PARQUE BARUERI", 97: "ASSAÍ JOÃO DIAS",
            98: "FRANCO DA ROCHA", 101: "CARREFOUR RAPOSO TAVARES", 118: "SHOPPING ITAPECERICA II",
            126: "OSASCO JOÃO DE ANDRADE", 133: "PARQUE TIETÊ", 145: "ITASHOPPING",
            157: "JARDIM SÃO LUIZ", 158: "ASSAÍ CARAPICUÍBA", 162: "MARQUESA TAIPAS",
            178: "EXTRA CARAPICUÍBA", 183: "FRANCO DA ROCHA 2", 189: "SHOPPING PATIO CIANÊ",
            195: "EXTRA JARAGUÁ", 210: "ASSAÍ ABOLIÇÃO CAMPINAS", 247: "METRÔ CCR VILA DAS BELEZAS",
            248: "METRÔ CCR CAPÃO REDONDO", 251: "SOROCABA CENTRO", 262: "ASSAÍ INDAIATUBA",
            285: "EXTRA JARDIM ÂNGELA", 294: "SHOPPING RAPOSO"
        };

        const admPorLoja = {
            247: "Thais", 157: "Thais", 63: "Thais", 285: "Thais", 118: "Thais", 248: "Thais", 97: "Thais",
            262: "Fernando", 210: "Fernando", 31: "Hedla", 73: "Hedla", 86: "Hedla", 82: "Hedla",
            145: "Elves", 251: "Elves", 294: "Elves", 101: "Elves", 189: "Elves",
            69: "Gabriela", 162: "Gabriela", 195: "Gabriela", 133: "Gabriela", 183: "Gabriela", 98: "Gabriela",
            158: "Marcia", 90: "Marcia", 28: "Marcia", 178: "Marcia", 5: "Wagner", 126: "Wagner", 10: "Wagner"
        };

        // ========== VARIÁVEIS GLOBAIS ==========
        let dadosCompletos = [];
        const dadosPorData = {};
        let dataInicio = "", dataFim = "";
        let periodoSelecionado = "hoje";
        let termoBuscaGlobal = '';
        let filtroLoja = '';
        let filtroStatus = '';
        let filtroAdm = '';
        let notas = [];
        let viewAtual = 'visao-geral';
        let graficos = {};

        // ========== FUNÇÕES DE UTILIDADE ==========
        function formatMoney(v) {
            if (isNaN(v)) v = 0;
            return v.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        function formatMoneyDecimal(v) {
            if (isNaN(v)) v = 0;
            return v.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        function showLoading(message = 'Carregando...') {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-overlay';
            loadingDiv.className = 'loading-overlay';
            loadingDiv.innerHTML = `
                <div style="background: var(--bg-card); padding: 30px; border-radius: 16px; text-align: center; box-shadow: var(--shadow-xl);">
                    <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
                    <p style="color: var(--text-primary); font-weight: 500;">${message}</p>
                </div>
            `;
            document.body.appendChild(loadingDiv);
        }

        function hideLoading() {
            const loading = document.getElementById('loading-overlay');
            if (loading) loading.remove();
        }

        function initTooltips() {
            if (typeof tippy !== 'undefined') {
                tippy('[data-tippy-content]', {
                    theme: 'light',
                    placement: 'top',
                    animation: 'scale',
                    duration: 200,
                });
            }
        }

        // ========== FUNÇÃO DE FALLBACK ==========
        function atualizarGraficos(dados) {
            console.warn('Função atualizarGraficos depreciada, usando renderizarGraficosApex');
            if (viewAtual === 'visao-geral') {
                renderizarGraficosApex('canalPie', dados, document.getElementById('tipoCanal')?.value || 'doughnut');
                renderizarGraficosApex('top10', dados, document.getElementById('tipoTop10')?.value || 'bar');
            }
        }

        // ========== SIDEBAR TOGGLE ==========
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.getElementById('menuToggle');
            sidebar.classList.toggle('mobile-open');
            
            const icon = menuToggle.querySelector('i');
            if (sidebar.classList.contains('mobile-open')) {
                icon.className = 'fas fa-times';
            } else {
                icon.className = 'fas fa-bars';
            }
        }

        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.getElementById('menuToggle');
            
            if (window.innerWidth <= 992) {
                if (!sidebar.contains(event.target) && !menuToggle.contains(event.target)) {
                    sidebar.classList.remove('mobile-open');
                    menuToggle.querySelector('i').className = 'fas fa-bars';
                }
            }
        });

        // ========== TEMA DARK/LIGHT ==========
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            
            const themeBtn = document.querySelector('.theme-btn span');
            const themeIcon = document.querySelector('.theme-btn i');
            if (themeBtn) {
                themeBtn.textContent = newTheme === 'dark' ? 'Modo Claro' : 'Modo Escuro';
                themeIcon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
        }

        // ========== NAVEGAÇÃO ==========
        function mudarView(viewId) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            document.querySelectorAll('.view').forEach(view => {
                view.style.display = 'none';
            });
            document.getElementById(viewId).style.display = 'block';
            viewAtual = viewId;
            
            if (window.innerWidth <= 992) {
                document.getElementById('sidebar').classList.remove('mobile-open');
                document.getElementById('menuToggle').querySelector('i').className = 'fas fa-bars';
            }
            
            // Forçar renderização imediata
            setTimeout(() => {
                const dados = getDadosPeriodoFiltrados();
                if (viewId === 'visao-geral') {
                    renderizarGraficosApex('canalPie', dados, document.getElementById('tipoCanal')?.value || 'doughnut');
                    renderizarGraficosApex('top10', dados, document.getElementById('tipoTop10')?.value || 'bar');
                } else if (viewId === 'performance') {
                    renderizarGraficosPerformance();
                } else if (viewId === 'canais') {
                    // Garantir que ambos os gráficos carreguem
                    renderizarGraficosCanais(document.getElementById('tipoCanalDetalhado')?.value || 'pie', 'distribuicao');
                    renderizarGraficosCanais(document.getElementById('tipoEvolucao')?.value || 'line', 'evolucao');
                } else if (viewId === 'tendencias') {
                    renderizarGraficosTendencias();
                } else if (viewId === 'detalhado') {
                    atualizarAlertasTabela(dados);
                    atualizarTabela(dados);
                }
            }, 100);
        }

        // ========== FUNÇÕES DE EXTRAÇÃO ==========
        function extrairHora(valor) {
            if (!valor || valor === 'NULL' || valor === null || valor === '' || valor === undefined) return '-';
            
            try {
                if (typeof valor === 'number' && !isNaN(valor)) {
                    const totalMinutos = Math.round(valor * 24 * 60);
                    const horas = Math.floor(totalMinutos / 60) % 24;
                    const minutos = totalMinutos % 60;
                    if (horas >= 0 && horas < 24) {
                        return `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}`;
                    }
                }
                
                if (typeof valor === 'string') {
                    const matchHMS = valor.match(/(\d{1,2}):(\d{2}):(\d{2})/);
                    if (matchHMS) {
                        return `${matchHMS[1].padStart(2, '0')}:${matchHMS[2]}`;
                    }
                    
                    const matchHM = valor.match(/(\d{1,2}):(\d{2})/);
                    if (matchHM) {
                        return `${matchHM[1].padStart(2, '0')}:${matchHM[2]}`;
                    }
                    
                    const matchData = valor.match(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})/);
                    if (matchData) {
                        return `${matchData[4]}:${matchData[5]}`;
                    }
                }
            } catch (e) {}
            
            return '-';
        }

        // ========== FUNÇÕES DE FILTRO DE DADOS ==========
        function getDadosPeriodo() {
            if (!dataInicio || !dataFim || !Object.keys(dadosPorData).length) return [];
            const dados = [];
            for (let data in dadosPorData) {
                if (isDataNoPeriodo(data, dataInicio, dataFim)) {
                    dados.push(...dadosPorData[data]);
                }
            }
            return dados;
        }

        function getDadosPeriodoFiltrados() {
            const dados = getDadosPeriodo();
            
            let filtrados = dados;
            
            if (termoBuscaGlobal) {
                filtrados = filtrados.filter(l => 
                    l.loja.toString().includes(termoBuscaGlobal) ||
                    (lojaNomes[l.loja] || '').toLowerCase().includes(termoBuscaGlobal) ||
                    l.adm.toLowerCase().includes(termoBuscaGlobal)
                );
            }
            
            if (filtroStatus) filtrados = filtrados.filter(l => l.status === filtroStatus);
            if (filtroAdm) filtrados = filtrados.filter(l => l.adm === filtroAdm);
            if (filtroLoja) filtrados = filtrados.filter(l => l.loja == filtroLoja);
            
            return filtrados;
        }

        function isDataNoPeriodo(data, inicio, fim) {
            if (!data) return false;
            try {
                const [dD, mD, aD] = data.split('/').map(Number);
                const [dI, mI, aI] = inicio.split('/').map(Number);
                const [dF, mF, aF] = fim.split('/').map(Number);
                const dataObj = new Date(aD, mD - 1, dD);
                return dataObj >= new Date(aI, mI - 1, dI) && dataObj <= new Date(aF, mF - 1, dF);
            } catch { 
                return false; 
            }
        }

        // ========== FUNÇÕES DE ANÁLISE AVANÇADA ==========
        function calcularAlertas(dados) {
            const alertas = [];
            if (!dados || dados.length === 0) return alertas;
            
            const datas = [...new Set(dados.map(d => d.data))].sort((a, b) => {
                const [dA,mA,anA] = a.split('/');
                const [dB,mB,anB] = b.split('/');
                return new Date(anB,mB-1,dB) - new Date(anA,mA-1,dA);
            });
            
            if (datas.length < 2) return alertas;
            
            const hoje = datas[0];
            const ontem = datas[1];
            
            const dadosHoje = dados.filter(d => d.data === hoje);
            const dadosOntem = dados.filter(d => d.data === ontem);
            
            dadosHoje.forEach(lojaHoje => {
                const lojaOntem = dadosOntem.find(l => l.loja === lojaHoje.loja);
                if (lojaOntem && lojaOntem.faturamento > 0) {
                    const variacao = ((lojaHoje.faturamento - lojaOntem.faturamento) / lojaOntem.faturamento) * 100;
                    if (variacao < -15) {
                        alertas.push({
                            tipo: 'danger',
                            icone: '⚠️',
                            titulo: 'Queda acentuada',
                            descricao: `<strong>Loja ${lojaHoje.loja}</strong> (${lojaHoje.adm}) caiu <strong>${Math.abs(variacao).toFixed(1)}%</strong> em relação a ontem`,
                            time: 'Agora mesmo',
                            loja: lojaHoje.loja
                        });
                    }
                }
            });
            
            const lojasCriticas = dadosHoje.filter(l => l.status === 'NÃO' && l.meta > 0 && (l.faturamento / l.meta) < 0.5);
            lojasCriticas.slice(0, 2).forEach(loja => {
                alertas.push({
                    tipo: 'warning',
                    icone: '⚠️',
                    titulo: 'Loja crítica',
                    descricao: `<strong>Loja ${loja.loja}</strong> (${loja.adm}) está com apenas <strong>${((loja.faturamento/loja.meta)*100).toFixed(1)}%</strong> da meta`,
                    time: 'Necessita atenção',
                    loja: loja.loja
                });
            });
            
            const maioresCrescimentos = [];
            dadosHoje.forEach(lojaHoje => {
                const lojaOntem = dadosOntem.find(l => l.loja === lojaHoje.loja);
                if (lojaOntem && lojaOntem.faturamento > 0) {
                    const variacao = ((lojaHoje.faturamento - lojaOntem.faturamento) / lojaOntem.faturamento) * 100;
                    if (variacao > 30) {
                        maioresCrescimentos.push({
                            loja: lojaHoje.loja,
                            adm: lojaHoje.adm,
                            variacao
                        });
                    }
                }
            });
            
            maioresCrescimentos.sort((a, b) => b.variacao - a.variacao).slice(0, 1).forEach(item => {
                alertas.push({
                    tipo: 'success',
                    icone: '📈',
                    titulo: 'Destaque de crescimento',
                    descricao: `<strong>Loja ${item.loja}</strong> (${item.adm}) cresceu <strong>${item.variacao.toFixed(1)}%</strong> em relação a ontem`,
                    time: 'Excelente performance',
                    loja: item.loja
                });
            });
            
            return alertas.slice(0, 4);
        }

        function calcularAlertasTabela(registro) {
            if (registro.status === 'FECHADA') {
                return { tipo: 'neutral', texto: '🔴 Fechada' };
            }
            
            const percentualMeta = registro.meta > 0 ? (registro.faturamento / registro.meta) * 100 : 0;
            
            if (percentualMeta < 30) {
                return { tipo: 'danger', texto: '⚠️ Crítico' };
            } else if (percentualMeta < 60) {
                return { tipo: 'warning', texto: '⚡ Atenção' };
            } else if (percentualMeta >= 100) {
                return { tipo: 'success', texto: '✅ Meta OK' };
            }
            return { tipo: 'neutral', texto: '📊 Normal' };
        }

        // ========== FUNÇÕES DE ATUALIZAÇÃO ==========
        function atualizarAlertas(dados) {
            const alertas = calcularAlertas(dados);
            const grid = document.getElementById('alertsGrid');
            if (!grid) return;
            
            if (alertas.length === 0) {
                grid.innerHTML = `
                    <div class="alert-card success">
                        <div class="alert-icon success">✅</div>
                        <div class="alert-content">
                            <div class="alert-title">Tudo sob controle</div>
                            <div class="alert-desc">Nenhum alerta crítico no momento</div>
                            <div class="alert-time"><i class="far fa-clock"></i> Sistema estável</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            alertas.forEach(a => {
                html += `
                    <div class="alert-card ${a.tipo}" onclick="filtrarPorLoja(${a.loja})" style="cursor: pointer;">
                        <div class="alert-icon ${a.tipo}">${a.icone}</div>
                        <div class="alert-content">
                            <div class="alert-title">${a.titulo}</div>
                            <div class="alert-desc">${a.descricao}</div>
                            <div class="alert-time"><i class="far fa-clock"></i> ${a.time}</div>
                        </div>
                    </div>
                `;
            });
            grid.innerHTML = html;
        }

        function atualizarAlertasTabela(dados) {
            const alertas = [];
            const lojasUnicas = [...new Set(dados.map(l => l.loja))];
            
            lojasUnicas.forEach(loja => {
                const dadosLoja = dados.filter(l => l.loja === loja);
                const mediaPercentual = dadosLoja.reduce((acc, l) => acc + (l.meta > 0 ? (l.faturamento / l.meta) : 0), 0) / dadosLoja.length * 100;
                
                if (mediaPercentual < 50) {
                    alertas.push({
                        tipo: 'danger',
                        icone: '⚠️',
                        titulo: `Loja ${loja} crítica`,
                        descricao: `Média de ${mediaPercentual.toFixed(0)}% da meta no período`,
                        loja: loja
                    });
                } else if (mediaPercentual > 120) {
                    alertas.push({
                        tipo: 'success',
                        icone: '🏆',
                        titulo: `Loja ${loja} destaque`,
                        descricao: `Média de ${mediaPercentual.toFixed(0)}% da meta - acima do esperado`,
                        loja: loja
                    });
                }
            });

            const grid = document.getElementById('tabelaAlertas');
            if (!grid) return;

            if (alertas.length === 0) {
                grid.innerHTML = `
                    <div class="alert-card success">
                        <div class="alert-icon success">✅</div>
                        <div class="alert-content">
                            <div class="alert-title">Todas as lojas estáveis</div>
                            <div class="alert-desc">Nenhum alerta no período selecionado</div>
                        </div>
                    </div>
                `;
                return;
            }

            let html = '';
            alertas.slice(0, 3).forEach(a => {
                html += `
                    <div class="alert-card ${a.tipo}" onclick="filtrarPorLoja(${a.loja})" style="cursor: pointer;">
                        <div class="alert-icon ${a.tipo}">${a.icone}</div>
                        <div class="alert-content">
                            <div class="alert-title">${a.titulo}</div>
                            <div class="alert-desc">${a.descricao}</div>
                        </div>
                    </div>
                `;
            });
            grid.innerHTML = html;
        }

        function atualizarKPIs(dados) {
            const fat = dados.reduce((acc, l) => acc + l.faturamento, 0);
            const meta = dados.reduce((acc, l) => acc + l.meta, 0);
            const dif = fat - meta;
            
            const lojasUnicas = [...new Set(dados.map(l => l.loja))];
            const total = lojasUnicas.length;
            const dias = [...new Set(dados.map(l => l.data))].length;
            
            const metasSim = dados.filter(l => l.status === 'SIM').length;
            const cupons = dados.reduce((acc, l) => acc + l.cupons, 0);
            const ticket = cupons > 0 ? fat / cupons : 0;
            
            const elementos = {
                totalFaturamento: document.getElementById('totalFaturamento'),
                totalMeta: document.getElementById('totalMeta'),
                metasAtingidas: document.getElementById('metasAtingidas'),
                progressoMeta: document.getElementById('progressoMeta'),
                totalDiferenca: document.getElementById('totalDiferenca'),
                diferencaText: document.getElementById('diferencaText'),
                ticketMedio: document.getElementById('ticketMedio'),
                ticketPeriodo: document.getElementById('ticketPeriodo')
            };

            if (elementos.totalFaturamento) elementos.totalFaturamento.innerHTML = `R$ ${formatMoneyDecimal(fat)}`;
            if (elementos.totalMeta) elementos.totalMeta.innerHTML = `R$ ${formatMoneyDecimal(meta)}`;
            if (elementos.metasAtingidas) elementos.metasAtingidas.innerHTML = `${metasSim}/${total}`;
            if (elementos.progressoMeta) elementos.progressoMeta.style.width = meta > 0 ? Math.min(100, (fat / meta * 100)) + '%' : '0%';
            
            if (elementos.totalDiferenca) {
                elementos.totalDiferenca.innerHTML = `${dif >= 0 ? '+' : '-'} R$ ${formatMoneyDecimal(Math.abs(dif))}`;
                elementos.totalDiferenca.className = `kpi-value ${dif >= 0 ? 'valor-positivo' : 'valor-negativo'}`;
            }
            if (elementos.diferencaText) elementos.diferencaText.innerHTML = meta > 0 ? `${dif >= 0 ? '+' : ''}${((dif / meta) * 100).toFixed(1)}% da meta` : '0% da meta';
            
            if (elementos.ticketMedio) elementos.ticketMedio.innerHTML = `R$ ${formatMoneyDecimal(ticket)}`;
            if (elementos.ticketPeriodo) elementos.ticketPeriodo.innerHTML = dias === 1 ? 'hoje' : `média ${dias}d`;
        }

        function atualizarComparativos(dados) {
            const datas = [...new Set(dados.map(d => d.data))].sort((a, b) => {
                const [dA,mA,anA] = a.split('/');
                const [dB,mB,anB] = b.split('/');
                return new Date(anB,mB-1,dB) - new Date(anA,mA-1,dA);
            });
            
            if (datas.length < 2) return;
            
            const hoje = datas[0];
            const ontem = datas[1];
            
            const dadosHoje = dados.filter(d => d.data === hoje);
            const dadosOntem = dados.filter(d => d.data === ontem);
            
            const fatHoje = dadosHoje.reduce((acc, l) => acc + l.faturamento, 0);
            const fatOntem = dadosOntem.reduce((acc, l) => acc + l.faturamento, 0);
            const variacaoOntem = fatOntem > 0 ? ((fatHoje - fatOntem) / fatOntem) * 100 : 0;
            
            const dataSemanaPassada = new Date(hoje.split('/').reverse().join('-'));
            dataSemanaPassada.setDate(dataSemanaPassada.getDate() - 7);
            const dataSemanaStr = `${dataSemanaPassada.getDate().toString().padStart(2,'0')}/${(dataSemanaPassada.getMonth()+1).toString().padStart(2,'0')}/${dataSemanaPassada.getFullYear()}`;
            const dadosSemana = dados.filter(d => d.data === dataSemanaStr);
            const fatSemana = dadosSemana.reduce((acc, l) => acc + l.faturamento, 0);
            const variacaoSemana = fatSemana > 0 ? ((fatHoje - fatSemana) / fatSemana) * 100 : 0;
            
            const dataMesPassado = new Date(hoje.split('/').reverse().join('-'));
            dataMesPassado.setMonth(dataMesPassado.getMonth() - 1);
            const dataMesStr = `${dataMesPassado.getDate().toString().padStart(2,'0')}/${(dataMesPassado.getMonth()+1).toString().padStart(2,'0')}/${dataMesPassado.getFullYear()}`;
            const dadosMes = dados.filter(d => d.data === dataMesStr);
            const fatMes = dadosMes.reduce((acc, l) => acc + l.faturamento, 0);
            const variacaoMes = fatMes > 0 ? ((fatHoje - fatMes) / fatMes) * 100 : 0;
            
            const dataAnoPassado = new Date(hoje.split('/').reverse().join('-'));
            dataAnoPassado.setFullYear(dataAnoPassado.getFullYear() - 1);
            const dataAnoStr = `${dataAnoPassado.getDate().toString().padStart(2,'0')}/${(dataAnoPassado.getMonth()+1).toString().padStart(2,'0')}/${dataAnoPassado.getFullYear()}`;
            const dadosAno = dados.filter(d => d.data === dataAnoStr);
            const fatAno = dadosAno.reduce((acc, l) => acc + l.faturamento, 0);
            const variacaoAno = fatAno > 0 ? ((fatHoje - fatAno) / fatAno) * 100 : 0;
            
            const elementos = {
                comparativoOntem: document.getElementById('comparativoOntem'),
                variacaoOntem: document.getElementById('variacaoOntem'),
                comparativoSemana: document.getElementById('comparativoSemana'),
                variacaoSemana: document.getElementById('variacaoSemana'),
                comparativoMes: document.getElementById('comparativoMes'),
                variacaoMes: document.getElementById('variacaoMes'),
                comparativoAno: document.getElementById('comparativoAno'),
                variacaoAno: document.getElementById('variacaoAno')
            };
            
            if (elementos.comparativoOntem) elementos.comparativoOntem.innerHTML = `R$ ${formatMoneyDecimal(fatOntem)}`;
            if (elementos.variacaoOntem) {
                elementos.variacaoOntem.innerHTML = `${variacaoOntem >= 0 ? '+' : ''}${variacaoOntem.toFixed(1)}%`;
                elementos.variacaoOntem.className = `kpi-footer ${variacaoOntem >= 0 ? 'trend-up' : 'trend-down'}`;
            }
            
            if (elementos.comparativoSemana) elementos.comparativoSemana.innerHTML = `R$ ${formatMoneyDecimal(fatSemana)}`;
            if (elementos.variacaoSemana) {
                elementos.variacaoSemana.innerHTML = `${variacaoSemana >= 0 ? '+' : ''}${variacaoSemana.toFixed(1)}%`;
                elementos.variacaoSemana.className = `kpi-footer ${variacaoSemana >= 0 ? 'trend-up' : 'trend-down'}`;
            }
            
            if (elementos.comparativoMes) elementos.comparativoMes.innerHTML = `R$ ${formatMoneyDecimal(fatMes)}`;
            if (elementos.variacaoMes) {
                elementos.variacaoMes.innerHTML = `${variacaoMes >= 0 ? '+' : ''}${variacaoMes.toFixed(1)}%`;
                elementos.variacaoMes.className = `kpi-footer ${variacaoMes >= 0 ? 'trend-up' : 'trend-down'}`;
            }
            
            if (elementos.comparativoAno) elementos.comparativoAno.innerHTML = `R$ ${formatMoneyDecimal(fatAno)}`;
            if (elementos.variacaoAno) {
                elementos.variacaoAno.innerHTML = `${variacaoAno >= 0 ? '+' : ''}${variacaoAno.toFixed(1)}%`;
                elementos.variacaoAno.className = `kpi-footer ${variacaoAno >= 0 ? 'trend-up' : 'trend-down'}`;
            }
        }

        function atualizarRankingsADM(dados) {
            const admDados = {};
            
            dados.forEach(l => {
                if (!admDados[l.adm]) {
                    admDados[l.adm] = { nome: l.adm, faturamento: 0, meta: 0, lojas: new Set() };
                }
                admDados[l.adm].faturamento += l.faturamento;
                admDados[l.adm].meta += l.meta;
                admDados[l.adm].lojas.add(l.loja);
            });

            const adms = Object.values(admDados).map(adm => ({
                ...adm,
                percentual: adm.meta > 0 ? (adm.faturamento / adm.meta * 100) : 0,
                totalLojas: adm.lojas.size
            }));

            const rankingFaturamento = [...adms].sort((a, b) => b.faturamento - a.faturamento);
            const rankingPerformance = [...adms].filter(adm => adm.meta > 0).sort((a, b) => b.percentual - a.percentual);

            atualizarPodium('Faturamento', rankingFaturamento);
            atualizarLista('Faturamento', rankingFaturamento);
            atualizarPodium('Performance', rankingPerformance);
            atualizarLista('Performance', rankingPerformance);
        }

        function atualizarPodium(tipo, ranking) {
            const podiumDiv = document.getElementById(`podium${tipo}`);
            if (!podiumDiv) return;

            const top3 = ranking.slice(0, 3);
            if (top3.length === 0) {
                podiumDiv.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Sem dados</div>';
                return;
            }

            let html = '';
            const ordem = [1, 0, 2];
            for (let i = 0; i < 3; i++) {
                const idx = ordem[i];
                if (idx >= top3.length) continue;
                
                const adm = top3[idx];
                const posicao = idx + 1;
                const medalha = posicao === 1 ? '🥇' : posicao === 2 ? '🥈' : '🥉';
                
                let valor = tipo === 'Faturamento' ? `R$ ${formatMoneyDecimal(adm.faturamento)}` : `${adm.percentual.toFixed(1)}%`;
                
                html += `
                    <div class="podium-item podium-${posicao}">
                        <div class="podium-medal">${medalha}</div>
                        <div class="podium-name">${adm.nome}</div>
                        <div class="podium-value">${valor}</div>
                    </div>
                `;
            }

            podiumDiv.innerHTML = html;
        }

        function atualizarLista(tipo, ranking) {
            const listaDiv = document.getElementById(`lista${tipo}`);
            if (!listaDiv) return;

            let html = '';
            ranking.slice(0, 7).forEach((adm, index) => {
                const posicao = index + 1;
                let classePosicao = '';
                if (posicao === 1) classePosicao = 'top-1';
                else if (posicao === 2) classePosicao = 'top-2';
                else if (posicao === 3) classePosicao = 'top-3';

                const medalha = posicao <= 3 ? (posicao === 1 ? '🥇' : posicao === 2 ? '🥈' : '🥉') : '';
                
                const valorPrincipal = tipo === 'Faturamento' ? `R$ ${formatMoneyDecimal(adm.faturamento)}` : `${adm.percentual.toFixed(1)}%`;
                const infoAdicional = tipo === 'Faturamento'
                    ? `${adm.percentual.toFixed(1)}% meta`
                    : `R$ ${formatMoneyDecimal(adm.faturamento)}`;

                html += `
                    <div class="ranking-item">
                        <div class="ranking-pos ${classePosicao}">${posicao}</div>
                        <div class="ranking-info">
                            <span class="ranking-name">
                                ${adm.nome}
                                ${medalha ? `<span style="margin-left: 4px;">${medalha}</span>` : ''}
                            </span>
                            <span class="ranking-stats">
                                ${valorPrincipal} · ${infoAdicional} · ${adm.totalLojas} lojas
                            </span>
                        </div>
                    </div>
                `;
            });

            listaDiv.innerHTML = html;
        }

        function atualizarTabela(dados, filtroAlerta = '') {
            const tbody = document.getElementById('tableBody');
            if (!tbody) return;
            
            let html = '';
            let registrosFiltrados = dados;
            
            if (filtroAlerta) {
                registrosFiltrados = dados.filter(l => {
                    const alerta = calcularAlertasTabela(l);
                    if (filtroAlerta === 'critico') return alerta.tipo === 'danger';
                    if (filtroAlerta === 'atencao') return alerta.tipo === 'warning';
                    if (filtroAlerta === 'bom') return alerta.tipo === 'success';
                    return true;
                });
            }
            
            registrosFiltrados.forEach(l => {
                const nome = lojaNomes[l.loja] || `Loja ${l.loja}`;
                const difClass = l.dif >= 0 ? 'valor-positivo' : 'valor-negativo';
                const statusClass = l.status === 'SIM' ? 'status-success' : l.status === 'FECHADA' ? 'status-neutral' : 'status-danger';
                const statusText = l.status === 'SIM' ? '✅ Meta OK' : l.status === 'FECHADA' ? '🔴 Fechada' : '❌ Abaixo';
                const sinal = l.dif > 0 ? '+' : '';
                
                const alerta = calcularAlertasTabela(l);
                
                html += `<tr>
                    <td>${l.data || '-'}</td>
                    <td><span class="store-name" onclick="abrirModalLoja(${l.loja})">${l.loja} - ${nome}</span></td>
                    <td>${l.adm}</td>
                    <td>${l.inicio || '-'}</td>
                    <td>${l.fim || '-'}</td>
                    <td>${l.cupons}</td>
                    <td class="${difClass}">R$ ${formatMoneyDecimal(l.faturamento)}</td>
                    <td>R$ ${formatMoneyDecimal(l.meta)}</td>
                    <td class="${difClass}">${l.dif >= 0 ? '+' : '-'} R$ ${formatMoneyDecimal(Math.abs(l.dif))}</td>
                    <td class="${difClass}">${l.meta > 0 ? sinal + l.difPercentual.toFixed(2) + '%' : '-'}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td><span class="badge ${alerta.tipo === 'danger' ? 'badge-danger' : alerta.tipo === 'warning' ? 'badge-warning' : alerta.tipo === 'success' ? 'badge-success' : ''}">${alerta.texto}</span></td>
                </tr>`;
            });
            
            tbody.innerHTML = html || '<tr><td colspan="12" style="text-align:center;padding:40px;">Nenhum registro encontrado</td></tr>';
            
            const registrosCount = document.getElementById('registrosCount');
            if (registrosCount) registrosCount.innerText = registrosFiltrados.length;
        }

        // ========== FUNÇÕES CORRIGIDAS PARA GRÁFICOS DE TENDÊNCIAS ==========
        function renderizarGraficoEvolucaoProjecao(dados) {
            const datas = [...new Set(dados.map(d => d.data))].sort((a, b) => {
                const [dA, mA, anA] = a.split('/');
                const [dB, mB, anB] = b.split('/');
                return new Date(anA, mA-1, dA) - new Date(anB, mB-1, dB);
            });

            if (datas.length < 3) {
                document.getElementById('evolucaoProjecaoChart').innerHTML = '<div style="height: 100%; display: flex; align-items: center; justify-content: center; color: var(--text-secondary);">Dados insuficientes para análise de tendência</div>';
                return;
            }

            const ultimasDatas = datas.slice(-15);
            const valoresReais = ultimasDatas.map(data => 
                dados.filter(d => d.data === data).reduce((acc, l) => acc + l.faturamento, 0)
            );

            const metaTotal = dados.reduce((acc, l) => acc + l.meta, 0);
            const metaMediaDiaria = metaTotal / datas.length;

            const n = valoresReais.length;
            const x = [...Array(n).keys()];
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = valoresReais.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((a, i) => a + i * valoresReais[i], 0);
            const sumXX = x.reduce((a, i) => a + i * i, 0);

            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            const yMean = sumY / n;
            const ssTot = valoresReais.reduce((acc, y) => acc + Math.pow(y - yMean, 2), 0);
            const ssRes = valoresReais.reduce((acc, y, i) => {
                const yPred = intercept + slope * i;
                return acc + Math.pow(y - yPred, 2);
            }, 0);
            const r2 = 1 - (ssRes / ssTot);

            const projecoes = [];
            for (let i = n; i < n + 7; i++) {
                projecoes.push(Math.max(0, intercept + slope * i));
            }

            const labels = [
                ...ultimasDatas.map(d => d.substring(0,5)),
                ...Array(7).fill('').map((_, i) => `D+${i+1}`)
            ];

            const metaLinha = Array(labels.length).fill(metaMediaDiaria);

            const options = {
                chart: {
                    type: 'line',
                    height: 320,
                    fontFamily: 'Inter, sans-serif',
                    background: 'transparent',
                    toolbar: { show: true, tools: { download: true } },
                    zoom: { enabled: true },
                    animations: { enabled: true }
                },
                series: [
                    {
                        name: 'Venda Real',
                        data: valoresReais,
                        type: 'line',
                        color: '#2e7d32',
                        markers: { size: 5 }
                    },
                    {
                        name: 'Projeção (Tendência)',
                        data: [...Array(n-1).fill(null), ...valoresReais.slice(-1), ...projecoes],
                        type: 'line',
                        color: '#ffd166',
                        dashArray: 5,
                        markers: { size: 0 }
                    },
                    {
                        name: 'Meta Diária',
                        data: metaLinha,
                        type: 'line',
                        color: '#4cc9f0',
                        dashArray: 3,
                        markers: { size: 0 }
                    }
                ],
                xaxis: {
                    categories: labels,
                    labels: { 
                        style: { fontSize: '10px' },
                        rotate: -45,
                        rotateAlways: true
                    }
                },
                yaxis: {
                    labels: {
                        formatter: (val) => `R$ ${formatMoneyDecimal(val)}`
                    },
                    min: 0
                },
                stroke: {
                    width: [2, 2, 1.5],
                    curve: 'smooth'
                },
                markers: {
                    size: [5, 0, 0],
                    hover: { size: 6 }
                },
                grid: {
                    borderColor: 'var(--border-color)',
                    strokeDashArray: 5
                },
                tooltip: {
                    y: {
                        formatter: (val) => `R$ ${formatMoneyDecimal(val)}`
                    },
                    shared: true
                },
                annotations: {
                    yaxis: [{
                        y: metaMediaDiaria,
                        borderColor: '#4cc9f0',
                        label: {
                            borderColor: '#4cc9f0',
                            style: { color: '#fff', background: '#4cc9f0' },
                            text: `Meta Média: R$ ${formatMoneyDecimal(metaMediaDiaria)}`
                        }
                    }],
                    points: valoresReais.map((val, idx) => ({
                        x: labels[idx],
                        y: val,
                        marker: { size: 0 },
                        label: {
                            borderColor: '#2e7d32',
                            style: { color: '#fff', background: '#2e7d32', fontSize: '9px' },
                            text: `R$ ${(val/1000).toFixed(0)}k`,
                            offsetY: -10
                        }
                    })).slice(-3)
                }
            };

            if (graficos.evolucaoProjecao) graficos.evolucaoProjecao.destroy();
            graficos.evolucaoProjecao = new ApexCharts(document.querySelector("#evolucaoProjecaoChart"), options);
            graficos.evolucaoProjecao.render();

            const crescimentoDiario = (slope / valoresReais[n-1]) * 100;
            document.getElementById('crescimentoDiario').innerText = `${crescimentoDiario >= 0 ? '+' : ''}${crescimentoDiario.toFixed(1)}%`.replace('.', ',');
            document.getElementById('detalheCrescimento').innerHTML = `vs média R$ ${formatMoneyDecimal(yMean)}`;
            
            const projecaoFinal = projecoes.reduce((a, b) => a + b, 0) / projecoes.length * 30;
            const diferencaProjecao = ((projecaoFinal - metaTotal) / metaTotal) * 100;
            
            document.getElementById('projecaoFinalMes').innerHTML = `R$ ${formatMoneyDecimal(projecaoFinal)}`;
            document.getElementById('detalheProjecao').innerHTML = `vs Meta: ${diferencaProjecao >= 0 ? '+' : ''}${diferencaProjecao.toFixed(1)}% · ${((valoresReais.reduce((a,b) => a+b,0) / metaTotal) * 100).toFixed(0)}% realizado`.replace('.', ',');
            
            const diasSemana = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
            const diasAbreviados = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            const valoresPorDia = Array(7).fill(0).map(() => ({ total: 0, count: 0 }));
            
            dados.forEach(l => {
                const [d, m, a] = l.data.split('/').map(Number);
                const dataObj = new Date(a, m-1, d);
                const diaSemana = dataObj.getDay();
                valoresPorDia[diaSemana].total += l.faturamento;
                valoresPorDia[diaSemana].count++;
            });

            let melhorDiaIndex = 0;
            let melhorMedia = 0;
            let mediaGeral = 0;
            let totalGeral = 0;
            
            valoresPorDia.forEach((v, i) => {
                const media = v.count > 0 ? v.total / v.count : 0;
                totalGeral += media;
                if (media > melhorMedia) {
                    melhorMedia = media;
                    melhorDiaIndex = i;
                }
            });
            
            mediaGeral = totalGeral / 7;

            document.getElementById('melhorDia').innerText = diasAbreviados[melhorDiaIndex];
            document.getElementById('detalheMelhorDia').innerHTML = `média R$ ${formatMoneyDecimal(melhorMedia)} · ${((melhorMedia - mediaGeral) / mediaGeral * 100).toFixed(0)}% acima`.replace('.', ',');
            
            document.getElementById('confiabilidade').innerHTML = `${(r2 * 100).toFixed(0)}%`.replace('.', ',');
            
            const confiabilidadeTexto = r2 > 0.7 ? 'forte' : r2 > 0.4 ? 'moderada' : 'fraca';
            const confiabilidadeCor = r2 > 0.7 ? 'var(--success)' : r2 > 0.4 ? 'var(--warning)' : 'var(--danger)';
            document.getElementById('detalheConfiabilidade').innerHTML = `R² = ${r2.toFixed(2)} · tendência ${confiabilidadeTexto}`.replace('.', ',');
            document.getElementById('confiabilidadeExplicacao').innerHTML = `Confiabilidade <strong style="color: ${confiabilidadeCor};">${confiabilidadeTexto}</strong> - ${r2 > 0.7 ? 'projeções confiáveis' : r2 > 0.4 ? 'acompanhar com atenção' : 'baixa precisão, reavaliar estratégia'}`;
            
            // Texto explicativo da tendência
            const tendenciaTexto = slope > 0 ? 'crescimento' : slope < 0 ? 'queda' : 'estabilidade';
            const tendenciaIcone = slope > 0 ? '📈' : slope < 0 ? '📉' : '📊';
            const tendenciaForca = Math.abs(slope) > 1000 ? 'forte' : Math.abs(slope) > 500 ? 'moderada' : 'suave';
            
            document.getElementById('tendenciaTextoDetalhado').innerHTML = `${tendenciaIcone} ${tendenciaForca} ${tendenciaTexto} (${slope > 0 ? '+' : ''}${formatMoneyDecimal(slope)}/dia)`;
            document.getElementById('confiabilidadeTextoDetalhado').innerHTML = `<span style="color: ${confiabilidadeCor};">${confiabilidadeTexto}</span>`;

            const fatTotal = dados.reduce((acc, l) => acc + l.faturamento, 0);
            const percentualMeta = metaTotal > 0 ? (fatTotal / metaTotal) * 100 : 0;
            document.getElementById('progressoPerformance').style.width = `${percentualMeta}%`;
            document.getElementById('metaAtingidaPercentual').innerHTML = `${percentualMeta.toFixed(0)}%`.replace('.', ',');
            document.getElementById('faltamMeta').innerHTML = `${(100 - percentualMeta).toFixed(0)}%`.replace('.', ',');
            
            const hoje = new Date();
            const ultimoDiaMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
            const diasRestantes = Math.ceil((ultimoDiaMes - hoje) / (1000 * 60 * 60 * 24));
            const diasUteis = calcularDiasUteis(hoje, ultimoDiaMes);
            
            const valorFaltante = metaTotal - fatTotal;
            const necessarioDiario = valorFaltante > 0 ? valorFaltante / diasUteis : 0;
            
            document.getElementById('diasRestantes').innerHTML = `<i class="far fa-calendar-alt"></i> ${diasUteis} dias úteis restantes (${diasRestantes} totais)`;
            document.getElementById('necessarioDiario').innerHTML = `R$ ${formatMoneyDecimal(necessarioDiario)}/dia`;
            document.getElementById('explicacaoPerformance').innerHTML = `<i class="fas fa-info-circle"></i> Para atingir a meta mensal, precisa de <strong>R$ ${formatMoneyDecimal(necessarioDiario)}/dia</strong> nos próximos dias.`;
            
            const statusEl = document.getElementById('statusPerformance');
            if (percentualMeta >= 100) {
                statusEl.innerHTML = '✅ Meta atingida';
                statusEl.className = 'badge badge-success';
            } else if (percentualMeta >= 80) {
                statusEl.innerHTML = '⚠️ Próximo da meta';
                statusEl.className = 'badge badge-warning';
            } else {
                statusEl.innerHTML = '🔴 Abaixo do esperado';
                statusEl.className = 'badge badge-danger';
            }
            
            document.getElementById('realizadoPercentual').innerHTML = `${percentualMeta.toFixed(0)}%`.replace('.', ',');
            document.getElementById('aRealizarPercentual').innerHTML = `${(100 - percentualMeta).toFixed(0)}%`.replace('.', ',');
            document.getElementById('progressoRealizado').style.width = `${percentualMeta}%`;
            document.getElementById('progressoARealizar').style.width = `${100 - percentualMeta}%`;
            document.getElementById('valorProjetado').innerHTML = `R$ ${(projecaoFinal/1000).toFixed(1)}k`.replace('.', ',');
            
            const statusProjecao = document.getElementById('statusProjecao');
            if (projecaoFinal > metaTotal) {
                statusProjecao.innerHTML = '▲ Acima da meta';
                statusProjecao.className = 'trend-up';
            } else {
                statusProjecao.innerHTML = '▼ Abaixo da meta';
                statusProjecao.className = 'trend-down';
            }

            const alertasTendencia = [];
            
            if (crescimentoDiario < -5) {
                alertasTendencia.push({
                    tipo: 'danger',
                    icone: '📉',
                    titulo: 'Queda acentuada',
                    descricao: `Queda de ${Math.abs(crescimentoDiario).toFixed(1)}% na tendência`.replace('.', ',')
                });
            } else if (crescimentoDiario > 5) {
                alertasTendencia.push({
                    tipo: 'success',
                    icone: '📈',
                    titulo: 'Crescimento forte',
                    descricao: `Crescimento de ${crescimentoDiario.toFixed(1)}% na tendência`.replace('.', ',')
                });
            }
            
            if (percentualMeta < 50) {
                alertasTendencia.push({
                    tipo: 'danger',
                    icone: '⚠️',
                    titulo: 'Meta comprometida',
                    descricao: `Apenas ${percentualMeta.toFixed(0)}% da meta atingida`.replace('.', ',')
                });
            } else if (percentualMeta < 70) {
                alertasTendencia.push({
                    tipo: 'warning',
                    icone: '⚡',
                    titulo: 'Atenção',
                    descricao: `Precisa de R$ ${formatMoneyDecimal(necessarioDiario)}/dia para atingir meta`
                });
            }
            
            if (r2 > 0.8) {
                alertasTendencia.push({
                    tipo: 'success',
                    icone: '📊',
                    titulo: 'Alta confiabilidade',
                    descricao: 'Projeções com alto grau de confiança'
                });
            } else if (r2 < 0.3) {
                alertasTendencia.push({
                    tipo: 'warning',
                    icone: '⚠️',
                    titulo: 'Baixa confiabilidade',
                    descricao: 'Projeções podem não refletir a realidade'
                });
            }

            const alertasContainer = document.getElementById('alertasTendencia');
            if (alertasContainer) {
                let alertasHtml = '';
                alertasTendencia.slice(0, 3).forEach(a => {
                    alertasHtml += `
                        <div class="alert-card ${a.tipo}" style="padding: 10px;">
                            <div class="alert-icon ${a.tipo}" style="width: 24px; height: 24px; font-size: 12px;">${a.icone}</div>
                            <div class="alert-content">
                                <div class="alert-title" style="font-size: 11px;">${a.titulo}</div>
                                <div class="alert-desc" style="font-size: 10px;">${a.descricao}</div>
                            </div>
                        </div>
                    `;
                });
                alertasContainer.innerHTML = alertasHtml || '<div class="alert-card success"><div class="alert-icon success">✅</div><div class="alert-content"><div class="alert-title">Tudo sob controle</div><div class="alert-desc">Nenhum alerta crítico</div></div></div>';
            }
        }

        function calcularDiasUteis(inicio, fim) {
            let count = 0;
            const current = new Date(inicio);
            while (current <= fim) {
                const diaSemana = current.getDay();
                if (diaSemana !== 0 && diaSemana !== 6) count++;
                current.setDate(current.getDate() + 1);
            }
            return count;
        }

        function renderizarGraficoProjecao(dados, tipo = 'linear') {
            const datas = [...new Set(dados.map(d => d.data))].sort((a, b) => {
                const [dA,mA,anA] = a.split('/');
                const [dB,mB,anB] = b.split('/');
                return new Date(anA,mA-1,dA) - new Date(anB,mB-1,dB);
            });

            if (datas.length < 3) {
                document.getElementById('projecaoChart').innerHTML = '<div style="height: 100%; display: flex; align-items: center; justify-content: center; color: var(--text-secondary);">Dados insuficientes para projeção</div>';
                return;
            }

            const valores = datas.map(data => 
                dados.filter(d => d.data === data).reduce((acc, l) => acc + l.faturamento, 0)
            );

            const n = valores.length;
            let projecoes = [];
            let label = '';
            
            if (tipo === 'linear') {
                const x = [...Array(n).keys()];
                const sumX = x.reduce((a, b) => a + b, 0);
                const sumY = valores.reduce((a, b) => a + b, 0);
                const sumXY = x.reduce((a, i) => a + i * valores[i], 0);
                const sumXX = x.reduce((a, i) => a + i * i, 0);

                const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;

                for (let i = n; i < n + 30; i++) {
                    projecoes.push(Math.max(0, intercept + slope * i));
                }
                label = 'Projeção Linear';
            } else if (tipo === 'media') {
                const media7d = valores.slice(-7).reduce((a, b) => a + b, 0) / 7;
                for (let i = 0; i < 30; i++) {
                    projecoes.push(media7d);
                }
                label = 'Média Móvel (7d)';
            } else if (tipo === 'otimista') {
                const x = [...Array(n).keys()];
                const sumX = x.reduce((a, b) => a + b, 0);
                const sumY = valores.reduce((a, b) => a + b, 0);
                const sumXY = x.reduce((a, i) => a + i * valores[i], 0);
                const sumXX = x.reduce((a, i) => a + i * i, 0);

                const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;

                for (let i = n; i < n + 30; i++) {
                    projecoes.push(Math.max(0, (intercept + slope * i) * 1.2));
                }
                label = 'Cenário Otimista (+20%)';
            } else if (tipo === 'pessimista') {
                const x = [...Array(n).keys()];
                const sumX = x.reduce((a, b) => a + b, 0);
                const sumY = valores.reduce((a, b) => a + b, 0);
                const sumXY = x.reduce((a, i) => a + i * valores[i], 0);
                const sumXX = x.reduce((a, i) => a + i * i, 0);

                const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;

                for (let i = n; i < n + 30; i++) {
                    projecoes.push(Math.max(0, (intercept + slope * i) * 0.8));
                }
                label = 'Cenário Pessimista (-20%)';
            }

            const labels = [
                ...datas.slice(-15).map(d => d.substring(0,5)),
                ...Array(30).fill('').map((_, i) => `D+${i+1}`)
            ];

            const historicoData = valores.slice(-15);
            const projecaoData = [...Array(15).fill(null), ...valores.slice(-1), ...projecoes];

            const options = {
                chart: {
                    type: 'line',
                    height: 280,
                    fontFamily: 'Inter, sans-serif',
                    background: 'transparent',
                    toolbar: { show: true },
                    zoom: { enabled: true },
                    animations: { enabled: true }
                },
                series: [
                    {
                        name: 'Histórico',
                        data: historicoData,
                        color: '#2e7d32',
                        type: 'line'
                    },
                    {
                        name: label,
                        data: projecaoData,
                        color: tipo === 'otimista' ? '#06d6a0' : tipo === 'pessimista' ? '#ef476f' : '#ffd166',
                        type: 'line',
                        dashArray: tipo === 'linear' ? 5 : tipo === 'media' ? 3 : 5
                    }
                ],
                xaxis: {
                    categories: labels,
                    labels: { 
                        style: { fontSize: '9px' },
                        rotate: -45,
                        rotateAlways: true
                    }
                },
                yaxis: {
                    labels: { 
                        formatter: (val) => `R$ ${formatMoneyDecimal(val)}`
                    }
                },
                stroke: {
                    width: 2,
                    curve: 'smooth'
                },
                markers: {
                    size: 4,
                    hover: { size: 6 }
                },
                grid: {
                    borderColor: 'var(--border-color)',
                    strokeDashArray: 5
                },
                tooltip: { 
                    y: { 
                        formatter: (val) => `R$ ${formatMoneyDecimal(val)}` 
                    }
                },
                annotations: {
                    points: [
                        {
                            x: labels[14],
                            y: valores[valores.length - 1],
                            marker: { size: 0 },
                            label: {
                                borderColor: '#2e7d32',
                                style: { color: '#fff', background: '#2e7d32', fontSize: '9px' },
                                text: `R$ ${(valores[valores.length - 1]/1000).toFixed(0)}k`,
                                offsetY: -10
                            }
                        }
                    ]
                }
            };

            const container = document.querySelector("#projecaoChart");
            if (container) {
                container.innerHTML = ''; // Limpar o placeholder
                
                if (graficos.projecao) graficos.projecao.destroy();
                graficos.projecao = new ApexCharts(container, options);
                graficos.projecao.render();
            }
        }

        function renderizarGraficoSazonalidade(dados, tipo = 'media') {
            const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            const diasCompletos = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
            
            const valoresPorDia = Array(7).fill(0).map(() => ({ total: 0, count: 0 }));
            const metasPorDia = Array(7).fill(0).map(() => ({ total: 0, count: 0 }));

            dados.forEach(l => {
                const [d, m, a] = l.data.split('/').map(Number);
                const dataObj = new Date(a, m-1, d);
                const diaSemana = dataObj.getDay();
                valoresPorDia[diaSemana].total += l.faturamento;
                valoresPorDia[diaSemana].count++;
                metasPorDia[diaSemana].total += l.meta;
                metasPorDia[diaSemana].count++;
            });

            let series = [];
            
            if (tipo === 'media') {
                series = [{
                    name: 'Média de Vendas',
                    data: valoresPorDia.map(v => v.count > 0 ? v.total / v.count : 0)
                }];
            } else if (tipo === 'total') {
                series = [{
                    name: 'Total de Vendas',
                    data: valoresPorDia.map(v => v.total)
                }];
            } else if (tipo === 'comparativo') {
                series = [
                    {
                        name: 'Média Vendas',
                        data: valoresPorDia.map(v => v.count > 0 ? v.total / v.count : 0)
                    },
                    {
                        name: 'Média Meta',
                        data: metasPorDia.map(v => v.count > 0 ? v.total / v.count : 0)
                    }
                ];
            } else if (tipo === 'percentual') {
                const totalGeral = valoresPorDia.reduce((acc, v) => acc + v.total, 0);
                series = [{
                    name: '% do Total',
                    data: valoresPorDia.map(v => totalGeral > 0 ? (v.total / totalGeral * 100) : 0)
                }];
            }

            const options = {
                chart: {
                    type: 'bar',
                    height: 280,
                    fontFamily: 'Inter, sans-serif',
                    background: 'transparent',
                    toolbar: { show: true }
                },
                series: series,
                xaxis: {
                    categories: diasSemana,
                    labels: { style: { fontSize: '11px' } }
                },
                yaxis: {
                    labels: { 
                        formatter: (val) => tipo === 'percentual' ? val.toFixed(0) + '%' : `R$ ${formatMoneyDecimal(val)}`
                    }
                },
                colors: tipo === 'comparativo' ? ['#2e7d32', '#4cc9f0'] : ['#4cc9f0'],
                plotOptions: {
                    bar: {
                        borderRadius: 6,
                        columnWidth: '60%',
                        distributed: tipo !== 'comparativo'
                    }
                },
                dataLabels: {
                    enabled: true,
                    formatter: (val) => tipo === 'percentual' ? val.toFixed(0) + '%' : `R$ ${formatMoneyDecimal(val)}`
                },
                tooltip: {
                    y: { formatter: (val) => tipo === 'percentual' ? val.toFixed(1) + '%' : `R$ ${formatMoneyDecimal(val)}` }
                }
            };

            if (graficos.sazonalidade) graficos.sazonalidade.destroy();
            graficos.sazonalidade = new ApexCharts(document.querySelector("#sazonalidadeChart"), options);
            graficos.sazonalidade.render();

            const medias = valoresPorDia.map(v => v.count > 0 ? v.total / v.count : 0);
            const mediaGeral = medias.reduce((a, b) => a + b, 0) / 7;
            
            let melhorIdx = 0, piorIdx = 0;
            medias.forEach((m, i) => {
                if (m > medias[melhorIdx]) melhorIdx = i;
                if (m < medias[piorIdx]) piorIdx = i;
            });

            const variacaoMelhor = ((medias[melhorIdx] - mediaGeral) / mediaGeral * 100).toFixed(0);
            const variacaoPior = ((medias[piorIdx] - mediaGeral) / mediaGeral * 100).toFixed(0);
            
            const explicacao = document.getElementById('sazonalidadeExplicacao');
            if (explicacao) {
                explicacao.innerHTML = `${diasCompletos[piorIdx]} tem média <strong>${variacaoPior}% abaixo</strong> da média semanal. ` +
                                      `${diasCompletos[melhorIdx]} é o melhor dia, <strong>${variacaoMelhor}% acima</strong> da média.`;
            }
        }

        function renderizarGraficoHorario(dados, tipo = 'line') {
            const horarios = Array(24).fill(0);
            const horariosCount = Array(24).fill(0);
            const tickets = Array(24).fill(0);

            dados.forEach(l => {
                if (l.inicio && l.inicio !== '-') {
                    const hora = parseInt(l.inicio.split(':')[0]);
                    if (!isNaN(hora) && hora >= 0 && hora < 24) {
                        horarios[hora] += l.faturamento;
                        horariosCount[hora] += l.cupons;
                        if (l.cupons > 0) {
                            tickets[hora] += l.faturamento / l.cupons;
                        }
                    }
                }
            });

            const mediasPorHora = horarios.map((val, i) => horariosCount[i] > 0 ? val / horariosCount[i] : 0);
            const ticketMedioPorHora = horariosCount.map((count, i) => count > 0 ? tickets[i] / count : 0);

            const options = {
                chart: {
                    type: tipo,
                    height: 280,
                    fontFamily: 'Inter, sans-serif',
                    background: 'transparent',
                    toolbar: { show: true }
                },
                series: [
                    {
                        name: 'Faturamento por Hora',
                        data: horarios,
                        type: tipo
                    },
                    {
                        name: 'Ticket Médio por Hora',
                        data: ticketMedioPorHora,
                        type: tipo,
                        yaxis: 'ticket'
                    }
                ],
                xaxis: {
                    categories: Array(24).fill(0).map((_, i) => `${i}h`),
                    labels: { style: { fontSize: '9px' }, rotate: -45 }
                },
                yaxis: [
                    {
                        title: { text: 'Faturamento (R$)', style: { fontSize: '10px' } },
                        labels: { 
                            formatter: (val) => `R$ ${formatMoneyDecimal(val)}`
                        }
                    },
                    {
                        opposite: true,
                        title: { text: 'Ticket Médio (R$)', style: { fontSize: '10px' } },
                        labels: { 
                            formatter: (val) => `R$ ${formatMoneyDecimal(val)}`
                        }
                    }
                ],
                colors: ['#2e7d32', '#ffd166'],
                stroke: { width: 2 },
                markers: { size: tipo === 'line' ? 3 : 0 },
                fill: {
                    type: tipo === 'area' ? 'gradient' : 'solid',
                    gradient: {
                        shadeIntensity: 1,
                        opacityFrom: 0.7,
                        opacityTo: 0.3
                    }
                },
                tooltip: {
                    y: [
                        { formatter: (val) => `R$ ${formatMoneyDecimal(val)}` },
                        { formatter: (val) => `R$ ${formatMoneyDecimal(val)}` }
                    ]
                }
            };

            if (graficos.horario) graficos.horario.destroy();
            graficos.horario = new ApexCharts(document.querySelector("#horarioChart"), options);
            graficos.horario.render();

            let horaPico = 0, maiorValor = 0;
            horarios.forEach((val, i) => {
                if (val > maiorValor) {
                    maiorValor = val;
                    horaPico = i;
                }
            });

            let horaMelhorTicket = 0, melhorTicket = 0;
            ticketMedioPorHora.forEach((val, i) => {
                if (val > melhorTicket) {
                    melhorTicket = val;
                    horaMelhorTicket = i;
                }
            });

            document.getElementById('horarioInfo').innerHTML = `<i class="fas fa-info-circle"></i> Pico às <strong>${horaPico}h</strong> (R$ ${formatMoneyDecimal(maiorValor)}) · ` +
                                                               `Ticket médio maior às <strong>${horaMelhorTicket}h</strong> (R$ ${formatMoneyDecimal(melhorTicket)})`;
        }

        function renderizarGraficoCorrelacao(dados, tipo = 'scatter') {
            const lojas = [...new Set(dados.map(l => l.loja))];
            const pontos = [];
            
            lojas.forEach(loja => {
                const dadosLoja = dados.filter(l => l.loja === loja);
                const totalCupons = dadosLoja.reduce((acc, l) => acc + l.cupons, 0);
                const totalFaturamento = dadosLoja.reduce((acc, l) => acc + l.faturamento, 0);
                const mediaCupons = dadosLoja.length > 0 ? totalCupons / dadosLoja.length : 0;
                const mediaFaturamento = dadosLoja.length > 0 ? totalFaturamento / dadosLoja.length : 0;
                
                pontos.push({
                    x: mediaCupons,
                    y: mediaFaturamento,
                    name: lojaNomes[loja] || `Loja ${loja}`
                });
            });

            const n = pontos.length;
            const sumX = pontos.reduce((acc, p) => acc + p.x, 0);
            const sumY = pontos.reduce((acc, p) => acc + p.y, 0);
            const sumXY = pontos.reduce((acc, p) => acc + p.x * p.y, 0);
            const sumX2 = pontos.reduce((acc, p) => acc + p.x * p.x, 0);
            const sumY2 = pontos.reduce((acc, p) => acc + p.y * p.y, 0);

            const r = (n * sumXY - sumX * sumY) / Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            const series = tipo === 'scatter' 
                ? [{
                    name: 'Lojas',
                    data: pontos.map(p => ({ x: p.x, y: p.y }))
                  }]
                : [{
                    name: 'Lojas',
                    data: pontos.map(p => ({ x: p.x, y: p.y }))
                  },
                  {
                    name: 'Tendência',
                    type: 'line',
                    data: pontos.map(p => ({ x: p.x, y: intercept + slope * p.x }))
                  }];

            const options = {
                chart: {
                    type: tipo === 'scatter' ? 'scatter' : 'line',
                    height: 280,
                    fontFamily: 'Inter, sans-serif',
                    background: 'transparent',
                    toolbar: { show: true },
                    zoom: { enabled: true }
                },
                series: series,
                xaxis: {
                    title: { text: 'Média de Cupons', style: { fontSize: '10px' } },
                    labels: { style: { fontSize: '10px' } }
                },
                yaxis: {
                    title: { text: 'Média Faturamento (R$)', style: { fontSize: '10px' } },
                    labels: { formatter: (val) => `R$ ${formatMoneyDecimal(val)}` }
                },
                colors: tipo === 'scatter' ? ['#2e7d32'] : ['#2e7d32', '#ffd166'],
                markers: {
                    size: 6,
                    hover: { size: 8 }
                },
                stroke: {
                    width: tipo === 'scatter' ? 0 : [0, 2],
                    dashArray: [0, 5]
                },
                tooltip: {
                    custom: ({ seriesIndex, dataPointIndex }) => {
                        const ponto = pontos[dataPointIndex];
                        return `
                            <div style="padding: 8px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 4px;">
                                <strong>${ponto.name}</strong><br>
                                Cupons: ${ponto.x.toFixed(0)}<br>
                                Faturamento: R$ ${formatMoneyDecimal(ponto.y)}
                            </div>
                        `;
                    }
                }
            };

            if (graficos.correlacao) graficos.correlacao.destroy();
            graficos.correlacao = new ApexCharts(document.querySelector("#correlacaoChart"), options);
            graficos.correlacao.render();

            const correlacaoTexto = Math.abs(r) > 0.7 ? 'forte' : Math.abs(r) > 0.4 ? 'moderada' : 'fraca';
            const valorPorCupom = slope;
            
            document.getElementById('correlacaoInfo').innerHTML = `<i class="fas fa-info-circle"></i> Correlação: <strong>${r.toFixed(2).replace('.', ',')}</strong> (${correlacaoTexto}) · ` +
                                                                  `A cada 10 cupons, R$ ${formatMoneyDecimal(valorPorCupom * 10)} em vendas`;
        }

        function renderizarGraficosTendencias() {
            const dados = getDadosPeriodoFiltrados();
            renderizarGraficoEvolucaoProjecao(dados);
            renderizarGraficoProjecao(dados, document.getElementById('tipoProjecao')?.value || 'linear');
            renderizarGraficoSazonalidade(dados, document.getElementById('tipoSazonalidade')?.value || 'media');
            renderizarGraficoCorrelacao(dados, document.getElementById('tipoCorrelacao')?.value || 'scatter');
            renderizarGraficoHorario(dados, document.getElementById('tipoHorario')?.value || 'line');
        }

        // ========== FUNÇÕES CORRIGIDAS PARA GRÁFICOS GERAIS ==========
        function renderizarGraficosApex(tipo, dados, tipoGrafico = 'doughnut') {
            if (!dados || dados.length === 0) return;
            
            if (tipo === 'canalPie') {
                let auto = 0, delivery = 0, viagem = 0, balcao = 0;
                dados.forEach(l => {
                    auto += l.canais?.auto || 0;
                    delivery += l.canais?.delivery || 0;
                    viagem += l.canais?.viagem || 0;
                    balcao += l.canais?.balcao || 0;
                });

                let chartType = tipoGrafico === 'doughnut' ? 'donut' : tipoGrafico === 'pie' ? 'pie' : 'bar';

                const options = {
                    chart: {
                        type: chartType,
                        height: 280,
                        fontFamily: 'Inter, sans-serif',
                        background: 'transparent'
                    },
                    series: chartType === 'bar' ? [{
                        name: 'Faturamento',
                        data: [auto, delivery, viagem, balcao]
                    }] : [auto, delivery, viagem, balcao],
                    labels: ['Auto', 'Delivery', 'Viagem', 'Balcão'],
                    colors: ['#2563eb', '#ef476f', '#4cc9f0', '#ffd166'],
                    plotOptions: chartType === 'donut' ? {
                        pie: {
                            donut: {
                                size: '65%',
                                labels: {
                                    show: true,
                                    total: {
                                        show: true,
                                        label: 'Total',
                                        formatter: () => `R$ ${formatMoneyDecimal(auto + delivery + viagem + balcao)}`
                                    }
                                }
                            }
                        }
                    } : chartType === 'bar' ? {
                        bar: {
                            borderRadius: 6,
                            columnWidth: '60%'
                        }
                    } : {},
                    xaxis: chartType === 'bar' ? {
                        categories: ['Auto', 'Delivery', 'Viagem', 'Balcão'],
                        labels: { style: { fontSize: '11px' } }
                    } : {},
                    yaxis: chartType === 'bar' ? {
                        labels: { formatter: (val) => `R$ ${formatMoneyDecimal(val)}` }
                    } : {},
                    dataLabels: {
                        enabled: chartType === 'bar',
                        formatter: (val) => `R$ ${formatMoneyDecimal(val)}`
                    },
                    legend: {
                        position: 'bottom',
                        fontSize: '11px'
                    },
                    tooltip: {
                        y: {
                            formatter: (val) => `R$ ${formatMoneyDecimal(val)}`
                        }
                    }
                };

                if (graficos.canalPie) graficos.canalPie.destroy();
                graficos.canalPie = new ApexCharts(document.querySelector("#canalPieChart"), options);
                graficos.canalPie.render();
            }
            
            else if (tipo === 'top10') {
                const lojaAgg = {};
                dados.forEach(l => {
                    if (!lojaAgg[l.loja]) lojaAgg[l.loja] = { fat: 0, nome: lojaNomes[l.loja] };
                    lojaAgg[l.loja].fat += l.faturamento;
                });

                const topLojas = Object.values(lojaAgg)
                    .filter(l => l.fat > 0)
                    .sort((a,b) => b.fat - a.fat)
                    .slice(0, 10);

                let chartType = tipoGrafico === 'horizontal' ? 'bar' : tipoGrafico;
                
                const options = {
                    chart: {
                        type: chartType === 'line' ? 'line' : 'bar',
                        height: 280,
                        fontFamily: 'Inter, sans-serif',
                        background: 'transparent',
                        toolbar: { show: false }
                    },
                    series: [{
                        name: 'Faturamento',
                        data: topLojas.map(l => l.fat)
                    }],
                    xaxis: {
                        categories: topLojas.map(l => l.nome.substring(0,15)),
                        labels: { style: { fontSize: '11px' }, rotate: -45 }
                    },
                    yaxis: {
                        labels: { formatter: (val) => `R$ ${formatMoneyDecimal(val)}` }
                    },
                    colors: ['#2e7d32'],
                    plotOptions: chartType === 'bar' ? {
                        bar: {
                            borderRadius: 6,
                            dataLabels: { position: 'top' },
                            horizontal: tipoGrafico === 'horizontal'
                        }
                    } : {},
                    dataLabels: {
                        enabled: chartType === 'bar',
                        formatter: (val) => `R$ ${formatMoneyDecimal(val)}`,
                        offsetY: tipoGrafico === 'horizontal' ? 0 : -20,
                        offsetX: tipoGrafico === 'horizontal' ? 5 : 0
                    },
                    stroke: chartType === 'line' ? { curve: 'smooth', width: 2 } : {},
                    markers: chartType === 'line' ? { size: 4 } : {},
                    tooltip: {
                        y: { formatter: (val) => `R$ ${formatMoneyDecimal(val)}` }
                    }
                };

                if (graficos.top10) graficos.top10.destroy();
                graficos.top10 = new ApexCharts(document.querySelector("#top10Chart"), options);
                graficos.top10.render();
            }
        }

        function renderizarGraficosPerformance(tipo = 'bar', qual = 'ambos') {
            const dados = getDadosPeriodoFiltrados();
            if (!dados || dados.length === 0) return;
            
            const admAgg = {};
            dados.forEach(l => {
                if (!admAgg[l.adm]) admAgg[l.adm] = 0;
                admAgg[l.adm] += l.faturamento;
            });

            const adms = Object.keys(admAgg).sort((a,b) => admAgg[b] - admAgg[a]);

            if (qual === 'faturamento' || qual === 'ambos') {
                const chartType = tipo === 'horizontal' ? 'bar' : tipo;
                
                const options1 = {
                    chart: {
                        type: chartType,
                        height: 280,
                        fontFamily: 'Inter, sans-serif',
                        background: 'transparent',
                        toolbar: { show: false }
                    },
                    series: [{
                        name: 'Faturamento',
                        data: adms.map(a => admAgg[a])
                    }],
                    xaxis: {
                        categories: adms,
                        labels: { style: { fontSize: '11px' } }
                    },
                    yaxis: {
                        labels: { formatter: (val) => `R$ ${formatMoneyDecimal(val)}` }
                    },
                    colors: ['#2e7d32'],
                    plotOptions: chartType === 'bar' ? {
                        bar: {
                            borderRadius: 6,
                            horizontal: tipo === 'horizontal'
                        }
                    } : {},
                    dataLabels: {
                        enabled: true,
                        formatter: (val) => `R$ ${formatMoneyDecimal(val)}`
                    },
                    stroke: chartType === 'line' ? { curve: 'smooth', width: 2 } : {},
                    markers: chartType === 'line' ? { size: 4 } : {}
                };

                if (graficos.admFaturamento) graficos.admFaturamento.destroy();
                graficos.admFaturamento = new ApexCharts(document.querySelector("#admFaturamentoChart"), options1);
                graficos.admFaturamento.render();
            }

            if (qual === 'meta' || qual === 'ambos') {
                const admMeta = {};
                dados.forEach(l => {
                    if (!admMeta[l.adm]) admMeta[l.adm] = { fat: 0, meta: 0 };
                    admMeta[l.adm].fat += l.faturamento;
                    admMeta[l.adm].meta += l.meta;
                });

                const admsMeta = Object.keys(admMeta);
                const percentuais = admsMeta.map(adm => admMeta[adm].meta > 0 ? (admMeta[adm].fat / admMeta[adm].meta * 100) : 0);

                const chartType = tipo === 'horizontal' ? 'bar' : tipo;

                const options2 = {
                    chart: {
                        type: chartType,
                        height: 280,
                        fontFamily: 'Inter, sans-serif',
                        background: 'transparent',
                        toolbar: { show: false }
                    },
                    series: [{
                        name: '% Meta',
                        data: percentuais
                    }],
                    xaxis: {
                        categories: admsMeta,
                        labels: { style: { fontSize: '11px' } }
                    },
                    yaxis: {
                        max: 200,
                        labels: { formatter: (val) => val.toFixed(0) + '%' }
                    },
                    colors: percentuais.map(p => p >= 100 ? '#06d6a0' : '#ef476f'),
                    plotOptions: chartType === 'bar' ? {
                        bar: {
                            borderRadius: 6,
                            distributed: true,
                            horizontal: tipo === 'horizontal'
                        }
                    } : {},
                    dataLabels: {
                        enabled: true,
                        formatter: (val) => val.toFixed(0) + '%'
                    },
                    stroke: chartType === 'line' ? { curve: 'smooth', width: 2 } : {},
                    markers: chartType === 'line' ? { size: 4 } : {}
                };

                if (graficos.admMeta) graficos.admMeta.destroy();
                graficos.admMeta = new ApexCharts(document.querySelector("#admMetaChart"), options2);
                graficos.admMeta.render();
            }
        }

        function renderizarGraficosCanais(tipo = 'pie', qual = 'ambos') {
            const dados = getDadosPeriodoFiltrados();
            if (!dados || dados.length === 0) return;
            
            // Forçar renderização imediatamente, independente do tipo selecionado
            const tipoDistribuicao = document.getElementById('tipoCanalDetalhado')?.value || tipo || 'pie';
            const tipoEvolucao = document.getElementById('tipoEvolucao')?.value || 'line';
            
            if (qual === 'distribuicao' || qual === 'ambos') {
                let auto = 0, delivery = 0, viagem = 0, balcao = 0;
                dados.forEach(l => {
                    auto += l.canais?.auto || 0;
                    delivery += l.canais?.delivery || 0;
                    viagem += l.canais?.viagem || 0;
                    balcao += l.canais?.balcao || 0;
                });

                const chartType = tipoDistribuicao === 'donut' ? 'donut' : tipoDistribuicao === 'pie' ? 'pie' : 'bar';

                const options1 = {
                    chart: {
                        type: chartType,
                        height: 280,
                        fontFamily: 'Inter, sans-serif',
                        background: 'transparent'
                    },
                    series: chartType === 'bar' ? [{
                        name: 'Faturamento',
                        data: [auto, delivery, viagem, balcao]
                    }] : [auto, delivery, viagem, balcao],
                    labels: ['Auto', 'Delivery', 'Viagem', 'Balcão'],
                    colors: ['#2563eb', '#ef476f', '#4cc9f0', '#ffd166'],
                    plotOptions: chartType === 'donut' ? {
                        pie: {
                            donut: {
                                size: '65%',
                                labels: {
                                    show: true,
                                    total: {
                                        show: true,
                                        label: 'Total',
                                        formatter: () => `R$ ${formatMoneyDecimal(auto + delivery + viagem + balcao)}`
                                    }
                                }
                            }
                        }
                    } : chartType === 'bar' ? {
                        bar: {
                            borderRadius: 6,
                            columnWidth: '60%'
                        }
                    } : {},
                    xaxis: chartType === 'bar' ? {
                        categories: ['Auto', 'Delivery', 'Viagem', 'Balcão'],
                        labels: { style: { fontSize: '11px' } }
                    } : {},
                    yaxis: chartType === 'bar' ? {
                        labels: { formatter: (val) => `R$ ${formatMoneyDecimal(val)}` }
                    } : {},
                    dataLabels: {
                        enabled: chartType === 'bar',
                        formatter: (val) => `R$ ${formatMoneyDecimal(val)}`
                    },
                    legend: {
                        position: 'bottom',
                        fontSize: '11px'
                    },
                    tooltip: {
                        y: {
                            formatter: (val) => `R$ ${formatMoneyDecimal(val)}`
                        }
                    }
                };

                if (graficos.canaisDetalhado) graficos.canaisDetalhado.destroy();
                graficos.canaisDetalhado = new ApexCharts(document.querySelector("#canaisDetalhadoChart"), options1);
                graficos.canaisDetalhado.render();
            }

            if (qual === 'evolucao' || qual === 'ambos') {
                const datas = [...new Set(dados.map(d => d.data))].sort((a, b) => {
                    const [dA,mA,anA] = a.split('/');
                    const [dB,mB,anB] = b.split('/');
                    return new Date(anA,mA-1,dA) - new Date(anB,mB-1,dB);
                }).slice(-10);

                const autoData = [], deliveryData = [], viagemData = [], balcaoData = [];
                
                datas.forEach(data => {
                    const dadosData = dados.filter(d => d.data === data);
                    autoData.push(dadosData.reduce((acc, l) => acc + (l.canais?.auto || 0), 0));
                    deliveryData.push(dadosData.reduce((acc, l) => acc + (l.canais?.delivery || 0), 0));
                    viagemData.push(dadosData.reduce((acc, l) => acc + (l.canais?.viagem || 0), 0));
                    balcaoData.push(dadosData.reduce((acc, l) => acc + (l.canais?.balcao || 0), 0));
                });

                const options2 = {
                    chart: {
                        type: tipoEvolucao,
                        height: 280,
                        fontFamily: 'Inter, sans-serif',
                        background: 'transparent',
                        toolbar: { show: true }
                    },
                    series: [
                        { 
                            name: 'Auto', 
                            data: autoData,
                            color: '#2563eb'
                        },
                        { 
                            name: 'Delivery', 
                            data: deliveryData,
                            color: '#ef476f'
                        },
                        { 
                            name: 'Viagem', 
                            data: viagemData,
                            color: '#4cc9f0'
                        },
                        { 
                            name: 'Balcão', 
                            data: balcaoData,
                            color: '#ffd166'
                        }
                    ],
                    xaxis: {
                        categories: datas.map(d => d.substring(0,5)),
                        labels: { style: { fontSize: '11px' }, rotate: -45 }
                    },
                    yaxis: {
                        labels: { 
                            formatter: (val) => `R$ ${formatMoneyDecimal(val)}`
                        }
                    },
                    colors: ['#2563eb', '#ef476f', '#4cc9f0', '#ffd166'],
                    stroke: {
                        width: 2,
                        curve: 'smooth'
                    },
                    fill: {
                        type: tipoEvolucao === 'area' ? 'gradient' : 'solid',
                        gradient: {
                            shadeIntensity: 1,
                            opacityFrom: 0.7,
                            opacityTo: 0.3
                        }
                    },
                    markers: {
                        size: tipoEvolucao === 'line' ? 4 : 0
                    },
                    legend: {
                        position: 'bottom',
                        fontSize: '11px'
                    },
                    tooltip: {
                        y: { 
                            formatter: (val) => `R$ ${formatMoneyDecimal(val)}` 
                        }
                    },
                    dataLabels: {
                        enabled: true,
                        formatter: (val) => `R$ ${formatMoneyDecimal(val)}`,
                        background: {
                            enabled: true,
                            foreColor: '#fff',
                            borderRadius: 2,
                            padding: 4,
                            opacity: 0.8,
                            borderWidth: 1,
                            borderColor: '#fff'
                        }
                    }
                };

                if (graficos.canaisEvolucao) graficos.canaisEvolucao.destroy();
                graficos.canaisEvolucao = new ApexCharts(document.querySelector("#canaisEvolucaoChart"), options2);
                graficos.canaisEvolucao.render();
            }
        }

        // ========== FUNÇÕES PARA MUDAR TIPOS DE GRÁFICOS ==========
        function mudarTipoCanal() {
            const tipo = document.getElementById('tipoCanal').value;
            const dados = getDadosPeriodoFiltrados();
            renderizarGraficosApex('canalPie', dados, tipo);
        }

        function mudarTipoTop10() {
            const tipo = document.getElementById('tipoTop10').value;
            const dados = getDadosPeriodoFiltrados();
            renderizarGraficosApex('top10', dados, tipo);
        }

        function mudarTipoAdmFaturamento() {
            const tipo = document.getElementById('tipoAdmFaturamento').value;
            renderizarGraficosPerformance(tipo, 'faturamento');
        }

        function mudarTipoAdmMeta() {
            const tipo = document.getElementById('tipoAdmMeta').value;
            renderizarGraficosPerformance(tipo, 'meta');
        }

        function mudarTipoCanalDetalhado() {
            const tipo = document.getElementById('tipoCanalDetalhado').value;
            console.log('Mudando tipo de distribuição para:', tipo);
            renderizarGraficosCanais(tipo, 'distribuicao');
        }

        function mudarTipoEvolucao() {
            const tipo = document.getElementById('tipoEvolucao').value;
            console.log('Mudando tipo de evolução para:', tipo);
            renderizarGraficosCanais(tipo, 'evolucao');
        }

        function mudarTipoProjecao() {
            const tipo = document.getElementById('tipoProjecao').value;
            const dados = getDadosPeriodoFiltrados();
            renderizarGraficoProjecao(dados, tipo);
        }

        function mudarTipoSazonalidade() {
            const tipo = document.getElementById('tipoSazonalidade').value;
            const dados = getDadosPeriodoFiltrados();
            renderizarGraficoSazonalidade(dados, tipo);
        }

        function mudarTipoCorrelacao() {
            const tipo = document.getElementById('tipoCorrelacao').value;
            const dados = getDadosPeriodoFiltrados();
            renderizarGraficoCorrelacao(dados, tipo);
        }

        function mudarTipoHorario() {
            const tipo = document.getElementById('tipoHorario').value;
            const dados = getDadosPeriodoFiltrados();
            renderizarGraficoHorario(dados, tipo);
        }

        // ========== EXPORTAÇÃO DE GRÁFICOS ==========
        function exportarGrafico(tipo) {
            const grafico = graficos[tipo === 'canalPie' ? 'canalPie' : tipo === 'top10' ? 'top10' : tipo === 'projecao' ? 'projecao' : tipo === 'sazonalidade' ? 'sazonalidade' : tipo === 'correlacao' ? 'correlacao' : tipo === 'horario' ? 'horario' : null];
            if (grafico) {
                grafico.dataURI().then(({ imgURI }) => {
                    const link = document.createElement('a');
                    link.download = `grafico-${tipo}-${new Date().toLocaleDateString()}.png`;
                    link.href = imgURI;
                    link.click();
                });
            }
        }

        function mostrarDetalheMetrica(tipo) {
            let mensagem = '';
            switch(tipo) {
                case 'crescimento':
                    mensagem = '📊 CRESCIMENTO DIÁRIO: Esta métrica mostra a variação percentual média por dia, calculada através da regressão linear dos últimos 15 dias. Um valor positivo indica tendência de crescimento, negativo indica queda. Quanto maior o valor absoluto, mais acentuada é a tendência.';
                    break;
                case 'projecao':
                    mensagem = '🎯 PROJEÇÃO FINAL DO MÊS: Valor estimado para o final do mês com base na tendência atual. Considera o crescimento diário projetado e projeta para 30 dias. A comparação com a meta mostra se estamos no caminho certo.';
                    break;
                case 'melhorDia':
                    mensagem = '📅 MELHOR DIA: Dia da semana com maior média de faturamento no período analisado. Útil para planejar promoções e alocar recursos. A porcentagem indica quanto este dia está acima da média geral.';
                    break;
                case 'confiabilidade':
                    mensagem = '📈 CONFIABILIDADE (R²): Mede o quão bem a linha de tendência se ajusta aos dados reais. Varia de 0 a 1 (0% a 100%). Quanto mais próximo de 1 (100%), mais confiável é a projeção. Valores abaixo de 0,5 indicam baixa confiabilidade.';
                    break;
            }
            alert(mensagem);
        }

        // ========== ANOTAÇÕES ==========
        function adicionarNota() {
            const texto = prompt('Digite sua anotação:');
            if (!texto) return;
            
            const nota = {
                id: Date.now(),
                texto,
                data: new Date().toLocaleString('pt-BR'),
                usuario: 'Administrador'
            };
            
            notas.unshift(nota);
            salvarNotas();
            atualizarNotas();
        }

        function atualizarNotas() {
            const lista = document.getElementById('notesList');
            if (!lista) return;
            
            if (notas.length === 0) {
                lista.innerHTML = '<div class="note-item"><div class="note-text">Nenhuma anotação ainda. Clique em "Adicionar nota" para começar.</div></div>';
                return;
            }
            
            let html = '';
            notas.slice(0, 5).forEach(n => {
                html += `
                    <div class="note-item">
                        <div class="note-text">${n.texto}</div>
                        <div class="note-meta">
                            <span><i class="far fa-user"></i> ${n.usuario}</span>
                            <span><i class="far fa-clock"></i> ${n.data}</span>
                        </div>
                    </div>
                `;
            });
            lista.innerHTML = html;
        }

        function salvarNotas() {
            const dadosContainer = document.getElementById('dados-permanentes');
            if (dadosContainer) {
                const dadosAtuais = JSON.parse(dadosContainer.textContent || '{"dadosCompletos":[],"dataAtualizacao":"","notas":[]}');
                dadosAtuais.notas = notas;
                dadosContainer.textContent = JSON.stringify(dadosAtuais);
            }
        }

        function carregarNotas() {
            const dadosContainer = document.getElementById('dados-permanentes');
            if (dadosContainer && dadosContainer.textContent) {
                try {
                    const parsed = JSON.parse(dadosContainer.textContent);
                    if (parsed.notas) {
                        notas = parsed.notas;
                    }
                } catch (e) {}
            }
            atualizarNotas();
        }

        // ========== FUNÇÕES DE FILTRO ==========
        function buscarGlobal() {
            const searchInput = document.getElementById('globalSearch');
            if (searchInput) termoBuscaGlobal = searchInput.value.toLowerCase();
            aplicarFiltros();
        }

        function filtrarPorLoja(loja) {
            const lojaFilter = document.getElementById('lojaFilter');
            if (lojaFilter) {
                for (let i = 0; i < lojaFilter.options.length; i++) {
                    if (lojaFilter.options[i].value == loja) {
                        lojaFilter.selectedIndex = i;
                        break;
                    }
                }
            }
            filtroLoja = loja;
            aplicarFiltros();
        }

        function filtrarPorAlerta() {
            const tipo = document.getElementById('alertaTipo').value;
            const dados = getDadosPeriodoFiltrados();
            atualizarTabela(dados, tipo);
        }

        function aplicarFiltros() {
            const statusSelect = document.getElementById('statusFilter');
            const admSelect = document.getElementById('admFilter');
            const lojaSelect = document.getElementById('lojaFilter');
            
            filtroStatus = statusSelect ? statusSelect.value : '';
            filtroAdm = admSelect ? admSelect.value : '';
            filtroLoja = lojaSelect ? lojaSelect.value : '';
            
            const dados = getDadosPeriodoFiltrados();
            
            atualizarAlertas(dados);
            atualizarKPIs(dados);
            atualizarComparativos(dados);
            atualizarRankingsADM(dados);
            
            if (viewAtual === 'visao-geral') {
                renderizarGraficosApex('canalPie', dados, document.getElementById('tipoCanal')?.value || 'doughnut');
                renderizarGraficosApex('top10', dados, document.getElementById('tipoTop10')?.value || 'bar');
            } else if (viewAtual === 'performance') {
                renderizarGraficosPerformance();
            } else if (viewAtual === 'canais') {
                renderizarGraficosCanais(document.getElementById('tipoCanalDetalhado')?.value || 'pie', 'distribuicao');
                renderizarGraficosCanais(document.getElementById('tipoEvolucao')?.value || 'line', 'evolucao');
            } else if (viewAtual === 'tendencias') {
                renderizarGraficosTendencias();
            } else if (viewAtual === 'detalhado') {
                atualizarTabela(dados);
                atualizarAlertasTabela(dados);
            }
        }

        function filtrarPorStatus(status) {
            const statusSelect = document.getElementById('statusFilter');
            if (statusSelect) statusSelect.value = status;
            aplicarFiltros();
        }

        function setPeriodo(tipo) {
            periodoSelecionado = tipo;
            const periodBtns = document.querySelectorAll('.period-btn');
            periodBtns.forEach(b => b.classList.remove('active'));
            
            let btn;
            if (tipo === 'hoje') btn = Array.from(periodBtns).find(b => b.textContent.includes('Hoje'));
            else if (tipo === 'ontem') btn = Array.from(periodBtns).find(b => b.textContent.includes('Ontem'));
            else if (tipo === '7d') btn = Array.from(periodBtns).find(b => b.textContent.includes('7d'));
            else if (tipo === '15d') btn = Array.from(periodBtns).find(b => b.textContent.includes('15d'));
            else if (tipo === '30d') btn = Array.from(periodBtns).find(b => b.textContent.includes('30d'));
            else if (tipo === 'mes') btn = Array.from(periodBtns).find(b => b.textContent.includes('Mês'));
            else if (tipo === 'custom') btn = Array.from(periodBtns).find(b => b.textContent.includes('Período'));
            
            if (btn) btn.classList.add('active');
            
            const datas = Object.keys(dadosPorData).sort((a, b) => {
                const [dA, mA, anA] = a.split('/');
                const [dB, mB, anB] = b.split('/');
                return new Date(anB, mB - 1, dB) - new Date(anA, mA - 1, dA);
            });
            
            if (!datas.length) return;
            
            const ultima = datas[0];
            const primeira = datas[datas.length - 1];
            
            const dateRangeInputs = document.getElementById('dateRangeInputs');
            if (!dateRangeInputs) return;
            
            if (tipo === 'hoje') {
                dataInicio = dataFim = ultima;
                dateRangeInputs.style.display = 'none';
            } else if (tipo === 'ontem') {
                dataInicio = dataFim = datas[1] || ultima;
                dateRangeInputs.style.display = 'none';
            } else if (tipo === '7d') {
                dataInicio = datas[Math.min(datas.length - 1, 6)] || primeira;
                dataFim = ultima;
                dateRangeInputs.style.display = 'none';
            } else if (tipo === '15d') {
                dataInicio = datas[Math.min(datas.length - 1, 14)] || primeira;
                dataFim = ultima;
                dateRangeInputs.style.display = 'none';
            } else if (tipo === '30d') {
                dataInicio = datas[Math.min(datas.length - 1, 29)] || primeira;
                dataFim = ultima;
                dateRangeInputs.style.display = 'none';
            } else if (tipo === 'mes') {
                dataInicio = primeira;
                dataFim = ultima;
                dateRangeInputs.style.display = 'none';
            } else if (tipo === 'custom') {
                dateRangeInputs.style.display = 'flex';
                if (dataInicio) {
                    const [dI, mI, aI] = dataInicio.split('/');
                    const dataInicioInput = document.getElementById('dataInicio');
                    if (dataInicioInput) dataInicioInput.value = `${aI}-${mI}-${dI}`;
                }
                if (dataFim) {
                    const [dF, mF, aF] = dataFim.split('/');
                    const dataFimInput = document.getElementById('dataFim');
                    if (dataFimInput) dataFimInput.value = `${aF}-${mF}-${dF}`;
                }
                return;
            }
            
            atualizarPeriodoDisplay();
            recarregarTudo();
        }

        function atualizarPorData() {
            const dataInicioInput = document.getElementById('dataInicio');
            const dataFimInput = document.getElementById('dataFim');
            
            if (!dataInicioInput || !dataFimInput || !dataInicioInput.value || !dataFimInput.value) return;
            
            const [anoI, mesI, diaI] = dataInicioInput.value.split('-');
            const [anoF, mesF, diaF] = dataFimInput.value.split('-');
            
            dataInicio = `${diaI}/${mesI}/${anoI}`;
            dataFim = `${diaF}/${mesF}/${anoF}`;
            
            const periodBtns = document.querySelectorAll('.period-btn');
            periodBtns.forEach(b => b.classList.remove('active'));
            const btnPeriodo = Array.from(periodBtns).find(b => b.textContent.includes('Período'));
            if (btnPeriodo) btnPeriodo.classList.add('active');
            
            atualizarPeriodoDisplay();
            recarregarTudo();
        }

        function atualizarPeriodoDisplay() {
            if (!dataInicio) return;
            const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            const headerDay = document.getElementById('headerDay');
            const headerMonth = document.getElementById('headerMonth');
            const headerPeriod = document.getElementById('headerPeriod');
            
            if (!headerDay || !headerMonth || !headerPeriod) return;
            
            if (dataInicio === dataFim) {
                const [d, m, a] = dataInicio.split('/');
                headerDay.innerText = d;
                headerMonth.innerText = meses[m - 1].toUpperCase() + ' ' + a;
                headerPeriod.innerText = meses[m - 1] + ' ' + a;
            } else {
                const [dI, mI, aI] = dataInicio.split('/');
                const [dF, mF, aF] = dataFim.split('/');
                headerDay.innerText = dI + '-' + dF;
                headerMonth.innerText = meses[mI - 1].toUpperCase() + ' ' + aI;
                headerPeriod.innerText = `${dI}/${mI} a ${dF}/${mF}/${aF}`;
            }
        }

        function recarregarTudo() {
            if (!Object.keys(dadosPorData).length) return;
            const dados = getDadosPeriodo();
            if (!dados.length) return;
            
            preencherLojaFilter(dados);
            aplicarFiltros();
        }

        function preencherLojaFilter(dados) {
            const select = document.getElementById('lojaFilter');
            if (!select) return;
            
            const lojas = [...new Set(dados.map(l => l.loja))].sort((a, b) => a - b);
            
            select.innerHTML = '<option value="">Todas as Lojas</option>';
            lojas.forEach(loja => {
                const nome = lojaNomes[loja] || `Loja ${loja}`;
                select.innerHTML += `<option value="${loja}">${loja} - ${nome}</option>`;
            });
        }

        function preencherADMFilter() {
            const select = document.getElementById('admFilter');
            if (!select) return;
            
            select.innerHTML = '<option value="">Todos os ADMs</option>';
            const adms = [...new Set(dadosCompletos.map(d => d.adm))].sort();
            adms.forEach(adm => {
                if (adm && adm !== 'Não mapeado') {
                    select.innerHTML += `<option value="${adm}">${adm}</option>`;
                }
            });
        }

        function abrirModalLoja(codigoLoja) {
            const modal = document.getElementById('storeModal');
            const modalTitle = document.getElementById('modalStoreName');
            const modalBody = document.getElementById('modalTableBody');

            if (!modal || !modalTitle || !modalBody) return;

            const nomeLoja = lojaNomes[codigoLoja];
            modalTitle.innerText = `${codigoLoja} - ${nomeLoja}`;

            const dadosLoja = dadosCompletos
                .filter(d => d.loja === codigoLoja)
                .sort((a, b) => {
                    const [dA,mA,anA] = a.data.split('/');
                    const [dB,mB,anB] = b.data.split('/');
                    return new Date(anB,mB-1,dB) - new Date(anA,mA-1,dA);
                });

            let html = '';
            dadosLoja.forEach(d => {
                const pct = d.meta > 0 ? ((d.faturamento/d.meta)*100).toFixed(1) : '-';
                const statusClass = d.status === 'SIM' ? 'status-success' : d.status === 'FECHADA' ? 'status-neutral' : 'status-danger';
                const statusText = d.status === 'SIM' ? '✅ Meta OK' : d.status === 'FECHADA' ? '🔴 Fechada' : '❌ Abaixo';
                html += `<tr>
                    <td>${d.data}</td>
                    <td>R$ ${formatMoneyDecimal(d.faturamento)}</td>
                    <td>R$ ${formatMoneyDecimal(d.meta)}</td>
                    <td style="color: ${d.faturamento >= d.meta ? 'var(--success)' : 'var(--danger)'};">${pct}%</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                </tr>`;
            });

            modalBody.innerHTML = html;
            modal.style.display = 'block';
        }

        function ordenarTabela(coluna) {
            const tbody = document.querySelector('#tableBody');
            if (!tbody) return;
            
            const linhas = Array.from(tbody.querySelectorAll('tr'));
            if (!linhas.length) return;
            
            const ordemAtual = window.ordemAtual || { coluna: -1, ascendente: true };
            ordemAtual.ascendente = ordemAtual.coluna === coluna ? !ordemAtual.ascendente : true;
            ordemAtual.coluna = coluna;
            window.ordemAtual = ordemAtual;
            
            linhas.sort((a, b) => {
                const celA = a.children[coluna]?.innerText.trim() || '';
                const celB = b.children[coluna]?.innerText.trim() || '';
                
                let valA, valB;
                if (coluna === 0) {
                    const [dA, mA, anA] = celA.split('/').map(Number);
                    const [dB, mB, anB] = celB.split('/').map(Number);
                    valA = new Date(anA, mA - 1, dA);
                    valB = new Date(anB, mB - 1, dB);
                } else if (coluna === 1) {
                    valA = parseInt(celA.split(' - ')[0]) || 0;
                    valB = parseInt(celB.split(' - ')[0]) || 0;
                } else if (coluna === 5) {
                    valA = parseInt(celA) || 0;
                    valB = parseInt(celB) || 0;
                } else if ([6, 7, 8].includes(coluna)) {
                    valA = parseFloat(celA.replace('R$', '').replace(/\./g, '').replace(',', '.').replace('+', '').replace('-', '')) || 0;
                    valB = parseFloat(celB.replace('R$', '').replace(/\./g, '').replace(',', '.').replace('+', '').replace('-', '')) || 0;
                    if (celA.includes('-')) valA = -valA;
                    if (celB.includes('-')) valB = -valB;
                } else if (coluna === 9) {
                    valA = parseFloat(celA.replace('%', '').replace('+', '')) || 0;
                    valB = parseFloat(celB.replace('%', '').replace('+', '')) || 0;
                } else {
                    valA = celA;
                    valB = celB;
                }
                
                if (valA < valB) return ordemAtual.ascendente ? -1 : 1;
                if (valA > valB) return ordemAtual.ascendente ? 1 : -1;
                return 0;
            });
            
            tbody.innerHTML = '';
            linhas.forEach(l => tbody.appendChild(l));
        }

        // ========== FUNÇÃO CORRIGIDA DE EXPORTAÇÃO PDF ==========
        async function exportarPDF() {
            showLoading('Gerando PDF...');
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape');
                
                doc.setFillColor(46, 125, 96);
                doc.rect(0, 0, doc.internal.pageSize.width, 25, 'F');
                doc.setTextColor(255);
                doc.setFontSize(18);
                doc.text('REX - Setor Patty - Relatório Executivo', 14, 17);
                
                doc.setTextColor(0);
                doc.setFontSize(9);
                doc.text(`Período: ${dataInicio} a ${dataFim}`, 14, 35);
                doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 42);
                
                doc.setFontSize(10);
                doc.text('Indicadores Principais', 14, 55);
                doc.setFontSize(8);
                
                const kpis = [
                    ['Faturamento', document.getElementById('totalFaturamento')?.innerText || 'R$ 0,00'],
                    ['Meta', document.getElementById('totalMeta')?.innerText || 'R$ 0,00'],
                    ['Diferença', document.getElementById('totalDiferenca')?.innerText || 'R$ 0,00'],
                    ['Ticket Médio', document.getElementById('ticketMedio')?.innerText || 'R$ 0,00'],
                    ['Lojas', document.getElementById('totalLojas')?.innerText || '0'],
                    ['Metas OK', document.getElementById('metasAtingidas')?.innerText || '0/0']
                ];
                
                let yPos = 62;
                kpis.forEach((kpi, index) => {
                    const xPos = 14 + (index % 3) * 70;
                    if (index > 0 && index % 3 === 0) yPos += 10;
                    doc.text(`${kpi[0]}: ${kpi[1]}`, xPos, yPos);
                });
                
                const trendCanvas = document.getElementById('evolucaoProjecaoChart');
                if (trendCanvas && trendCanvas.querySelector) {
                    try {
                        const canvas = trendCanvas.querySelector('canvas');
                        if (canvas) {
                            const imgData = canvas.toDataURL('image/png');
                            doc.addImage(imgData, 'PNG', 14, 80, 260, 80);
                        }
                    } catch (e) {
                        console.warn('Erro ao capturar gráfico:', e);
                    }
                }
                
                const dadosTabela = [];
                document.querySelectorAll('#tableBody tr').forEach((tr, index) => {
                    if (index < 10) {
                        const cells = tr.querySelectorAll('td');
                        if (cells.length >= 7) {
                            dadosTabela.push([
                                cells[0]?.innerText || '',
                                cells[1]?.innerText || '',
                                cells[2]?.innerText || '',
                                cells[6]?.innerText || '',
                                cells[7]?.innerText || '',
                                cells[9]?.innerText || '',
                                cells[10]?.innerText || ''
                            ]);
                        }
                    }
                });
                
                if (dadosTabela.length > 0) {
                    doc.autoTable({
                        head: [['Data', 'Loja', 'ADM', 'Faturamento', 'Meta', '%', 'Status']],
                        body: dadosTabela,
                        startY: 170,
                        theme: 'grid',
                        styles: { fontSize: 6, cellPadding: 1.5 },
                        headStyles: { fillColor: [46, 125, 96], textColor: 255 },
                        margin: { left: 14, right: 14 }
                    });
                }
                
                doc.save(`REX_Relatorio_${new Date().toLocaleDateString().replace(/\//g, '-')}.pdf`);
                hideLoading();
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                hideLoading();
                alert('Erro ao gerar PDF. Tente novamente.');
            }
        }

        // ========== EXPORTAÇÃO EXCEL ==========
        function exportarExcel() {
            showLoading('Gerando Excel...');
            const wb = XLSX.utils.book_new();
            
            const resumoData = [
                ['REX - Setor Patty - Relatório Executivo'],
                [`Período: ${dataInicio} a ${dataFim}`],
                [`Gerado em: ${new Date().toLocaleString('pt-BR')}`],
                [],
                ['INDICADORES', 'Valor'],
                ['Faturamento Total', document.getElementById('totalFaturamento')?.innerText || 'R$ 0,00'],
                ['Meta Total', document.getElementById('totalMeta')?.innerText || 'R$ 0,00'],
                ['Diferença', document.getElementById('totalDiferenca')?.innerText || 'R$ 0,00'],
                ['Ticket Médio', document.getElementById('ticketMedio')?.innerText || 'R$ 0,00'],
                ['Lojas Ativas', document.getElementById('totalLojas')?.innerText || '0'],
                ['Metas OK', document.getElementById('metasAtingidas')?.innerText || '0']
            ];
            
            const wsResumo = XLSX.utils.aoa_to_sheet(resumoData);
            XLSX.utils.book_append_sheet(wb, wsResumo, 'Resumo');
            
            const detalhamentoData = [['Data', 'Loja', 'ADM', 'Início', 'Fim', 'Cupons', 'Faturamento', 'Meta', 'Diferença', '%', 'Status', 'Alerta']];
            document.querySelectorAll('#tableBody tr').forEach(tr => {
                const linha = [];
                tr.querySelectorAll('td').forEach(td => linha.push(td.innerText));
                detalhamentoData.push(linha);
            });
            const wsDetalhamento = XLSX.utils.aoa_to_sheet(detalhamentoData);
            XLSX.utils.book_append_sheet(wb, wsDetalhamento, 'Detalhamento');
            
            XLSX.writeFile(wb, `REX_Dados_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`);
            hideLoading();
        }

        function exportarHTML() {
            salvarDadosNoContainer();
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'REX_Dashboard_' + new Date().toLocaleDateString().replace(/\//g, '-') + '.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('✅ Dashboard HTML gerado com sucesso!');
        }

        // ========== CARREGAMENTO DE DADOS ==========
        function carregarDadosSalvos() {
            const dadosContainer = document.getElementById('dados-permanentes');
            if (dadosContainer && dadosContainer.textContent && dadosContainer.textContent.trim() !== '{}' && dadosContainer.textContent.trim() !== '{"dadosCompletos":[],"dataAtualizacao":"","notas":[]}') {
                try {
                    const parsed = JSON.parse(dadosContainer.textContent);
                    if (parsed?.dadosCompletos?.length) {
                        dadosCompletos = parsed.dadosCompletos;
                        if (parsed.notas) notas = parsed.notas;
                        const dataAtualizacao = document.getElementById('dataAtualizacao');
                        if (dataAtualizacao) dataAtualizacao.innerText = parsed.dataAtualizacao || new Date().toLocaleString('pt-BR');
                        return true;
                    }
                } catch (e) {
                    console.error('Erro ao carregar dados salvos:', e);
                }
            }
            return false;
        }

        function salvarDadosNoContainer() {
            const dadosContainer = document.getElementById('dados-permanentes');
            if (dadosContainer) {
                dadosContainer.textContent = JSON.stringify({
                    dadosCompletos: dadosCompletos,
                    dataAtualizacao: new Date().toLocaleString('pt-BR'),
                    notas: notas
                });
            }
        }

        function carregarDadosExemplo() {
            dadosCompletos = [];
            const lojas = Object.keys(lojaNomes).map(Number);
            const datas = [];
            
            for (let d = 1; d <= 21; d++) datas.push(`${d.toString().padStart(2, '0')}/02/2026`);
            
            lojas.forEach(loja => {
                datas.forEach((data, index) => {
                    const fatorTendencia = 1 + (index / 50);
                    const fat = (Math.random() * 3000 + 1000) * fatorTendencia;
                    const meta = Math.random() * 2500 + 1500;
                    const status = fat > 0 ? (fat >= meta ? 'SIM' : 'NÃO') : 'FECHADA';
                    
                    dadosCompletos.push({
                        loja: loja,
                        adm: admPorLoja[loja] || 'Não mapeado',
                        data: data,
                        inicio: Math.random() > 0.1 ? '09:' + Math.floor(Math.random() * 60).toString().padStart(2, '0') : '-',
                        fim: Math.random() > 0.1 ? '21:' + Math.floor(Math.random() * 60).toString().padStart(2, '0') : '-',
                        cupons: Math.floor(Math.random() * 200) + 20,
                        faturamento: fat,
                        meta: meta,
                        dif: fat - meta,
                        difPercentual: meta > 0 ? ((fat - meta) / meta * 100) : 0,
                        status: status,
                        canais: {
                            auto: fat * (Math.random() * 0.6),
                            delivery: fat * (Math.random() * 0.4),
                            viagem: fat * (Math.random() * 0.2),
                            balcao: fat * (Math.random() * 0.1)
                        }
                    });
                });
            });
            
            salvarDadosNoContainer();
            const dataAtualizacao = document.getElementById('dataAtualizacao');
            if (dataAtualizacao) dataAtualizacao.innerText = new Date().toLocaleString('pt-BR');
        }

        function processarDadosCarregados() {
            for (let key in dadosPorData) delete dadosPorData[key];
            
            dadosCompletos.forEach(reg => {
                if (reg && reg.data) {
                    if (!dadosPorData[reg.data]) dadosPorData[reg.data] = [];
                    dadosPorData[reg.data].push(reg);
                }
            });

            const totalLojasHeader = document.getElementById('totalLojasHeader');
            if (totalLojasHeader) totalLojasHeader.innerText = Object.keys(lojaNomes).length;
            
            const datas = Object.keys(dadosPorData).sort();
            if (datas.length) {
                dataInicio = dataFim = datas[0];
            }
            
            preencherADMFilter();
            carregarNotas();
            
            setPeriodo('hoje');
        }

        function limparDadosSalvos() {
            if (confirm('Limpar todos os dados salvos?')) {
                dadosCompletos = [];
                for (let key in dadosPorData) delete dadosPorData[key];
                notas = [];
                
                const dadosContainer = document.getElementById('dados-permanentes');
                if (dadosContainer) dadosContainer.textContent = '{"dadosCompletos":[],"dataAtualizacao":"","notas":[]}';
                
                carregarDadosExemplo();
                processarDadosCarregados();
            }
        }

        // ========== PROCESSAMENTO DE PLANILHA ==========
        function processarPlanilha(input) {
            if (!input || !input.files || !input.files[0]) {
                alert('Nenhum arquivo selecionado');
                return;
            }
            
            showLoading('Processando planilha...');
            const arquivo = input.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    if (!e || !e.target || !e.target.result) {
                        throw new Error('Erro ao ler o arquivo');
                    }
                    
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    if (!workbook || !workbook.SheetNames || workbook.SheetNames.length === 0) {
                        throw new Error('Planilha sem abas');
                    }
                    
                    const primeiraAba = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[primeiraAba];
                    
                    if (!worksheet) {
                        throw new Error('Não foi possível ler a primeira aba da planilha');
                    }
                    
                    const dadosBrutos = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                    
                    if (!dadosBrutos || dadosBrutos.length < 2) {
                        hideLoading();
                        return alert('Planilha vazia ou sem dados');
                    }

                    dadosCompletos = [];
                    
                    for (let i = 1; i < dadosBrutos.length; i++) {
                        const linha = dadosBrutos[i];
                        if (!linha || linha.length < 8) continue;
                        
                        let codigoLoja = linha[0];
                        if (!codigoLoja && codigoLoja !== 0) continue;
                        
                        if (typeof codigoLoja === 'string') {
                            codigoLoja = parseInt(codigoLoja.replace(/\D/g, ''));
                        }
                        codigoLoja = Number(codigoLoja);
                        
                        if (isNaN(codigoLoja) || !lojaNomes[codigoLoja]) continue;
                        
                        let dataStr = linha[2];
                        if (!dataStr) continue;
                        
                        if (typeof dataStr === 'number') {
                            try {
                                const dataObj = XLSX.SSF.parse_date_code(dataStr);
                                if (dataObj) {
                                    dataStr = `${dataObj.d.toString().padStart(2, '0')}/${dataObj.m.toString().padStart(2, '0')}/${dataObj.y}`;
                                }
                            } catch (e) {
                                continue;
                            }
                        } else if (typeof dataStr === 'string') {
                            dataStr = dataStr.split(' ')[0];
                            if (dataStr.includes('-')) {
                                const partes = dataStr.split('-');
                                if (partes.length === 3) {
                                    dataStr = `${partes[2]}/${partes[1]}/${partes[0]}`;
                                }
                            }
                        }
                        
                        if (!dataStr || !dataStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) continue;
                        
                        const inicio = extrairHora(linha[3]);
                        const fim = extrairHora(linha[4]);
                        
                        const cupons = parseInt(linha[5]) || 0;
                        const fat = parseFloat(linha[6]) || 0;
                        const meta = parseFloat(linha[7]) || 0;
                        
                        const auto = parseFloat(linha[9]) || 0;
                        const delivery = parseFloat(linha[10]) || 0;
                        const viagem = parseFloat(linha[11]) || 0;
                        const balcao = parseFloat(linha[14]) || 0;
                        
                        let status = 'FECHADA';
                        if (fat > 0) {
                            status = fat >= meta ? 'SIM' : 'NÃO';
                        }
                        
                        const difPercentual = meta > 0 ? ((fat - meta) / meta * 100) : 0;
                        
                        dadosCompletos.push({
                            loja: codigoLoja,
                            adm: admPorLoja[codigoLoja] || 'Não mapeado',
                            data: dataStr,
                            inicio: inicio,
                            fim: fim,
                            cupons: cupons,
                            faturamento: fat,
                            meta: meta,
                            dif: fat - meta,
                            difPercentual: difPercentual,
                            status: status,
                            canais: {
                                auto: auto,
                                delivery: delivery,
                                viagem: viagem,
                                balcao: balcao
                            }
                        });
                    }

                    if (dadosCompletos.length === 0) {
                        hideLoading();
                        return alert('Nenhum dado válido encontrado na planilha');
                    }

                    salvarDadosNoContainer();
                    processarDadosCarregados();
                    
                    const dataAtualizacao = document.getElementById('dataAtualizacao');
                    if (dataAtualizacao) dataAtualizacao.innerText = new Date().toLocaleString('pt-BR');
                    
                    setTimeout(() => {
                        aplicarFiltros();
                        initTooltips();
                        hideLoading();
                        alert(`✅ ${dadosCompletos.length} registros importados com sucesso!`);
                    }, 500);
                    
                } catch (error) {
                    console.error('Erro detalhado:', error);
                    hideLoading();
                    alert('Erro ao processar planilha: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                hideLoading();
                alert('Erro ao ler o arquivo');
            };
            
            reader.readAsArrayBuffer(arquivo);
        }

        // ========== INICIALIZAÇÃO ==========
        (function() {
            if (!carregarDadosSalvos()) {
                carregarDadosExemplo();
            }
            
            setTimeout(() => {
                processarDadosCarregados();
                
                // Renderizar gráficos imediatamente
                const dados = getDadosPeriodo();
                if (dados.length > 0) {
                    // Visão Geral (ativa por padrão)
                    setTimeout(() => {
                        renderizarGraficosApex('canalPie', dados, 'doughnut');
                        renderizarGraficosApex('top10', dados, 'bar');
                    }, 100);
                    
                    // Pré-carregar gráficos de canais para quando a view for aberta
                    setTimeout(() => {
                        // Salvar os gráficos em cache para renderização rápida
                        const canvasDist = document.querySelector("#canaisDetalhadoChart");
                        const canvasEvo = document.querySelector("#canaisEvolucaoChart");
                        
                        // Se os canvas existirem e a view não estiver visível, não faz nada
                        // Quando a view for aberta, renderizará normalmente
                    }, 200);
                }
                
                setTimeout(() => {
                    initTooltips();
                }, 500);
            }, 100);
            
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            });
            
            window.addEventListener('resize', function() {
                if (window.innerWidth > 992) {
                    document.getElementById('sidebar').classList.remove('mobile-open');
                }
            });
        })();

        // Expor funções globalmente
        window.mudarView = mudarView;
        window.toggleTheme = toggleTheme;
        window.toggleSidebar = toggleSidebar;
        window.filtrarPorStatus = filtrarPorStatus;
        window.filtrarPorLoja = filtrarPorLoja;
        window.setPeriodo = setPeriodo;
        window.atualizarPorData = atualizarPorData;
        window.buscarGlobal = buscarGlobal;
        window.aplicarFiltros = aplicarFiltros;
        window.abrirModalLoja = abrirModalLoja;
        window.ordenarTabela = ordenarTabela;
        window.exportarGrafico = exportarGrafico;
        window.mostrarDetalheMetrica = mostrarDetalheMetrica;
        window.mudarTipoCanal = mudarTipoCanal;
        window.mudarTipoTop10 = mudarTipoTop10;
        window.mudarTipoAdmFaturamento = mudarTipoAdmFaturamento;
        window.mudarTipoAdmMeta = mudarTipoAdmMeta;
        window.mudarTipoCanalDetalhado = mudarTipoCanalDetalhado;
        window.mudarTipoEvolucao = mudarTipoEvolucao;
        window.mudarTipoProjecao = mudarTipoProjecao;
        window.mudarTipoSazonalidade = mudarTipoSazonalidade;
        window.mudarTipoCorrelacao = mudarTipoCorrelacao;
        window.mudarTipoHorario = mudarTipoHorario;
        window.filtrarPorAlerta = filtrarPorAlerta;
        window.adicionarNota = adicionarNota;
        window.limparDadosSalvos = limparDadosSalvos;
        window.exportarPDF = exportarPDF;
        window.exportarExcel = exportarExcel;
        window.exportarHTML = exportarHTML;
        window.processarPlanilha = processarPlanilha;
    </script>
</body>
</html>
