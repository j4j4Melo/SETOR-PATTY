<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setor Patty - Relatório de Metas | Fevereiro 2026</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #f72585;
            --success: #06d6a0;
            --danger: #ef476f;
            --warning: #ffd166;
            --info: #4cc9f0;
            --light: #f8f9fa;
            --dark: #2b2d42;
            --gray: #8d99ae;
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(0,0,0,0.15);
            --shadow-sm: 0 5px 15px rgba(0,0,0,0.08);
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        body {
            font-family: 'Inter', 'Segoe UI', Roboto, system-ui, -apple-system, sans-serif;
            background: #f1f5f9;
            min-height: 100vh;
            padding: 30px 20px;
        }

        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: var(--gradient-1);
            padding: 30px;
            border-radius: 24px;
            margin-bottom: 30px;
            color: white;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            animation: rotate 30s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .header-content {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-title h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .header-title p {
            font-size: 16px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-title p i {
            font-size: 18px;
        }

        .header-date {
            background: rgba(255,255,255,0.2);
            padding: 15px 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            text-align: center;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .header-date .day {
            font-size: 36px;
            font-weight: 700;
            line-height: 1;
        }

        .header-date .month {
            font-size: 16px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .date-selector {
            background: rgba(255,255,255,0.15);
            padding: 8px 15px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: 20px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .date-selector button {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .date-selector button:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        .date-selector span {
            font-weight: 600;
            min-width: 140px;
            text-align: center;
        }

        .filters {
            background: white;
            padding: 20px 25px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 250px;
        }

        .filter-group label {
            color: var(--dark);
            font-weight: 600;
            font-size: 14px;
            min-width: 70px;
        }

        .multi-select {
            position: relative;
            flex: 1;
        }

        .multi-select .select-btn {
            width: 100%;
            padding: 12px 18px;
            border: 2px solid #e9ecef;
            border-radius: 14px;
            background: white;
            text-align: left;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .multi-select .select-btn:hover {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .multi-select .select-btn .selected-count {
            background: var(--primary);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .multi-select .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 16px;
            margin-top: 8px;
            max-height: 350px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: var(--shadow);
            display: none;
        }

        .multi-select .dropdown-menu.show {
            display: block;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .multi-select .search-box {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .multi-select .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 13px;
            transition: all 0.3s;
        }

        .multi-select .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .multi-select .select-all {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
            transition: background 0.2s;
        }

        .multi-select .select-all:hover {
            background: #f8f9fa;
        }

        .multi-select .select-all i {
            font-size: 16px;
        }

        .multi-select .options-list {
            padding: 8px 0;
        }

        .multi-select .option-item {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .multi-select .option-item:hover {
            background: #f8f9fa;
            border-left-color: var(--primary);
        }

        .multi-select .option-item.selected {
            background: rgba(67, 97, 238, 0.05);
            border-left-color: var(--primary);
        }

        .multi-select .option-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        select {
            padding: 12px 18px;
            border: 2px solid #e9ecef;
            border-radius: 14px;
            font-size: 14px;
            font-weight: 500;
            color: var(--dark);
            background: white;
            cursor: pointer;
            min-width: 200px;
        }

        .btn {
            padding: 12px 28px;
            border: none;
            border-radius: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            letter-spacing: 0.3px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(67, 97, 238, 0.4);
        }

        .btn-success {
            background: var(--success);
            color: white;
            box-shadow: 0 4px 10px rgba(6, 214, 160, 0.3);
        }

        .btn-success:hover {
            background: #05b586;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(6, 214, 160, 0.4);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            border-radius: 24px;
            padding: 25px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.03);
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }

        .kpi-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, transparent 50%, rgba(67, 97, 238, 0.03) 100%);
            border-radius: 50%;
        }

        .kpi-icon {
            width: 55px;
            height: 55px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            margin-bottom: 18px;
            position: relative;
            z-index: 1;
        }

        .kpi-icon.blue { background: linear-gradient(135deg, #4361ee20, #4361ee40); color: var(--primary); }
        .kpi-icon.green { background: linear-gradient(135deg, #06d6a020, #06d6a040); color: var(--success); }
        .kpi-icon.orange { background: linear-gradient(135deg, #f7258520, #f7258540); color: var(--secondary); }
        .kpi-icon.red { background: linear-gradient(135deg, #ef476f20, #ef476f40); color: var(--danger); }
        .kpi-icon.purple { background: linear-gradient(135deg, #9b5de520, #9b5de540); color: #9b5de5; }

        .kpi-label {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .kpi-trend {
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
            padding-top: 8px;
            border-top: 1px solid #e9ecef;
        }

        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 24px;
            padding: 25px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s;
            border: 1px solid rgba(0,0,0,0.03);
        }

        .chart-card:hover {
            box-shadow: var(--shadow);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }

        .chart-header h3 {
            color: var(--dark);
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-header h3 i {
            color: var(--primary);
            font-size: 20px;
        }

        .chart-header .badge {
            background: var(--light);
            padding: 6px 12px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
            color: var(--gray);
        }

        .chart-wrapper {
            position: relative;
            height: 320px;
            margin-top: 10px;
        }

        .tables-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .table-card {
            background: white;
            border-radius: 24px;
            padding: 25px;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(0,0,0,0.03);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }

        .table-header h2 {
            color: var(--dark);
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-header h2 i {
            color: var(--primary);
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 16px;
            border: 1px solid #f1f5f9;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            background: #f8fafc;
            color: var(--dark);
            padding: 16px 12px;
            font-weight: 700;
            text-align: center;
            white-space: nowrap;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-bottom: 2px solid #e9ecef;
        }

        th:hover {
            background: #f1f5f9;
        }

        th i {
            margin-left: 5px;
            font-size: 12px;
            color: var(--gray);
        }

        td {
            padding: 14px 12px;
            border-bottom: 1px solid #f1f5f9;
            text-align: center;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: #f8fafc;
        }

        .meta-sim {
            background: linear-gradient(135deg, #06d6a020, #06d6a040);
            color: var(--success);
            font-weight: 700;
            border-radius: 30px;
            padding: 6px 16px;
            display: inline-block;
            font-size: 12px;
        }

        .meta-nao {
            background: linear-gradient(135deg, #ef476f20, #ef476f40);
            color: var(--danger);
            font-weight: 700;
            border-radius: 30px;
            padding: 6px 16px;
            display: inline-block;
            font-size: 12px;
        }

        .valor-positivo {
            color: var(--success);
            font-weight: 700;
        }

        .valor-negativo {
            color: var(--danger);
            font-weight: 700;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f1f5f9;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-1);
            border-radius: 10px;
            transition: width 0.3s;
        }

        .info-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 25px;
        }

        .info-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid #f1f5f9;
            transition: all 0.3s;
        }

        .info-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-sm);
        }

        .info-icon {
            width: 60px;
            height: 60px;
            border-radius: 18px;
            background: var(--gradient-1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
        }

        .info-content h4 {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .info-content p {
            color: var(--dark);
            font-size: 20px;
            font-weight: 700;
        }

        .footer {
            margin-top: 50px;
            text-align: center;
            color: var(--gray);
            font-size: 13px;
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .tables-section {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body { padding: 15px; }
            .header-content { flex-direction: column; text-align: center; }
            .kpi-grid { grid-template-columns: 1fr; }
            .info-cards { grid-template-columns: 1fr; }
            .filters { flex-direction: column; }
            .filter-group { width: 100%; }
            .multi-select { width: 100%; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .kpi-card, .chart-card, .table-card {
            animation: slideIn 0.5s ease-out;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--dark);
        }

        .dropdown-close {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border-top: 1px solid #e9ecef;
            cursor: pointer;
            color: var(--gray);
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .dropdown-close:hover {
            background: #f8f9fa;
            color: var(--danger);
        }

        .dropdown-close i {
            font-size: 14px;
        }

        .date-navigation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            background: white;
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: var(--shadow-sm);
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .date-navigation button {
            background: var(--primary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .date-navigation button:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        .date-navigation button:disabled {
            background: var(--gray);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .date-navigation span {
            font-weight: 600;
            font-size: 18px;
            color: var(--dark);
            min-width: 200px;
            text-align: center;
        }

        .store-name {
            font-weight: 600;
            color: var(--primary);
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <div class="header-content">
                <div class="header-title">
                    <h1><i class="fas fa-store-alt" style="margin-right: 12px;"></i>Setor Patty</h1>
                    <p>
                        <i class="fas fa-store"></i> 31 Lojas em operação 
                        <i class="fas fa-circle" style="font-size: 6px; margin: 0 8px;"></i>
                        <i class="fas fa-chart-line"></i> Atualizado em tempo real
                    </p>
                </div>
                <div style="display: flex; align-items: center;">
                    <div class="date-selector">
                        <button onclick="mudarDia(-1)" id="btnHeaderAnterior" title="Dia anterior"><i class="fas fa-chevron-left"></i></button>
                        <span id="dataAtualDisplay">14/02/2026</span>
                        <button onclick="mudarDia(1)" id="btnHeaderProximo" title="Próximo dia"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="header-date" style="margin-left: 15px;">
                        <div class="day" id="headerDay">14</div>
                        <div class="month" id="headerMonth">FEVEREIRO 2026</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="date-navigation">
            <button onclick="mudarDia(-1)" id="btnDiaAnterior"><i class="fas fa-chevron-left"></i></button>
            <span id="dataSelecionada">Sexta-feira, 14 de Fevereiro de 2026</span>
            <button onclick="mudarDia(1)" id="btnProximoDia"><i class="fas fa-chevron-right"></i></button>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label><i class="fas fa-store"></i> Lojas:</label>
                <div class="multi-select" id="lojaMultiSelect">
                    <div class="select-btn" onclick="toggleLojaDropdown()">
                        <span id="selectedLojasText">Todas as Lojas</span>
                        <span class="selected-count" id="selectedCount">31</span>
                    </div>
                    <div class="dropdown-menu" id="lojaDropdown">
                        <div class="search-box">
                            <input type="text" id="lojaSearch" placeholder="Buscar loja..." onkeyup="filtrarLojas()">
                        </div>
                        <div class="select-all" onclick="toggleAllLojas()">
                            <i class="fas fa-check-square"></i> Selecionar Todas
                        </div>
                        <div class="options-list" id="lojaOptions"></div>
                        <div class="dropdown-close" onclick="fecharDropdownLojas()">
                            <i class="fas fa-times"></i> Fechar
                        </div>
                    </div>
                </div>
            </div>
            <div class="filter-group">
                <label><i class="fas fa-chart-bar"></i> Status:</label>
                <select id="statusFilter" onchange="aplicarFiltros()">
                    <option value="">Todos os Status</option>
                    <option value="SIM">Meta Atingida</option>
                    <option value="NÃO">Meta Não Atingida</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="aplicarFiltros()">
                <i class="fas fa-sync-alt"></i> Atualizar Dados
            </button>
            <button class="btn btn-success" onclick="exportarExcel()">
                <i class="fas fa-file-excel"></i> Exportar Excel
            </button>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-icon blue"><i class="fas fa-store"></i></div>
                <div class="kpi-label">Total de Lojas</div>
                <div class="kpi-value" id="totalLojas">31</div>
                <div class="kpi-trend"><i class="fas fa-check-circle trend-up"></i> 100% operantes</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon green"><i class="fas fa-dollar-sign"></i></div>
                <div class="kpi-label">Faturamento Total</div>
                <div class="kpi-value" id="totalFaturamento">R$ 0,00</div>
                <div class="kpi-trend"><i class="fas fa-chart-line"></i> <span id="percentualMeta">0,00%</span> vs meta</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon purple"><i class="fas fa-bullseye"></i></div>
                <div class="kpi-label">Meta Total</div>
                <div class="kpi-value" id="totalMeta">R$ 0,00</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressoMeta" style="width: 0%"></div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon red"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="kpi-label">Diferença</div>
                <div class="kpi-value" id="totalDiferenca">R$ 0,00</div>
                <div class="kpi-trend"><i class="fas fa-arrow-down trend-down"></i> <span id="percentualDiferenca">0,00%</span> abaixo</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon blue"><i class="fas fa-ticket-alt"></i></div>
                <div class="kpi-label">Ticket Médio</div>
                <div class="kpi-value" id="ticketMedio">R$ 0,00</div>
                <div class="kpi-trend"><i class="fas fa-chart-line trend-up"></i> vs ontem</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon orange"><i class="fas fa-trophy"></i></div>
                <div class="kpi-label">Metas Atingidas</div>
                <div class="kpi-value" id="metasAtingidas">0/31</div>
                <div class="kpi-trend"><i class="fas fa-percent"></i> <span id="percentualLojas">0,0%</span> das lojas</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-pie" style="color: var(--primary);"></i>Distribuição por Canal</h3>
                    <span class="badge"><i class="fas fa-store-alt"></i> Vendas</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="canalPieChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-bullseye" style="color: var(--secondary);"></i>Atingimento de Metas</h3>
                    <span class="badge"><i class="fas fa-check-circle"></i> Performance</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="metasPieChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-bar" style="color: var(--success);"></i>Top 10 Lojas - Faturamento vs Meta</h3>
                    <span class="badge"><i class="fas fa-crown"></i> Ranking</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="top10BarChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-line" style="color: var(--warning);"></i>Desempenho por Loja</h3>
                    <span class="badge"><i class="fas fa-percent"></i> Atingimento</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="desempenhoBarChart"></canvas>
                </div>
            </div>
        </div>

        <div class="tables-section">
            <div class="table-card">
                <div class="table-header">
                    <h2><i class="fas fa-list"></i> Detalhamento por Loja</h2>
                    <span class="badge"><i class="fas fa-table"></i> Dados detalhados</span>
                </div>
                <div class="table-wrapper">
                    <table id="mainTable">
                        <thead>
                            <tr>
                                <th onclick="ordenarTabela(0)">Data <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(1)">Loja <i class="fas fa-sort"></i></th>
                                <th>Início</th>
                                <th>Fim</th>
                                <th onclick="ordenarTabela(4)">Cupons <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(5)">Faturamento <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(6)">Meta <i class="fas fa-sort"></i></th>
                                <th>Diferença</th>
                                <th onclick="ordenarTabela(8)">Dif % <i class="fas fa-sort"></i></th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="table-card">
                <div class="table-header">
                    <h2><i class="fas fa-chart-pie"></i> Resumo por Canal</h2>
                    <span class="badge"><i class="fas fa-chart-simple"></i> Análise</span>
                </div>
                <div class="table-wrapper">
                    <table id="canaisTable">
                        <thead>
                            <tr>
                                <th>Canal</th>
                                <th>Valor (R$)</th>
                                <th>Participação</th>
                                <th>Performance</th>
                            </tr>
                        </thead>
                        <tbody id="canaisTableBody"></tbody>
                    </table>
                </div>

                <div style="margin-top: 25px;">
                    <h3 style="margin-bottom: 15px; color: var(--dark); font-size: 16px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-chart-simple" style="color: var(--primary);"></i> Indicadores Gerais
                    </h3>
                    <div class="info-cards">
                        <div class="info-card">
                            <div class="info-icon"><i class="fas fa-check-circle"></i></div>
                            <div class="info-content">
                                <h4>Lojas que Atingiram Meta</h4>
                                <p id="lojasMetaSim">0 lojas (0.0%)</p>
                            </div>
                        </div>
                        <div class="info-card">
                            <div class="info-icon"><i class="fas fa-times-circle"></i></div>
                            <div class="info-content">
                                <h4>Lojas Abaixo da Meta</h4>
                                <p id="lojasMetaNao">0 lojas (0.0%)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p><i class="far fa-clock"></i> Relatório gerado em <span id="dataGeracao">14/02/2026</span> às 10:30:00</p>
            <p style="margin-top: 5px;">© 2026 Setor Patty - Todos os direitos reservados</p>
        </div>
    </div>

    <script>
        // MAPEAMENTO COMPLETO DOS NOMES DAS LOJAS (extraído da planilha)
        const lojaNomes = {
            5: "ANTONIO AGU",
            10: "OSASCO PLAZA",
            28: "SHOPPING TAMBORÉ",
            31: "AUGUSTA",
            63: "SHOPPING ITAPECERICA",
            69: "PERUS",
            73: "BRIGADEIRO JARDINS",
            82: "TEODORO SAMPAIO",
            86: "REX RAFAEL DE BARROS",
            90: "SHOPPING PARQUE BARUERI",
            97: "ASSAÍ JOÃO DIAS",
            98: "FRANCO DA ROCHA",
            101: "CARREFOUR RAPOSO TAVARES",
            118: "SHOPPING ITAPECERICA II",
            126: "OSASCO JOÃO DE ANDRADE",
            133: "PARQUE TIETÊ",
            145: "ITASHOPPING",
            157: "JARDIM SÃO LUIZ",
            158: "ASSAÍ CARAPICUÍBA",
            162: "MARQUESA TAIPAS",
            178: "EXTRA CARAPICUÍBA",
            183: "FRANCO DA ROCHA 2",
            189: "SHOPPING PATIO CIANÊ",
            195: "EXTRA JARAGUÁ",
            210: "ASSAÍ ABOLIÇÃO CAMPINAS",
            247: "METRÔ CCR VILA DAS BELEZAS",
            248: "METRÔ CCR CAPÃO REDONDO",
            251: "SOROCABA CENTRO",
            262: "ASSAÍ INDAIATUBA",
            285: "EXTRA JARDIM ÂNGELA",
            294: "SHOPPING RAPOSO"
        };

        // DADOS COMPLETOS POR DATA (extraídos da planilha)
        const dadosPorData = {
            "13/02/2026": [
                {loja: 5, inicio: '09:10', fim: '20:41', cupons: 117, faturamento: 3468.01, meta: 4005.0, canais: {auto: 916.93, delivery: 2263.16, viagem: 287.92}},
                {loja: 10, inicio: '13:52', fim: '21:32', cupons: 440, faturamento: 11244.67, meta: 10605.0, canais: {auto: 2670.74, delivery: 3526.33, viagem: 1762.66}},
                {loja: 28, inicio: '10:16', fim: '21:54', cupons: 186, faturamento: 4553.9, meta: 5215.0, canais: {auto: 1483.52, delivery: 2696.43, viagem: 373.95}},
                {loja: 31, inicio: '09:33', fim: '21:17', cupons: 173, faturamento: 3256.98, meta: 4280.0, canais: {auto: 0, delivery: 1171.54, viagem: 0}},
                {loja: 63, inicio: '10:34', fim: '21:34', cupons: 76, faturamento: 1111.57, meta: 2055.0, canais: {auto: 237.48, delivery: 0, viagem: 1111.57}},
                {loja: 69, inicio: '09:02', fim: '21:42', cupons: 211, faturamento: 5193.42, meta: 4570.0, canais: {auto: 0, delivery: 3876.7, viagem: 1394.96}},
                {loja: 73, inicio: '10:38', fim: '18:28', cupons: 86, faturamento: 2147.35, meta: 2815.0, canais: {auto: 795.02, delivery: 1097.72, viagem: 254.61}},
                {loja: 82, inicio: '09:03', fim: '19:52', cupons: 177, faturamento: 3106.1, meta: 2995.0, canais: {auto: 421.82, delivery: 2029.92, viagem: 0}},
                {loja: 86, inicio: '10:06', fim: '21:30', cupons: 108, faturamento: 3642.71, meta: 6405.0, canais: {auto: 1485.02, delivery: 641.94, viagem: 152.48}},
                {loja: 90, inicio: '10:25', fim: '22:02', cupons: 198, faturamento: 4673.55, meta: 4345.0, canais: {auto: 1752.34, delivery: 217.27, viagem: 746.4}},
                {loja: 97, inicio: '10:24', fim: '04:19', cupons: 155, faturamento: 4223.68, meta: 4100.0, canais: {auto: 2306.69, delivery: 133.1, viagem: 542.1}},
                {loja: 98, inicio: '08:41', fim: '19:26', cupons: 258, faturamento: 3493.53, meta: 4245.0, canais: {auto: 532.17, delivery: 586.56, viagem: 2374.8}},
                {loja: 101, inicio: '10:39', fim: '20:53', cupons: 116, faturamento: 2575.19, meta: 2450.0, canais: {auto: 0, delivery: 1489.73, viagem: 1085.46}},
                {loja: 118, inicio: '10:21', fim: '21:58', cupons: 103, faturamento: 2239.19, meta: 2920.0, canais: {auto: 932.34, delivery: 540.76, viagem: 766.09}},
                {loja: 126, inicio: '10:15', fim: '21:30', cupons: 396, faturamento: 10997.7, meta: 11555.0, canais: {auto: 643.84, delivery: 6195.35, viagem: 31.07}},
                {loja: 133, inicio: '10:08', fim: '21:47', cupons: 164, faturamento: 5198.91, meta: 5875.0, canais: {auto: 278.37, delivery: 4016.21, viagem: 904.33}},
                {loja: 145, inicio: '09:05', fim: '09:19', cupons: 142, faturamento: 2451.98, meta: 4270.0, canais: {auto: 732, delivery: 736.95, viagem: 979.54}},
                {loja: 157, inicio: '10:22', fim: '21:20', cupons: 107, faturamento: 2516.24, meta: 3405.0, canais: {auto: 0, delivery: 1644.09, viagem: 872.15}},
                {loja: 158, inicio: '09:50', fim: '21:40', cupons: 168, faturamento: 4512.33, meta: 4425.0, canais: {auto: 2490.5, delivery: 1741.45, viagem: 280.38}},
                {loja: 162, inicio: '09:23', fim: '20:42', cupons: 91, faturamento: 2951.27, meta: 3090.0, canais: {auto: 0, delivery: 0, viagem: 0}},
                {loja: 178, inicio: '09:28', fim: '22:11', cupons: 124, faturamento: 3964.04, meta: 2270.0, canais: {auto: 0, delivery: 2933.02, viagem: 0}},
                {loja: 183, inicio: '09:36', fim: '19:26', cupons: 126, faturamento: 2092.38, meta: 3020.0, canais: {auto: 912.16, delivery: 542.95, viagem: 629.27}},
                {loja: 189, inicio: '09:53', fim: '21:54', cupons: 203, faturamento: 2519.29, meta: 2830.0, canais: {auto: 737.6, delivery: 379.76, viagem: 1401.93}},
                {loja: 195, inicio: '10:16', fim: '21:25', cupons: 256, faturamento: 6232.95, meta: 6590.0, canais: {auto: 0, delivery: 4180.13, viagem: 2052.82}},
                {loja: 210, inicio: '08:45', fim: '20:49', cupons: 128, faturamento: 2899.39, meta: 3815.0, canais: {auto: 0, delivery: 1176.61, viagem: 0}},
                {loja: 247, inicio: '08:46', fim: '20:31', cupons: 112, faturamento: 1768.7, meta: 2050.0, canais: {auto: 0, delivery: 632.17, viagem: 1136.53}},
                {loja: 248, inicio: '07:34', fim: '23:51', cupons: 277, faturamento: 6052.05, meta: 5735.0, canais: {auto: 387.87, delivery: 3040.98, viagem: 1978.3}},
                {loja: 251, inicio: '08:37', fim: '15:58', cupons: 88, faturamento: 1072.78, meta: 1935.0, canais: {auto: 0, delivery: 59.8, viagem: 1012.98}},
                {loja: 262, inicio: '08:31', fim: '21:17', cupons: 96, faturamento: 2489.25, meta: 2355.0, canais: {auto: 0, delivery: 1262.64, viagem: 1099.12}},
                {loja: 285, inicio: '10:46', fim: '21:44', cupons: 91, faturamento: 1741.23, meta: 3375.0, canais: {auto: 0, delivery: 546.45, viagem: 1194.78}},
                {loja: 294, inicio: '10:34', fim: '21:31', cupons: 120, faturamento: 2254.62, meta: 1990.0, canais: {auto: 360.98, delivery: 792.59, viagem: 1101.05}}
            ],
            "14/02/2026": [
                {loja: 5, inicio: '09:24', fim: '12:34', cupons: 29, faturamento: 886.93, meta: 4015.0, canais: {auto: 204.58, delivery: 565.12, viagem: 117.23}},
                {loja: 10, inicio: '12:06', fim: '12:15', cupons: 15, faturamento: 367.1, meta: 12645.0, canais: {auto: 0, delivery: 0, viagem: 112.93}},
                {loja: 28, inicio: '10:27', fim: '12:32', cupons: 18, faturamento: 396.84, meta: 5390.0, canais: {auto: 218.81, delivery: 172.54, viagem: 5.49}},
                {loja: 31, inicio: '09:38', fim: '12:36', cupons: 23, faturamento: 419.6, meta: 3335.0, canais: {auto: 0, delivery: 198.43, viagem: 0}},
                {loja: 63, inicio: '10:36', fim: '12:35', cupons: 13, faturamento: 243.17, meta: 1650.0, canais: {auto: 19.9, delivery: 0, viagem: 243.17}},
                {loja: 69, inicio: '09:49', fim: '12:32', cupons: 19, faturamento: 460.12, meta: 5095.0, canais: {auto: 0, delivery: 300.25, viagem: 189.63}},
                {loja: 73, inicio: '10:37', fim: '12:32', cupons: 13, faturamento: 226.44, meta: 2285.0, canais: {auto: 180.75, delivery: 0, viagem: 45.69}},
                {loja: 82, inicio: '09:03', fim: '12:32', cupons: 32, faturamento: 590.89, meta: 2100.0, canais: {auto: 0, delivery: 409.8, viagem: 0}},
                {loja: 86, inicio: '10:08', fim: '12:09', cupons: 14, faturamento: 331.55, meta: 5635.0, canais: {auto: 113.49, delivery: 29.9, viagem: 28.8}},
                {loja: 90, inicio: '10:47', fim: '12:21', cupons: 7, faturamento: 237.3, meta: 4955.0, canais: {auto: 129.04, delivery: 0, viagem: 0}},
                {loja: 97, inicio: '19:36', fim: '12:09', cupons: 28, faturamento: 631.59, meta: 6315.0, canais: {auto: 346.75, delivery: 259.16, viagem: 37.84}},
                {loja: 98, inicio: '09:55', fim: '12:34', cupons: 33, faturamento: 606.66, meta: 3780.0, canais: {auto: 0, delivery: 154.54, viagem: 452.12}},
                {loja: 101, inicio: '10:05', fim: '12:34', cupons: 11, faturamento: 262.79, meta: 2980.0, canais: {auto: 0, delivery: 130.57, viagem: 132.22}},
                {loja: 118, inicio: '10:34', fim: '12:22', cupons: 10, faturamento: 295.4, meta: 3870.0, canais: {auto: 205.63, delivery: 82.8, viagem: 6.97}},
                {loja: 126, inicio: null, fim: null, cupons: 10, faturamento: 406.17, meta: 13025.0, canais: {auto: 0, delivery: 0, viagem: 0}},
                {loja: 133, inicio: '10:09', fim: '12:25', cupons: 21, faturamento: 534.99, meta: 6680.0, canais: {auto: 0, delivery: 409.63, viagem: 125.36}},
                {loja: 145, inicio: '09:28', fim: '12:25', cupons: 14, faturamento: 232.3, meta: 4375.0, canais: {auto: 74.3, delivery: 119.44, viagem: 112.86}},
                {loja: 157, inicio: '10:28', fim: '12:29', cupons: 13, faturamento: 440.71, meta: 3365.0, canais: {auto: 0, delivery: 311.77, viagem: 128.94}},
                {loja: 158, inicio: '09:23', fim: '12:37', cupons: 21, faturamento: 580.7, meta: 4655.0, canais: {auto: 322.01, delivery: 258.69, viagem: 0}},
                {loja: 162, inicio: '09:42', fim: '12:23', cupons: 26, faturamento: 381.51, meta: 2985.0, canais: {auto: 0, delivery: 0, viagem: 0}},
                {loja: 178, inicio: '09:26', fim: '12:24', cupons: 13, faturamento: 361.86, meta: 2165.0, canais: {auto: 0, delivery: 289.9, viagem: 0}},
                {loja: 183, inicio: '10:54', fim: '12:35', cupons: 14, faturamento: 219.33, meta: 2540.0, canais: {auto: 0, delivery: 0, viagem: 219.33}},
                {loja: 189, inicio: '10:06', fim: '12:32', cupons: 29, faturamento: 327.98, meta: 2665.0, canais: {auto: 10.88, delivery: 75.88, viagem: 241.22}},
                {loja: 195, inicio: '09:51', fim: '12:30', cupons: 32, faturamento: 604.97, meta: 5780.0, canais: {auto: 0, delivery: 267.55, viagem: 337.42}},
                {loja: 210, inicio: '08:31', fim: '12:33', cupons: 57, faturamento: 1032.05, meta: 4025.0, canais: {auto: 0, delivery: 344.01, viagem: 0}},
                {loja: 247, inicio: '08:26', fim: '12:23', cupons: 27, faturamento: 338.39, meta: 1700.0, canais: {auto: 0, delivery: 55.17, viagem: 283.22}},
                {loja: 248, inicio: '07:13', fim: '12:35', cupons: 59, faturamento: 1009.95, meta: 5725.0, canais: {auto: 0, delivery: 357.27, viagem: 403.2}},
                {loja: 251, inicio: '08:31', fim: '12:36', cupons: 33, faturamento: 405.0, meta: 1705.0, canais: {auto: 0, delivery: 0, viagem: 405.0}},
                {loja: 262, inicio: '08:28', fim: '12:34', cupons: 31, faturamento: 505.79, meta: 2615.0, canais: {auto: 0, delivery: 168.13, viagem: 337.66}},
                {loja: 285, inicio: '08:38', fim: '12:24', cupons: 20, faturamento: 422.86, meta: 2585.0, canais: {auto: 0, delivery: 61.58, viagem: 361.28}},
                {loja: 294, inicio: '11:50', fim: '12:14', cupons: 4, faturamento: 153.47, meta: 2390.0, canais: {auto: 0, delivery: 113.67, viagem: 39.8}}
            ]
        };

        // Calcular dif e status para cada registro
        for (let data in dadosPorData) {
            dadosPorData[data].forEach(loja => {
                loja.dif = loja.faturamento - loja.meta;
                loja.difPercentual = loja.meta > 0 ? (loja.dif / loja.meta) * 100 : 0;
                loja.status = loja.dif >= 0 ? 'SIM' : 'NÃO';
                
                // Calcular Balcão (o que sobra dos canais)
                const somaCanais = (loja.canais.auto || 0) + (loja.canais.delivery || 0) + (loja.canais.viagem || 0);
                loja.canais.balcao = loja.faturamento - somaCanais;
                if (loja.canais.balcao < 0) loja.canais.balcao = 0;
            });
        }

        // Lista de todas as datas disponíveis
        const datasDisponiveis = Object.keys(dadosPorData).sort((a, b) => {
            const [diaA, mesA, anoA] = a.split('/').map(Number);
            const [diaB, mesB, anoB] = b.split('/').map(Number);
            return new Date(anoA, mesA-1, diaA) - new Date(anoB, mesB-1, diaB);
        });

        let dataAtual = "14/02/2026";
        let canalPieChart, metasPieChart, top10BarChart, desempenhoBarChart;
        let lojasSelecionadas = [];
        let todasLojas = [];

        function getDadosAtuais() {
            return dadosPorData[dataAtual] || [];
        }

        function mudarDia(direcao) {
            const indexAtual = datasDisponiveis.indexOf(dataAtual);
            if (indexAtual === -1) return;
            
            const novoIndex = indexAtual + direcao;
            if (novoIndex >= 0 && novoIndex < datasDisponiveis.length) {
                dataAtual = datasDisponiveis[novoIndex];
                atualizarInterfaceData();
                recarregarTudo();
            }
        }

        function atualizarInterfaceData() {
            const [dia, mes, ano] = dataAtual.split('/');
            const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const diasSemana = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
            
            const dataObj = new Date(ano, mes-1, dia);
            const diaSemana = diasSemana[dataObj.getDay()];
            
            $('#dataAtualDisplay').text(dataAtual);
            $('#headerDay').text(dia);
            $('#headerMonth').text(`${meses[mes-1].toUpperCase()} ${ano}`);
            $('#dataSelecionada').text(`${diaSemana}, ${dia} de ${meses[mes-1]} de ${ano}`);
            $('#dataGeracao').text(dataAtual);
            
            const indexAtual = datasDisponiveis.indexOf(dataAtual);
            $('#btnDiaAnterior, #btnHeaderAnterior').prop('disabled', indexAtual === 0);
            $('#btnProximoDia, #btnHeaderProximo').prop('disabled', indexAtual === datasDisponiveis.length - 1);
        }

        function recarregarTudo() {
            todasLojas = [...new Set(getDadosAtuais().map(loja => loja.loja))].sort((a, b) => a - b);
            lojasSelecionadas = [...todasLojas];
            
            preencherOpcoesLojas();
            atualizarTextoSelecionadas();
            carregarTabela();
            destruirGraficos();
            inicializarGraficos();
            atualizarKPIs();
            atualizarTabelaCanais();
        }

        function destruirGraficos() {
            if (canalPieChart) canalPieChart.destroy();
            if (metasPieChart) metasPieChart.destroy();
            if (top10BarChart) top10BarChart.destroy();
            if (desempenhoBarChart) desempenhoBarChart.destroy();
        }

        $(document).ready(function() {
            atualizarInterfaceData();
            recarregarTudo();

            $(document).click(function(event) {
                if (!$(event.target).closest('#lojaMultiSelect').length) {
                    $('#lojaDropdown').removeClass('show');
                }
            });
            
            $('#lojaDropdown').click(function(event) {
                event.stopPropagation();
            });
        });

        function preencherOpcoesLojas() {
            let html = '';
            todasLojas.forEach(loja => {
                const nomeLoja = lojaNomes[loja] || `Loja ${loja}`;
                const isSelected = lojasSelecionadas.includes(loja);
                html += `<div class="option-item ${isSelected ? 'selected' : ''}" onclick="toggleLoja(${loja})">
                    <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleLoja(${loja})">
                    <span>${nomeLoja}</span>
                </div>`;
            });
            $('#lojaOptions').html(html);
        }

        function toggleLojaDropdown() {
            $('#lojaDropdown').toggleClass('show');
            $('#lojaSearch').val('').focus();
            filtrarLojas();
        }

        function fecharDropdownLojas() {
            $('#lojaDropdown').removeClass('show');
        }

        function filtrarLojas() {
            const termo = $('#lojaSearch').val().toLowerCase();
            $('.option-item').each(function() {
                const texto = $(this).find('span').text().toLowerCase();
                $(this).toggle(texto.includes(termo));
            });
        }

        function toggleLoja(loja) {
            const index = lojasSelecionadas.indexOf(loja);
            if (index === -1) {
                lojasSelecionadas.push(loja);
            } else {
                lojasSelecionadas.splice(index, 1);
            }
            
            atualizarTextoSelecionadas();
            preencherOpcoesLojas();
            aplicarFiltros();
        }

        function toggleAllLojas() {
            if (lojasSelecionadas.length === todasLojas.length) {
                lojasSelecionadas = [];
            } else {
                lojasSelecionadas = [...todasLojas];
            }
            
            atualizarTextoSelecionadas();
            preencherOpcoesLojas();
            aplicarFiltros();
        }

        function atualizarTextoSelecionadas() {
            const count = lojasSelecionadas.length;
            $('#selectedCount').text(count);
            
            if (count === 0) {
                $('#selectedLojasText').text('Nenhuma loja');
            } else if (count === todasLojas.length) {
                $('#selectedLojasText').text('Todas as Lojas');
            } else if (count <= 3) {
                const nomes = lojasSelecionadas.sort((a, b) => a - b).map(l => lojaNomes[l] || `Loja ${l}`).join(', ');
                $('#selectedLojasText').text(nomes);
            } else {
                $('#selectedLojasText').text(`${count} lojas selecionadas`);
            }
        }

        function carregarTabela() {
            let html = '';
            const statusFiltro = $('#statusFilter').val();
            const dadosAtuais = getDadosAtuais();

            const dadosFiltrados = dadosAtuais.filter(loja => {
                if (lojasSelecionadas.length > 0 && !lojasSelecionadas.includes(loja.loja)) return false;
                if (statusFiltro && loja.status != statusFiltro) return false;
                return true;
            });

            dadosFiltrados.forEach(loja => {
                const nomeLoja = lojaNomes[loja.loja] || `Loja ${loja.loja}`;
                const difClass = loja.dif >= 0 ? 'valor-positivo' : 'valor-negativo';
                const statusClass = loja.status === 'SIM' ? 'meta-sim' : 'meta-nao';
                
                html += `<tr>
                    <td>${dataAtual}</td>
                    <td><span class="store-name">${nomeLoja}</span></td>
                    <td>${loja.inicio || '-'}</td>
                    <td>${loja.fim || '-'}</td>
                    <td>${loja.cupons}</td>
                    <td class="currency">R$ ${formatMoney(loja.faturamento)}</td>
                    <td class="currency">R$ ${formatMoney(loja.meta)}</td>
                    <td class="currency ${difClass}">R$ ${formatMoney(loja.dif)}</td>
                    <td class="${difClass}">${formatPercent(loja.difPercentual)}</td>
                    <td><span class="${statusClass}">${loja.status}</span></td>
                </tr>`;
            });

            $('#tableBody').html(html);
            atualizarKPIs(dadosFiltrados);
        }

        function atualizarTabelaCanais() {
            const statusFiltro = $('#statusFilter').val();
            const dadosAtuais = getDadosAtuais();
            
            const dadosFiltrados = dadosAtuais.filter(loja => {
                if (lojasSelecionadas.length > 0 && !lojasSelecionadas.includes(loja.loja)) return false;
                if (statusFiltro && loja.status != statusFiltro) return false;
                return true;
            });
            
            let totaisCanais = {
                'Auto-Atendimento': 0,
                'Delivery': 0,
                'Viagem': 0,
                'Balcão': 0
            };
            
            dadosFiltrados.forEach(loja => {
                totaisCanais['Auto-Atendimento'] += loja.canais.auto || 0;
                totaisCanais['Delivery'] += loja.canais.delivery || 0;
                totaisCanais['Viagem'] += loja.canais.viagem || 0;
                totaisCanais['Balcão'] += loja.canais.balcao || 0;
            });
            
            const totalGeral = Object.values(totaisCanais).reduce((a, b) => a + b, 0);
            
            if (canalPieChart) {
                canalPieChart.data.datasets[0].data = Object.values(totaisCanais);
                canalPieChart.update();
            }
            
            let html = '';
            const icones = {
                'Auto-Atendimento': 'fa-robot',
                'Delivery': 'fa-motorcycle',
                'Viagem': 'fa-plane',
                'Balcão': 'fa-store'
            };
            
            const cores = {
                'Auto-Atendimento': '#4361ee',
                'Delivery': '#f72585',
                'Viagem': '#4cc9f0',
                'Balcão': '#ffd166'
            };
            
            Object.entries(totaisCanais).forEach(([canal, valor]) => {
                const participacao = totalGeral > 0 ? (valor / totalGeral * 100) : 0;
                html += `<tr>
                    <td><i class="fas ${icones[canal]}" style="color: ${cores[canal]}; margin-right: 8px;"></i> ${canal}</td>
                    <td class="currency">R$ ${formatMoney(valor)}</td>
                    <td>${participacao.toFixed(1)}%</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${participacao}%"></div>
                        </div>
                    </td>
                </tr>`;
            });
            
            $('#canaisTableBody').html(html);
        }

        function atualizarKPIs(dadosFiltrados = null) {
            const statusFiltro = $('#statusFilter').val();
            const dadosAtuais = getDadosAtuais();
            
            const dados = dadosFiltrados || dadosAtuais.filter(loja => {
                if (lojasSelecionadas.length > 0 && !lojasSelecionadas.includes(loja.loja)) return false;
                if (statusFiltro && loja.status != statusFiltro) return false;
                return true;
            });
            
            const totalLojas = dados.length;
            const totalFaturamento = dados.reduce((sum, loja) => sum + loja.faturamento, 0);
            const totalMeta = dados.reduce((sum, loja) => sum + loja.meta, 0);
            const totalDiferenca = totalFaturamento - totalMeta;
            const percentualDiferenca = totalMeta > 0 ? (totalDiferenca / totalMeta) * 100 : 0;
            const totalCupons = dados.reduce((sum, loja) => sum + loja.cupons, 0);
            const ticketMedio = totalCupons > 0 ? totalFaturamento / totalCupons : 0;
            const metasAtingidas = dados.filter(loja => loja.status === 'SIM').length;
            const percentualLojas = totalLojas > 0 ? (metasAtingidas / totalLojas) * 100 : 0;
            
            $('#totalLojas').text(totalLojas);
            $('#totalFaturamento').text(`R$ ${formatMoney(totalFaturamento)}`);
            $('#totalMeta').text(`R$ ${formatMoney(totalMeta)}`);
            $('#totalDiferenca').text(`R$ ${formatMoney(totalDiferenca)}`);
            $('#percentualMeta').text(formatPercent(percentualDiferenca));
            $('#percentualDiferenca').text(formatPercent(percentualDiferenca));
            $('#ticketMedio').text(`R$ ${formatMoney(ticketMedio)}`);
            $('#metasAtingidas').text(`${metasAtingidas}/${totalLojas}`);
            $('#percentualLojas').text(`${percentualLojas.toFixed(1)}%`);
            $('#lojasMetaSim').text(`${metasAtingidas} lojas (${percentualLojas.toFixed(1)}%)`);
            $('#lojasMetaNao').text(`${totalLojas - metasAtingidas} lojas (${(100 - percentualLojas).toFixed(1)}%)`);
            
            const percentualProgresso = totalMeta > 0 ? (totalFaturamento / totalMeta) * 100 : 0;
            $('#progressoMeta').css('width', `${percentualProgresso}%`);
            
            if (metasPieChart) {
                metasPieChart.data.datasets[0].data = [metasAtingidas, totalLojas - metasAtingidas];
                metasPieChart.update();
            }
        }

        function formatMoney(value) {
            return value.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        function formatPercent(value) {
            return (value > 0 ? '+' : '') + value.toFixed(2) + '%';
        }

        function aplicarFiltros() {
            carregarTabela();
            atualizarTabelaCanais();
            
            const statusFiltro = $('#statusFilter').val();
            const dadosAtuais = getDadosAtuais();

            const dadosFiltrados = dadosAtuais.filter(loja => {
                if (lojasSelecionadas.length > 0 && !lojasSelecionadas.includes(loja.loja)) return false;
                if (statusFiltro && loja.status != statusFiltro) return false;
                return true;
            });
            
            if (desempenhoBarChart) {
                if (dadosFiltrados.length > 0) {
                    desempenhoBarChart.data.labels = dadosFiltrados.map(d => lojaNomes[d.loja] || `Loja ${d.loja}`);
                    desempenhoBarChart.data.datasets[0].data = dadosFiltrados.map(d => 100 + d.difPercentual);
                    desempenhoBarChart.data.datasets[0].backgroundColor = dadosFiltrados.map(d => d.difPercentual >= 0 ? '#06d6a0' : '#ef476f');
                } else {
                    desempenhoBarChart.data.labels = [];
                    desempenhoBarChart.data.datasets[0].data = [];
                }
                desempenhoBarChart.update();
            }
            
            if (top10BarChart) {
                if (dadosFiltrados.length > 0) {
                    const top10Data = [...dadosFiltrados].sort((a, b) => b.faturamento - a.faturamento).slice(0, Math.min(10, dadosFiltrados.length));
                    top10BarChart.data.labels = top10Data.map(d => lojaNomes[d.loja] || `Loja ${d.loja}`);
                    top10BarChart.data.datasets[0].data = top10Data.map(d => d.faturamento);
                    top10BarChart.data.datasets[1].data = top10Data.map(d => d.meta);
                } else {
                    top10BarChart.data.labels = [];
                    top10BarChart.data.datasets[0].data = [];
                    top10BarChart.data.datasets[1].data = [];
                }
                top10BarChart.update();
            }
        }

        let ordemAtual = { coluna: -1, ascendente: true };

        function ordenarTabela(coluna) {
            const tbody = $('#tableBody');
            const linhas = tbody.find('tr').get();
            
            if (ordemAtual.coluna === coluna) {
                ordemAtual.ascendente = !ordemAtual.ascendente;
            } else {
                ordemAtual.coluna = coluna;
                ordemAtual.ascendente = true;
            }
            
            linhas.sort((a, b) => {
                const celulaA = $(a).children('td').eq(coluna).text();
                const celulaB = $(b).children('td').eq(coluna).text();
                
                let valorA, valorB;
                
                if (coluna === 1) {
                    valorA = celulaA;
                    valorB = celulaB;
                } else if (coluna === 4) {
                    valorA = parseInt(celulaA) || 0;
                    valorB = parseInt(celulaB) || 0;
                } else if (coluna === 5 || coluna === 6 || coluna === 7) {
                    valorA = parseFloat(celulaA.replace('R$ ', '').replace(/\./g, '').replace(',', '.')) || 0;
                    valorB = parseFloat(celulaB.replace('R$ ', '').replace(/\./g, '').replace(',', '.')) || 0;
                } else if (coluna === 8) {
                    valorA = parseFloat(celulaA.replace('%', '').replace('+', '')) || 0;
                    valorB = parseFloat(celulaB.replace('%', '').replace('+', '')) || 0;
                } else {
                    valorA = celulaA;
                    valorB = celulaB;
                }
                
                if (valorA < valorB) return ordemAtual.ascendente ? -1 : 1;
                if (valorA > valorB) return ordemAtual.ascendente ? 1 : -1;
                return 0;
            });
            
            tbody.empty().append(linhas);
            
            $('th i').removeClass('fa-sort-up fa-sort-down').addClass('fa-sort');
            const icone = ordemAtual.ascendente ? 'fa-sort-up' : 'fa-sort-down';
            $(`th:eq(${coluna}) i`).removeClass('fa-sort').addClass(icone);
        }

        function exportarExcel() {
            const statusFiltro = $('#statusFilter').val();
            const dadosAtuais = getDadosAtuais();

            const dadosFiltrados = dadosAtuais.filter(loja => {
                if (lojasSelecionadas.length > 0 && !lojasSelecionadas.includes(loja.loja)) return false;
                if (statusFiltro && loja.status != statusFiltro) return false;
                return true;
            });

            const totalFaturamento = dadosFiltrados.reduce((sum, loja) => sum + loja.faturamento, 0);
            const totalMeta = dadosFiltrados.reduce((sum, loja) => sum + loja.meta, 0);
            const totalDiferenca = totalFaturamento - totalMeta;
            const percentualDiferenca = totalMeta > 0 ? (totalDiferenca / totalMeta) * 100 : 0;
            const metasAtingidas = dadosFiltrados.filter(loja => loja.status === 'SIM').length;

            const wb = XLSX.utils.book_new();
            
            const dadosDetalhamento = [
                ['RELATÓRIO DE METAS - SETOR PATTY'],
                [`Data: ${dataAtual} - Lojas Selecionadas: ${lojasSelecionadas.length} lojas, Status: ${statusFiltro || 'Todos'}`],
                []
            ];
            
            dadosDetalhamento.push([
                'Data', 'Loja', 'Início', 'Fim', 'Qtd Cupons', 
                'Faturamento (R$)', 'Meta (R$)', 'Diferença (R$)', 'Diferença %', 'Status'
            ]);
            
            dadosFiltrados.forEach(loja => {
                const nomeLoja = lojaNomes[loja.loja] || `Loja ${loja.loja}`;
                dadosDetalhamento.push([
                    dataAtual,
                    nomeLoja,
                    loja.inicio || '-',
                    loja.fim || '-',
                    loja.cupons,
                    loja.faturamento,
                    loja.meta,
                    loja.dif,
                    loja.difPercentual,
                    loja.status
                ]);
            });
            
            dadosDetalhamento.push([]);
            dadosDetalhamento.push([
                'TOTAIS', '', '', '', 
                dadosFiltrados.reduce((sum, loja) => sum + loja.cupons, 0),
                totalFaturamento,
                totalMeta,
                totalDiferenca,
                percentualDiferenca,
                `${metasAtingidas}/${dadosFiltrados.length} lojas`
            ]);

            const wsDetalhamento = XLSX.utils.aoa_to_sheet(dadosDetalhamento);
            
            wsDetalhamento['!cols'] = [
                { wch: 12 }, { wch: 30 }, { wch: 8 }, { wch: 8 }, { wch: 12 },
                { wch: 18 }, { wch: 18 }, { wch: 18 }, { wch: 15 }, { wch: 12 }
            ];

            let totaisCanais = {
                'Auto-Atendimento': 0,
                'Delivery': 0,
                'Viagem': 0,
                'Balcão': 0
            };
            
            dadosFiltrados.forEach(loja => {
                totaisCanais['Auto-Atendimento'] += loja.canais.auto || 0;
                totaisCanais['Delivery'] += loja.canais.delivery || 0;
                totaisCanais['Viagem'] += loja.canais.viagem || 0;
                totaisCanais['Balcão'] += loja.canais.balcao || 0;
            });
            
            const totalCanais = Object.values(totaisCanais).reduce((a, b) => a + b, 0);
            
            const dadosCanais = [
                ['RESUMO POR CANAL'],
                [],
                ['Canal', 'Valor (R$)', 'Participação (%)']
            ];
            
            Object.entries(totaisCanais).forEach(([canal, valor]) => {
                dadosCanais.push([canal, valor, totalCanais > 0 ? (valor / totalCanais * 100) : 0]);
            });
            
            dadosCanais.push([]);
            dadosCanais.push(['TOTAL', totalCanais, '100.0']);

            const wsCanais = XLSX.utils.aoa_to_sheet(dadosCanais);
            wsCanais['!cols'] = [{ wch: 25 }, { wch: 18 }, { wch: 18 }];

            const ticketMedio = dadosFiltrados.reduce((sum, loja) => sum + loja.cupons, 0) > 0 ? 
                totalFaturamento / dadosFiltrados.reduce((sum, loja) => sum + loja.cupons, 0) : 0;
                
            const dadosIndicadores = [
                ['INDICADORES GERAIS'],
                [],
                ['Indicador', 'Valor'],
                ['Total de Lojas', dadosFiltrados.length],
                ['Faturamento Total', totalFaturamento],
                ['Meta Total', totalMeta],
                ['Diferença', totalDiferenca],
                ['Percentual de Atingimento', totalMeta > 0 ? (totalFaturamento / totalMeta * 100) : 0],
                ['Ticket Médio', ticketMedio],
                ['Lojas que Atingiram Meta', metasAtingidas],
                ['Lojas Abaixo da Meta', dadosFiltrados.length - metasAtingidas],
                ['Percentual de Metas Atingidas', dadosFiltrados.length > 0 ? (metasAtingidas / dadosFiltrados.length * 100) : 0]
            ];

            const wsIndicadores = XLSX.utils.aoa_to_sheet(dadosIndicadores);
            wsIndicadores['!cols'] = [{ wch: 30 }, { wch: 20 }];

            XLSX.utils.book_append_sheet(wb, wsDetalhamento, 'Detalhamento');
            XLSX.utils.book_append_sheet(wb, wsCanais, 'Resumo por Canal');
            XLSX.utils.book_append_sheet(wb, wsIndicadores, 'Indicadores');

            const dataStr = dataAtual.replace(/\//g, '-');
            const nomeArquivo = `Setor_Patty_${dataStr}.xlsx`;

            XLSX.writeFile(wb, nomeArquivo);

            const btnExport = event.target.closest('.btn');
            const textoOriginal = btnExport.innerHTML;
            btnExport.innerHTML = '<i class="fas fa-check"></i> Excel Gerado!';
            btnExport.style.background = '#06d6a0';
            setTimeout(() => {
                btnExport.innerHTML = textoOriginal;
                btnExport.style.background = '';
            }, 2000);
        }

        function inicializarGraficos() {
            Chart.defaults.font.family = "'Inter', 'Segoe UI', Roboto, sans-serif";
            Chart.defaults.font.size = 12;

            const dadosAtuais = getDadosAtuais();

            let totaisCanais = {
                'Auto-Atendimento': 0,
                'Delivery': 0,
                'Viagem': 0,
                'Balcão': 0
            };
            
            dadosAtuais.forEach(loja => {
                totaisCanais['Auto-Atendimento'] += loja.canais.auto || 0;
                totaisCanais['Delivery'] += loja.canais.delivery || 0;
                totaisCanais['Viagem'] += loja.canais.viagem || 0;
                totaisCanais['Balcão'] += loja.canais.balcao || 0;
            });

            canalPieChart = new Chart(document.getElementById('canalPieChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(totaisCanais),
                    datasets: [{
                        data: Object.values(totaisCanais),
                        backgroundColor: ['#4361ee', '#f72585', '#4cc9f0', '#ffd166'],
                        borderWidth: 0,
                        borderRadius: 8,
                        spacing: 4,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20,
                                font: { size: 12, weight: '500' }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(43, 45, 66, 0.9)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: (ctx) => {
                                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const valor = ctx.raw;
                                    const percent = ((valor / total) * 100).toFixed(1);
                                    return `${ctx.label}: R$ ${formatMoney(valor)} (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });

            const metasAtingidas = dadosAtuais.filter(loja => loja.status === 'SIM').length;
            const metasNaoAtingidas = dadosAtuais.length - metasAtingidas;
            
            metasPieChart = new Chart(document.getElementById('metasPieChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Atingiram Meta', 'Não Atingiram'],
                    datasets: [{
                        data: [metasAtingidas, metasNaoAtingidas],
                        backgroundColor: ['#06d6a0', '#ef476f'],
                        borderWidth: 0,
                        borderRadius: 8,
                        spacing: 4,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20,
                                font: { size: 12, weight: '500' }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(43, 45, 66, 0.9)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: (ctx) => {
                                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const percent = ((ctx.raw / total) * 100).toFixed(1);
                                    return `${ctx.label}: ${ctx.raw} lojas (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });

            const top10Data = [...dadosAtuais].sort((a, b) => b.faturamento - a.faturamento).slice(0, 10);
            top10BarChart = new Chart(document.getElementById('top10BarChart'), {
                type: 'bar',
                data: {
                    labels: top10Data.map(d => lojaNomes[d.loja] || `Loja ${d.loja}`),
                    datasets: [
                        {
                            label: 'Faturamento',
                            data: top10Data.map(d => d.faturamento),
                            backgroundColor: '#4361ee',
                            borderRadius: 8,
                            barPercentage: 0.6,
                            categoryPercentage: 0.8
                        },
                        {
                            label: 'Meta',
                            data: top10Data.map(d => d.meta),
                            backgroundColor: '#f72585',
                            borderRadius: 8,
                            barPercentage: 0.6,
                            categoryPercentage: 0.8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'rect',
                                padding: 15,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(43, 45, 66, 0.9)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: (ctx) => `R$ ${formatMoney(ctx.raw)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#f1f5f9',
                                drawBorder: false
                            },
                            ticks: {
                                callback: (value) => 'R$ ' + value.toLocaleString('pt-BR')
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });

            desempenhoBarChart = new Chart(document.getElementById('desempenhoBarChart'), {
                type: 'bar',
                data: {
                    labels: dadosAtuais.map(d => lojaNomes[d.loja] || `Loja ${d.loja}`),
                    datasets: [{
                        label: 'Atingimento da Meta (%)',
                        data: dadosAtuais.map(d => 100 + d.difPercentual),
                        backgroundColor: dadosAtuais.map(d => d.difPercentual >= 0 ? '#06d6a0' : '#ef476f'),
                        borderRadius: 8,
                        barPercentage: 0.7,
                        categoryPercentage: 0.9
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(43, 45, 66, 0.9)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: (ctx) => `Atingimento: ${ctx.raw.toFixed(1)}%`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 200,
                            grid: {
                                color: '#f1f5f9',
                                drawBorder: false
                            },
                            ticks: {
                                callback: (value) => value + '%'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
