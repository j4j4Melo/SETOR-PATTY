<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Ragazzo Express - Setor Patty | Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2e7d32;
            --primary-dark: #1b5e20;
            --primary-light: #e8f5e9;
            --secondary: #2b2d42;
            --success: #06d6a0;
            --success-light: #e6fff5;
            --danger: #ef476f;
            --danger-light: #ffe6ec;
            --warning: #ffd166;
            --info: #4cc9f0;
            --light: #f8fafc;
            --dark: #0f172a;
            --gray: #475569;
            --gray-light: #e2e8f0;
            --white: #ffffff;
            --shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            --shadow-sm: 0 10px 15px -3px rgba(0,0,0,0.1);
            --shadow-lg: 0 30px 60px -15px rgba(46,125,96,0.3);
            --gradient-1: linear-gradient(135deg, #2e7d32, #1b5e20);
            --gradient-2: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-3: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --border-radius: 32px;
            --border-radius-sm: 20px;
            --border-radius-lg: 40px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(145deg, #f1f8e9 0%, #d4e6d4 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 200" opacity="0.03"><path fill="%232e7d32" d="M80 40 L320 40 L360 140 L200 200 L40 140 L80 40 Z"/><text x="120" y="100" font-family="Arial Black" font-size="48" fill="%232e7d32" font-weight="900">RAGAZZO</text><text x="160" y="160" font-family="Arial Black" font-size="48" fill="%232e7d32" font-weight="900">EXPRESS</text></svg>') repeat;
            pointer-events: none;
            z-index: 0;
        }

        .dashboard {
            width: 100%;
            max-width: 1440px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* Glassmorphism Header */
        .header {
            background: var(--gradient-1);
            padding: 24px 28px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            color: white;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            animation: rotate 30s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .header-content {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-title h1 {
            font-size: 26px;
            font-weight: 800;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-title p {
            font-size: 14px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .header-date {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            border-radius: 60px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .header-date .day {
            font-size: 24px;
            font-weight: 800;
            line-height: 1;
        }

        .header-date .month {
            font-size: 13px;
            opacity: 0.9;
            letter-spacing: 1px;
        }

        /* Upload Area Moderna */
        .upload-area {
            background: white;
            border-radius: 60px;
            padding: 8px 16px 8px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .upload-info {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--primary);
            font-size: 14px;
            font-weight: 500;
        }

        .upload-info i {
            font-size: 18px;
            color: var(--primary);
        }

        .update-log {
            background: var(--primary-light);
            padding: 6px 16px;
            border-radius: 40px;
            font-size: 13px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .btn-upload {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 22px;
            border-radius: 40px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(46,125,96,0.3);
        }

        .btn-upload:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(46,125,96,0.4);
        }

        .btn-clear {
            background: white;
            color: var(--gray);
            border: 1px solid var(--gray-light);
            padding: 8px 18px;
            border-radius: 40px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-clear:hover {
            background: #f1f5f9;
            border-color: var(--gray);
        }

        /* Filtros de Per√≠odo Modernos */
        .period-filters {
            background: white;
            padding: 8px 16px;
            border-radius: 60px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .period-group {
            display: flex;
            gap: 4px;
            background: var(--light);
            padding: 4px;
            border-radius: 40px;
        }

        .period-btn {
            padding: 8px 18px;
            border: none;
            border-radius: 40px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            background: transparent;
            color: var(--gray);
            transition: all 0.2s;
        }

        .period-btn:hover {
            color: var(--primary);
            background: var(--primary-light);
        }

        .period-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(46,125,96,0.3);
        }

        .date-range {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .date-range-item {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--light);
            padding: 6px 12px;
            border-radius: 40px;
        }

        .date-range-item input {
            border: none;
            background: transparent;
            font-size: 12px;
            width: 110px;
            padding: 4px;
        }

        /* Filtros Principais com Design Moderno */
        .filters {
            background: white;
            padding: 18px 20px;
            border-radius: var(--border-radius-sm);
            margin-bottom: 24px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--light);
            padding: 5px 12px 5px 16px;
            border-radius: 40px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .filter-group label {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark);
        }

        /* Multi-select Moderno */
        .multi-select {
            position: relative;
            min-width: 300px;
        }

        .select-btn {
            background: white;
            padding: 10px 18px;
            border-radius: 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.05);
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }

        .select-btn:hover {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .select-btn .selected-count {
            background: var(--primary);
            color: white;
            padding: 3px 10px;
            border-radius: 30px;
            font-size: 11px;
            font-weight: 700;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px;
            margin-top: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: none;
            border: 1px solid rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .dropdown-menu.show {
            display: block;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .search-box {
            padding: 15px;
            border-bottom: 1px solid var(--gray-light);
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 10px 40px 10px 16px;
            border: 1px solid var(--gray-light);
            border-radius: 40px;
            font-size: 13px;
            transition: all 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .search-box i {
            position: absolute;
            right: 28px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 14px;
        }

        .select-all {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            color: var(--primary);
            font-weight: 600;
            font-size: 13px;
            border-bottom: 1px solid var(--gray-light);
            transition: background 0.2s;
        }

        .select-all:hover {
            background: var(--primary-light);
        }

        .options-list {
            max-height: 250px;
            overflow-y: auto;
            padding: 8px 0;
        }

        .option-item {
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .option-item:hover {
            background: var(--primary-light);
            border-left-color: var(--primary);
        }

        .option-item.selected {
            background: rgba(46,125,96,0.05);
            border-left-color: var(--primary);
        }

        .option-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }

        .dropdown-close {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border-top: 1px solid var(--gray-light);
            cursor: pointer;
            color: var(--primary);
            font-size: 13px;
            font-weight: 600;
            background: var(--primary-light);
            transition: all 0.2s;
        }

        .dropdown-close:hover {
            background: var(--primary);
            color: white;
        }

        select {
            background: white;
            padding: 10px 24px 10px 18px;
            border-radius: 40px;
            border: 1px solid rgba(0,0,0,0.05);
            font-size: 13px;
            font-weight: 500;
            min-width: 150px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23475669' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
        }

        select:hover {
            border-color: var(--primary);
        }

        /* Bot√µes de A√ß√£o Modernos */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-left: auto;
        }

        .btn-action {
            padding: 10px 22px;
            border: none;
            border-radius: 40px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            background: white;
            color: var(--dark);
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-action i {
            font-size: 15px;
            color: var(--gray);
            transition: all 0.2s;
        }

        .btn-action:hover i {
            color: var(--primary);
        }

        .btn-action.primary {
            background: var(--gradient-1);
            color: white;
            border: none;
            box-shadow: 0 4px 10px rgba(46,125,96,0.3);
        }

        .btn-action.primary:hover {
            background: linear-gradient(135deg, #1b5e20, #2e7d32);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(46,125,96,0.4);
        }

        .btn-action.primary i {
            color: white;
        }

        .btn-action.success {
            background: linear-gradient(135deg, #06d6a0, #05b586);
            color: white;
            border: none;
            box-shadow: 0 4px 10px rgba(6,214,160,0.3);
        }

        .btn-action.success:hover {
            background: linear-gradient(135deg, #05b586, #049f76);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(6,214,160,0.4);
        }

        .btn-action.success i {
            color: white;
        }

        /* KPIs com Design Moderno */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: white;
            border-radius: var(--border-radius-sm);
            padding: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(0,0,0,0.03);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .kpi-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, rgba(46,125,96,0.05) 0%, transparent 70%);
            border-radius: 50%;
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .kpi-card .tooltip {
            visibility: hidden;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: white;
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 100;
            margin-bottom: 10px;
            box-shadow: var(--shadow);
            max-width: 300px;
            white-space: normal;
            word-wrap: break-word;
        }

        .kpi-card:hover .tooltip {
            visibility: visible;
        }

        .kpi-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .kpi-icon {
            width: 40px;
            height: 40px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .kpi-icon.green { background: var(--primary-light); color: var(--primary); }
        .kpi-icon.red { background: var(--danger-light); color: var(--danger); }
        .kpi-icon.blue { background: #e6f0ff; color: #2563eb; }
        .kpi-icon.purple { background: #f0e7ff; color: #9b5de5; }

        .kpi-label {
            font-size: 13px;
            color: var(--gray);
            font-weight: 500;
        }

        .kpi-main {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .kpi-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--dark);
            letter-spacing: -0.5px;
        }

        .kpi-value.success { color: var(--success); }
        .kpi-value.danger { color: var(--danger) !important; }

        .kpi-sub {
            font-size: 11px;
            color: var(--gray);
            background: var(--light);
            padding: 3px 10px;
            border-radius: 30px;
            font-weight: 500;
        }

        .kpi-comparison {
            font-size: 12px;
            color: var(--gray);
            padding-top: 10px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--gray-light);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-1);
            border-radius: 10px;
            transition: width 0.3s;
        }

        /* Status Cards Modernos */
        .lojas-status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .status-card {
            background: white;
            border-radius: var(--border-radius-sm);
            padding: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(0,0,0,0.03);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .status-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .status-card .tooltip {
            visibility: hidden;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: white;
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 100;
            margin-bottom: 10px;
            box-shadow: var(--shadow);
            max-width: 300px;
            white-space: normal;
            word-wrap: break-word;
        }

        .status-card:hover .tooltip {
            visibility: visible;
        }

        .status-titulo {
            font-size: 15px;
            color: var(--gray);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .status-valor {
            font-size: 36px;
            font-weight: 800;
            color: var(--dark);
            line-height: 1;
            margin-bottom: 8px;
        }

        .status-valor.success { color: var(--success); }
        .status-valor.danger { color: var(--danger); }
        .status-valor.primary { color: var(--primary); }

        .status-percentual {
            font-size: 15px;
            font-weight: 500;
        }

        .status-percentual.success { color: var(--success); }
        .status-percentual.danger { color: var(--danger); }

        /* Cards de Gr√°ficos Modernos */
        .charts-grid-2col {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: white;
            border-radius: var(--border-radius-sm);
            padding: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(0,0,0,0.03);
            transition: all 0.3s;
        }

        .chart-card:hover {
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--gray-light);
        }

        .chart-header h3 {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--dark);
        }

        .chart-header h3 i {
            color: var(--primary);
        }

        .chart-header .badge {
            background: var(--light);
            padding: 5px 14px;
            border-radius: 40px;
            font-size: 12px;
            font-weight: 600;
            color: var(--gray);
        }

        .chart-wrapper {
            height: 240px;
            position: relative;
        }

        .charts-grid-3col {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        /* Ranking de ADMs Moderno */
        .melhores-adm-container {
            background: white;
            border-radius: var(--border-radius-sm);
            padding: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(0,0,0,0.03);
            margin-bottom: 24px;
        }

        .melhores-adm-header {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .adm-ranking-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .adm-ranking-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            background: var(--light);
            border-radius: 14px;
            border-left: 5px solid;
            transition: all 0.2s;
        }

        .adm-ranking-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-sm);
        }

        .adm-ranking-posicao {
            width: 36px;
            height: 36px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            margin-right: 15px;
        }

        .adm-ranking-info {
            flex: 1;
        }

        .adm-ranking-nome {
            font-weight: 700;
            color: var(--dark);
            font-size: 15px;
        }

        .adm-ranking-detalhes {
            display: flex;
            gap: 20px;
            margin-top: 5px;
            font-size: 13px;
        }

        .adm-ranking-faturamento {
            color: var(--primary);
            font-weight: 600;
        }

        .adm-ranking-meta {
            color: var(--gray);
        }

        .adm-ranking-percentual {
            font-weight: 700;
        }

        .adm-ranking-percentual.alta { color: var(--success); }
        .adm-ranking-percentual.media { color: #f97316; }
        .adm-ranking-percentual.baixa { color: var(--danger); }

        /* Tabela Moderna */
        .tables-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .table-card {
            background: white;
            border-radius: var(--border-radius-sm);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 2px solid var(--primary);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary);
        }

        .table-header h2 {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--gray-light);
            max-height: 400px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            min-width: 1100px;
        }

        th {
            background: var(--light);
            padding: 14px 8px;
            position: sticky;
            top: 0;
            border-bottom: 2px solid var(--primary);
            cursor: pointer;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--dark);
        }

        th:hover {
            background: var(--gray-light);
        }

        td {
            padding: 12px 8px;
            border-bottom: 1px solid var(--gray-light);
            text-align: center;
        }

        tr:hover {
            background: var(--primary-light);
        }

        .store-name {
            font-weight: 600;
            color: var(--primary);
        }

        .hora-cell {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--gray);
        }

        .valor-positivo { color: var(--success) !important; font-weight: 600; }
        .valor-negativo { color: var(--danger) !important; font-weight: 600; }

        .meta-sim {
            background: var(--success-light);
            color: var(--success);
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 11px;
            font-weight: 600;
        }

        .meta-nao {
            background: var(--danger-light);
            color: var(--danger);
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 11px;
            font-weight: 600;
        }

        .loja-fechada {
            background: #f1f5f9;
            color: var(--gray);
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 11px;
            font-weight: 600;
        }

        .footer {
            margin-top: 30px;
            text-align: center;
            font-size: 12px;
            color: var(--gray);
            padding: 20px 0 10px;
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        /* Scrollbar Moderna */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray-light);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* Responsividade */
        @media (max-width: 1200px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .charts-grid-2col { grid-template-columns: 1fr; }
            .charts-grid-3col { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 900px) {
            .charts-grid-3col { grid-template-columns: 1fr; }
            .lojas-status-grid { grid-template-columns: 1fr; }
            .filters { flex-direction: column; align-items: stretch; }
            .multi-select { min-width: 100%; }
            .action-buttons { margin-left: 0; width: 100%; justify-content: flex-end; }
            .period-filters { flex-direction: column; }
            .date-range { margin-left: 0; width: 100%; }
        }

        @media (max-width: 600px) {
            .kpi-grid { grid-template-columns: 1fr; }
            .action-buttons { flex-wrap: wrap; }
            .upload-area { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Header Moderno -->
        <div class="header">
            <div class="header-content">
                <div class="header-title">
                    <h1><i class="fas fa-store-alt"></i> Ragazzo Express</h1>
                    <p>
                        <i class="fas fa-store"></i> <span id="totalLojasHeader">0</span> Lojas em opera√ß√£o
                        <i class="fas fa-circle" style="font-size: 6px;"></i>
                        <i class="fas fa-calendar"></i> Fevereiro 2026
                    </p>
                </div>
                <div class="header-date">
                    <div class="day" id="headerDay">15</div>
                    <div class="month" id="headerMonth">FEVEREIRO 2026</div>
                </div>
            </div>
        </div>

        <!-- Upload Area Moderna -->
        <div class="upload-area">
            <div class="upload-info">
                <i class="fas fa-file-excel"></i>
                <span>Planilha de vendas</span>
                <span class="update-log">
                    <i class="fas fa-clock"></i>
                    <span id="dataAtualizacao">Aguardando upload</span>
                </span>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn-clear" onclick="limparDadosSalvos()">
                    <i class="fas fa-trash"></i> Limpar
                </button>
                <button class="btn-upload" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-cloud-upload-alt"></i> Atualizar Dados
                </button>
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" onchange="processarPlanilha(this)" style="display: none;">
            </div>
        </div>

        <!-- Filtros de Per√≠odo Modernos -->
        <div class="period-filters">
            <div class="period-group">
                <button class="period-btn" onclick="setPeriodo('hoje')">Hoje</button>
                <button class="period-btn" onclick="setPeriodo('ontem')">Ontem</button>
                <button class="period-btn" onclick="setPeriodo('7d')">7 dias</button>
                <button class="period-btn" onclick="setPeriodo('15d')">15 dias</button>
                <button class="period-btn" onclick="setPeriodo('mes')">M√™s</button>
                <button class="period-btn" onclick="setPeriodo('custom')">Per√≠odo</button>
            </div>
            <div class="date-range" id="dateRangeInputs" style="display: none;">
                <div class="date-range-item">
                    <label>De:</label>
                    <input type="date" id="dataInicio" onchange="atualizarPorData()">
                </div>
                <div class="date-range-item">
                    <label>At√©:</label>
                    <input type="date" id="dataFim" onchange="atualizarPorData()">
                </div>
            </div>
        </div>

        <!-- Filtros com Bot√µes Modernos -->
        <div class="filters">
            <div class="filter-group">
                <label><i class="fas fa-store"></i> Lojas:</label>
                <div class="multi-select" id="lojaMultiSelect">
                    <div class="select-btn" onclick="toggleLojaDropdown()">
                        <span id="selectedLojasText">Todas as Lojas</span>
                        <span class="selected-count" id="selectedCount">0</span>
                    </div>
                    <div class="dropdown-menu" id="lojaDropdown">
                        <div class="search-box">
                            <input type="text" id="lojaSearch" placeholder="Buscar loja por nome ou c√≥digo...">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="select-all" onclick="toggleAllLojas()">
                            <i class="fas fa-check-square"></i> Selecionar Todas
                        </div>
                        <div class="options-list" id="lojaOptions"></div>
                        <div class="dropdown-close" onclick="fecharDropdownLojas()">
                            <i class="fas fa-check-circle"></i> Concluir Sele√ß√£o
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="filter-group">
                <label><i class="fas fa-user-tie"></i> ADM:</label>
                <select id="admFilter" onchange="aplicarFiltrosAutom√°tico()">
                    <option value="">Todos os ADMs</option>
                </select>
            </div>

            <div class="filter-group">
                <label><i class="fas fa-flag"></i> Status:</label>
                <select id="statusFilter" onchange="aplicarFiltrosAutom√°tico()">
                    <option value="">Todos os Status</option>
                    <option value="SIM">‚úÖ Meta Atingida</option>
                    <option value="N√ÉO">‚ùå Abaixo da Meta</option>
                    <option value="FECHADA">üî¥ Loja Fechada</option>
                </select>
            </div>

            <!-- Bot√µes de A√ß√£o Modernos -->
            <div class="action-buttons">
                <button class="btn-action" onclick="aplicarFiltrosAutom√°tico()">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
                <button class="btn-action" onclick="recarregarDados()">
                    <i class="fas fa-database"></i> Recarregar
                </button>
                <button class="btn-action success" onclick="exportarExcel()">
                    <i class="fas fa-file-excel"></i> Exportar Excel
                </button>
            </div>
        </div>

        <!-- KPIs Modernos -->
        <div class="kpi-grid">
            <div class="kpi-card" onclick="filtrarPorStatus('')">
                <div class="tooltip" id="tooltipTotalLojas">Total de lojas no per√≠odo</div>
                <div class="kpi-header">
                    <div class="kpi-icon blue"><i class="fas fa-store"></i></div>
                    <span class="kpi-label">Total de Lojas</span>
                </div>
                <div class="kpi-main">
                    <span class="kpi-value" id="totalLojas">0</span>
                    <span class="kpi-sub" id="totalLojasPeriodo">0d</span>
                </div>
                <div class="kpi-comparison" id="lojasAtivas"></div>
            </div>

            <div class="kpi-card" onclick="filtrarPorStatus('')">
                <div class="kpi-header">
                    <div class="kpi-icon green"><i class="fas fa-dollar-sign"></i></div>
                    <span class="kpi-label">Faturamento Total</span>
                </div>
                <div class="kpi-main">
                    <span class="kpi-value" id="totalFaturamento">R$ 0</span>
                </div>
                <div class="kpi-comparison" id="percentualMeta">0% vs meta</div>
            </div>

            <div class="kpi-card" onclick="filtrarPorStatus('')">
                <div class="kpi-header">
                    <div class="kpi-icon green"><i class="fas fa-bullseye"></i></div>
                    <span class="kpi-label">Meta Total</span>
                </div>
                <div class="kpi-main">
                    <span class="kpi-value" id="totalMeta">R$ 0</span>
                    <span class="kpi-sub" id="metasAtingidas">0/0</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressoMeta" style="width:0%"></div>
                </div>
            </div>

            <div class="kpi-card" onclick="filtrarPorStatus('')">
                <div class="kpi-header">
                    <div class="kpi-icon red"><i class="fas fa-balance-scale"></i></div>
                    <span class="kpi-label">Diferen√ßa</span>
                </div>
                <div class="kpi-main">
                    <span class="kpi-value" id="totalDiferenca">R$ 0</span>
                    <span class="emoji-indicator" id="diferencaEmoji"></span>
                </div>
                <div class="kpi-comparison" id="diferencaText">0%</div>
            </div>

            <div class="kpi-card" onclick="filtrarPorStatus('')">
                <div class="kpi-header">
                    <div class="kpi-icon green"><i class="fas fa-ticket-alt"></i></div>
                    <span class="kpi-label">Ticket M√©dio</span>
                </div>
                <div class="kpi-main">
                    <span class="kpi-value" id="ticketMedio">R$ 0</span>
                </div>
                <div class="kpi-comparison" id="ticketPeriodo">hoje</div>
            </div>

            <div class="kpi-card" onclick="filtrarPorStatus('SIM')">
                <div class="tooltip" id="tooltipMetasOK">Lojas que atingiram a meta</div>
                <div class="kpi-header">
                    <div class="kpi-icon green"><i class="fas fa-trophy"></i></div>
                    <span class="kpi-label">Metas OK</span>
                </div>
                <div class="kpi-main">
                    <span class="kpi-value success" id="metasAtingidasValor">0</span>
                    <span class="kpi-sub" id="metasPercentual">0%</span>
                </div>
                <div class="kpi-comparison">das lojas ativas</div>
            </div>

            <div class="kpi-card" onclick="filtrarPorStatus('N√ÉO')">
                <div class="tooltip" id="tooltipMetasNao">Lojas abaixo da meta</div>
                <div class="kpi-header">
                    <div class="kpi-icon red"><i class="fas fa-times-circle"></i></div>
                    <span class="kpi-label">Abaixo da Meta</span>
                </div>
                <div class="kpi-main">
                    <span class="kpi-value danger" id="metasNaoValor">0</span>
                    <span class="kpi-sub" id="metasNaoPercentual">0%</span>
                </div>
                <div class="kpi-comparison">das lojas ativas</div>
            </div>

            <div class="kpi-card" onclick="filtrarPorStatus('FECHADA')">
                <div class="tooltip" id="tooltipFechadas">Lojas fechadas no per√≠odo</div>
                <div class="kpi-header">
                    <div class="kpi-icon red"><i class="fas fa-store-slash"></i></div>
                    <span class="kpi-label">Fechadas</span>
                </div>
                <div class="kpi-main">
                    <span class="kpi-value danger" id="lojasFechadas">0</span>
                    <span class="kpi-sub" id="percentualFechadas">0%</span>
                </div>
                <div class="kpi-comparison">do total</div>
            </div>
        </div>

        <!-- Status Cards Modernos -->
        <div class="lojas-status-grid">
            <div class="status-card" onclick="filtrarPorStatus('OPERACAO')">
                <div class="tooltip" id="tooltipOperacao">Lojas que realizaram vendas</div>
                <div class="status-titulo">
                    <i class="fas fa-store-alt" style="color: var(--success);"></i> Lojas em Opera√ß√£o
                </div>
                <div class="status-valor success" id="lojasOperacaoValor">0</div>
                <div class="status-percentual success" id="lojasOperacaoPercentual">0%</div>
            </div>

            <div class="status-card" onclick="filtrarPorStatus('FECHADA')">
                <div class="tooltip" id="tooltipFechadas2">Lojas sem vendas no per√≠odo</div>
                <div class="status-titulo">
                    <i class="fas fa-store-slash" style="color: var(--danger);"></i> Lojas Fechadas
                </div>
                <div class="status-valor danger" id="lojasFechadasValor">0</div>
                <div class="status-percentual danger" id="lojasFechadasPercentual">0%</div>
            </div>
        </div>

        <!-- Grid de Gr√°ficos Modernos -->
        <div class="charts-grid-2col">
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-pie"></i> Distribui√ß√£o por Canal</h3>
                    <span class="badge">Vendas</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="canalPieChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-bar"></i> Top 10 Faturamento</h3>
                    <span class="badge">Ranking</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="top10BarChart"></canvas>
                </div>
            </div>
        </div>

        <div class="charts-grid-3col">
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-line"></i> Desempenho por Loja</h3>
                    <span class="badge">% Meta</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="desempenhoBarChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-tachometer-alt"></i> Ranking por ADM</h3>
                    <span class="badge">Faturamento</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="admRankingChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-simple"></i> Canais por ADM</h3>
                    <span class="badge">An√°lise</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="canaisPorAdmChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Ranking de Performance Moderno -->
        <div class="melhores-adm-container">
            <div class="melhores-adm-header">
                <i class="fas fa-trophy"></i> Ranking de Performance por ADM
            </div>
            <div class="adm-ranking-list" id="admRankingList"></div>
        </div>

        <!-- Tabela Detalhamento Moderna -->
        <div class="tables-section">
            <div class="table-card">
                <div class="table-header">
                    <h2><i class="fas fa-list"></i> Detalhamento de Vendas por Loja</h2>
                    <span class="badge"><span id="registrosCount">0</span> registros</span>
                </div>
                <div class="table-wrapper">
                    <table id="mainTable">
                        <thead>
                            <tr>
                                <th onclick="ordenarTabela(0)">Data <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(1)">Loja <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(2)">ADM <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(3)">In√≠cio <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(4)">Fim <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(5)">Cupons <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(6)">Faturamento <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(7)">Meta <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(8)">Diferen√ßa <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(9)">% <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(10)">Status <i class="fas fa-sort"></i></th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Lista de Lojas Fechadas (escondida) -->
        <div id="listaFechadasExpandida" style="display: none; margin-bottom: 20px; background: var(--danger-light); padding: 20px; border-radius: var(--border-radius-sm);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h4 style="color: var(--danger); font-weight: 700;"><i class="fas fa-door-closed"></i> Lojas Fechadas no Per√≠odo:</h4>
                <button onclick="document.getElementById('listaFechadasExpandida').style.display='none'" style="background: none; border: none; cursor: pointer; color: var(--gray); font-size: 18px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="listaFechadasCompleta" style="font-size: 14px; color: var(--dark); line-height: 1.6;"></div>
        </div>

        <div class="footer">
            <p>¬© 2026 Ragazzo Express - Dashboard Moderno v2.0 - Dados persistidos no navegador</p>
        </div>
    </div>

    <script>
        // Mapeamento (mantido igual)
        const lojaNomes = {
            5: "ANTONIO AGU",
            10: "OSASCO PLAZA",
            28: "SHOPPING TAMBOR√â",
            31: "AUGUSTA",
            63: "SHOPPING ITAPECERICA",
            69: "PERUS",
            73: "BRIGADEIRO JARDINS",
            82: "TEODORO SAMPAIO",
            86: "REX RAFAEL DE BARROS",
            90: "SHOPPING PARQUE BARUERI",
            97: "ASSA√ç JO√ÉO DIAS",
            98: "FRANCO DA ROCHA",
            101: "CARREFOUR RAPOSO TAVARES",
            118: "SHOPPING ITAPECERICA II",
            126: "OSASCO JO√ÉO DE ANDRADE",
            133: "PARQUE TIET√ä",
            145: "ITASHOPPING",
            157: "JARDIM S√ÉO LUIZ",
            158: "ASSA√ç CARAPICU√çBA",
            162: "MARQUESA TAIPAS",
            178: "EXTRA CARAPICU√çBA",
            183: "FRANCO DA ROCHA 2",
            189: "SHOPPING PATIO CIAN√ä",
            195: "EXTRA JARAGU√Å",
            210: "ASSA√ç ABOLI√á√ÉO CAMPINAS",
            247: "METR√î CCR VILA DAS BELEZAS",
            248: "METR√î CCR CAP√ÉO REDONDO",
            251: "SOROCABA CENTRO",
            262: "ASSA√ç INDAIATUBA",
            285: "EXTRA JARDIM √ÇNGELA",
            294: "SHOPPING RAPOSO"
        };

        const admPorLoja = {
            247: "Thais", 157: "Thais", 63: "Thais", 285: "Thais", 118: "Thais", 248: "Thais", 97: "Thais",
            262: "Fernando", 210: "Fernando",
            31: "Hedla", 73: "Hedla", 86: "Hedla", 82: "Hedla",
            145: "Elves", 251: "Elves", 294: "Elves", 101: "Elves", 189: "Elves",
            69: "Gabriela", 162: "Gabriela", 195: "Gabriela", 133: "Gabriela", 183: "Gabriela", 98: "Gabriela",
            158: "Marcia", 90: "Marcia", 28: "Marcia", 178: "Marcia",
            5: "Wagner", 126: "Wagner", 10: "Wagner"
        };

        // Vari√°veis (mantido igual)
        let dadosCompletos = [];
        const dadosPorData = {};
        let dataInicio = "", dataFim = "";
        let periodoSelecionado = "hoje";
        let canalPieChart, top10BarChart, desempenhoBarChart, admRankingChart, canaisPorAdmChart;
        let lojasSelecionadas = [];
        let todasLojas = [];
        let ordemAtual = { coluna: -1, ascendente: true };
        let termoBuscaLojas = '';

        // Fun√ß√µes (mantidas iguais)
        document.addEventListener('DOMContentLoaded', carregarDadosSalvos);

        function carregarDadosSalvos() {
            const dadosSalvos = localStorage.getItem('ragazzoDados');
            if (dadosSalvos) {
                try {
                    const parsed = JSON.parse(dadosSalvos);
                    if (parsed?.dadosCompletos?.length) {
                        dadosCompletos = parsed.dadosCompletos;
                        document.getElementById('dataAtualizacao').innerText = parsed.dataAtualizacao || new Date().toLocaleString('pt-BR');
                        
                        for (let key in dadosPorData) delete dadosPorData[key];
                        dadosCompletos.forEach(reg => {
                            if (reg.data) {
                                if (!dadosPorData[reg.data]) dadosPorData[reg.data] = [];
                                dadosPorData[reg.data].push(reg);
                            }
                        });

                        todasLojas = [...new Set(dadosCompletos.map(d => d.loja))].sort((a,b)=>a-b);
                        lojasSelecionadas = [...todasLojas];
                        
                        document.getElementById('totalLojasHeader').innerText = todasLojas.length;
                        document.getElementById('selectedCount').innerText = todasLojas.length;
                        
                        const datas = Object.keys(dadosPorData).sort();
                        if (datas.length) dataInicio = dataFim = datas[0];
                        
                        preencherOpcoesLojas();
                        preencherADMFilter();
                        atualizarTextoSelecionadas();
                        setPeriodo('hoje');
                    }
                } catch (e) { console.error(e); }
            }
        }

        function salvarDados(nomeArquivo) {
            localStorage.setItem('ragazzoDados', JSON.stringify({
                dadosCompletos,
                dataAtualizacao: new Date().toLocaleString('pt-BR')
            }));
        }

        function limparDadosSalvos() {
            if (confirm('Limpar dados salvos?')) {
                localStorage.removeItem('ragazzoDados');
                location.reload();
            }
        }

        function recarregarDados() {
            carregarDadosSalvos();
        }

        function filtrarPorStatus(status) {
            const select = document.getElementById('statusFilter');
            if (!select) return;
            
            if (status === 'OPERACAO') {
                select.value = '';
            } else {
                select.value = status;
            }
            aplicarFiltrosAutom√°tico();
        }

        window.toggleLojaDropdown = function() {
            const dropdown = document.getElementById('lojaDropdown');
            if (dropdown) dropdown.classList.add('show');
            const search = document.getElementById('lojaSearch');
            if (search) {
                search.value = termoBuscaLojas;
                search.focus();
            }
            filtrarLojas();
        };

        window.fecharDropdownLojas = function() {
            const dropdown = document.getElementById('lojaDropdown');
            if (dropdown) dropdown.classList.remove('show');
        };

        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('lojaDropdown');
            const multiSelect = document.getElementById('lojaMultiSelect');
            
            if (dropdown && multiSelect) {
                if (!multiSelect.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            }
        });

        window.filtrarLojas = function() {
            const searchInput = document.getElementById('lojaSearch');
            if (searchInput) {
                termoBuscaLojas = searchInput.value.toLowerCase();
            }
            const options = document.querySelectorAll('.option-item');
            options.forEach(opt => {
                const span = opt.querySelector('span');
                if (span) {
                    const texto = span.innerText.toLowerCase();
                    opt.style.display = texto.includes(termoBuscaLojas) ? 'flex' : 'none';
                }
            });
        };

        const searchInput = document.getElementById('lojaSearch');
        if (searchInput) {
            searchInput.addEventListener('keyup', filtrarLojas);
        }

        window.toggleLoja = function(loja) {
            const index = lojasSelecionadas.indexOf(loja);
            if (index === -1) lojasSelecionadas.push(loja);
            else lojasSelecionadas.splice(index, 1);
            atualizarTextoSelecionadas();
            preencherOpcoesLojas();
            aplicarFiltrosAutom√°tico();
        };

        window.toggleAllLojas = function() {
            lojasSelecionadas = lojasSelecionadas.length === todasLojas.length ? [] : [...todasLojas];
            atualizarTextoSelecionadas();
            preencherOpcoesLojas();
            aplicarFiltrosAutom√°tico();
        };

        function aplicarFiltrosAutom√°tico() {
            const dados = getDadosPeriodo();
            const statusSelect = document.getElementById('statusFilter');
            const admSelect = document.getElementById('admFilter');
            
            const status = statusSelect ? statusSelect.value : '';
            const admFiltro = admSelect ? admSelect.value : '';
            
            const filtrados = dados.filter(l => {
                if (lojasSelecionadas.length && !lojasSelecionadas.includes(l.loja)) return false;
                if (status && l.status !== status) return false;
                if (admFiltro && l.adm !== admFiltro) return false;
                return true;
            });
            
            carregarTabela();
            atualizarLojasIndicadores(dados);
            atualizarMelhoresADMs(filtrados);
            atualizarGraficos(filtrados);
            atualizarTooltips(dados);
        }

        function atualizarTooltips(dados) {
            const ativas = dados.filter(l => l.faturamento > 0).map(l => `${l.loja} - ${lojaNomes[l.loja]}`).join(', ');
            const metasSim = dados.filter(l => l.status === 'SIM').map(l => `${l.loja} - ${lojaNomes[l.loja]}`).join(', ');
            const metasNao = dados.filter(l => l.status === 'N√ÉO').map(l => `${l.loja} - ${lojaNomes[l.loja]}`).join(', ');
            const fechadas = dados.filter(l => l.status === 'FECHADA').map(l => `${l.loja} - ${lojaNomes[l.loja]}`).join(', ');
            
            const tooltipTotal = document.getElementById('tooltipTotalLojas');
            if (tooltipTotal) tooltipTotal.innerText = `Total: ${dados.length} lojas`;
            
            const tooltipMetasOK = document.getElementById('tooltipMetasOK');
            if (tooltipMetasOK) tooltipMetasOK.innerText = metasSim || 'Nenhuma loja';
            
            const tooltipMetasNao = document.getElementById('tooltipMetasNao');
            if (tooltipMetasNao) tooltipMetasNao.innerText = metasNao || 'Nenhuma loja';
            
            const tooltipFechadas = document.getElementById('tooltipFechadas');
            if (tooltipFechadas) tooltipFechadas.innerText = fechadas || 'Nenhuma loja';
            
            const tooltipOperacao = document.getElementById('tooltipOperacao');
            if (tooltipOperacao) tooltipOperacao.innerText = ativas || 'Nenhuma loja';
            
            const tooltipFechadas2 = document.getElementById('tooltipFechadas2');
            if (tooltipFechadas2) tooltipFechadas2.innerText = fechadas || 'Nenhuma loja';
        }

        function processarPlanilha(input) {
            if (!input.files?.[0]) return;
            
            const arquivo = input.files[0];
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const dadosBrutos = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (dadosBrutos.length < 2) return alert('Planilha vazia');

                    dadosCompletos = [];
                    for (let i = 1; i < dadosBrutos.length; i++) {
                        const linha = dadosBrutos[i];
                        if (!linha?.length) continue;
                        
                        let codigoLoja = linha[0];
                        if (!codigoLoja) continue;
                        if (typeof codigoLoja === 'string') codigoLoja = parseInt(codigoLoja.replace(/\D/g, ''));
                        if (!lojaNomes[codigoLoja]) continue;
                        
                        let dataStr = linha[2];
                        if (dataStr && typeof dataStr === 'number') {
                            const d = XLSX.SSF.parse_date_code(dataStr);
                            if (d) dataStr = `${d.d.toString().padStart(2,'0')}/${d.m.toString().padStart(2,'0')}/${d.y}`;
                        } else if (typeof dataStr === 'string' && dataStr.includes('-')) {
                            const partes = dataStr.split(' ')[0].split('-');
                            if (partes.length === 3) dataStr = `${partes[2]}/${partes[1]}/${partes[0]}`;
                        }
                        
                        const fat = parseFloat(linha[6]) || 0;
                        const meta = parseFloat(linha[7]) || 0;
                        
                        let inicio = extrairHora(linha[3]);
                        let fim = extrairHora(linha[4]);
                        
                        dadosCompletos.push({
                            loja: codigoLoja,
                            adm: admPorLoja[codigoLoja] || 'N√£o mapeado',
                            data: dataStr || null,
                            inicio: inicio,
                            fim: fim,
                            cupons: parseFloat(linha[5]) || 0,
                            faturamento: fat,
                            meta: meta,
                            dif: fat - meta,
                            difPercentual: meta > 0 ? ((fat-meta)/meta*100) : 0,
                            status: fat > 0 ? (fat >= meta ? 'SIM' : 'N√ÉO') : 'FECHADA',
                            canais: {
                                auto: parseFloat(linha[10]) || 0,
                                delivery: parseFloat(linha[11]) || 0,
                                viagem: parseFloat(linha[12]) || 0,
                                balcao: parseFloat(linha[14]) || 0
                            }
                        });
                    }

                    for (let key in dadosPorData) delete dadosPorData[key];
                    dadosCompletos.forEach(reg => {
                        if (reg.data) {
                            if (!dadosPorData[reg.data]) dadosPorData[reg.data] = [];
                            dadosPorData[reg.data].push(reg);
                        }
                    });

                    todasLojas = [...new Set(dadosCompletos.map(d => d.loja))].sort((a,b)=>a-b);
                    lojasSelecionadas = [...todasLojas];
                    
                    document.getElementById('totalLojasHeader').innerText = todasLojas.length;
                    document.getElementById('selectedCount').innerText = todasLojas.length;
                    
                    const datas = Object.keys(dadosPorData).sort();
                    if (datas.length) dataInicio = dataFim = datas[0];
                    
                    document.getElementById('dataAtualizacao').innerText = new Date().toLocaleString('pt-BR');
                    
                    preencherOpcoesLojas();
                    preencherADMFilter();
                    atualizarTextoSelecionadas();
                    setPeriodo('hoje');
                    salvarDados(arquivo.name);
                    
                } catch (error) { alert('Erro: ' + error.message); }
            };
            reader.readAsArrayBuffer(arquivo);
        }

        function extrairHora(valor) {
            if (!valor || valor === 'NULL' || valor === null) return '-';
            
            if (typeof valor === 'number') {
                const dataObj = XLSX.SSF.parse_date_code(valor);
                if (dataObj) {
                    return `${dataObj.H.toString().padStart(2,'0')}:${dataObj.M.toString().padStart(2,'0')}`;
                }
            }
            
            const str = String(valor).trim();
            
            if (str.includes(' ')) {
                const partes = str.split(' ');
                if (partes.length > 1) {
                    const horaPartes = partes[1].split(':');
                    if (horaPartes.length >= 2) {
                        return `${horaPartes[0].padStart(2,'0')}:${horaPartes[1].padStart(2,'0')}`;
                    }
                }
            }
            
            if (str.includes(':')) {
                const partes = str.split(':');
                if (partes.length >= 2) {
                    return `${partes[0].padStart(2,'0')}:${partes[1].padStart(2,'0')}`;
                }
            }
            
            return '-';
        }

        function preencherOpcoesLojas() {
            const optionsDiv = document.getElementById('lojaOptions');
            if (!optionsDiv) return;
            
            let html = '';
            todasLojas.forEach(loja => {
                const nome = lojaNomes[loja] || `Loja ${loja}`;
                const adm = admPorLoja[loja] || '?';
                const checked = lojasSelecionadas.includes(loja) ? 'checked' : '';
                const selectedClass = lojasSelecionadas.includes(loja) ? 'selected' : '';
                html += `<div class="option-item ${selectedClass}" onclick="toggleLoja(${loja})">
                    <input type="checkbox" ${checked} onchange="toggleLoja(${loja})">
                    <span><strong>${loja}</strong> - ${nome} (${adm})</span>
                </div>`;
            });
            optionsDiv.innerHTML = html;
            filtrarLojas();
        }

        function preencherADMFilter() {
            const select = document.getElementById('admFilter');
            if (!select) return;
            
            select.innerHTML = '<option value="">Todos os ADMs</option>';
            const adms = [...new Set(dadosCompletos.map(d => d.adm))].sort();
            adms.forEach(adm => {
                if (adm && adm !== 'N√£o mapeado') {
                    select.innerHTML += `<option value="${adm}">${adm}</option>`;
                }
            });
        }

        function atualizarTextoSelecionadas() {
            const count = lojasSelecionadas.length;
            const countSpan = document.getElementById('selectedCount');
            const textSpan = document.getElementById('selectedLojasText');
            
            if (countSpan) countSpan.innerText = count;
            if (textSpan) {
                textSpan.innerText = count === 0 ? 'Nenhuma loja' : count === todasLojas.length ? 'Todas as Lojas' : `${count} lojas selecionadas`;
            }
        }

        function getDadosPeriodo() {
            if (!dataInicio || !dataFim || !Object.keys(dadosPorData).length) return [];
            const dados = [];
            for (let data in dadosPorData) {
                if (isDataNoPeriodo(data, dataInicio, dataFim)) {
                    dados.push(...dadosPorData[data]);
                }
            }
            return dados;
        }

        function isDataNoPeriodo(data, inicio, fim) {
            if (!data) return false;
            try {
                const [dD,mD,aD] = data.split('/').map(Number);
                const [dI,mI,aI] = inicio.split('/').map(Number);
                const [dF,mF,aF] = fim.split('/').map(Number);
                const dataObj = new Date(aD,mD-1,dD);
                return dataObj >= new Date(aI,mI-1,dI) && dataObj <= new Date(aF,mF-1,dF);
            } catch { return false; }
        }

        function setPeriodo(tipo) {
            periodoSelecionado = tipo;
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector(`.period-btn[onclick="setPeriodo('${tipo}')"]`);
            if (btn) btn.classList.add('active');
            
            const datas = Object.keys(dadosPorData).sort((a,b) => {
                const [dA,mA,anA] = a.split('/');
                const [dB,mB,anB] = b.split('/');
                return new Date(anB,mB-1,dB) - new Date(anA,mA-1,dA);
            });
            
            if (!datas.length) return;
            
            const ultima = datas[0];
            const primeira = datas[datas.length-1];
            
            if (tipo === 'hoje') { dataInicio = dataFim = ultima; }
            else if (tipo === 'ontem') { dataInicio = dataFim = datas[1] || ultima; }
            else if (tipo === '7d') { dataInicio = datas[Math.min(datas.length-1,6)] || primeira; dataFim = ultima; }
            else if (tipo === '15d') { dataInicio = datas[Math.min(datas.length-1,14)] || primeira; dataFim = ultima; }
            else if (tipo === 'mes') { dataInicio = primeira; dataFim = ultima; }
            
            const dateRange = document.getElementById('dateRangeInputs');
            if (dateRange) dateRange.style.display = tipo === 'custom' ? 'flex' : 'none';
            
            atualizarPeriodoDisplay();
            recarregarTudo();
        }

        function atualizarPorData() {
            if (periodoSelecionado === 'custom') {
                const inicio = document.getElementById('dataInicio');
                const fim = document.getElementById('dataFim');
                if (inicio && fim && inicio.value && fim.value) {
                    const [aI,mI,dI] = inicio.value.split('-');
                    const [aF,mF,dF] = fim.value.split('-');
                    dataInicio = `${dI}/${mI}/${aI}`;
                    dataFim = `${dF}/${mF}/${aF}`;
                    atualizarPeriodoDisplay();
                    recarregarTudo();
                }
            }
        }

        function atualizarPeriodoDisplay() {
            if (!dataInicio) return;
            const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
            if (dataInicio === dataFim) {
                const [d,m,a] = dataInicio.split('/');
                const headerDay = document.getElementById('headerDay');
                const headerMonth = document.getElementById('headerMonth');
                if (headerDay) headerDay.innerText = d;
                if (headerMonth) headerMonth.innerText = meses[m-1].toUpperCase() + ' ' + a;
            } else {
                const [dI,mI,aI] = dataInicio.split('/');
                const headerDay = document.getElementById('headerDay');
                const headerMonth = document.getElementById('headerMonth');
                if (headerDay) headerDay.innerText = dI + '-' + dataFim.split('/')[0];
                if (headerMonth) headerMonth.innerText = meses[mI-1].toUpperCase() + ' ' + aI;
            }
        }

        function recarregarTudo() {
            if (!Object.keys(dadosPorData).length) return;
            const dados = getDadosPeriodo();
            if (!dados.length) return;
            
            todasLojas = [...new Set(dados.map(l=>l.loja))].sort((a,b)=>a-b);
            lojasSelecionadas = [...todasLojas];
            
            preencherOpcoesLojas();
            atualizarTextoSelecionadas();
            carregarTabela();
            destruirGraficos();
            inicializarGraficos();
            atualizarKPIs();
            atualizarLojasIndicadores(dados);
            atualizarMelhoresADMs(dados);
            atualizarGraficos(dados);
            atualizarTooltips(dados);
        }

        function formatMoney(v) {
            if (isNaN(v)) v = 0;
            return v.toFixed(2).replace('.',',').replace(/\B(?=(\d{3})+(?!\d))/g,'.');
        }

        function carregarTabela() {
            const statusSelect = document.getElementById('statusFilter');
            const admSelect = document.getElementById('admFilter');
            
            const status = statusSelect ? statusSelect.value : '';
            const admFiltro = admSelect ? admSelect.value : '';
            
            const dados = getDadosPeriodo().filter(l => {
                if (lojasSelecionadas.length && !lojasSelecionadas.includes(l.loja)) return false;
                if (status && l.status !== status) return false;
                if (admFiltro && l.adm !== admFiltro) return false;
                return true;
            });
            
            let html = '';
            dados.forEach(l => {
                const nome = lojaNomes[l.loja] || `Loja ${l.loja}`;
                const difClass = l.dif >= 0 ? 'valor-positivo' : 'valor-negativo';
                const statusClass = l.status === 'SIM' ? 'meta-sim' : l.status === 'FECHADA' ? 'loja-fechada' : 'meta-nao';
                const sinal = l.dif > 0 ? '+' : '';
                
                html += `<tr>
                    <td>${l.data || '-'}</td>
                    <td><span class="store-name">${l.loja} - ${nome}</span></td>
                    <td>${l.adm}</td>
                    <td class="hora-cell">${l.inicio}</td>
                    <td class="hora-cell">${l.fim}</td>
                    <td>${l.cupons}</td>
                    <td class="currency ${difClass}">R$ ${formatMoney(l.faturamento)}</td>
                    <td class="currency">R$ ${formatMoney(l.meta)}</td>
                    <td class="currency ${difClass}">${l.dif >= 0 ? '+' : '-'} R$ ${formatMoney(Math.abs(l.dif))}</td>
                    <td class="${difClass}">${l.meta > 0 ? sinal + l.difPercentual.toFixed(2)+'%' : '-'}</td>
                    <td><span class="${statusClass}">${l.status}</span></td>
                </tr>`;
            });
            const tableBody = document.getElementById('tableBody');
            if (tableBody) {
                tableBody.innerHTML = html || '<tr><td colspan="11">Nenhum registro encontrado</td></tr>';
            }
            
            const registrosCount = document.getElementById('registrosCount');
            if (registrosCount) registrosCount.innerText = dados.length;
            
            atualizarKPIs(dados);
        }

        function atualizarKPIs(dadosFiltrados = null) {
            const statusSelect = document.getElementById('statusFilter');
            const admSelect = document.getElementById('admFilter');
            
            const status = statusSelect ? statusSelect.value : '';
            const admFiltro = admSelect ? admSelect.value : '';
            
            const dados = dadosFiltrados || getDadosPeriodo().filter(l => {
                if (lojasSelecionadas.length && !lojasSelecionadas.includes(l.loja)) return false;
                if (status && l.status !== status) return false;
                if (admFiltro && l.adm !== admFiltro) return false;
                return true;
            });
            
            let fat=0, meta=0, cupons=0;
            dados.forEach(l => { fat+=l.faturamento; meta+=l.meta; cupons+=l.cupons; });
            
            const dif = fat - meta;
            const pctDif = meta>0 ? (dif/meta*100) : 0;
            const ticket = cupons>0 ? fat/cupons : 0;
            
            const lojasUnicas = [...new Set(dados.map(l=>l.loja))];
            const total = lojasUnicas.length;
            const dias = [...new Set(dados.map(l=>l.data))].length;
            
            const ativas = dados.filter(l=>l.faturamento>0).length;
            const fechadas = dados.filter(l=>l.status==='FECHADA').length;
            const metasSim = dados.filter(l=>l.status==='SIM').length;
            const metasNao = dados.filter(l=>l.status==='N√ÉO').length;
            
            const totalFaturamento = document.getElementById('totalFaturamento');
            if (totalFaturamento) totalFaturamento.innerText = `R$ ${formatMoney(fat)}`;
            
            const totalMeta = document.getElementById('totalMeta');
            if (totalMeta) totalMeta.innerText = `R$ ${formatMoney(meta)}`;
            
            const totalDiferenca = document.getElementById('totalDiferenca');
            if (totalDiferenca) {
                totalDiferenca.innerText = `${dif >= 0 ? '+' : '-'} R$ ${formatMoney(Math.abs(dif))}`;
                if (dif < 0) totalDiferenca.classList.add('danger');
                else totalDiferenca.classList.remove('danger');
            }
            
            const totalLojas = document.getElementById('totalLojas');
            if (totalLojas) totalLojas.innerText = total;
            
            const totalLojasPeriodo = document.getElementById('totalLojasPeriodo');
            if (totalLojasPeriodo) totalLojasPeriodo.innerText = `${dias} dia${dias > 1 ? 's' : ''}`;
            
            const diferencaEmoji = document.getElementById('diferencaEmoji');
            if (diferencaEmoji) diferencaEmoji.innerText = dif >= 0 ? '‚úÖ' : '‚ùå';
            
            const diferencaText = document.getElementById('diferencaText');
            if (diferencaText) diferencaText.innerText = (dif>=0?'+':'')+pctDif.toFixed(1)+'%';
            
            const percentualMeta = document.getElementById('percentualMeta');
            if (percentualMeta) {
                percentualMeta.innerHTML = `<span class="${dif>=0?'trend-up':'trend-down'}">${dif>=0?'+':''}${pctDif.toFixed(1)}%</span> vs meta`;
            }
            
            const ticketMedio = document.getElementById('ticketMedio');
            if (ticketMedio) ticketMedio.innerText = `R$ ${formatMoney(ticket)}`;
            
            const ticketPeriodo = document.getElementById('ticketPeriodo');
            if (ticketPeriodo) ticketPeriodo.innerText = dias===1?'hoje':`m√©dia ${dias} dias`;
            
            const metasAtingidas = document.getElementById('metasAtingidas');
            if (metasAtingidas) metasAtingidas.innerHTML = `${metasSim}/${total}`;
            
            const metasAtingidasValor = document.getElementById('metasAtingidasValor');
            if (metasAtingidasValor) metasAtingidasValor.innerText = metasSim;
            
            const metasPercentual = document.getElementById('metasPercentual');
            if (metasPercentual) metasPercentual.innerText = ativas>0 ? ((metasSim/ativas)*100).toFixed(1)+'%' : '0%';
            
            const metasNaoValor = document.getElementById('metasNaoValor');
            if (metasNaoValor) metasNaoValor.innerText = metasNao;
            
            const metasNaoPercentual = document.getElementById('metasNaoPercentual');
            if (metasNaoPercentual) metasNaoPercentual.innerText = ativas>0 ? ((metasNao/ativas)*100).toFixed(1)+'%' : '0%';
            
            const lojasEmOperacao = document.getElementById('lojasEmOperacao');
            if (lojasEmOperacao) lojasEmOperacao.innerText = ativas;
            
            const percentualOperacao = document.getElementById('percentualOperacao');
            if (percentualOperacao) percentualOperacao.innerText = total>0 ? ((ativas/total)*100).toFixed(1)+'%' : '0%';
            
            const lojasAtivas = document.getElementById('lojasAtivas');
            if (lojasAtivas) lojasAtivas.innerHTML = `${ativas} ativas (${total>0?((ativas/total)*100).toFixed(1):0}%)`;
            
            const lojasFechadas = document.getElementById('lojasFechadas');
            if (lojasFechadas) lojasFechadas.innerText = fechadas;
            
            const percentualFechadas = document.getElementById('percentualFechadas');
            if (percentualFechadas) percentualFechadas.innerText = total>0 ? ((fechadas/total)*100).toFixed(1)+'%' : '0%';
            
            const progressoMeta = document.getElementById('progressoMeta');
            if (progressoMeta) progressoMeta.style.width = meta>0 ? Math.min(100, fat/meta*100)+'%' : '0%';
        }

        function atualizarLojasIndicadores(dados) {
            const lojasUnicas = [...new Set(dados.map(l=>l.loja))];
            const total = lojasUnicas.length;
            const ativas = dados.filter(l=>l.faturamento>0).length;
            const fechadas = dados.filter(l=>l.status==='FECHADA').length;
            
            const lojasOperacaoValor = document.getElementById('lojasOperacaoValor');
            if (lojasOperacaoValor) lojasOperacaoValor.innerText = ativas;
            
            const lojasOperacaoPercentual = document.getElementById('lojasOperacaoPercentual');
            if (lojasOperacaoPercentual) lojasOperacaoPercentual.innerText = `${((ativas/total)*100).toFixed(1)}%`;
            
            const lojasFechadasValor = document.getElementById('lojasFechadasValor');
            if (lojasFechadasValor) lojasFechadasValor.innerText = fechadas;
            
            const lojasFechadasPercentual = document.getElementById('lojasFechadasPercentual');
            if (lojasFechadasPercentual) lojasFechadasPercentual.innerText = `${((fechadas/total)*100).toFixed(1)}%`;
            
            const fechadasList = dados.filter(l=>l.status==='FECHADA').map(l=>`${l.loja} - ${lojaNomes[l.loja]}`).join(' ¬∑ ');
            const listaFechadasCompleta = document.getElementById('listaFechadasCompleta');
            if (listaFechadasCompleta) {
                listaFechadasCompleta.innerHTML = fechadasList || 'Nenhuma loja fechada no per√≠odo';
            }
        }

        function atualizarMelhoresADMs(dados) {
            const admDados = {};
            dados.forEach(l => {
                if (!admDados[l.adm]) admDados[l.adm] = { 
                    lojas: new Set(), 
                    fat: 0, 
                    meta: 0,
                    vendas: 0
                };
                admDados[l.adm].lojas.add(l.loja);
                admDados[l.adm].fat += l.faturamento;
                admDados[l.adm].meta += l.meta;
                if (l.faturamento > 0) admDados[l.adm].vendas++;
            });
            
            const admArray = Object.entries(admDados).map(([adm, d]) => {
                const atingimento = d.meta > 0 ? (d.fat / d.meta * 100) : 0;
                return {
                    adm,
                    lojas: d.lojas.size,
                    fat: d.fat,
                    meta: d.meta,
                    atingimento,
                    vendas: d.vendas
                };
            }).sort((a, b) => b.atingimento - a.atingimento);
            
            let html = '';
            admArray.forEach((adm, index) => {
                const posicao = index + 1;
                let classePercentual = 'baixa';
                if (adm.atingimento >= 100) classePercentual = 'alta';
                else if (adm.atingimento >= 70) classePercentual = 'media';
                
                let medalha = '';
                if (posicao === 1) medalha = 'ü•á';
                else if (posicao === 2) medalha = 'ü•à';
                else if (posicao === 3) medalha = 'ü•â';
                
                html += `
                    <div class="adm-ranking-item" style="border-left-color: ${adm.atingimento >= 100 ? '#06d6a0' : (adm.atingimento >= 70 ? '#f97316' : '#ef476f')};">
                        <div class="adm-ranking-posicao">${medalha || posicao}</div>
                        <div class="adm-ranking-info">
                            <div class="adm-ranking-nome">${adm.adm} ${medalha}</div>
                            <div class="adm-ranking-detalhes">
                                <span class="adm-ranking-faturamento">R$ ${formatMoney(adm.fat)}</span>
                                <span class="adm-ranking-meta">Meta: R$ ${formatMoney(adm.meta)}</span>
                                <span class="adm-ranking-percentual ${classePercentual}">${adm.atingimento.toFixed(1)}%</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            const admRankingList = document.getElementById('admRankingList');
            if (admRankingList) {
                admRankingList.innerHTML = html || '<div>Nenhum dado dispon√≠vel</div>';
            }
        }

        function atualizarGraficos(dados) {
            let auto = 0, delivery = 0, viagem = 0, balcao = 0;
            dados.forEach(l => {
                auto += l.canais.auto;
                delivery += l.canais.delivery;
                viagem += l.canais.viagem;
                balcao += l.canais.balcao;
            });
            
            if (canalPieChart) {
                canalPieChart.data.datasets[0].data = [auto, delivery, viagem, balcao];
                canalPieChart.update();
            }
            
            const lojaAgg = {};
            dados.forEach(l => {
                if (!lojaAgg[l.loja]) lojaAgg[l.loja] = { 
                    fat: 0, 
                    meta: 0,
                    nome: lojaNomes[l.loja],
                    cod: l.loja
                };
                lojaAgg[l.loja].fat += l.faturamento;
                lojaAgg[l.loja].meta += l.meta;
            });
            
            Object.values(lojaAgg).forEach(l => {
                l.atingimento = l.meta > 0 ? (l.fat / l.meta * 100) : 0;
            });
            
            const topLojas = Object.values(lojaAgg)
                .filter(l => l.fat > 0)
                .sort((a,b) => b.fat - a.fat)
                .slice(0, 15);
            
            if (top10BarChart) {
                top10BarChart.data.labels = topLojas.map(l => l.nome.substring(0,12));
                top10BarChart.data.datasets[0].data = topLojas.map(l => l.fat);
                top10BarChart.update();
            }
            
            const desempenhoLojas = Object.values(lojaAgg)
                .filter(l => l.fat > 0)
                .sort((a,b) => b.atingimento - a.atingimento)
                .slice(0, 12);
            
            if (desempenhoBarChart) {
                desempenhoBarChart.data.labels = desempenhoLojas.map(l => l.nome.substring(0,12));
                desempenhoBarChart.data.datasets[0].data = desempenhoLojas.map(l => l.atingimento);
                desempenhoBarChart.data.datasets[0].backgroundColor = desempenhoLojas.map(l => 
                    l.atingimento >= 100 ? '#06d6a0' : '#ef476f'
                );
                desempenhoBarChart.update();
            }
            
            const admAgg = {};
            dados.forEach(l => {
                if (!admAgg[l.adm]) admAgg[l.adm] = { fat: 0 };
                admAgg[l.adm].fat += l.faturamento;
            });
            
            const admsLista = ['Thais', 'Fernando', 'Hedla', 'Elves', 'Gabriela', 'Marcia', 'Wagner']
                .filter(a => admAgg[a] && admAgg[a].fat > 0);
            
            if (admRankingChart) {
                admRankingChart.data.labels = admsLista;
                admRankingChart.data.datasets[0].data = admsLista.map(a => admAgg[a].fat);
                admRankingChart.update();
            }
            
            const admCanais = {};
            dados.forEach(l => {
                if (!admCanais[l.adm]) admCanais[l.adm] = { auto:0, del:0, via:0, bal:0 };
                admCanais[l.adm].auto += l.canais.auto;
                admCanais[l.adm].del += l.canais.delivery;
                admCanais[l.adm].via += l.canais.viagem;
                admCanais[l.adm].bal += l.canais.balcao;
            });
            
            const admsCanais = ['Thais', 'Fernando', 'Hedla', 'Elves', 'Gabriela', 'Marcia', 'Wagner']
                .filter(a => admCanais[a] && (admCanais[a].auto + admCanais[a].del + admCanais[a].via + admCanais[a].bal > 0));
            
            if (canaisPorAdmChart) {
                canaisPorAdmChart.data.labels = admsCanais;
                canaisPorAdmChart.data.datasets[0].data = admsCanais.map(a => admCanais[a]?.auto || 0);
                canaisPorAdmChart.data.datasets[1].data = admsCanais.map(a => admCanais[a]?.del || 0);
                canaisPorAdmChart.data.datasets[2].data = admsCanais.map(a => admCanais[a]?.via || 0);
                canaisPorAdmChart.data.datasets[3].data = admsCanais.map(a => admCanais[a]?.bal || 0);
                canaisPorAdmChart.update();
            }
        }

        function ordenarTabela(coluna) {
            const tbody = document.querySelector('#tableBody');
            if (!tbody) return;
            
            const linhas = Array.from(tbody.querySelectorAll('tr'));
            if (!linhas.length) return;
            
            ordemAtual.ascendente = ordemAtual.coluna === coluna ? !ordemAtual.ascendente : true;
            ordemAtual.coluna = coluna;
            
            linhas.sort((a,b) => {
                const celA = a.children[coluna]?.innerText.trim() || '';
                const celB = b.children[coluna]?.innerText.trim() || '';
                
                let valA, valB;
                if (coluna === 0) {
                    const [dA,mA,anA] = celA.split('/').map(Number);
                    const [dB,mB,anB] = celB.split('/').map(Number);
                    valA = new Date(anA,mA-1,dA);
                    valB = new Date(anB,mB-1,dB);
                } else if (coluna === 1) {
                    valA = parseInt(celA.split(' - ')[0]) || 0;
                    valB = parseInt(celB.split(' - ')[0]) || 0;
                } else if (coluna === 2) {
                    valA = celA;
                    valB = celB;
                } else if (coluna === 3 || coluna === 4) {
                    if (celA === '-') valA = -1;
                    else {
                        const [hA, mA] = celA.split(':').map(Number);
                        valA = (hA || 0) * 60 + (mA || 0);
                    }
                    if (celB === '-') valB = -1;
                    else {
                        const [hB, mB] = celB.split(':').map(Number);
                        valB = (hB || 0) * 60 + (mB || 0);
                    }
                } else if (coluna === 5) {
                    valA = parseInt(celA) || 0;
                    valB = parseInt(celB) || 0;
                } else if ([6,7,8].includes(coluna)) {
                    valA = parseFloat(celA.replace('R$','').replace(/\./g,'').replace(',','.').replace('+','').replace('-','')) || 0;
                    valB = parseFloat(celB.replace('R$','').replace(/\./g,'').replace(',','.').replace('+','').replace('-','')) || 0;
                    if (celA.includes('-')) valA = -valA;
                    if (celB.includes('-')) valB = -valB;
                } else if (coluna === 9) {
                    valA = parseFloat(celA.replace('%','').replace('+','')) || 0;
                    valB = parseFloat(celB.replace('%','').replace('+','')) || 0;
                } else if (coluna === 10) {
                    valA = celA;
                    valB = celB;
                } else {
                    valA = celA; valB = celB;
                }
                
                if (valA < valB) return ordemAtual.ascendente ? -1 : 1;
                if (valA > valB) return ordemAtual.ascendente ? 1 : -1;
                return 0;
            });
            
            tbody.innerHTML = '';
            linhas.forEach(l => tbody.appendChild(l));
            
            document.querySelectorAll('th i').forEach(i => i.className = 'fas fa-sort');
            const th = document.querySelector(`th:nth-child(${coluna+1}) i`);
            if (th) th.className = ordemAtual.ascendente ? 'fas fa-sort-up' : 'fas fa-sort-down';
        }

        function exportarExcel() {
            const dados = getDadosPeriodo();
            const statusSelect = document.getElementById('statusFilter');
            const admSelect = document.getElementById('admFilter');
            
            const status = statusSelect ? statusSelect.value : '';
            const admFiltro = admSelect ? admSelect.value : '';
            
            const filtrados = dados.filter(l => {
                if (lojasSelecionadas.length && !lojasSelecionadas.includes(l.loja)) return false;
                if (status && l.status !== status) return false;
                if (admFiltro && l.adm !== admFiltro) return false;
                return true;
            });
            
            const wb = XLSX.utils.book_new();
            
            const det = [
                ['RAGAZZO EXPRESS - SETOR PATTY'],
                [`Per√≠odo: ${dataInicio} a ${dataFim}`],
                [`Exportado: ${new Date().toLocaleString('pt-BR')}`],
                [],
                ['Data','Loja','ADM','In√≠cio','Fim','Cupons','Faturamento','Meta','Diferen√ßa','%','Status']
            ];
            filtrados.forEach(l => {
                det.push([
                    l.data, l.loja, l.adm, l.inicio, l.fim, l.cupons,
                    l.faturamento, l.meta, l.dif,
                    l.meta>0 ? l.difPercentual.toFixed(2) : '-', l.status
                ]);
            });
            
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(det), 'Detalhamento');
            XLSX.writeFile(wb, `Ragazzo_${dataInicio.replace(/\//g,'-')}.xlsx`);
        }

        function destruirGraficos() {
            if (canalPieChart) canalPieChart.destroy();
            if (top10BarChart) top10BarChart.destroy();
            if (desempenhoBarChart) desempenhoBarChart.destroy();
            if (admRankingChart) admRankingChart.destroy();
            if (canaisPorAdmChart) canaisPorAdmChart.destroy();
        }

        function inicializarGraficos() {
            Chart.defaults.font.family = 'Inter, sans-serif';
            Chart.defaults.font.size = 11;

            const canalCanvas = document.getElementById('canalPieChart');
            if (canalCanvas) {
                canalPieChart = new Chart(canalCanvas, {
                    type: 'doughnut',
                    data: { 
                        labels: ['Auto-Atendimento', 'Delivery', 'Viagem', 'Balc√£o'], 
                        datasets: [{ 
                            data: [0,0,0,0], 
                            backgroundColor: ['#4361ee', '#f72585', '#4cc9f0', '#ffd166'],
                            borderWidth: 0,
                            borderRadius: 8,
                            spacing: 4
                        }] 
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        cutout: '65%',
                        plugins: { 
                            legend: { 
                                position: 'bottom',
                                labels: { usePointStyle: true, boxWidth: 10, padding: 15 }
                            } 
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const total = ctx.dataset.data.reduce((a,b) => a + b, 0);
                                    const percent = total > 0 ? ((ctx.raw / total) * 100).toFixed(1) : 0;
                                    return `${ctx.label}: R$ ${formatMoney(ctx.raw)} (${percent}%)`;
                                }
                            }
                        }
                    }
                });
            }

            const top10Canvas = document.getElementById('top10BarChart');
            if (top10Canvas) {
                top10BarChart = new Chart(top10Canvas, {
                    type: 'bar',
                    data: { 
                        labels: [], 
                        datasets: [{ 
                            label: 'Faturamento (R$)', 
                            data: [], 
                            backgroundColor: '#2e7d32',
                            borderRadius: 8,
                            barPercentage: 0.6
                        }] 
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: (value) => 'R$ ' + (value/1000).toFixed(0) + 'k' }
                            }
                        }
                    }
                });
            }

            const desempenhoCanvas = document.getElementById('desempenhoBarChart');
            if (desempenhoCanvas) {
                desempenhoBarChart = new Chart(desempenhoCanvas, {
                    type: 'bar',
                    data: { 
                        labels: [], 
                        datasets: [{ 
                            label: '% Meta', 
                            data: [], 
                            backgroundColor: [],
                            borderRadius: 8,
                            barPercentage: 0.7
                        }] 
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 200,
                                ticks: { callback: (value) => value + '%' }
                            }
                        }
                    }
                });
            }

            const admCanvas = document.getElementById('admRankingChart');
            if (admCanvas) {
                admRankingChart = new Chart(admCanvas, {
                    type: 'bar',
                    data: { 
                        labels: [], 
                        datasets: [{ 
                            label: 'Faturamento (R$)', 
                            data: [], 
                            backgroundColor: '#2e7d32',
                            borderRadius: 8,
                            barPercentage: 0.7
                        }] 
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: (value) => 'R$ ' + (value/1000).toFixed(0) + 'k' }
                            }
                        }
                    }
                });
            }

            const canaisCanvas = document.getElementById('canaisPorAdmChart');
            if (canaisCanvas) {
                canaisPorAdmChart = new Chart(canaisCanvas, {
                    type: 'bar',
                    data: { 
                        labels: [], 
                        datasets: [
                            { label: 'Auto', data: [], backgroundColor: '#4361ee', borderRadius: 6, barPercentage: 0.8, categoryPercentage: 0.9 },
                            { label: 'Delivery', data: [], backgroundColor: '#f72585', borderRadius: 6, barPercentage: 0.8, categoryPercentage: 0.9 },
                            { label: 'Viagem', data: [], backgroundColor: '#4cc9f0', borderRadius: 6, barPercentage: 0.8, categoryPercentage: 0.9 },
                            { label: 'Balc√£o', data: [], backgroundColor: '#ffd166', borderRadius: 6, barPercentage: 0.8, categoryPercentage: 0.9 }
                        ] 
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: (value) => 'R$ ' + (value/1000).toFixed(0) + 'k' }
                            }
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>
