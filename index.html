<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <title>Setor Patty - Relatório de Metas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #f72585;
            --success: #06d6a0;
            --danger: #ef476f;
            --warning: #ffd166;
            --info: #4cc9f0;
            --light: #f8f9fa;
            --dark: #2b2d42;
            --gray: #8d99ae;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.15);
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --border-radius: 16px;
            --border-radius-sm: 12px;
            --safe-area-inset: env(safe-area-inset-top, 0px) env(safe-area-inset-right, 0px) env(safe-area-inset-bottom, 0px) env(safe-area-inset-left, 0px);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f1f5f9;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            width: 100%;
            overflow-x: hidden;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 12px;
            width: 100%;
        }

        /* Header Responsivo */
        .header {
            background: var(--gradient-1);
            border-radius: var(--border-radius);
            margin-bottom: 16px;
            color: white;
            box-shadow: var(--shadow-lg);
            width: 100%;
            overflow: hidden;
        }

        .header-content {
            padding: clamp(16px, 4vw, 30px);
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
            justify-content: space-between;
        }

        .header-title {
            flex: 1;
            min-width: 250px;
        }

        .header-title h1 {
            font-size: clamp(24px, 5vw, 32px);
            font-weight: 700;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .header-title p {
            font-size: clamp(12px, 3vw, 14px);
            opacity: 0.9;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .header-date-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255,255,255,0.15);
            border-radius: 50px;
            padding: 8px 16px;
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
            justify-content: center;
        }

        .date-nav-btn {
            background: transparent;
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 40px;
        }

        .date-nav-btn:active {
            background: rgba(255,255,255,0.3);
        }

        .date-nav-btn:disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        .current-date {
            font-weight: 600;
            font-size: clamp(14px, 4vw, 16px);
            white-space: nowrap;
        }

        .header-day-box {
            text-align: center;
            min-width: 70px;
        }

        .header-day-box .day {
            font-size: clamp(28px, 6vw, 36px);
            font-weight: 700;
            line-height: 1;
        }

        .header-day-box .month {
            font-size: clamp(12px, 3vw, 14px);
            opacity: 0.9;
            text-transform: uppercase;
        }

        /* Navegação de Data */
        .date-navigation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
            background: white;
            padding: 12px 16px;
            border-radius: 50px;
            box-shadow: var(--shadow);
            width: 100%;
        }

        .date-navigation button {
            background: var(--primary);
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .date-navigation button:active {
            background: var(--primary-dark);
            transform: scale(0.95);
        }

        .date-navigation button:disabled {
            background: var(--gray);
            opacity: 0.5;
        }

        .date-navigation span {
            font-weight: 600;
            font-size: clamp(14px, 4vw, 16px);
            color: var(--dark);
            text-align: center;
            flex: 1;
        }

        /* Filtros Responsivos */
        .filters {
            background: white;
            padding: clamp(16px, 4vw, 20px);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            width: 100%;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            color: var(--dark);
            font-weight: 600;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-group label i {
            color: var(--primary);
            width: 18px;
        }

        /* Multi-select */
        .multi-select {
            position: relative;
            width: 100%;
        }

        .select-btn {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius-sm);
            background: white;
            text-align: left;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            transition: all 0.2s;
            min-height: 52px;
        }

        .select-btn:active {
            border-color: var(--primary);
            background: #f8f9fa;
        }

        .selected-count {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            margin-left: 8px;
        }

        /* Dropdown Modal para Mobile */
        .dropdown-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            align-items: flex-end;
            justify-content: center;
        }

        .dropdown-modal.show {
            display: flex;
        }

        .dropdown-content {
            background: white;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            border-radius: 24px 24px 0 0;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .dropdown-header {
            padding: 20px;
            background: var(--primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dropdown-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-box {
            padding: 16px;
            border-bottom: 1px solid #e9ecef;
        }

        .search-box input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius-sm);
            font-size: 15px;
        }

        .select-all {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-weight: 600;
            color: var(--primary);
            border-bottom: 1px solid #e9ecef;
        }

        .options-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 8px 0;
        }

        .option-item {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .option-item.selected {
            background: rgba(67, 97, 238, 0.05);
            border-left-color: var(--primary);
        }

        .option-item input[type="checkbox"] {
            width: 22px;
            height: 22px;
            accent-color: var(--primary);
        }

        select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            background: white;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 16px;
            min-height: 52px;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            flex: 1;
            min-width: 140px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background: white;
            border-radius: var(--border-radius);
            padding: clamp(16px, 3vw, 20px);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .kpi-icon {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            margin-bottom: 12px;
        }

        .kpi-icon.blue { background: linear-gradient(135deg, #4361ee20, #4361ee40); color: var(--primary); }
        .kpi-icon.green { background: linear-gradient(135deg, #06d6a020, #06d6a040); color: var(--success); }
        .kpi-icon.purple { background: linear-gradient(135deg, #9b5de520, #9b5de540); color: #9b5de5; }
        .kpi-icon.orange { background: linear-gradient(135deg, #f7258520, #f7258540); color: var(--secondary); }
        .kpi-icon.red { background: linear-gradient(135deg, #ef476f20, #ef476f40); color: var(--danger); }

        .kpi-label {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .kpi-value {
            font-size: clamp(18px, 4vw, 24px);
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
            line-height: 1.2;
            word-break: break-word;
        }

        .kpi-trend {
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
            padding-top: 8px;
            border-top: 1px solid #e9ecef;
            margin-top: auto;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #f1f5f9;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-1);
            border-radius: 10px;
            transition: width 0.3s;
        }

        /* Gráficos */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: white;
            border-radius: var(--border-radius);
            padding: clamp(16px, 3vw, 20px);
            box-shadow: var(--shadow);
            width: 100%;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f1f5f9;
            flex-wrap: wrap;
            gap: 8px;
        }

        .chart-header h3 {
            color: var(--dark);
            font-size: clamp(16px, 4vw, 18px);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chart-header .badge {
            background: var(--light);
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 11px;
            font-weight: 600;
            color: var(--gray);
        }

        .chart-wrapper {
            position: relative;
            height: clamp(250px, 40vh, 300px);
            width: 100%;
        }

        /* Tabelas */
        .tables-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 900px) {
            .tables-section {
                grid-template-columns: 1fr;
            }
        }

        .table-card {
            background: white;
            border-radius: var(--border-radius);
            padding: clamp(16px, 3vw, 20px);
            box-shadow: var(--shadow);
            width: 100%;
            overflow: hidden;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .table-header h2 {
            color: var(--dark);
            font-size: clamp(18px, 4vw, 20px);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 12px;
            border: 1px solid #f1f5f9;
            margin: 0 -1px;
            width: calc(100% + 2px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            min-width: 800px;
        }

        th {
            background: #f8fafc;
            color: var(--dark);
            padding: 14px 8px;
            font-weight: 700;
            text-align: center;
            white-space: nowrap;
            font-size: 12px;
            border-bottom: 2px solid #e9ecef;
        }

        td {
            padding: 12px 8px;
            border-bottom: 1px solid #f1f5f9;
            text-align: center;
        }

        .meta-sim, .meta-nao {
            padding: 4px 12px;
            border-radius: 30px;
            display: inline-block;
            font-size: 11px;
            font-weight: 700;
        }

        .meta-sim {
            background: linear-gradient(135deg, #06d6a020, #06d6a040);
            color: var(--success);
        }

        .meta-nao {
            background: linear-gradient(135deg, #ef476f20, #ef476f40);
            color: var(--danger);
        }

        .valor-positivo { color: var(--success); font-weight: 700; }
        .valor-negativo { color: var(--danger); font-weight: 700; }

        .store-name {
            font-weight: 600;
            color: var(--primary);
            white-space: nowrap;
        }

        .currency {
            white-space: nowrap;
        }

        /* Info Cards */
        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .info-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            border: 1px solid #f1f5f9;
        }

        .info-icon {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            background: var(--gradient-1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: white;
            flex-shrink: 0;
        }

        .info-content h4 {
            color: var(--gray);
            font-size: 13px;
            margin-bottom: 4px;
        }

        .info-content p {
            color: var(--dark);
            font-size: 18px;
            font-weight: 700;
            line-height: 1.2;
        }

        /* Footer */
        .footer {
            margin-top: 30px;
            text-align: center;
            color: var(--gray);
            font-size: 12px;
            padding: 16px;
            border-top: 1px solid #e9ecef;
        }

        /* Utilitários */
        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Header Responsivo -->
        <div class="header">
            <div class="header-content">
                <div class="header-title">
                    <h1>
                        <i class="fas fa-store-alt"></i> 
                        Setor Patty
                    </h1>
                    <p>
                        <i class="fas fa-store"></i> 31 Lojas em operação 
                        <i class="fas fa-circle" style="font-size: 4px;"></i>
                        <i class="fas fa-chart-line"></i> Tempo real
                    </p>
                </div>
                
                <div class="header-date-wrapper">
                    <button class="date-nav-btn" onclick="mudarDia(-1)" id="btnHeaderAnterior">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="current-date" id="dataAtualDisplay">14/02/2026</span>
                    <button class="date-nav-btn" onclick="mudarDia(1)" id="btnHeaderProximo">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <div class="header-day-box">
                        <div class="day" id="headerDay">14</div>
                        <div class="month" id="headerMonth">FEV 2026</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navegação de Data -->
        <div class="date-navigation">
            <button onclick="mudarDia(-1)" id="btnDiaAnterior">
                <i class="fas fa-chevron-left"></i>
            </button>
            <span id="dataSelecionada">Sábado, 14 de Fevereiro de 2026</span>
            <button onclick="mudarDia(1)" id="btnProximoDia">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>

        <!-- Filtros -->
        <div class="filters">
            <div class="filters-grid">
                <div class="filter-group">
                    <label><i class="fas fa-store"></i> Lojas</label>
                    <div class="multi-select" id="lojaMultiSelect">
                        <div class="select-btn" onclick="abrirModalLojas()">
                            <span id="selectedLojasText">Todas as Lojas</span>
                            <span class="selected-count" id="selectedCount">31</span>
                        </div>
                    </div>
                </div>

                <div class="filter-group">
                    <label><i class="fas fa-chart-bar"></i> Status</label>
                    <select id="statusFilter" onchange="aplicarFiltros()">
                        <option value="">Todos os Status</option>
                        <option value="SIM">Meta Atingida</option>
                        <option value="NÃO">Meta Não Atingida</option>
                    </select>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="aplicarFiltros()">
                        <i class="fas fa-sync-alt"></i> Atualizar
                    </button>
                    <button class="btn btn-success" onclick="exportarExcel()">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Seleção de Lojas -->
        <div class="dropdown-modal" id="lojaModal" onclick="fecharModalLojas(event)">
            <div class="dropdown-content" onclick="event.stopPropagation()">
                <div class="dropdown-header">
                    <h3>Selecionar Lojas</h3>
                    <button class="close-btn" onclick="fecharModalLojas()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="search-box">
                    <input type="text" id="lojaSearch" placeholder="Buscar loja..." onkeyup="filtrarLojas()">
                </div>
                <div class="select-all" onclick="toggleAllLojas()">
                    <i class="fas fa-check-square"></i> Selecionar Todas
                </div>
                <div class="options-list" id="lojaOptions"></div>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-icon blue"><i class="fas fa-store"></i></div>
                <div class="kpi-label">Total de Lojas</div>
                <div class="kpi-value" id="totalLojas">0</div>
                <div class="kpi-trend"><i class="fas fa-check-circle trend-up"></i> 100% operantes</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon green"><i class="fas fa-dollar-sign"></i></div>
                <div class="kpi-label">Faturamento</div>
                <div class="kpi-value" id="totalFaturamento">R$ 0</div>
                <div class="kpi-trend"><span id="percentualMeta">0,00%</span> vs meta</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon purple"><i class="fas fa-bullseye"></i></div>
                <div class="kpi-label">Meta Total</div>
                <div class="kpi-value" id="totalMeta">R$ 0</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressoMeta" style="width: 0%"></div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon orange"><i class="fas fa-trophy"></i></div>
                <div class="kpi-label">Metas Atingidas</div>
                <div class="kpi-value" id="metasAtingidas">0/0</div>
                <div class="kpi-trend"><span id="percentualLojas">0%</span> das lojas</div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-pie"></i>Distribuição por Canal</h3>
                    <span class="badge">Vendas</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="canalPieChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-bullseye"></i>Atingimento de Metas</h3>
                    <span class="badge">Performance</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="metasPieChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-bar"></i>Top 10 Lojas</h3>
                    <span class="badge">Ranking</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="top10BarChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-line"></i>Desempenho por Loja</h3>
                    <span class="badge">Atingimento</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="desempenhoBarChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Tabelas -->
        <div class="tables-section">
            <div class="table-card">
                <div class="table-header">
                    <h2><i class="fas fa-list"></i> Detalhamento por Loja</h2>
                </div>
                <div class="table-wrapper">
                    <table id="mainTable">
                        <thead>
                            <tr>
                                <th onclick="ordenarTabela(0)">Data <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(1)">Loja <i class="fas fa-sort"></i></th>
                                <th>Início</th>
                                <th>Fim</th>
                                <th onclick="ordenarTabela(4)">Cupons <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(5)">Faturamento <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(6)">Meta <i class="fas fa-sort"></i></th>
                                <th>Diferença</th>
                                <th onclick="ordenarTabela(8)">Dif % <i class="fas fa-sort"></i></th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="table-card">
                <div class="table-header">
                    <h2><i class="fas fa-chart-pie"></i> Resumo por Canal</h2>
                </div>
                <div class="table-wrapper">
                    <table id="canaisTable">
                        <thead>
                            <tr>
                                <th>Canal</th>
                                <th>Valor (R$)</th>
                                <th>Participação</th>
                                <th>Performance</th>
                            </tr>
                        </thead>
                        <tbody id="canaisTableBody"></tbody>
                    </table>
                </div>

                <div class="info-cards">
                    <div class="info-card">
                        <div class="info-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="info-content">
                            <h4>Lojas que Atingiram Meta</h4>
                            <p id="lojasMetaSim">0 lojas</p>
                        </div>
                    </div>
                    <div class="info-card">
                        <div class="info-icon"><i class="fas fa-times-circle"></i></div>
                        <div class="info-content">
                            <h4>Lojas Abaixo da Meta</h4>
                            <p id="lojasMetaNao">0 lojas</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p><i class="far fa-clock"></i> Relatório gerado em <span id="dataGeracao">14/02/2026</span></p>
            <p style="margin-top: 4px;">© 2026 Setor Patty</p>
        </div>
    </div>

    <script>
        // MAPEAMENTO DOS NOMES DAS LOJAS
        const lojaNomes = {
            5: "ANTONIO AGU",
            10: "OSASCO PLAZA",
            28: "SHOPPING TAMBORÉ",
            31: "AUGUSTA",
            63: "SHOPPING ITAPECERICA",
            69: "PERUS",
            73: "BRIGADEIRO JARDINS",
            82: "TEODORO SAMPAIO",
            86: "REX RAFAEL DE BARROS",
            90: "SHOPPING PARQUE BARUERI",
            97: "ASSAÍ JOÃO DIAS",
            98: "FRANCO DA ROCHA",
            101: "CARREFOUR RAPOSO TAVARES",
            118: "SHOPPING ITAPECERICA II",
            126: "OSASCO JOÃO DE ANDRADE",
            133: "PARQUE TIETÊ",
            145: "ITASHOPPING",
            157: "JARDIM SÃO LUIZ",
            158: "ASSAÍ CARAPICUÍBA",
            162: "MARQUESA TAIPAS",
            178: "EXTRA CARAPICUÍBA",
            183: "FRANCO DA ROCHA 2",
            189: "SHOPPING PATIO CIANÊ",
            195: "EXTRA JARAGUÁ",
            210: "ASSAÍ ABOLIÇÃO CAMPINAS",
            247: "METRÔ CCR VILA DAS BELEZAS",
            248: "METRÔ CCR CAPÃO REDONDO",
            251: "SOROCABA CENTRO",
            262: "ASSAÍ INDAIATUBA",
            285: "EXTRA JARDIM ÂNGELA",
            294: "SHOPPING RAPOSO"
        };

        // DADOS COMPLETOS
        const dadosPorData = {
            "13/02/2026": [
                {loja: 5, inicio: '09:10', fim: '20:41', cupons: 117, faturamento: 3468.01, meta: 4005.0, canais: {auto: 916.93, delivery: 2263.16, viagem: 287.92}},
                {loja: 10, inicio: '13:52', fim: '21:32', cupons: 440, faturamento: 11244.67, meta: 10605.0, canais: {auto: 2670.74, delivery: 3526.33, viagem: 1762.66}},
                {loja: 28, inicio: '10:16', fim: '21:54', cupons: 186, faturamento: 4553.9, meta: 5215.0, canais: {auto: 1483.52, delivery: 2696.43, viagem: 373.95}},
                {loja: 31, inicio: '09:33', fim: '21:17', cupons: 173, faturamento: 3256.98, meta: 4280.0, canais: {auto: 0, delivery: 1171.54, viagem: 0}},
                {loja: 63, inicio: '10:34', fim: '21:34', cupons: 76, faturamento: 1111.57, meta: 2055.0, canais: {auto: 237.48, delivery: 0, viagem: 1111.57}},
                {loja: 69, inicio: '09:02', fim: '21:42', cupons: 211, faturamento: 5193.42, meta: 4570.0, canais: {auto: 0, delivery: 3876.7, viagem: 1394.96}},
                {loja: 73, inicio: '10:38', fim: '18:28', cupons: 86, faturamento: 2147.35, meta: 2815.0, canais: {auto: 795.02, delivery: 1097.72, viagem: 254.61}},
                {loja: 82, inicio: '09:03', fim: '19:52', cupons: 177, faturamento: 3106.1, meta: 2995.0, canais: {auto: 421.82, delivery: 2029.92, viagem: 0}},
                {loja: 86, inicio: '10:06', fim: '21:30', cupons: 108, faturamento: 3642.71, meta: 6405.0, canais: {auto: 1485.02, delivery: 641.94, viagem: 152.48}},
                {loja: 90, inicio: '10:25', fim: '22:02', cupons: 198, faturamento: 4673.55, meta: 4345.0, canais: {auto: 1752.34, delivery: 217.27, viagem: 746.4}},
                {loja: 97, inicio: '10:24', fim: '04:19', cupons: 155, faturamento: 4223.68, meta: 4100.0, canais: {auto: 2306.69, delivery: 133.1, viagem: 542.1}},
                {loja: 98, inicio: '08:41', fim: '19:26', cupons: 258, faturamento: 3493.53, meta: 4245.0, canais: {auto: 532.17, delivery: 586.56, viagem: 2374.8}},
                {loja: 101, inicio: '10:39', fim: '20:53', cupons: 116, faturamento: 2575.19, meta: 2450.0, canais: {auto: 0, delivery: 1489.73, viagem: 1085.46}},
                {loja: 118, inicio: '10:21', fim: '21:58', cupons: 103, faturamento: 2239.19, meta: 2920.0, canais: {auto: 932.34, delivery: 540.76, viagem: 766.09}},
                {loja: 126, inicio: '10:15', fim: '21:30', cupons: 396, faturamento: 10997.7, meta: 11555.0, canais: {auto: 643.84, delivery: 6195.35, viagem: 31.07}},
                {loja: 133, inicio: '10:08', fim: '21:47', cupons: 164, faturamento: 5198.91, meta: 5875.0, canais: {auto: 278.37, delivery: 4016.21, viagem: 904.33}},
                {loja: 145, inicio: '09:05', fim: '09:19', cupons: 142, faturamento: 2451.98, meta: 4270.0, canais: {auto: 732, delivery: 736.95, viagem: 979.54}},
                {loja: 157, inicio: '10:22', fim: '21:20', cupons: 107, faturamento: 2516.24, meta: 3405.0, canais: {auto: 0, delivery: 1644.09, viagem: 872.15}},
                {loja: 158, inicio: '09:50', fim: '21:40', cupons: 168, faturamento: 4512.33, meta: 4425.0, canais: {auto: 2490.5, delivery: 1741.45, viagem: 280.38}},
                {loja: 162, inicio: '09:23', fim: '20:42', cupons: 91, faturamento: 2951.27, meta: 3090.0, canais: {auto: 0, delivery: 0, viagem: 0}},
                {loja: 178, inicio: '09:28', fim: '22:11', cupons: 124, faturamento: 3964.04, meta: 2270.0, canais: {auto: 0, delivery: 2933.02, viagem: 0}},
                {loja: 183, inicio: '09:36', fim: '19:26', cupons: 126, faturamento: 2092.38, meta: 3020.0, canais: {auto: 912.16, delivery: 542.95, viagem: 629.27}},
                {loja: 189, inicio: '09:53', fim: '21:54', cupons: 203, faturamento: 2519.29, meta: 2830.0, canais: {auto: 737.6, delivery: 379.76, viagem: 1401.93}},
                {loja: 195, inicio: '10:16', fim: '21:25', cupons: 256, faturamento: 6232.95, meta: 6590.0, canais: {auto: 0, delivery: 4180.13, viagem: 2052.82}},
                {loja: 210, inicio: '08:45', fim: '20:49', cupons: 128, faturamento: 2899.39, meta: 3815.0, canais: {auto: 0, delivery: 1176.61, viagem: 0}},
                {loja: 247, inicio: '08:46', fim: '20:31', cupons: 112, faturamento: 1768.7, meta: 2050.0, canais: {auto: 0, delivery: 632.17, viagem: 1136.53}},
                {loja: 248, inicio: '07:34', fim: '23:51', cupons: 277, faturamento: 6052.05, meta: 5735.0, canais: {auto: 387.87, delivery: 3040.98, viagem: 1978.3}},
                {loja: 251, inicio: '08:37', fim: '15:58', cupons: 88, faturamento: 1072.78, meta: 1935.0, canais: {auto: 0, delivery: 59.8, viagem: 1012.98}},
                {loja: 262, inicio: '08:31', fim: '21:17', cupons: 96, faturamento: 2489.25, meta: 2355.0, canais: {auto: 0, delivery: 1262.64, viagem: 1099.12}},
                {loja: 285, inicio: '10:46', fim: '21:44', cupons: 91, faturamento: 1741.23, meta: 3375.0, canais: {auto: 0, delivery: 546.45, viagem: 1194.78}},
                {loja: 294, inicio: '10:34', fim: '21:31', cupons: 120, faturamento: 2254.62, meta: 1990.0, canais: {auto: 360.98, delivery: 792.59, viagem: 1101.05}}
            ],
            "14/02/2026": [
                {loja: 5, inicio: '09:24', fim: '12:34', cupons: 29, faturamento: 886.93, meta: 4015.0, canais: {auto: 204.58, delivery: 565.12, viagem: 117.23}},
                {loja: 10, inicio: '12:06', fim: '12:15', cupons: 15, faturamento: 367.1, meta: 12645.0, canais: {auto: 0, delivery: 0, viagem: 112.93}},
                {loja: 28, inicio: '10:27', fim: '12:32', cupons: 18, faturamento: 396.84, meta: 5390.0, canais: {auto: 218.81, delivery: 172.54, viagem: 5.49}},
                {loja: 31, inicio: '09:38', fim: '12:36', cupons: 23, faturamento: 419.6, meta: 3335.0, canais: {auto: 0, delivery: 198.43, viagem: 0}},
                {loja: 63, inicio: '10:36', fim: '12:35', cupons: 13, faturamento: 243.17, meta: 1650.0, canais: {auto: 19.9, delivery: 0, viagem: 243.17}},
                {loja: 69, inicio: '09:49', fim: '12:32', cupons: 19, faturamento: 460.12, meta: 5095.0, canais: {auto: 0, delivery: 300.25, viagem: 189.63}},
                {loja: 73, inicio: '10:37', fim: '12:32', cupons: 13, faturamento: 226.44, meta: 2285.0, canais: {auto: 180.75, delivery: 0, viagem: 45.69}},
                {loja: 82, inicio: '09:03', fim: '12:32', cupons: 32, faturamento: 590.89, meta: 2100.0, canais: {auto: 0, delivery: 409.8, viagem: 0}},
                {loja: 86, inicio: '10:08', fim: '12:09', cupons: 14, faturamento: 331.55, meta: 5635.0, canais: {auto: 113.49, delivery: 29.9, viagem: 28.8}},
                {loja: 90, inicio: '10:47', fim: '12:21', cupons: 7, faturamento: 237.3, meta: 4955.0, canais: {auto: 129.04, delivery: 0, viagem: 0}},
                {loja: 97, inicio: '19:36', fim: '12:09', cupons: 28, faturamento: 631.59, meta: 6315.0, canais: {auto: 346.75, delivery: 259.16, viagem: 37.84}},
                {loja: 98, inicio: '09:55', fim: '12:34', cupons: 33, faturamento: 606.66, meta: 3780.0, canais: {auto: 0, delivery: 154.54, viagem: 452.12}},
                {loja: 101, inicio: '10:05', fim: '12:34', cupons: 11, faturamento: 262.79, meta: 2980.0, canais: {auto: 0, delivery: 130.57, viagem: 132.22}},
                {loja: 118, inicio: '10:34', fim: '12:22', cupons: 10, faturamento: 295.4, meta: 3870.0, canais: {auto: 205.63, delivery: 82.8, viagem: 6.97}},
                {loja: 126, inicio: null, fim: null, cupons: 10, faturamento: 406.17, meta: 13025.0, canais: {auto: 0, delivery: 0, viagem: 0}},
                {loja: 133, inicio: '10:09', fim: '12:25', cupons: 21, faturamento: 534.99, meta: 6680.0, canais: {auto: 0, delivery: 409.63, viagem: 125.36}},
                {loja: 145, inicio: '09:28', fim: '12:25', cupons: 14, faturamento: 232.3, meta: 4375.0, canais: {auto: 74.3, delivery: 119.44, viagem: 112.86}},
                {loja: 157, inicio: '10:28', fim: '12:29', cupons: 13, faturamento: 440.71, meta: 3365.0, canais: {auto: 0, delivery: 311.77, viagem: 128.94}},
                {loja: 158, inicio: '09:23', fim: '12:37', cupons: 21, faturamento: 580.7, meta: 4655.0, canais: {auto: 322.01, delivery: 258.69, viagem: 0}},
                {loja: 162, inicio: '09:42', fim: '12:23', cupons: 26, faturamento: 381.51, meta: 2985.0, canais: {auto: 0, delivery: 0, viagem: 0}},
                {loja: 178, inicio: '09:26', fim: '12:24', cupons: 13, faturamento: 361.86, meta: 2165.0, canais: {auto: 0, delivery: 289.9, viagem: 0}},
                {loja: 183, inicio: '10:54', fim: '12:35', cupons: 14, faturamento: 219.33, meta: 2540.0, canais: {auto: 0, delivery: 0, viagem: 219.33}},
                {loja: 189, inicio: '10:06', fim: '12:32', cupons: 29, faturamento: 327.98, meta: 2665.0, canais: {auto: 10.88, delivery: 75.88, viagem: 241.22}},
                {loja: 195, inicio: '09:51', fim: '12:30', cupons: 32, faturamento: 604.97, meta: 5780.0, canais: {auto: 0, delivery: 267.55, viagem: 337.42}},
                {loja: 210, inicio: '08:31', fim: '12:33', cupons: 57, faturamento: 1032.05, meta: 4025.0, canais: {auto: 0, delivery: 344.01, viagem: 0}},
                {loja: 247, inicio: '08:26', fim: '12:23', cupons: 27, faturamento: 338.39, meta: 1700.0, canais: {auto: 0, delivery: 55.17, viagem: 283.22}},
                {loja: 248, inicio: '07:13', fim: '12:35', cupons: 59, faturamento: 1009.95, meta: 5725.0, canais: {auto: 0, delivery: 357.27, viagem: 403.2}},
                {loja: 251, inicio: '08:31', fim: '12:36', cupons: 33, faturamento: 405.0, meta: 1705.0, canais: {auto: 0, delivery: 0, viagem: 405.0}},
                {loja: 262, inicio: '08:28', fim: '12:34', cupons: 31, faturamento: 505.79, meta: 2615.0, canais: {auto: 0, delivery: 168.13, viagem: 337.66}},
                {loja: 285, inicio: '08:38', fim: '12:24', cupons: 20, faturamento: 422.86, meta: 2585.0, canais: {auto: 0, delivery: 61.58, viagem: 361.28}},
                {loja: 294, inicio: '11:50', fim: '12:14', cupons: 4, faturamento: 153.47, meta: 2390.0, canais: {auto: 0, delivery: 113.67, viagem: 39.8}}
            ]
        };

        // Calcular dif, status e balcão
        for (let data in dadosPorData) {
            dadosPorData[data].forEach(loja => {
                loja.dif = loja.faturamento - loja.meta;
                loja.difPercentual = loja.meta > 0 ? (loja.dif / loja.meta) * 100 : 0;
                loja.status = loja.dif >= 0 ? 'SIM' : 'NÃO';
                
                const somaCanais = (loja.canais.auto || 0) + (loja.canais.delivery || 0) + (loja.canais.viagem || 0);
                loja.canais.balcao = Math.max(0, loja.faturamento - somaCanais);
            });
        }

        // Lista de datas
        const datasDisponiveis = Object.keys(dadosPorData).sort((a, b) => {
            const [diaA, mesA, anoA] = a.split('/').map(Number);
            const [diaB, mesB, anoB] = b.split('/').map(Number);
            return new Date(anoA, mesA-1, diaA) - new Date(anoB, mesB-1, diaB);
        });

        let dataAtual = "14/02/2026";
        let canalPieChart, metasPieChart, top10BarChart, desempenhoBarChart;
        let lojasSelecionadas = [];
        let todasLojas = [];

        function getDadosAtuais() {
            return dadosPorData[dataAtual] || [];
        }

        function mudarDia(direcao) {
            const indexAtual = datasDisponiveis.indexOf(dataAtual);
            if (indexAtual === -1) return;
            
            const novoIndex = indexAtual + direcao;
            if (novoIndex >= 0 && novoIndex < datasDisponiveis.length) {
                dataAtual = datasDisponiveis[novoIndex];
                atualizarInterfaceData();
                recarregarTudo();
            }
        }

        function atualizarInterfaceData() {
            const [dia, mes, ano] = dataAtual.split('/');
            const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const diasSemana = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
            
            const dataObj = new Date(ano, mes-1, dia);
            const diaSemana = diasSemana[dataObj.getDay()];
            
            $('#dataAtualDisplay').text(dataAtual);
            $('#headerDay').text(dia);
            $('#headerMonth').text(`${meses[mes-1].substring(0,3).toUpperCase()} ${ano}`);
            $('#dataSelecionada').text(`${diaSemana}, ${dia} de ${meses[mes-1]} de ${ano}`);
            $('#dataGeracao').text(dataAtual);
            
            const indexAtual = datasDisponiveis.indexOf(dataAtual);
            $('#btnDiaAnterior, #btnHeaderAnterior').prop('disabled', indexAtual === 0);
            $('#btnProximoDia, #btnHeaderProximo').prop('disabled', indexAtual === datasDisponiveis.length - 1);
        }

        function recarregarTudo() {
            todasLojas = [...new Set(getDadosAtuais().map(loja => loja.loja))].sort((a, b) => a - b);
            lojasSelecionadas = [...todasLojas];
            
            preencherOpcoesLojas();
            atualizarTextoSelecionadas();
            carregarTabela();
            destruirGraficos();
            inicializarGraficos();
            atualizarKPIs();
            atualizarTabelaCanais();
        }

        function destruirGraficos() {
            if (canalPieChart) canalPieChart.destroy();
            if (metasPieChart) metasPieChart.destroy();
            if (top10BarChart) top10BarChart.destroy();
            if (desempenhoBarChart) desempenhoBarChart.destroy();
        }

        $(document).ready(function() {
            atualizarInterfaceData();
            recarregarTudo();
        });

        function abrirModalLojas() {
            $('#lojaModal').addClass('show');
            $('#lojaSearch').val('').focus();
            filtrarLojas();
        }

        function fecharModalLojas(event) {
            if (!event || event.target.id === 'lojaModal') {
                $('#lojaModal').removeClass('show');
            }
        }

        function preencherOpcoesLojas() {
            let html = '';
            todasLojas.forEach(loja => {
                const nomeLoja = lojaNomes[loja] || `Loja ${loja}`;
                const isSelected = lojasSelecionadas.includes(loja);
                html += `<div class="option-item ${isSelected ? 'selected' : ''}" onclick="toggleLoja(${loja})">
                    <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleLoja(${loja})">
                    <span>${nomeLoja}</span>
                </div>`;
            });
            $('#lojaOptions').html(html);
        }

        function filtrarLojas() {
            const termo = $('#lojaSearch').val().toLowerCase();
            $('.option-item').each(function() {
                const texto = $(this).find('span').text().toLowerCase();
                $(this).toggle(texto.includes(termo));
            });
        }

        function toggleLoja(loja) {
            const index = lojasSelecionadas.indexOf(loja);
            if (index === -1) {
                lojasSelecionadas.push(loja);
            } else {
                lojasSelecionadas.splice(index, 1);
            }
            
            atualizarTextoSelecionadas();
            preencherOpcoesLojas();
            aplicarFiltros();
        }

        function toggleAllLojas() {
            if (lojasSelecionadas.length === todasLojas.length) {
                lojasSelecionadas = [];
            } else {
                lojasSelecionadas = [...todasLojas];
            }
            
            atualizarTextoSelecionadas();
            preencherOpcoesLojas();
            aplicarFiltros();
        }

        function atualizarTextoSelecionadas() {
            const count = lojasSelecionadas.length;
            $('#selectedCount').text(count);
            
            if (count === 0) {
                $('#selectedLojasText').text('Nenhuma loja');
            } else if (count === todasLojas.length) {
                $('#selectedLojasText').text('Todas as Lojas');
            } else if (count <= 2) {
                const nomes = lojasSelecionadas.sort((a, b) => a - b).map(l => lojaNomes[l] || `Loja ${l}`).join(', ');
                $('#selectedLojasText').text(nomes);
            } else {
                $('#selectedLojasText').text(`${count} lojas selecionadas`);
            }
        }

        function carregarTabela() {
            let html = '';
            const statusFiltro = $('#statusFilter').val();
            const dadosAtuais = getDadosAtuais();

            const dadosFiltrados = dadosAtuais.filter(loja => {
                if (lojasSelecionadas.length > 0 && !lojasSelecionadas.includes(loja.loja)) return false;
                if (statusFiltro && loja.status != statusFiltro) return false;
                return true;
            });

            dadosFiltrados.forEach(loja => {
                const nomeLoja = lojaNomes[loja.loja] || `Loja ${loja.loja}`;
                const difClass = loja.dif >= 0 ? 'valor-positivo' : 'valor-negativo';
                const statusClass = loja.status === 'SIM' ? 'meta-sim' : 'meta-nao';
                
                html += `<tr>
                    <td>${dataAtual}</td>
                    <td><span class="store-name">${nomeLoja}</span></td>
                    <td>${loja.inicio || '-'}</td>
                    <td>${loja.fim || '-'}</td>
                    <td>${loja.cupons}</td>
                    <td class="currency">R$ ${formatMoney(loja.faturamento)}</td>
                    <td class="currency">R$ ${formatMoney(loja.meta)}</td>
                    <td class="currency ${difClass}">R$ ${formatMoney(loja.dif)}</td>
                    <td class="${difClass}">${formatPercent(loja.difPercentual)}</td>
                    <td><span class="${statusClass}">${loja.status}</span></td>
                </tr>`;
            });

            $('#tableBody').html(html);
            atualizarKPIs(dadosFiltrados);
        }

        function atualizarTabelaCanais() {
            const statusFiltro = $('#statusFilter').val();
            const dadosAtuais = getDadosAtuais();
            
            const dadosFiltrados = dadosAtuais.filter(loja => {
                if (lojasSelecionadas.length > 0 && !lojasSelecionadas.includes(loja.loja)) return false;
                if (statusFiltro && loja.status != statusFiltro) return false;
                return true;
            });
            
            let totaisCanais = {
                'Auto-Atendimento': 0,
                'Delivery': 0,
                'Viagem': 0,
                'Balcão': 0
            };
            
            dadosFiltrados.forEach(loja => {
                totaisCanais['Auto-Atendimento'] += loja.canais.auto || 0;
                totaisCanais['Delivery'] += loja.canais.delivery || 0;
                totaisCanais['Viagem'] += loja.canais.viagem || 0;
                totaisCanais['Balcão'] += loja.canais.balcao || 0;
            });
            
            const totalGeral = Object.values(totaisCanais).reduce((a, b) => a + b, 0);
            
            if (canalPieChart) {
                canalPieChart.data.datasets[0].data = Object.values(totaisCanais);
                canalPieChart.update();
            }
            
            let html = '';
            const icones = {
                'Auto-Atendimento': 'fa-robot',
                'Delivery': 'fa-motorcycle',
                'Viagem': 'fa-plane',
                'Balcão': 'fa-store'
            };
            
            Object.entries(totaisCanais).forEach(([canal, valor]) => {
                const participacao = totalGeral > 0 ? (valor / totalGeral * 100) : 0;
                html += `<tr>
                    <td><i class="fas ${icones[canal]}" style="color: var(--primary); margin-right: 4px;"></i> ${canal}</td>
                    <td>R$ ${formatMoney(valor)}</td>
                    <td>${participacao.toFixed(1)}%</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${participacao}%"></div>
                        </div>
                    </td>
                </tr>`;
            });
            
            $('#canaisTableBody').html(html);
        }

        function atualizarKPIs(dadosFiltrados = null) {
            const statusFiltro = $('#statusFilter').val();
            const dadosAtuais = getDadosAtuais();
            
            const dados = dadosFiltrados || dadosAtuais.filter(loja => {
                if (lojasSelecionadas.length > 0 && !lojasSelecionadas.includes(loja.loja)) return false;
                if (statusFiltro && loja.status != statusFiltro) return false;
                return true;
            });
            
            const totalLojas = dados.length;
            const totalFaturamento = dados.reduce((sum, loja) => sum + loja.faturamento, 0);
            const totalMeta = dados.reduce((sum, loja) => sum + loja.meta, 0);
            const totalDiferenca = totalFaturamento - totalMeta;
            const percentualDiferenca = totalMeta > 0 ? (totalDiferenca / totalMeta) * 100 : 0;
            const metasAtingidas = dados.filter(loja => loja.status === 'SIM').length;
            const percentualLojas = totalLojas > 0 ? (metasAtingidas / totalLojas) * 100 : 0;
            
            $('#totalLojas').text(totalLojas);
            $('#totalFaturamento').text(`R$ ${formatMoney(totalFaturamento)}`);
            $('#totalMeta').text(`R$ ${formatMoney(totalMeta)}`);
            $('#percentualMeta').text(formatPercent(percentualDiferenca));
            $('#metasAtingidas').text(`${metasAtingidas}/${totalLojas}`);
            $('#percentualLojas').text(`${percentualLojas.toFixed(1)}%`);
            $('#lojasMetaSim').text(`${metasAtingidas} lojas (${percentualLojas.toFixed(1)}%)`);
            $('#lojasMetaNao').text(`${totalLojas - metasAtingidas} lojas`);
            
            const percentualProgresso = totalMeta > 0 ? (totalFaturamento / totalMeta) * 100 : 0;
            $('#progressoMeta').css('width', `${percentualProgresso}%`);
            
            if (metasPieChart) {
                metasPieChart.data.datasets[0].data = [metasAtingidas, totalLojas - metasAtingidas];
                metasPieChart.update();
            }
        }

        function formatMoney(value) {
            return value.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        function formatPercent(value) {
            return (value > 0 ? '+' : '') + value.toFixed(2) + '%';
        }

        function aplicarFiltros() {
            carregarTabela();
            atualizarTabelaCanais();
            fecharModalLojas();
            
            const statusFiltro = $('#statusFilter').val();
            const dadosAtuais = getDadosAtuais();

            const dadosFiltrados = dadosAtuais.filter(loja => {
                if (lojasSelecionadas.length > 0 && !lojasSelecionadas.includes(loja.loja)) return false;
                if (statusFiltro && loja.status != statusFiltro) return false;
                return true;
            });
            
            if (desempenhoBarChart) {
                if (dadosFiltrados.length > 0) {
                    desempenhoBarChart.data.labels = dadosFiltrados.map(d => lojaNomes[d.loja] || `Loja ${d.loja}`);
                    desempenhoBarChart.data.datasets[0].data = dadosFiltrados.map(d => 100 + d.difPercentual);
                    desempenhoBarChart.data.datasets[0].backgroundColor = dadosFiltrados.map(d => d.difPercentual >= 0 ? '#06d6a0' : '#ef476f');
                } else {
                    desempenhoBarChart.data.labels = [];
                    desempenhoBarChart.data.datasets[0].data = [];
                }
                desempenhoBarChart.update();
            }
            
            if (top10BarChart) {
                if (dadosFiltrados.length > 0) {
                    const top10Data = [...dadosFiltrados].sort((a, b) => b.faturamento - a.faturamento).slice(0, Math.min(10, dadosFiltrados.length));
                    top10BarChart.data.labels = top10Data.map(d => lojaNomes[d.loja] || `Loja ${d.loja}`);
                    top10BarChart.data.datasets[0].data = top10Data.map(d => d.faturamento);
                    top10BarChart.data.datasets[1].data = top10Data.map(d => d.meta);
                } else {
                    top10BarChart.data.labels = [];
                    top10BarChart.data.datasets[0].data = [];
                    top10BarChart.data.datasets[1].data = [];
                }
                top10BarChart.update();
            }
        }

        let ordemAtual = { coluna: -1, ascendente: true };

        function ordenarTabela(coluna) {
            const tbody = $('#tableBody');
            const linhas = tbody.find('tr').get();
            
            if (ordemAtual.coluna === coluna) {
                ordemAtual.ascendente = !ordemAtual.ascendente;
            } else {
                ordemAtual.coluna = coluna;
                ordemAtual.ascendente = true;
            }
            
            linhas.sort((a, b) => {
                const celulaA = $(a).children('td').eq(coluna).text();
                const celulaB = $(b).children('td').eq(coluna).text();
                
                let valorA, valorB;
                
                if (coluna === 1) {
                    valorA = celulaA;
                    valorB = celulaB;
                } else if (coluna === 4) {
                    valorA = parseInt(celulaA) || 0;
                    valorB = parseInt(celulaB) || 0;
                } else if (coluna === 5 || coluna === 6 || coluna === 7) {
                    valorA = parseFloat(celulaA.replace('R$ ', '').replace(/\./g, '').replace(',', '.')) || 0;
                    valorB = parseFloat(celulaB.replace('R$ ', '').replace(/\./g, '').replace(',', '.')) || 0;
                } else if (coluna === 8) {
                    valorA = parseFloat(celulaA.replace('%', '').replace('+', '')) || 0;
                    valorB = parseFloat(celulaB.replace('%', '').replace('+', '')) || 0;
                } else {
                    valorA = celulaA;
                    valorB = celulaB;
                }
                
                if (valorA < valorB) return ordemAtual.ascendente ? -1 : 1;
                if (valorA > valorB) return ordemAtual.ascendente ? 1 : -1;
                return 0;
            });
            
            tbody.empty().append(linhas);
            
            $('th i').removeClass('fa-sort-up fa-sort-down').addClass('fa-sort');
            const icone = ordemAtual.ascendente ? 'fa-sort-up' : 'fa-sort-down';
            $(`th:eq(${coluna}) i`).removeClass('fa-sort').addClass(icone);
        }

        function exportarExcel() {
            const statusFiltro = $('#statusFilter').val();
            const dadosAtuais = getDadosAtuais();

            const dadosFiltrados = dadosAtuais.filter(loja => {
                if (lojasSelecionadas.length > 0 && !lojasSelecionadas.includes(loja.loja)) return false;
                if (statusFiltro && loja.status != statusFiltro) return false;
                return true;
            });

            const totalFaturamento = dadosFiltrados.reduce((sum, loja) => sum + loja.faturamento, 0);
            const totalMeta = dadosFiltrados.reduce((sum, loja) => sum + loja.meta, 0);
            const totalDiferenca = totalFaturamento - totalMeta;
            const percentualDiferenca = totalMeta > 0 ? (totalDiferenca / totalMeta) * 100 : 0;
            const metasAtingidas = dadosFiltrados.filter(loja => loja.status === 'SIM').length;

            const wb = XLSX.utils.book_new();
            
            const dadosDetalhamento = [
                ['RELATÓRIO DE METAS - SETOR PATTY'],
                [`Data: ${dataAtual} - Lojas Selecionadas: ${lojasSelecionadas.length} lojas, Status: ${statusFiltro || 'Todos'}`],
                []
            ];
            
            dadosDetalhamento.push([
                'Data', 'Loja', 'Início', 'Fim', 'Qtd Cupons', 
                'Faturamento (R$)', 'Meta (R$)', 'Diferença (R$)', 'Diferença %', 'Status'
            ]);
            
            dadosFiltrados.forEach(loja => {
                const nomeLoja = lojaNomes[loja.loja] || `Loja ${loja.loja}`;
                dadosDetalhamento.push([
                    dataAtual,
                    nomeLoja,
                    loja.inicio || '-',
                    loja.fim || '-',
                    loja.cupons,
                    loja.faturamento,
                    loja.meta,
                    loja.dif,
                    loja.difPercentual,
                    loja.status
                ]);
            });
            
            dadosDetalhamento.push([]);
            dadosDetalhamento.push([
                'TOTAIS', '', '', '', 
                dadosFiltrados.reduce((sum, loja) => sum + loja.cupons, 0),
                totalFaturamento,
                totalMeta,
                totalDiferenca,
                percentualDiferenca,
                `${metasAtingidas}/${dadosFiltrados.length} lojas`
            ]);

            const wsDetalhamento = XLSX.utils.aoa_to_sheet(dadosDetalhamento);
            
            wsDetalhamento['!cols'] = [
                { wch: 12 }, { wch: 30 }, { wch: 8 }, { wch: 8 }, { wch: 12 },
                { wch: 18 }, { wch: 18 }, { wch: 18 }, { wch: 15 }, { wch: 12 }
            ];

            let totaisCanais = {
                'Auto-Atendimento': 0,
                'Delivery': 0,
                'Viagem': 0,
                'Balcão': 0
            };
            
            dadosFiltrados.forEach(loja => {
                totaisCanais['Auto-Atendimento'] += loja.canais.auto || 0;
                totaisCanais['Delivery'] += loja.canais.delivery || 0;
                totaisCanais['Viagem'] += loja.canais.viagem || 0;
                totaisCanais['Balcão'] += loja.canais.balcao || 0;
            });
            
            const totalCanais = Object.values(totaisCanais).reduce((a, b) => a + b, 0);
            
            const dadosCanais = [
                ['RESUMO POR CANAL'],
                [],
                ['Canal', 'Valor (R$)', 'Participação (%)']
            ];
            
            Object.entries(totaisCanais).forEach(([canal, valor]) => {
                dadosCanais.push([canal, valor, totalCanais > 0 ? (valor / totalCanais * 100) : 0]);
            });
            
            dadosCanais.push([]);
            dadosCanais.push(['TOTAL', totalCanais, '100.0']);

            const wsCanais = XLSX.utils.aoa_to_sheet(dadosCanais);
            wsCanais['!cols'] = [{ wch: 25 }, { wch: 18 }, { wch: 18 }];

            const ticketMedio = dadosFiltrados.reduce((sum, loja) => sum + loja.cupons, 0) > 0 ? 
                totalFaturamento / dadosFiltrados.reduce((sum, loja) => sum + loja.cupons, 0) : 0;
                
            const dadosIndicadores = [
                ['INDICADORES GERAIS'],
                [],
                ['Indicador', 'Valor'],
                ['Total de Lojas', dadosFiltrados.length],
                ['Faturamento Total', totalFaturamento],
                ['Meta Total', totalMeta],
                ['Diferença', totalDiferenca],
                ['Percentual de Atingimento', totalMeta > 0 ? (totalFaturamento / totalMeta * 100) : 0],
                ['Ticket Médio', ticketMedio],
                ['Lojas que Atingiram Meta', metasAtingidas],
                ['Lojas Abaixo da Meta', dadosFiltrados.length - metasAtingidas],
                ['Percentual de Metas Atingidas', dadosFiltrados.length > 0 ? (metasAtingidas / dadosFiltrados.length * 100) : 0]
            ];

            const wsIndicadores = XLSX.utils.aoa_to_sheet(dadosIndicadores);
            wsIndicadores['!cols'] = [{ wch: 30 }, { wch: 20 }];

            XLSX.utils.book_append_sheet(wb, wsDetalhamento, 'Detalhamento');
            XLSX.utils.book_append_sheet(wb, wsCanais, 'Resumo por Canal');
            XLSX.utils.book_append_sheet(wb, wsIndicadores, 'Indicadores');

            const dataStr = dataAtual.replace(/\//g, '-');
            const nomeArquivo = `Setor_Patty_${dataStr}.xlsx`;

            XLSX.writeFile(wb, nomeArquivo);

            const btnExport = event.target.closest('.btn');
            const textoOriginal = btnExport.innerHTML;
            btnExport.innerHTML = '<i class="fas fa-check"></i> OK!';
            btnExport.style.background = '#06d6a0';
            setTimeout(() => {
                btnExport.innerHTML = textoOriginal;
                btnExport.style.background = '';
            }, 1500);
        }

        function inicializarGraficos() {
            Chart.defaults.font.family = "'Inter', 'Segoe UI', Roboto, sans-serif";
            Chart.defaults.font.size = 11;

            const dadosAtuais = getDadosAtuais();

            let totaisCanais = {
                'Auto-Atendimento': 0,
                'Delivery': 0,
                'Viagem': 0,
                'Balcão': 0
            };
            
            dadosAtuais.forEach(loja => {
                totaisCanais['Auto-Atendimento'] += loja.canais.auto || 0;
                totaisCanais['Delivery'] += loja.canais.delivery || 0;
                totaisCanais['Viagem'] += loja.canais.viagem || 0;
                totaisCanais['Balcão'] += loja.canais.balcao || 0;
            });

            canalPieChart = new Chart(document.getElementById('canalPieChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(totaisCanais),
                    datasets: [{
                        data: Object.values(totaisCanais),
                        backgroundColor: ['#4361ee', '#f72585', '#4cc9f0', '#ffd166'],
                        borderWidth: 0,
                        borderRadius: 8,
                        spacing: 2,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 10,
                                padding: 15,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(43, 45, 66, 0.9)',
                            padding: 10,
                            cornerRadius: 8,
                            callbacks: {
                                label: (ctx) => {
                                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const valor = ctx.raw;
                                    const percent = ((valor / total) * 100).toFixed(1);
                                    return `${ctx.label}: R$ ${formatMoney(valor)} (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });

            const metasAtingidas = dadosAtuais.filter(loja => loja.status === 'SIM').length;
            const metasNaoAtingidas = dadosAtuais.length - metasAtingidas;
            
            metasPieChart = new Chart(document.getElementById('metasPieChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Atingiram Meta', 'Não Atingiram'],
                    datasets: [{
                        data: [metasAtingidas, metasNaoAtingidas],
                        backgroundColor: ['#06d6a0', '#ef476f'],
                        borderWidth: 0,
                        borderRadius: 8,
                        spacing: 2,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 10,
                                padding: 15,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(43, 45, 66, 0.9)',
                            padding: 10,
                            cornerRadius: 8,
                            callbacks: {
                                label: (ctx) => {
                                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const percent = ((ctx.raw / total) * 100).toFixed(1);
                                    return `${ctx.label}: ${ctx.raw} lojas (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });

            const top10Data = [...dadosAtuais].sort((a, b) => b.faturamento - a.faturamento).slice(0, 10);
            top10BarChart = new Chart(document.getElementById('top10BarChart'), {
                type: 'bar',
                data: {
                    labels: top10Data.map(d => lojaNomes[d.loja] || `Loja ${d.loja}`),
                    datasets: [
                        {
                            label: 'Faturamento',
                            data: top10Data.map(d => d.faturamento),
                            backgroundColor: '#4361ee',
                            borderRadius: 6,
                            barPercentage: 0.6
                        },
                        {
                            label: 'Meta',
                            data: top10Data.map(d => d.meta),
                            backgroundColor: '#f72585',
                            borderRadius: 6,
                            barPercentage: 0.6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { font: { size: 11 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `R$ ${formatMoney(ctx.raw)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => 'R$ ' + value.toLocaleString('pt-BR', {maximumFractionDigits: 0})
                            }
                        },
                        x: {
                            ticks: { maxRotation: 45, minRotation: 45, font: { size: 9 } }
                        }
                    }
                }
            });

            desempenhoBarChart = new Chart(document.getElementById('desempenhoBarChart'), {
                type: 'bar',
                data: {
                    labels: dadosAtuais.map(d => lojaNomes[d.loja] || `Loja ${d.loja}`),
                    datasets: [{
                        label: 'Atingimento da Meta (%)',
                        data: dadosAtuais.map(d => 100 + d.difPercentual),
                        backgroundColor: dadosAtuais.map(d => d.difPercentual >= 0 ? '#06d6a0' : '#ef476f'),
                        borderRadius: 6,
                        barPercentage: 0.7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `Atingimento: ${ctx.raw.toFixed(1)}%`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 200,
                            ticks: { callback: (value) => value + '%' }
                        },
                        x: {
                            ticks: { maxRotation: 45, minRotation: 45, font: { size: 9 } }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
