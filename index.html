<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>REX - Setor Patty | Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2e7d32;
            --primary-dark: #1b5e20;
            --primary-light: #e8f5e9;
            --secondary: #2b2d42;
            --success: #06d6a0;
            --success-light: #e6fff5;
            --danger: #ef476f;
            --danger-light: #ffe6ec;
            --warning: #ffd166;
            --info: #4cc9f0;
            --light: #f8fafc;
            --dark: #0f172a;
            --gray: #475569;
            --gray-light: #e2e8f0;
            --white: #ffffff;
            --shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            --shadow-sm: 0 10px 15px -3px rgba(0,0,0,0.1);
            --shadow-lg: 0 30px 60px -15px rgba(46,125,96,0.3);
            --gradient-1: linear-gradient(135deg, #2e7d32, #1b5e20);
            --border-radius: 32px;
            --border-radius-sm: 20px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(145deg, #f1f8e9 0%, #d4e6d4 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: clamp(10px, 2vw, 20px);
            position: relative;
        }

        /* Logo de fundo Ragazzo */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 200" opacity="0.1"><path fill="%232e7d32" d="M80 40 L320 40 L360 140 L200 200 L40 140 L80 40 Z"/><text x="120" y="100" font-family="Arial Black" font-size="48" fill="%232e7d32" font-weight="900">RAGAZZO</text><text x="150" y="150" font-family="Arial" font-size="20" fill="%232e7d32" font-weight="500">Tudo que √© gostoso</text></svg>');
            background-repeat: repeat;
            background-size: 400px 200px;
            pointer-events: none;
            z-index: 0;
            opacity: 0.12;
            animation: floatLogo 120s linear infinite;
        }

        @keyframes floatLogo {
            0% { background-position: 0 0; }
            100% { background-position: 800px 400px; }
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            pointer-events: none;
            z-index: 0;
        }

        .dashboard {
            width: 100%;
            max-width: 1440px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(8px);
            border-radius: var(--border-radius);
            padding: clamp(16px, 3vw, 24px);
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .header {
            background: var(--gradient-1);
            padding: clamp(16px, 3vw, 24px) clamp(20px, 4vw, 28px);
            border-radius: var(--border-radius);
            margin-bottom: clamp(12px, 2vw, 20px);
            color: white;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
            z-index: 10;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            animation: rotate 30s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .header::after {
            content: 'RAGAZZO!';
            position: absolute;
            bottom: 5px;
            right: 15px;
            font-size: clamp(30px, 5vw, 50px);
            font-weight: 900;
            opacity: 0.1;
            color: white;
            letter-spacing: 2px;
            transform: rotate(-5deg);
            pointer-events: none;
            white-space: nowrap;
        }

        .header-content {
            position: relative;
            z-index: 11;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: clamp(10px, 2vw, 15px);
        }

        .header-title h1 {
            font-size: clamp(20px, 4vw, 26px);
            font-weight: 800;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: clamp(8px, 2vw, 12px);
        }

        .header-title p {
            font-size: clamp(12px, 2vw, 14px);
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: clamp(6px, 1.5vw, 8px);
            margin-top: 4px;
            flex-wrap: wrap;
        }

        .header-date {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            padding: clamp(8px, 2vw, 12px) clamp(16px, 3vw, 24px);
            border-radius: 60px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .header-date .day {
            font-size: clamp(18px, 3.5vw, 24px);
            font-weight: 800;
            line-height: 1;
        }

        .header-date .month {
            font-size: clamp(10px, 2vw, 13px);
            opacity: 0.9;
            letter-spacing: 1px;
        }

        /* √Årea de Upload */
        .upload-area {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: clamp(12px, 2vw, 16px);
            margin-bottom: clamp(16px, 3vw, 20px);
            flex-wrap: wrap;
            position: relative;
            z-index: 20;
        }

        .update-log {
            background: var(--primary-light);
            padding: clamp(6px, 1.2vw, 8px) clamp(14px, 2.5vw, 18px);
            border-radius: 40px;
            font-size: clamp(12px, 2vw, 13px);
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: clamp(6px, 1.2vw, 8px);
            font-weight: 500;
        }

        .btn-clear {
            background: white;
            color: var(--gray);
            border: 1px solid var(--gray-light);
            padding: clamp(6px, 1.2vw, 8px) clamp(14px, 2.5vw, 18px);
            border-radius: 40px;
            font-size: clamp(12px, 2vw, 13px);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-clear:hover {
            background: #f1f5f9;
            border-color: var(--gray);
        }

        .btn-upload {
            background: var(--primary);
            color: white;
            border: none;
            padding: clamp(6px, 1.2vw, 8px) clamp(16px, 3vw, 22px);
            border-radius: 40px;
            font-size: clamp(12px, 2vw, 13px);
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: clamp(6px, 1.2vw, 8px);
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(46,125,96,0.2);
        }

        .btn-upload:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(46,125,96,0.3);
        }

        /* FILTROS DE PER√çODO */
        .period-filters {
            background: rgba(255,255,255,0.9);
            padding: clamp(6px, 1.5vw, 8px) clamp(12px, 2.5vw, 16px);
            border-radius: 60px;
            margin-bottom: clamp(12px, 2vw, 20px);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: clamp(8px, 1.5vw, 12px);
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(0,0,0,0.05);
            backdrop-filter: blur(5px);
            position: relative;
            z-index: 30;
        }

        .period-group {
            display: flex;
            gap: 4px;
            background: var(--light);
            padding: 4px;
            border-radius: 40px;
            flex-wrap: wrap;
        }

        .period-btn {
            padding: clamp(6px, 1.5vw, 8px) clamp(12px, 2.5vw, 18px);
            border: none;
            border-radius: 40px;
            font-size: clamp(11px, 2vw, 13px);
            font-weight: 500;
            cursor: pointer;
            background: transparent;
            color: var(--gray);
            transition: all 0.2s;
            white-space: nowrap;
        }

        .period-btn:hover {
            color: var(--primary);
            background: var(--primary-light);
        }

        .period-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(46,125,96,0.3);
        }

        .date-range {
            display: flex;
            gap: clamp(6px, 1.5vw, 10px);
            margin-left: auto;
            flex-wrap: wrap;
        }

        .date-range-item {
            display: flex;
            align-items: center;
            gap: 4px;
            background: var(--light);
            padding: clamp(4px, 1vw, 6px) clamp(8px, 1.5vw, 12px);
            border-radius: 40px;
        }

        .date-range-item input {
            border: none;
            background: transparent;
            font-size: clamp(10px, 1.8vw, 12px);
            width: min(90px, 20vw);
            padding: 4px;
        }

        /* FILTRO DE LOJAS */
        .filters {
            background: rgba(255,255,255,0.9);
            padding: clamp(16px, 2.5vw, 20px);
            border-radius: var(--border-radius-sm);
            margin-bottom: clamp(16px, 3vw, 24px);
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: var(--shadow-lg);
            border: 2px solid var(--primary);
            backdrop-filter: blur(5px);
            position: relative;
            z-index: 100;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
        }

        .filter-row:first-child {
            border-bottom: 1px solid var(--gray-light);
            padding-bottom: 12px;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark);
            min-width: 60px;
        }

        .filter-label i {
            color: var(--primary);
            margin-right: 5px;
        }

        .loja-filter-container {
            flex: 3;
            min-width: 400px;
        }

        .filter-select {
            flex: 1;
            min-width: 180px;
        }

        .multi-select {
            position: relative;
            width: 100%;
            z-index: 1000;
        }

        .select-btn {
            background: white;
            padding: 12px 18px;
            border-radius: 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            cursor: pointer;
            border: 2px solid var(--primary);
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(46,125,96,0.1);
            position: relative;
            z-index: 1001;
        }

        .select-btn:hover {
            border-color: var(--primary-dark);
            box-shadow: 0 0 0 4px var(--primary-light);
            transform: translateY(-1px);
        }

        .select-btn .selected-count {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 700;
            min-width: 35px;
            text-align: center;
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px;
            margin-top: 5px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            z-index: 999999;
            display: none;
            border: 2px solid var(--primary);
            overflow: hidden;
            max-height: 500px;
        }

        .dropdown-menu.show {
            display: block;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .search-box {
            padding: 15px;
            border-bottom: 2px solid var(--primary-light);
            position: relative;
            background: white;
        }

        .search-box input {
            width: 100%;
            padding: 14px 45px 14px 18px;
            border: 2px solid var(--primary);
            border-radius: 40px;
            font-size: 14px;
            transition: all 0.2s;
            background: #f8fafc;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-dark);
            box-shadow: 0 0 0 4px var(--primary-light);
            background: white;
        }

        .search-box i {
            position: absolute;
            right: 28px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            font-size: 16px;
        }

        .dropdown-actions {
            display: flex;
            gap: 12px;
            padding: 15px;
            border-bottom: 2px solid var(--primary-light);
            background: var(--light);
        }

        .action-btn {
            flex: 1;
            padding: 14px 10px;
            border: none;
            border-radius: 40px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-btn.select-all {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(46,125,96,0.3);
        }

        .action-btn.select-all:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(46,125,96,0.4);
        }

        .action-btn.clear-all {
            background: white;
            color: var(--danger);
            border: 2px solid var(--danger);
        }

        .action-btn.clear-all:hover {
            background: var(--danger-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(239,71,111,0.2);
        }

        .options-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px 0;
            background: white;
        }

        .option-item {
            padding: 12px 18px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            border-left: 4px solid transparent;
            border-bottom: 1px solid var(--gray-light);
        }

        .option-item:hover {
            background: var(--primary-light);
            border-left-color: var(--primary);
        }

        .option-item.selected {
            background: rgba(46,125,96,0.1);
            border-left-color: var(--primary);
            font-weight: 500;
        }

        .option-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .dropdown-close {
            padding: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border-top: 3px solid var(--primary);
            cursor: pointer;
            color: white;
            font-size: 16px;
            font-weight: 800;
            background: var(--primary);
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .dropdown-close:hover {
            background: var(--primary-dark);
            transform: scale(1.02);
        }

        .dropdown-close i {
            font-size: 18px;
        }

        .filter-select select {
            background: white;
            padding: 12px 40px 12px 18px;
            border-radius: 40px;
            border: 2px solid var(--gray-light);
            font-size: 13px;
            font-weight: 500;
            min-width: 180px;
            width: 100%;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%232e7d32' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            transition: all 0.2s;
        }

        .filter-select select:hover {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .filter-select select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        /* KPIs */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: clamp(12px, 2vw, 16px);
            margin-bottom: clamp(16px, 3vw, 24px);
            position: relative;
            z-index: 1;
        }

        .kpi-card {
            background: rgba(255,255,255,0.9);
            border-radius: var(--border-radius-sm);
            padding: clamp(16px, 3vw, 20px);
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(0,0,0,0.03);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(5px);
            z-index: 1;
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .kpi-header {
            display: flex;
            align-items: center;
            gap: clamp(8px, 1.5vw, 10px);
            margin-bottom: clamp(8px, 1.5vw, 12px);
        }

        .kpi-icon {
            width: clamp(32px, 5vw, 40px);
            height: clamp(32px, 5vw, 40px);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(16px, 2.5vw, 18px);
        }

        .kpi-icon.green { background: var(--primary-light); color: var(--primary); }
        .kpi-icon.red { background: var(--danger-light); color: var(--danger); }
        .kpi-icon.blue { background: #e6f0ff; color: #2563eb; }
        .kpi-icon.purple { background: #f0e7ff; color: #9b5de5; }

        .kpi-label {
            font-size: clamp(11px, 2vw, 13px);
            color: var(--gray);
            font-weight: 500;
        }

        .kpi-main {
            display: flex;
            align-items: baseline;
            gap: clamp(6px, 1.5vw, 8px);
            margin-bottom: clamp(8px, 1.5vw, 12px);
            flex-wrap: wrap;
        }

        .kpi-value {
            font-size: clamp(18px, 3.5vw, 24px);
            font-weight: 800;
            color: var(--dark);
            letter-spacing: -0.5px;
        }

        .kpi-value.success { color: var(--success); }
        .kpi-value.danger { color: var(--danger) !important; }

        .kpi-sub {
            font-size: clamp(10px, 1.8vw, 11px);
            color: var(--gray);
            background: var(--light);
            padding: 3px clamp(8px, 1.5vw, 10px);
            border-radius: 30px;
            font-weight: 500;
        }

        .kpi-comparison {
            font-size: clamp(11px, 2vw, 12px);
            color: var(--gray);
            padding-top: clamp(8px, 1.5vw, 10px);
            border-top: 1px solid var(--gray-light);
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--gray-light);
            border-radius: 10px;
            overflow: hidden;
            margin-top: clamp(6px, 1.5vw, 8px);
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-1);
            border-radius: 10px;
            transition: width 0.3s;
        }

        .lojas-status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: clamp(12px, 2vw, 16px);
            margin-bottom: clamp(16px, 3vw, 24px);
        }

        .status-card {
            background: rgba(255,255,255,0.9);
            border-radius: var(--border-radius-sm);
            padding: clamp(16px, 3vw, 20px);
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(0,0,0,0.03);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }

        .status-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .status-titulo {
            font-size: clamp(13px, 2.5vw, 15px);
            color: var(--gray);
            margin-bottom: clamp(8px, 1.5vw, 12px);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .status-valor {
            font-size: clamp(28px, 5vw, 36px);
            font-weight: 800;
            color: var(--dark);
            line-height: 1;
            margin-bottom: clamp(6px, 1.5vw, 8px);
        }

        .status-valor.success { color: var(--success); }
        .status-valor.danger { color: var(--danger); }

        .status-percentual {
            font-size: clamp(13px, 2.5vw, 15px);
            font-weight: 500;
        }

        .status-percentual.success { color: var(--success); }
        .status-percentual.danger { color: var(--danger); }

        .lojas-fechadas-container {
            background: var(--danger-light);
            border-radius: var(--border-radius-sm);
            padding: clamp(16px, 3vw, 20px);
            margin-bottom: clamp(16px, 3vw, 24px);
            border: 1px solid rgba(239,71,111,0.2);
        }

        .lojas-fechadas-titulo {
            font-size: clamp(14px, 2.5vw, 16px);
            font-weight: 600;
            color: var(--danger);
            margin-bottom: clamp(10px, 2vw, 15px);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .lojas-fechadas-lista {
            font-size: clamp(12px, 2.2vw, 14px);
            color: var(--dark);
            line-height: 1.8;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .loja-fechada-item {
            background: white;
            padding: 4px 14px;
            border-radius: 30px;
            border: 1px solid var(--danger);
            color: var(--danger);
            font-weight: 500;
            font-size: clamp(11px, 2vw, 13px);
        }

        /* GR√ÅFICOS */
        .charts-grid-2col {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: clamp(15px, 2.5vw, 20px);
            margin-bottom: clamp(16px, 3vw, 24px);
        }

        .charts-grid-3col {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: clamp(15px, 2.5vw, 20px);
            margin-bottom: clamp(16px, 3vw, 24px);
        }

        .chart-card {
            background: rgba(255,255,255,0.9);
            border-radius: var(--border-radius-sm);
            padding: clamp(16px, 3vw, 20px);
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(0,0,0,0.03);
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }

        .chart-card:hover {
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: clamp(12px, 2vw, 16px);
            padding-bottom: clamp(8px, 1.5vw, 12px);
            border-bottom: 1px solid var(--gray-light);
            flex-wrap: wrap;
            gap: 8px;
        }

        .chart-header h3 {
            font-size: clamp(14px, 2.5vw, 16px);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--dark);
        }

        .chart-header h3 i {
            color: var(--primary);
        }

        .chart-header .badge {
            background: var(--light);
            padding: 5px clamp(10px, 2vw, 14px);
            border-radius: 40px;
            font-size: clamp(11px, 2vw, 12px);
            font-weight: 600;
            color: var(--gray);
        }

        .chart-wrapper {
            height: clamp(200px, 30vw, 240px);
            position: relative;
        }

        /* RANKINGS SIMPLIFICADOS */
        .rankings-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: clamp(15px, 2.5vw, 20px);
            margin-bottom: clamp(16px, 3vw, 24px);
        }

        .ranking-card {
            background: rgba(255,255,255,0.9);
            border-radius: var(--border-radius-sm);
            padding: clamp(16px, 3vw, 20px);
            box-shadow: var(--shadow-lg);
            border: 2px solid var(--primary);
            backdrop-filter: blur(5px);
            transition: all 0.3s;
        }

        .ranking-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
        }

        .ranking-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary);
        }

        .ranking-header i {
            font-size: 24px;
            color: var(--primary);
            background: var(--primary-light);
            padding: 12px;
            border-radius: 50%;
        }

        .ranking-header h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            flex: 1;
        }

        .ranking-header .badge {
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
        }

        .podium {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px 10px;
            background: linear-gradient(180deg, var(--primary-light) 0%, transparent 100%);
            border-radius: 20px;
            flex-wrap: wrap;
        }

        .podium-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            min-width: 100px;
        }

        .podium-1 {
            order: 2;
            transform: scale(1.1);
        }

        .podium-2 {
            order: 1;
        }

        .podium-3 {
            order: 3;
        }

        .podium-medalha {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            margin-bottom: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .podium-1 .podium-medalha {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            box-shadow: 0 10px 20px rgba(255,215,0,0.3);
        }

        .podium-2 .podium-medalha {
            background: linear-gradient(135deg, #C0C0C0, #A0A0A0);
            box-shadow: 0 10px 20px rgba(192,192,192,0.3);
        }

        .podium-3 .podium-medalha {
            background: linear-gradient(135deg, #CD7F32, #B87333);
            box-shadow: 0 10px 20px rgba(205,127,50,0.3);
        }

        .podium-nome {
            font-weight: 800;
            color: var(--dark);
            font-size: 16px;
            margin-bottom: 5px;
        }

        .podium-valor {
            font-weight: 700;
            font-size: 14px;
            color: var(--primary);
            background: rgba(255,255,255,0.7);
            padding: 3px 10px;
            border-radius: 20px;
        }

        .ranking-lista {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: var(--light);
            border-radius: 12px;
            border-left: 5px solid;
            transition: all 0.2s;
        }

        .ranking-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-sm);
        }

        .ranking-posicao {
            width: 32px;
            height: 32px;
            background: var(--gray-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: var(--gray);
            margin-right: 12px;
            flex-shrink: 0;
        }

        .ranking-posicao.top-1 {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
        }

        .ranking-posicao.top-2 {
            background: linear-gradient(135deg, #C0C0C0, #A0A0A0);
            color: white;
        }

        .ranking-posicao.top-3 {
            background: linear-gradient(135deg, #CD7F32, #B87333);
            color: white;
        }

        .ranking-info {
            flex: 1;
        }

        .ranking-nome {
            font-weight: 700;
            color: var(--dark);
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .ranking-stats {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: var(--gray);
            flex-wrap: wrap;
        }

        .ranking-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .ranking-stat i {
            color: var(--primary);
            font-size: 11px;
        }

        .ranking-valor {
            font-weight: 600;
            color: var(--primary);
        }

        .ranking-percentual {
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 20px;
            background: white;
        }

        .ranking-percentual.alta { 
            color: var(--success);
            background: var(--success-light);
        }
        
        .ranking-percentual.media { 
            color: #f97316;
            background: #fff3e0;
        }
        
        .ranking-percentual.baixa { 
            color: var(--danger);
            background: var(--danger-light);
        }

        .ranking-medalha-icon {
            font-size: 16px;
            margin-left: 5px;
        }

        /* Tabela Detalhamento */
        .tables-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: clamp(15px, 2.5vw, 20px);
            margin-bottom: clamp(16px, 3vw, 24px);
        }

        .table-card {
            background: rgba(255,255,255,0.9);
            border-radius: var(--border-radius-sm);
            padding: clamp(16px, 3vw, 20px);
            box-shadow: var(--shadow);
            border: 2px solid var(--primary);
            backdrop-filter: blur(5px);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: clamp(12px, 2vw, 16px);
            padding-bottom: clamp(8px, 1.5vw, 12px);
            border-bottom: 2px solid var(--primary);
            flex-wrap: wrap;
            gap: 8px;
        }

        .table-header h2 {
            font-size: clamp(14px, 2.5vw, 16px);
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--gray-light);
            max-height: min(400px, 50vh);
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: clamp(11px, 2vw, 13px);
            min-width: 1100px;
        }

        th {
            background: var(--light);
            padding: clamp(10px, 1.8vw, 14px) clamp(6px, 1.2vw, 8px);
            position: sticky;
            top: 0;
            border-bottom: 2px solid var(--primary);
            cursor: pointer;
            font-weight: 700;
            font-size: clamp(10px, 1.8vw, 12px);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--dark);
            white-space: nowrap;
        }

        th:hover {
            background: var(--gray-light);
        }

        td {
            padding: clamp(8px, 1.5vw, 12px) clamp(6px, 1.2vw, 8px);
            border-bottom: 1px solid var(--gray-light);
            text-align: center;
        }

        tr:hover {
            background: var(--primary-light);
        }

        .store-name {
            font-weight: 600;
            color: var(--primary);
        }

        .hora-cell {
            font-family: 'JetBrains Mono', monospace;
            font-size: clamp(10px, 1.8vw, 12px);
            color: var(--gray);
        }

        .valor-positivo { color: var(--success) !important; font-weight: 600; }
        .valor-negativo { color: var(--danger) !important; font-weight: 600; }

        .meta-sim {
            background: var(--success-light);
            color: var(--success);
            padding: 4px 12px;
            border-radius: 30px;
            font-size: clamp(10px, 1.8vw, 11px);
            font-weight: 600;
            display: inline-block;
        }

        .meta-nao {
            background: var(--danger-light);
            color: var(--danger);
            padding: 4px 12px;
            border-radius: 30px;
            font-size: clamp(10px, 1.8vw, 11px);
            font-weight: 600;
            display: inline-block;
        }

        .loja-fechada {
            background: #f1f5f9;
            color: var(--gray);
            padding: 4px 12px;
            border-radius: 30px;
            font-size: clamp(10px, 1.8vw, 11px);
            font-weight: 600;
            display: inline-block;
        }

        .footer {
            margin-top: clamp(20px, 4vw, 30px);
            text-align: center;
            font-size: clamp(11px, 2vw, 12px);
            color: var(--gray);
            padding: 20px 0 10px;
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        @media (max-width: 1200px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .charts-grid-2col { grid-template-columns: 1fr; }
            .charts-grid-3col { grid-template-columns: repeat(2, 1fr); }
            .rankings-container { grid-template-columns: 1fr; }
        }

        @media (max-width: 900px) {
            .charts-grid-3col { grid-template-columns: 1fr; }
            .filter-row { flex-direction: column; align-items: stretch; }
            .loja-filter-container { min-width: 100%; }
            .filter-select { width: 100%; }
            .podium { flex-direction: column; align-items: center; }
            .podium-item { transform: scale(1); width: 100%; }
            .podium-1 { order: 1; }
        }

        @media (max-width: 600px) {
            .kpi-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-title">
                    <h1><i class="fas fa-store-alt"></i> REX - Setor Patty</h1>
                    <p>
                        <i class="fas fa-store"></i> <span id="totalLojasHeader">0</span> Lojas em opera√ß√£o
                        <i class="fas fa-circle" style="font-size: 6px;"></i>
                        <i class="fas fa-calendar"></i> Fevereiro 2026
                    </p>
                </div>
                <div class="header-date">
                    <div class="day" id="headerDay">15</div>
                    <div class="month" id="headerMonth">FEVEREIRO 2026</div>
                </div>
            </div>
        </div>

        <!-- Upload Area -->
        <div class="upload-area">
            <div class="update-log">
                <i class="fas fa-clock"></i>
                <span id="dataAtualizacao">15/02/2026, 22:43:28</span>
            </div>
            <button class="btn-clear" onclick="limparDadosSalvos()">
                <i class="fas fa-trash"></i> Limpar
            </button>
            <button class="btn-upload" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-upload"></i> Atualizar
            </button>
            <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" onchange="processarPlanilha(this)" style="display: none;">
        </div>

        <!-- Filtros de Per√≠odo -->
        <div class="period-filters">
            <div class="period-group">
                <button class="period-btn" onclick="setPeriodo('hoje')">Hoje</button>
                <button class="period-btn" onclick="setPeriodo('ontem')">Ontem</button>
                <button class="period-btn" onclick="setPeriodo('7d')">√öltimos 7 dias</button>
                <button class="period-btn" onclick="setPeriodo('15d')">√öltimos 15 dias</button>
                <button class="period-btn" onclick="setPeriodo('mes')">M√™s</button>
                <button class="period-btn" onclick="setPeriodo('custom')">Per√≠odo</button>
            </div>
            <div class="date-range" id="dateRangeInputs" style="display: none;">
                <div class="date-range-item">
                    <label>De:</label>
                    <input type="date" id="dataInicio" onchange="atualizarPorData()">
                </div>
                <div class="date-range-item">
                    <label>At√©:</label>
                    <input type="date" id="dataFim" onchange="atualizarPorData()">
                </div>
            </div>
        </div>

        <!-- FILTROS -->
        <div class="filters">
            <!-- Primeira linha: Lojas -->
            <div class="filter-row">
                <span class="filter-label"><i class="fas fa-store"></i> Lojas:</span>
                <div class="loja-filter-container">
                    <div class="multi-select" id="lojaMultiSelect">
                        <div class="select-btn" onclick="toggleLojaDropdown()">
                            <span id="selectedLojasText">Todas as Lojas</span>
                            <span class="selected-count" id="selectedCount">0</span>
                        </div>
                        <div class="dropdown-menu" id="lojaDropdown">
                            <!-- Campo de busca -->
                            <div class="search-box">
                                <input type="text" id="lojaSearch" placeholder="Buscar loja por nome ou c√≥digo...">
                                <i class="fas fa-search"></i>
                            </div>
                            
                            <!-- A√ß√µes: Selecionar Todas e Limpar Todas -->
                            <div class="dropdown-actions">
                                <button class="action-btn select-all" onclick="selecionarTodasLojas()">
                                    <i class="fas fa-check-square"></i> Selecionar Todas
                                </button>
                                <button class="action-btn clear-all" onclick="limparTodasLojas()">
                                    <i class="fas fa-times-square"></i> Limpar Todas
                                </button>
                            </div>
                            
                            <!-- Lista de lojas -->
                            <div class="options-list" id="lojaOptions"></div>
                            
                            <!-- Bot√£o Concluir Sele√ß√£o -->
                            <div class="dropdown-close" onclick="fecharDropdownLojas()">
                                <i class="fas fa-check-circle"></i> CONCLUIR SELE√á√ÉO
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Segunda linha: ADM e Status -->
            <div class="filter-row">
                <span class="filter-label"><i class="fas fa-user-tie"></i> ADM:</span>
                <div class="filter-select">
                    <select id="admFilter" onchange="aplicarFiltros()">
                        <option value="">Todos os ADMs</option>
                    </select>
                </div>
                
                <span class="filter-label"><i class="fas fa-flag"></i> Status:</span>
                <div class="filter-select">
                    <select id="statusFilter" onchange="aplicarFiltros()">
                        <option value="">Todos os Status</option>
                        <option value="SIM">‚úÖ Meta Atingida</option>
                        <option value="N√ÉO">‚ùå Abaixo da Meta</option>
                        <option value="FECHADA">üî¥ Loja Fechada</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- CARDS DE INDICADORES -->
        <div class="kpi-grid">
            <!-- Card 1: Total de Lojas -->
            <div class="kpi-card" onclick="filtrarPorStatus('')">
                <div class="kpi-header">
                    <div class="kpi-icon blue"><i class="fas fa-store"></i></div>
                    <span class="kpi-label">Total de Lojas</span>
                </div>
                <div class="kpi-main">
                    <span class="kpi-value" id="totalLojas">0</span>
                    <span class="kpi-sub" id="totalLojasPeriodo">0d</span>
                </div>
                <div class="kpi-comparison" id="lojasAtivas"></div>
            </div>

            <!-- Card 2: Faturamento -->
            <div class="kpi-card" onclick="filtrarPorStatus('')">
                <div class="kpi-header">
                    <div class="kpi-icon green"><i class="fas fa-dollar-sign"></i></div>
                    <span class="kpi-label">Faturamento</span>
                </div>
                <div class="kpi-main">
                    <span class="kpi-value" id="totalFaturamento">R$ 0</span>
                </div>
                <div class="kpi-comparison" id="percentualMeta">0% vs meta</div>
            </div>

            <!-- Card 3: Meta Total -->
            <div class="kpi-card" onclick="filtrarPorStatus('')">
                <div class="kpi-header">
                    <div class="kpi-icon green"><i class="fas fa-bullseye"></i></div>
                    <span class="kpi-label">Meta Total</span>
                </div>
                <div class="kpi-main">
                    <span class="kpi-value" id="totalMeta">R$ 0</span>
                    <span class="kpi-sub" id="metasAtingidas">0/0</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressoMeta" style="width:0%"></div>
                </div>
            </div>

            <!-- Card 4: Diferen√ßa -->
            <div class="kpi-card" onclick="filtrarPorStatus('')">
                <div class="kpi-header">
                    <div class="kpi-icon red"><i class="fas fa-balance-scale"></i></div>
                    <span class="kpi-label">Diferen√ßa</span>
                </div>
                <div class="kpi-main">
                    <span class="kpi-value" id="totalDiferenca">R$ 0</span>
                    <span class="emoji-indicator" id="diferencaEmoji"></span>
                </div>
                <div class="kpi-comparison" id="diferencaText">0%</div>
            </div>

            <!-- Card 5: Ticket M√©dio -->
            <div class="kpi-card" onclick="filtrarPorStatus('')">
                <div class="kpi-header">
                    <div class="kpi-icon green"><i class="fas fa-ticket-alt"></i></div>
                    <span class="kpi-label">Ticket M√©dio</span>
                </div>
                <div class="kpi-main">
                    <span class="kpi-value" id="ticketMedio">R$ 0</span>
                </div>
                <div class="kpi-comparison" id="ticketPeriodo">hoje</div>
            </div>

            <!-- Card 6: Metas OK -->
            <div class="kpi-card" onclick="filtrarPorStatus('SIM')">
                <div class="kpi-header">
                    <div class="kpi-icon green"><i class="fas fa-trophy"></i></div>
                    <span class="kpi-label">Metas OK</span>
                </div>
                <div class="kpi-main">
                    <span class="kpi-value success" id="metasAtingidasValor">0</span>
                    <span class="kpi-sub" id="metasPercentual">0%</span>
                </div>
                <div class="kpi-comparison">das ativas</div>
            </div>

            <!-- Card 7: Abaixo -->
            <div class="kpi-card" onclick="filtrarPorStatus('N√ÉO')">
                <div class="kpi-header">
                    <div class="kpi-icon red"><i class="fas fa-times-circle"></i></div>
                    <span class="kpi-label">Abaixo</span>
                </div>
                <div class="kpi-main">
                    <span class="kpi-value danger" id="metasNaoValor">0</span>
                    <span class="kpi-sub" id="metasNaoPercentual">0%</span>
                </div>
                <div class="kpi-comparison">das ativas</div>
            </div>

            <!-- Card 8: Fechadas -->
            <div class="kpi-card" onclick="filtrarPorStatus('FECHADA')">
                <div class="kpi-header">
                    <div class="kpi-icon red"><i class="fas fa-store-slash"></i></div>
                    <span class="kpi-label">Fechadas</span>
                </div>
                <div class="kpi-main">
                    <span class="kpi-value danger" id="lojasFechadas">0</span>
                    <span class="kpi-sub" id="percentualFechadas">0%</span>
                </div>
                <div class="kpi-comparison">do total</div>
            </div>
        </div>

        <!-- Status Cards -->
        <div class="lojas-status-grid">
            <div class="status-card" onclick="filtrarPorStatus('OPERACAO')">
                <div class="status-titulo">
                    <i class="fas fa-store-alt" style="color: var(--success);"></i> Lojas em Opera√ß√£o
                </div>
                <div class="status-valor success" id="lojasOperacaoValor">0</div>
                <div class="status-percentual success" id="lojasOperacaoPercentual">0%</div>
            </div>

            <div class="status-card" onclick="filtrarPorStatus('FECHADA')">
                <div class="status-titulo">
                    <i class="fas fa-store-slash" style="color: var(--danger);"></i> Lojas Fechadas
                </div>
                <div class="status-valor danger" id="lojasFechadasValor">0</div>
                <div class="status-percentual danger" id="lojasFechadasPercentual">0%</div>
            </div>
        </div>

        <!-- Lista de Lojas Fechadas -->
        <div class="lojas-fechadas-container">
            <div class="lojas-fechadas-titulo">
                <i class="fas fa-door-closed"></i> Lojas Fechadas no Per√≠odo:
            </div>
            <div class="lojas-fechadas-lista" id="listaFechadasCompleta">
                Carregando...
            </div>
        </div>

        <!-- GR√ÅFICOS -->
        <div class="charts-grid-2col">
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-pie"></i> Distribui√ß√£o por Canal</h3>
                    <span class="badge">Vendas</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="canalPieChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-bar"></i> Top 10 Faturamento</h3>
                    <span class="badge">Ranking</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="top10BarChart"></canvas>
                </div>
            </div>
        </div>

        <div class="charts-grid-3col">
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-line"></i> Desempenho por Loja</h3>
                    <span class="badge">% Meta</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="desempenhoBarChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-tachometer-alt"></i> Ranking por ADM</h3>
                    <span class="badge">Faturamento</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="admRankingChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-simple"></i> Canais por ADM</h3>
                    <span class="badge">An√°lise</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="canaisPorAdmChart"></canvas>
                </div>
            </div>
        </div>

        <!-- RANKINGS SIMPLIFICADOS -->
        <div class="rankings-container">
            <!-- Ranking por Faturamento -->
            <div class="ranking-card" id="rankingFaturamento">
                <div class="ranking-header">
                    <i class="fas fa-chart-line"></i>
                    <h3>Top 3 Faturamento</h3>
                    <span class="badge">R$</span>
                </div>
                <div class="podium" id="podiumFaturamento">
                    <!-- Preenchido via JavaScript -->
                </div>
                <div class="ranking-lista" id="listaFaturamento">
                    <!-- Preenchido via JavaScript -->
                </div>
            </div>

            <!-- Ranking por Performance (% Meta) -->
            <div class="ranking-card" id="rankingPerformance">
                <div class="ranking-header">
                    <i class="fas fa-trophy"></i>
                    <h3>Top 3 Performance</h3>
                    <span class="badge">% Meta</span>
                </div>
                <div class="podium" id="podiumPerformance">
                    <!-- Preenchido via JavaScript -->
                </div>
                <div class="ranking-lista" id="listaPerformance">
                    <!-- Preenchido via JavaScript -->
                </div>
            </div>
        </div>

        <!-- Tabela Detalhamento -->
        <div class="tables-section">
            <div class="table-card">
                <div class="table-header">
                    <h2><i class="fas fa-list"></i> Detalhamento de Vendas</h2>
                    <span class="badge"><span id="registrosCount">0</span> registros</span>
                </div>
                <div class="table-wrapper">
                    <table id="mainTable">
                        <thead>
                            <tr>
                                <th onclick="ordenarTabela(0)">Data <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(1)">Loja <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(2)">ADM <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(3)">In√≠cio <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(4)">Fim <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(5)">Cupons <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(6)">Faturamento <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(7)">Meta <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(8)">Diferen√ßa <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(9)">% <i class="fas fa-sort"></i></th>
                                <th onclick="ordenarTabela(10)">Status <i class="fas fa-sort"></i></th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>¬© 2026 REX - Setor Patty | Ragazzo! Tudo que √© gostoso</p>
        </div>
    </div>

    <!-- DADOS EMBUTIDOS PARA PERSIST√äNCIA - FIXO -->
    <script id="dados-embedded" type="application/json">
        // OS DADOS SER√ÉO SALVOS AQUI AUTOMATICAMENTE E PERMANECER√ÉO FIXOS
    </script>

    <script>
        // MAPEAMENTO DAS LOJAS
        const lojaNomes = {
            5: "ANTONIO AGU",
            10: "OSASCO PLAZA",
            28: "SHOPPING TAMBOR√â",
            31: "AUGUSTA",
            63: "SHOPPING ITAPECERICA",
            69: "PERUS",
            73: "BRIGADEIRO JARDINS",
            82: "TEODORO SAMPAIO",
            86: "REX RAFAEL DE BARROS",
            90: "SHOPPING PARQUE BARUERI",
            97: "ASSA√ç JO√ÉO DIAS",
            98: "FRANCO DA ROCHA",
            101: "CARREFOUR RAPOSO TAVARES",
            118: "SHOPPING ITAPECERICA II",
            126: "OSASCO JO√ÉO DE ANDRADE",
            133: "PARQUE TIET√ä",
            145: "ITASHOPPING",
            157: "JARDIM S√ÉO LUIZ",
            158: "ASSA√ç CARAPICU√çBA",
            162: "MARQUESA TAIPAS",
            178: "EXTRA CARAPICU√çBA",
            183: "FRANCO DA ROCHA 2",
            189: "SHOPPING PATIO CIAN√ä",
            195: "EXTRA JARAGU√Å",
            210: "ASSA√ç ABOLI√á√ÉO CAMPINAS",
            247: "METR√î CCR VILA DAS BELEZAS",
            248: "METR√î CCR CAP√ÉO REDONDO",
            251: "SOROCABA CENTRO",
            262: "ASSA√ç INDAIATUBA",
            285: "EXTRA JARDIM √ÇNGELA",
            294: "SHOPPING RAPOSO"
        };

        const admPorLoja = {
            247: "Thais", 157: "Thais", 63: "Thais", 285: "Thais", 118: "Thais", 248: "Thais", 97: "Thais",
            262: "Fernando", 210: "Fernando",
            31: "Hedla", 73: "Hedla", 86: "Hedla", 82: "Hedla",
            145: "Elves", 251: "Elves", 294: "Elves", 101: "Elves", 189: "Elves",
            69: "Gabriela", 162: "Gabriela", 195: "Gabriela", 133: "Gabriela", 183: "Gabriela", 98: "Gabriela",
            158: "Marcia", 90: "Marcia", 28: "Marcia", 178: "Marcia",
            5: "Wagner", 126: "Wagner", 10: "Wagner"
        };

        // Vari√°veis globais
        let dadosCompletos = [];
        const dadosPorData = {};
        let dataInicio = "", dataFim = "";
        let periodoSelecionado = "hoje";
        let lojasSelecionadas = [];
        let todasLojas = [];
        let termoBuscaLojas = '';
        
        // Gr√°ficos
        let canalPieChart, top10BarChart, desempenhoBarChart, admRankingChart, canaisPorAdmChart;
        let ordemAtual = { coluna: -1, ascendente: true };

        // ===== FUN√á√ÉO PARA CARREGAR DADOS SALVOS =====
        function carregarDadosSalvos() {
            const dadosSalvos = document.getElementById('dados-embedded')?.textContent;
            if (dadosSalvos && dadosSalvos.trim() !== '' && !dadosSalvos.includes('OS DADOS SER√ÉO SALVOS AQUI')) {
                try {
                    const parsed = JSON.parse(dadosSalvos);
                    if (parsed?.dadosCompletos?.length) {
                        dadosCompletos = parsed.dadosCompletos;
                        document.getElementById('dataAtualizacao').innerText = parsed.dataAtualizacao || new Date().toLocaleString('pt-BR');
                        return true;
                    }
                } catch (e) {
                    console.error('Erro ao carregar dados salvos:', e);
                }
            }
            return false;
        }

        // ===== FUN√á√ÉO PARA SALVAR DADOS NO HTML =====
        function salvarDadosNoHTML() {
            const embedded = document.getElementById('dados-embedded');
            if (embedded) {
                const dadosParaSalvar = {
                    dadosCompletos: dadosCompletos,
                    dataAtualizacao: new Date().toLocaleString('pt-BR')
                };
                embedded.textContent = JSON.stringify(dadosParaSalvar);
                console.log('‚úÖ Dados salvos permanentemente no HTML!');
            }
        }

        // ===== PROCESSAR DADOS CARREGADOS =====
        function processarDadosCarregados() {
            // Organizar dados por data
            for (let key in dadosPorData) delete dadosPorData[key];
            dadosCompletos.forEach(reg => {
                if (reg.data) {
                    if (!dadosPorData[reg.data]) dadosPorData[reg.data] = [];
                    dadosPorData[reg.data].push(reg);
                }
            });

            todasLojas = [...new Set(dadosCompletos.map(d => d.loja))].sort((a,b)=>a-b);
            lojasSelecionadas = [...todasLojas];
            
            document.getElementById('totalLojasHeader').innerText = todasLojas.length;
            document.getElementById('selectedCount').innerText = todasLojas.length;
            
            const datas = Object.keys(dadosPorData).sort();
            if (datas.length) dataInicio = dataFim = datas[0];
            
            preencherOpcoesLojas();
            preencherADMFilter();
            atualizarTextoSelecionadas();
            
            // Aplicar per√≠odo e atualizar tudo
            setPeriodo('hoje');
        }

        // ===== INICIALIZA√á√ÉO - CARREGAR DADOS SALVOS =====
        (function() {
            if (carregarDadosSalvos()) {
                console.log('‚úÖ Dados carregados do HTML com sucesso!');
                // Processar ap√≥s um pequeno delay para garantir que tudo est√° carregado
                setTimeout(() => {
                    processarDadosCarregados();
                }, 100);
            } else {
                console.log('‚ÑπÔ∏è Nenhum dado salvo encontrado');
            }
        })();

        // FUN√á√ïES DO FILTRO DE LOJAS
        window.toggleLojaDropdown = function() {
            document.getElementById('lojaDropdown').classList.add('show');
            document.getElementById('lojaSearch').focus();
            filtrarLojas();
        };

        window.fecharDropdownLojas = function() {
            document.getElementById('lojaDropdown').classList.remove('show');
            aplicarFiltros();
        };

        // Fechar ao clicar fora
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('lojaDropdown');
            const multiSelect = document.getElementById('lojaMultiSelect');
            
            if (dropdown && multiSelect) {
                if (!multiSelect.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            }
        });

        // Busca de lojas
        window.filtrarLojas = function() {
            const searchInput = document.getElementById('lojaSearch');
            if (searchInput) {
                termoBuscaLojas = searchInput.value.toLowerCase();
            }
            const options = document.querySelectorAll('.option-item');
            options.forEach(opt => {
                const span = opt.querySelector('span');
                if (span) {
                    const texto = span.innerText.toLowerCase();
                    opt.style.display = texto.includes(termoBuscaLojas) ? 'flex' : 'none';
                }
            });
        };

        document.getElementById('lojaSearch')?.addEventListener('keyup', filtrarLojas);

        // Selecionar/deselecionar loja individual
        window.toggleLoja = function(loja, event) {
            if (event) event.stopPropagation();
            
            const index = lojasSelecionadas.indexOf(loja);
            if (index === -1) {
                lojasSelecionadas.push(loja);
            } else {
                lojasSelecionadas.splice(index, 1);
            }
            
            atualizarTextoSelecionadas();
            preencherOpcoesLojas();
            aplicarFiltros();
        };

        // Selecionar todas as lojas
        window.selecionarTodasLojas = function() {
            lojasSelecionadas = [...todasLojas];
            atualizarTextoSelecionadas();
            preencherOpcoesLojas();
            aplicarFiltros();
        };

        // Limpar todas as lojas
        window.limparTodasLojas = function() {
            lojasSelecionadas = [];
            atualizarTextoSelecionadas();
            preencherOpcoesLojas();
            aplicarFiltros();
        };

        // Preencher lista de lojas
        function preencherOpcoesLojas() {
            const optionsDiv = document.getElementById('lojaOptions');
            if (!optionsDiv) return;
            
            let html = '';
            todasLojas.forEach(loja => {
                const nome = lojaNomes[loja] || `Loja ${loja}`;
                const adm = admPorLoja[loja] || '?';
                const checked = lojasSelecionadas.includes(loja) ? 'checked' : '';
                const selectedClass = lojasSelecionadas.includes(loja) ? 'selected' : '';
                
                html += `<div class="option-item ${selectedClass}" onclick="toggleLoja(${loja}, event)">
                    <input type="checkbox" ${checked} onchange="toggleLoja(${loja}, event)" onclick="event.stopPropagation()">
                    <span><strong>${loja}</strong> - ${nome} (${adm})</span>
                </div>`;
            });
            optionsDiv.innerHTML = html;
            filtrarLojas();
        }

        // Preencher filtro de ADM
        function preencherADMFilter() {
            const select = document.getElementById('admFilter');
            if (!select) return;
            
            select.innerHTML = '<option value="">Todos os ADMs</option>';
            const adms = [...new Set(dadosCompletos.map(d => d.adm))].sort();
            adms.forEach(adm => {
                if (adm && adm !== 'N√£o mapeado') {
                    select.innerHTML += `<option value="${adm}">${adm}</option>`;
                }
            });
        }

        // Atualizar texto do bot√£o de lojas
        function atualizarTextoSelecionadas() {
            const count = lojasSelecionadas.length;
            document.getElementById('selectedCount').innerText = count;
            
            const textSpan = document.getElementById('selectedLojasText');
            if (textSpan) {
                textSpan.innerText = count === 0 ? 'Nenhuma loja' : 
                                    count === todasLojas.length ? 'Todas as Lojas' : 
                                    `${count} lojas`;
            }
        }

        // Fun√ß√£o para filtrar por status (chamada pelos cards)
        window.filtrarPorStatus = function(status) {
            const select = document.getElementById('statusFilter');
            if (!select) return;
            
            if (status === 'OPERACAO') {
                select.value = '';
            } else {
                select.value = status;
            }
            aplicarFiltros();
        };

        // Aplicar filtros e atualizar tudo
        window.aplicarFiltros = function() {
            const dados = getDadosPeriodo();
            const status = document.getElementById('statusFilter').value;
            const adm = document.getElementById('admFilter').value;
            
            const filtrados = dados.filter(l => {
                if (lojasSelecionadas.length && !lojasSelecionadas.includes(l.loja)) return false;
                if (status && l.status !== status) return false;
                if (adm && l.adm !== adm) return false;
                return true;
            });
            
            atualizarKPIs(filtrados);
            atualizarTabela(filtrados);
            atualizarGraficos(filtrados);
            atualizarLojasIndicadores(dados);
            atualizarRankingsADM(filtrados);
            
            // Salvar dados no HTML para persist√™ncia
            salvarDadosNoHTML();
        };

        // ===== RANKINGS SIMPLIFICADOS =====
        function atualizarRankingsADM(dados) {
            const admDados = {};
            
            // Agrupar dados por ADM
            dados.forEach(l => {
                if (!admDados[l.adm]) {
                    admDados[l.adm] = {
                        nome: l.adm,
                        faturamento: 0,
                        meta: 0,
                        lojas: new Set()
                    };
                }
                admDados[l.adm].faturamento += l.faturamento;
                admDados[l.adm].meta += l.meta;
                admDados[l.adm].lojas.add(l.loja);
            });

            // Converter para array e calcular percentual
            const adms = Object.values(admDados).map(adm => ({
                ...adm,
                percentual: adm.meta > 0 ? (adm.faturamento / adm.meta * 100) : 0,
                totalLojas: adm.lojas.size
            }));

            // Ranking por Faturamento
            const rankingFaturamento = [...adms].sort((a, b) => b.faturamento - a.faturamento);
            
            // Ranking por Performance (% Meta)
            const rankingPerformance = [...adms]
                .filter(adm => adm.meta > 0) // S√≥ considera quem tem meta
                .sort((a, b) => b.percentual - a.percentual);

            // Atualizar Podium e Lista de Faturamento
            atualizarPodium('Faturamento', rankingFaturamento);
            atualizarLista('Faturamento', rankingFaturamento);
            
            // Atualizar Podium e Lista de Performance
            atualizarPodium('Performance', rankingPerformance);
            atualizarLista('Performance', rankingPerformance);
        }

        function atualizarPodium(tipo, ranking) {
            const podiumDiv = document.getElementById(`podium${tipo}`);
            if (!podiumDiv) return;

            const top3 = ranking.slice(0, 3);
            if (top3.length === 0) {
                podiumDiv.innerHTML = '<div style="text-align: center; color: var(--gray); padding: 20px;">Sem dados suficientes</div>';
                return;
            }

            let html = '';
            
            // Ajustar ordem do podium (2¬∫, 1¬∫, 3¬∫)
            const ordem = [1, 0, 2];
            for (let i = 0; i < 3; i++) {
                const idx = ordem[i];
                if (idx >= top3.length) continue;
                
                const adm = top3[idx];
                const posicao = idx + 1;
                const medalha = posicao === 1 ? 'ü•á' : posicao === 2 ? 'ü•à' : 'ü•â';
                
                let valor = tipo === 'Faturamento' 
                    ? `R$ ${formatMoney(adm.faturamento)}`
                    : `${adm.percentual.toFixed(1)}%`;
                
                html += `
                    <div class="podium-item podium-${posicao}">
                        <div class="podium-medalha">${medalha}</div>
                        <div class="podium-nome">${adm.nome}</div>
                        <div class="podium-valor">${valor}</div>
                    </div>
                `;
            }

            podiumDiv.innerHTML = html;
        }

        function atualizarLista(tipo, ranking) {
            const listaDiv = document.getElementById(`lista${tipo}`);
            if (!listaDiv) return;

            let html = '';
            ranking.forEach((adm, index) => {
                const posicao = index + 1;
                let classePosicao = '';
                if (posicao === 1) classePosicao = 'top-1';
                else if (posicao === 2) classePosicao = 'top-2';
                else if (posicao === 3) classePosicao = 'top-3';

                const medalha = posicao <= 3 ? (posicao === 1 ? 'ü•á' : posicao === 2 ? 'ü•à' : 'ü•â') : '';
                
                let classePercentual = 'baixa';
                if (adm.percentual >= 100) classePercentual = 'alta';
                else if (adm.percentual >= 70) classePercentual = 'media';

                const valorPrincipal = tipo === 'Faturamento' 
                    ? `R$ ${formatMoney(adm.faturamento)}`
                    : `${adm.percentual.toFixed(1)}%`;

                const infoAdicional = tipo === 'Faturamento'
                    ? `<span class="ranking-stat"><i class="fas fa-percent"></i> ${adm.percentual.toFixed(1)}% meta</span>`
                    : `<span class="ranking-stat"><i class="fas fa-dollar-sign"></i> R$ ${formatMoney(adm.faturamento)}</span>`;

                html += `
                    <div class="ranking-item" style="border-left-color: ${adm.percentual >= 100 ? '#06d6a0' : (adm.percentual >= 70 ? '#f97316' : '#ef476f')};">
                        <div class="ranking-posicao ${classePosicao}">${posicao}</div>
                        <div class="ranking-info">
                            <div class="ranking-nome">
                                ${adm.nome}
                                ${medalha ? `<span class="ranking-medalha-icon">${medalha}</span>` : ''}
                            </div>
                            <div class="ranking-stats">
                                <span class="ranking-stat">
                                    <i class="fas fa-${tipo === 'Faturamento' ? 'dollar-sign' : 'percent'}"></i>
                                    <span class="ranking-valor">${valorPrincipal}</span>
                                </span>
                                ${infoAdicional}
                                <span class="ranking-stat">
                                    <i class="fas fa-store"></i>
                                    <span>${adm.totalLojas} lojas</span>
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            });

            listaDiv.innerHTML = html;
        }

        // Processar planilha importada
        function processarPlanilha(input) {
            if (!input.files?.[0]) return;
            
            const arquivo = input.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const dadosBrutos = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (dadosBrutos.length < 2) return alert('Planilha vazia');

                    dadosCompletos = [];
                    
                    for (let i = 1; i < dadosBrutos.length; i++) {
                        const linha = dadosBrutos[i];
                        if (!linha?.length) continue;
                        
                        let codigoLoja = linha[0];
                        if (!codigoLoja) continue;
                        if (typeof codigoLoja === 'string') codigoLoja = parseInt(codigoLoja.replace(/\D/g, ''));
                        if (!lojaNomes[codigoLoja]) continue;
                        
                        // Processar data
                        let dataStr = linha[2];
                        if (dataStr && typeof dataStr === 'number') {
                            const d = XLSX.SSF.parse_date_code(dataStr);
                            if (d) dataStr = `${d.d.toString().padStart(2,'0')}/${d.m.toString().padStart(2,'0')}/${d.y}`;
                        } else if (typeof dataStr === 'string' && dataStr.includes('-')) {
                            const partes = dataStr.split(' ')[0].split('-');
                            if (partes.length === 3) dataStr = `${partes[2]}/${partes[1]}/${partes[0]}`;
                        }
                        
                        const fat = parseFloat(linha[6]) || 0;
                        const meta = parseFloat(linha[7]) || 0;
                        
                        // Extrair apenas a hora
                        let inicio = extrairHora(linha[3]);
                        let fim = extrairHora(linha[4]);
                        
                        dadosCompletos.push({
                            loja: codigoLoja,
                            adm: admPorLoja[codigoLoja] || 'N√£o mapeado',
                            data: dataStr || null,
                            inicio: inicio,
                            fim: fim,
                            cupons: parseFloat(linha[5]) || 0,
                            faturamento: fat,
                            meta: meta,
                            dif: fat - meta,
                            difPercentual: meta > 0 ? ((fat-meta)/meta*100) : 0,
                            status: fat > 0 ? (fat >= meta ? 'SIM' : 'N√ÉO') : 'FECHADA',
                            canais: {
                                auto: parseFloat(linha[10]) || 0,
                                delivery: parseFloat(linha[11]) || 0,
                                viagem: parseFloat(linha[12]) || 0,
                                balcao: parseFloat(linha[14]) || 0
                            }
                        });
                    }

                    processarDadosCarregados();
                    
                    document.getElementById('dataAtualizacao').innerText = new Date().toLocaleString('pt-BR');
                    alert('‚úÖ Dados importados com sucesso! Eles foram salvos permanentemente no arquivo.');
                    
                } catch (error) { 
                    alert('Erro ao processar planilha: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(arquivo);
        }

        // Fun√ß√£o para extrair hora
        function extrairHora(valor) {
            if (!valor || valor === 'NULL' || valor === null) return '-';
            
            if (typeof valor === 'number') {
                const dataObj = XLSX.SSF.parse_date_code(valor);
                if (dataObj) {
                    return `${dataObj.H.toString().padStart(2,'0')}:${dataObj.M.toString().padStart(2,'0')}`;
                }
            }
            
            const str = String(valor).trim();
            
            if (str.includes(' ')) {
                const partes = str.split(' ');
                if (partes.length > 1) {
                    const horaPartes = partes[1].split(':');
                    if (horaPartes.length >= 2) {
                        return `${horaPartes[0].padStart(2,'0')}:${horaPartes[1].padStart(2,'0')}`;
                    }
                }
            }
            
            if (str.includes(':')) {
                const partes = str.split(':');
                if (partes.length >= 2) {
                    return `${partes[0].padStart(2,'0')}:${partes[1].padStart(2,'0')}`;
                }
            }
            
            return '-';
        }

        // Limpar dados salvos
        function limparDadosSalvos() {
            if (confirm('Limpar todos os dados salvos?')) {
                dadosCompletos = [];
                for (let key in dadosPorData) delete dadosPorData[key];
                todasLojas = [];
                lojasSelecionadas = [];
                
                const embedded = document.getElementById('dados-embedded');
                if (embedded) {
                    embedded.textContent = '// OS DADOS SER√ÉO SALVOS AQUI AUTOMATICAMENTE E PERMANECER√ÉO FIXOS';
                }
                
                // Recarregar p√°gina para reset completo
                location.reload();
            }
        }

        // Fun√ß√µes auxiliares
        function getDadosPeriodo() {
            if (!dataInicio || !dataFim || !Object.keys(dadosPorData).length) return [];
            const dados = [];
            for (let data in dadosPorData) {
                if (isDataNoPeriodo(data, dataInicio, dataFim)) {
                    dados.push(...dadosPorData[data]);
                }
            }
            return dados;
        }

        function isDataNoPeriodo(data, inicio, fim) {
            if (!data) return false;
            try {
                const [dD,mD,aD] = data.split('/').map(Number);
                const [dI,mI,aI] = inicio.split('/').map(Number);
                const [dF,mF,aF] = fim.split('/').map(Number);
                const dataObj = new Date(aD,mD-1,dD);
                return dataObj >= new Date(aI,mI-1,dI) && dataObj <= new Date(aF,mF-1,dF);
            } catch { return false; }
        }

        function setPeriodo(tipo) {
            periodoSelecionado = tipo;
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            
            let btn;
            if (tipo === 'hoje') btn = Array.from(document.querySelectorAll('.period-btn')).find(b => b.textContent.includes('Hoje'));
            else if (tipo === 'ontem') btn = Array.from(document.querySelectorAll('.period-btn')).find(b => b.textContent.includes('Ontem'));
            else if (tipo === '7d') btn = Array.from(document.querySelectorAll('.period-btn')).find(b => b.textContent.includes('√öltimos 7 dias'));
            else if (tipo === '15d') btn = Array.from(document.querySelectorAll('.period-btn')).find(b => b.textContent.includes('√öltimos 15 dias'));
            else if (tipo === 'mes') btn = Array.from(document.querySelectorAll('.period-btn')).find(b => b.textContent.includes('M√™s'));
            else if (tipo === 'custom') btn = Array.from(document.querySelectorAll('.period-btn')).find(b => b.textContent.includes('Per√≠odo'));
            
            if (btn) btn.classList.add('active');
            
            const datas = Object.keys(dadosPorData).sort((a,b) => {
                const [dA,mA,anA] = a.split('/');
                const [dB,mB,anB] = b.split('/');
                return new Date(anB,mB-1,dB) - new Date(anA,mA-1,dA);
            });
            
            if (!datas.length) return;
            
            const ultima = datas[0];
            const primeira = datas[datas.length-1];
            
            if (tipo === 'hoje') { dataInicio = dataFim = ultima; }
            else if (tipo === 'ontem') { dataInicio = dataFim = datas[1] || ultima; }
            else if (tipo === '7d') { dataInicio = datas[Math.min(datas.length-1,6)] || primeira; dataFim = ultima; }
            else if (tipo === '15d') { dataInicio = datas[Math.min(datas.length-1,14)] || primeira; dataFim = ultima; }
            else if (tipo === 'mes') { dataInicio = primeira; dataFim = ultima; }
            
            document.getElementById('dateRangeInputs').style.display = tipo === 'custom' ? 'flex' : 'none';
            
            atualizarPeriodoDisplay();
            recarregarTudo();
        }

        function atualizarPeriodoDisplay() {
            if (!dataInicio) return;
            const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
            
            if (dataInicio === dataFim) {
                const [d,m,a] = dataInicio.split('/');
                document.getElementById('headerDay').innerText = d;
                document.getElementById('headerMonth').innerText = meses[m-1].toUpperCase() + ' ' + a;
            } else {
                const [dI,mI,aI] = dataInicio.split('/');
                document.getElementById('headerDay').innerText = dI + '-' + dataFim.split('/')[0];
                document.getElementById('headerMonth').innerText = meses[mI-1].toUpperCase() + ' ' + aI;
            }
        }

        function recarregarTudo() {
            if (!Object.keys(dadosPorData).length) return;
            const dados = getDadosPeriodo();
            if (!dados.length) return;
            
            todasLojas = [...new Set(dados.map(l=>l.loja))].sort((a,b)=>a-b);
            lojasSelecionadas = [...todasLojas];
            
            preencherOpcoesLojas();
            atualizarTextoSelecionadas();
            aplicarFiltros();
        }

        function formatMoney(v) {
            if (isNaN(v)) v = 0;
            return v.toFixed(2).replace('.',',').replace(/\B(?=(\d{3})+(?!\d))/g,'.');
        }

        function atualizarKPIs(dados) {
            let fat=0, meta=0, cupons=0;
            dados.forEach(l => { fat+=l.faturamento; meta+=l.meta; cupons+=l.cupons; });
            
            const dif = fat - meta;
            const pctDif = meta>0 ? (dif/meta*100) : 0;
            const ticket = cupons>0 ? fat/cupons : 0;
            
            const lojasUnicas = [...new Set(dados.map(l=>l.loja))];
            const total = lojasUnicas.length;
            const dias = [...new Set(dados.map(l=>l.data))].length;
            
            const ativas = dados.filter(l=>l.faturamento>0).length;
            const fechadas = dados.filter(l=>l.status==='FECHADA').length;
            const metasSim = dados.filter(l=>l.status==='SIM').length;
            const metasNao = dados.filter(l=>l.status==='N√ÉO').length;
            
            // Card 1: Total de Lojas
            document.getElementById('totalLojas').innerText = total;
            document.getElementById('totalLojasPeriodo').innerText = `${dias}d`;
            document.getElementById('lojasAtivas').innerHTML = `${ativas} ativas (${total>0?((ativas/total)*100).toFixed(1):0}%)`;
            
            // Card 2: Faturamento
            document.getElementById('totalFaturamento').innerText = `R$ ${formatMoney(fat)}`;
            
            // Card 3: Meta Total
            document.getElementById('totalMeta').innerText = `R$ ${formatMoney(meta)}`;
            document.getElementById('metasAtingidas').innerHTML = `${metasSim}/${total}`;
            
            // Card 4: Diferen√ßa
            const diferencaEl = document.getElementById('totalDiferenca');
            if (diferencaEl) {
                diferencaEl.innerText = `${dif >= 0 ? '+' : '-'} R$ ${formatMoney(Math.abs(dif))}`;
                if (dif < 0) diferencaEl.classList.add('danger');
                else diferencaEl.classList.remove('danger');
            }
            document.getElementById('diferencaEmoji').innerText = dif >= 0 ? '‚úÖ' : '‚ùå';
            document.getElementById('diferencaText').innerText = (dif>=0?'+':'')+pctDif.toFixed(1)+'%';
            
            // Card 5: Ticket M√©dio
            document.getElementById('ticketMedio').innerText = `R$ ${formatMoney(ticket)}`;
            document.getElementById('ticketPeriodo').innerText = dias===1?'hoje':`m√©dia ${dias}d`;
            
            // Card 6: Metas OK
            document.getElementById('metasAtingidasValor').innerText = metasSim;
            document.getElementById('metasPercentual').innerText = ativas>0 ? ((metasSim/ativas)*100).toFixed(1)+'%' : '0%';
            
            // Card 7: Abaixo
            document.getElementById('metasNaoValor').innerText = metasNao;
            document.getElementById('metasNaoPercentual').innerText = ativas>0 ? ((metasNao/ativas)*100).toFixed(1)+'%' : '0%';
            
            // Card 8: Fechadas
            document.getElementById('lojasFechadas').innerText = fechadas;
            document.getElementById('percentualFechadas').innerText = total>0 ? ((fechadas/total)*100).toFixed(1)+'%' : '0%';
            
            // Progresso da Meta
            document.getElementById('progressoMeta').style.width = meta>0 ? Math.min(100, (fat/meta*100))+'%' : '0%';
            
            // Percentual vs Meta (para o card de faturamento)
            document.getElementById('percentualMeta').innerHTML = `<span class="${dif>=0?'valor-positivo':'valor-negativo'}">${dif>=0?'+':''}${pctDif.toFixed(1)}%</span> vs meta`;
        }

        function atualizarTabela(dados) {
            let html = '';
            dados.forEach(l => {
                const nome = lojaNomes[l.loja] || `Loja ${l.loja}`;
                const difClass = l.dif >= 0 ? 'valor-positivo' : 'valor-negativo';
                const statusClass = l.status === 'SIM' ? 'meta-sim' : l.status === 'FECHADA' ? 'loja-fechada' : 'meta-nao';
                const sinal = l.dif > 0 ? '+' : '';
                
                html += `<tr>
                    <td>${l.data || '-'}</td>
                    <td><span class="store-name">${l.loja} - ${nome}</span></td>
                    <td>${l.adm}</td>
                    <td class="hora-cell">${l.inicio}</td>
                    <td class="hora-cell">${l.fim}</td>
                    <td>${l.cupons}</td>
                    <td class="currency ${difClass}">R$ ${formatMoney(l.faturamento)}</td>
                    <td class="currency">R$ ${formatMoney(l.meta)}</td>
                    <td class="currency ${difClass}">${l.dif >= 0 ? '+' : '-'} R$ ${formatMoney(Math.abs(l.dif))}</td>
                    <td class="${difClass}">${l.meta > 0 ? sinal + l.difPercentual.toFixed(2)+'%' : '-'}</td>
                    <td><span class="${statusClass}">${l.status}</span></td>
                </tr>`;
            });
            
            document.getElementById('tableBody').innerHTML = html || '<tr><td colspan="11">Nenhum registro</td></tr>';
            document.getElementById('registrosCount').innerText = dados.length;
        }

        function atualizarLojasIndicadores(dados) {
            const lojasUnicas = [...new Set(dados.map(l=>l.loja))];
            const total = lojasUnicas.length;
            const ativas = dados.filter(l=>l.faturamento>0).length;
            const fechadas = dados.filter(l=>l.status==='FECHADA').length;
            
            document.getElementById('lojasOperacaoValor').innerText = ativas;
            document.getElementById('lojasOperacaoPercentual').innerText = total>0 ? `(${((ativas/total)*100).toFixed(1)}%)` : '(0%)';
            document.getElementById('lojasFechadasValor').innerText = fechadas;
            document.getElementById('lojasFechadasPercentual').innerText = total>0 ? `(${((fechadas/total)*100).toFixed(1)}%)` : '(0%)';
            
            const fechadasList = dados.filter(l=>l.status==='FECHADA').map(l => 
                `<span class="loja-fechada-item">${lojaNomes[l.loja]}</span>`
            ).join('');
            
            document.getElementById('listaFechadasCompleta').innerHTML = fechadasList || '<span>Nenhuma loja fechada no per√≠odo</span>';
        }

        function atualizarGraficos(dados) {
            // Gr√°fico de Pizza - Canais
            let auto = 0, delivery = 0, viagem = 0, balcao = 0;
            dados.forEach(l => {
                auto += l.canais.auto;
                delivery += l.canais.delivery;
                viagem += l.canais.viagem;
                balcao += l.canais.balcao;
            });
            
            if (canalPieChart) {
                canalPieChart.data.datasets[0].data = [auto, delivery, viagem, balcao];
                canalPieChart.update();
            }
            
            // Top 10 Faturamento
            const lojaAgg = {};
            dados.forEach(l => {
                if (!lojaAgg[l.loja]) lojaAgg[l.loja] = { 
                    fat: 0, 
                    meta: 0,
                    nome: lojaNomes[l.loja],
                    cod: l.loja
                };
                lojaAgg[l.loja].fat += l.faturamento;
                lojaAgg[l.loja].meta += l.meta;
            });
            
            Object.values(lojaAgg).forEach(l => {
                l.atingimento = l.meta > 0 ? (l.fat / l.meta * 100) : 0;
            });
            
            const topLojas = Object.values(lojaAgg)
                .filter(l => l.fat > 0)
                .sort((a,b) => b.fat - a.fat)
                .slice(0, 10);
            
            if (top10BarChart) {
                top10BarChart.data.labels = topLojas.map(l => l.nome.substring(0,12));
                top10BarChart.data.datasets[0].data = topLojas.map(l => l.fat);
                top10BarChart.update();
            }
            
            // Desempenho por Loja (% Meta)
            const desempenhoLojas = Object.values(lojaAgg)
                .filter(l => l.fat > 0)
                .sort((a,b) => b.atingimento - a.atingimento)
                .slice(0, 10);
            
            if (desempenhoBarChart) {
                desempenhoBarChart.data.labels = desempenhoLojas.map(l => l.nome.substring(0,12));
                desempenhoBarChart.data.datasets[0].data = desempenhoLojas.map(l => l.atingimento);
                desempenhoBarChart.data.datasets[0].backgroundColor = desempenhoLojas.map(l => 
                    l.atingimento >= 100 ? '#06d6a0' : '#ef476f'
                );
                desempenhoBarChart.update();
            }
            
            // Ranking por ADM (Faturamento)
            const admAgg = {};
            dados.forEach(l => {
                if (!admAgg[l.adm]) admAgg[l.adm] = { fat: 0 };
                admAgg[l.adm].fat += l.faturamento;
            });
            
            const admsLista = ['Thais', 'Fernando', 'Hedla', 'Elves', 'Gabriela', 'Marcia', 'Wagner']
                .filter(a => admAgg[a] && admAgg[a].fat > 0);
            
            if (admRankingChart) {
                admRankingChart.data.labels = admsLista;
                admRankingChart.data.datasets[0].data = admsLista.map(a => admAgg[a].fat);
                admRankingChart.update();
            }
            
            // Canais por ADM
            const admCanais = {};
            dados.forEach(l => {
                if (!admCanais[l.adm]) admCanais[l.adm] = { auto:0, del:0, via:0, bal:0 };
                admCanais[l.adm].auto += l.canais.auto;
                admCanais[l.adm].del += l.canais.delivery;
                admCanais[l.adm].via += l.canais.viagem;
                admCanais[l.adm].bal += l.canais.balcao;
            });
            
            const admsCanais = ['Thais', 'Fernando', 'Hedla', 'Elves', 'Gabriela', 'Marcia', 'Wagner']
                .filter(a => admCanais[a] && (admCanais[a].auto + admCanais[a].del + admCanais[a].via + admCanais[a].bal > 0));
            
            if (canaisPorAdmChart) {
                canaisPorAdmChart.data.labels = admsCanais;
                canaisPorAdmChart.data.datasets[0].data = admsCanais.map(a => admCanais[a]?.auto || 0);
                canaisPorAdmChart.data.datasets[1].data = admsCanais.map(a => admCanais[a]?.del || 0);
                canaisPorAdmChart.data.datasets[2].data = admsCanais.map(a => admCanais[a]?.via || 0);
                canaisPorAdmChart.data.datasets[3].data = admsCanais.map(a => admCanais[a]?.bal || 0);
                canaisPorAdmChart.update();
            }
        }

        function ordenarTabela(coluna) {
            const tbody = document.querySelector('#tableBody');
            if (!tbody) return;
            
            const linhas = Array.from(tbody.querySelectorAll('tr'));
            if (!linhas.length) return;
            
            ordemAtual.ascendente = ordemAtual.coluna === coluna ? !ordemAtual.ascendente : true;
            ordemAtual.coluna = coluna;
            
            linhas.sort((a,b) => {
                const celA = a.children[coluna]?.innerText.trim() || '';
                const celB = b.children[coluna]?.innerText.trim() || '';
                
                let valA, valB;
                if (coluna === 0) {
                    const [dA,mA,anA] = celA.split('/').map(Number);
                    const [dB,mB,anB] = celB.split('/').map(Number);
                    valA = new Date(anA,mA-1,dA);
                    valB = new Date(anB,mB-1,dB);
                } else if (coluna === 1) {
                    valA = parseInt(celA.split(' - ')[0]) || 0;
                    valB = parseInt(celB.split(' - ')[0]) || 0;
                } else if (coluna === 3 || coluna === 4) {
                    if (celA === '-') valA = -1;
                    else {
                        const [hA, mA] = celA.split(':').map(Number);
                        valA = (hA || 0) * 60 + (mA || 0);
                    }
                    if (celB === '-') valB = -1;
                    else {
                        const [hB, mB] = celB.split(':').map(Number);
                        valB = (hB || 0) * 60 + (mB || 0);
                    }
                } else if (coluna === 5) {
                    valA = parseInt(celA) || 0;
                    valB = parseInt(celB) || 0;
                } else if ([6,7,8].includes(coluna)) {
                    valA = parseFloat(celA.replace('R$','').replace(/\./g,'').replace(',','.').replace('+','').replace('-','')) || 0;
                    valB = parseFloat(celB.replace('R$','').replace(/\./g,'').replace(',','.').replace('+','').replace('-','')) || 0;
                    if (celA.includes('-')) valA = -valA;
                    if (celB.includes('-')) valB = -valB;
                } else if (coluna === 9) {
                    valA = parseFloat(celA.replace('%','').replace('+','')) || 0;
                    valB = parseFloat(celB.replace('%','').replace('+','')) || 0;
                } else if (coluna === 10) {
                    valA = celA;
                    valB = celB;
                } else {
                    valA = celA; valB = celB;
                }
                
                if (valA < valB) return ordemAtual.ascendente ? -1 : 1;
                if (valA > valB) return ordemAtual.ascendente ? 1 : -1;
                return 0;
            });
            
            tbody.innerHTML = '';
            linhas.forEach(l => tbody.appendChild(l));
            
            document.querySelectorAll('th i').forEach(i => i.className = 'fas fa-sort');
            const th = document.querySelector(`th:nth-child(${coluna+1}) i`);
            if (th) th.className = ordemAtual.ascendente ? 'fas fa-sort-up' : 'fas fa-sort-down';
        }

        // Inicializar gr√°ficos
        function inicializarGraficos() {
            Chart.defaults.font.family = 'Inter, sans-serif';
            Chart.defaults.font.size = 11;

            const canalCanvas = document.getElementById('canalPieChart');
            if (canalCanvas) {
                canalPieChart = new Chart(canalCanvas, {
                    type: 'doughnut',
                    data: { 
                        labels: ['Auto', 'Delivery', 'Viagem', 'Balc√£o'], 
                        datasets: [{ 
                            data: [0,0,0,0], 
                            backgroundColor: ['#4361ee', '#f72585', '#4cc9f0', '#ffd166'],
                            borderWidth: 0,
                            borderRadius: 8,
                            spacing: 4
                        }] 
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        cutout: '65%',
                        plugins: { 
                            legend: { 
                                position: 'bottom',
                                labels: { usePointStyle: true, boxWidth: 10, padding: 15, font: { size: 11 } }
                            } 
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const total = ctx.dataset.data.reduce((a,b) => a + b, 0);
                                    const percent = total > 0 ? ((ctx.raw / total) * 100).toFixed(1) : 0;
                                    return `${ctx.label}: R$ ${formatMoney(ctx.raw)} (${percent}%)`;
                                }
                            }
                        }
                    }
                });
            }

            const top10Canvas = document.getElementById('top10BarChart');
            if (top10Canvas) {
                top10BarChart = new Chart(top10Canvas, {
                    type: 'bar',
                    data: { 
                        labels: [], 
                        datasets: [{ 
                            label: 'Faturamento (R$)', 
                            data: [], 
                            backgroundColor: '#2e7d32',
                            borderRadius: 8,
                            barPercentage: 0.6
                        }] 
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: (value) => 'R$ ' + (value/1000).toFixed(0) + 'k' }
                            }
                        }
                    }
                });
            }

            const desempenhoCanvas = document.getElementById('desempenhoBarChart');
            if (desempenhoCanvas) {
                desempenhoBarChart = new Chart(desempenhoCanvas, {
                    type: 'bar',
                    data: { 
                        labels: [], 
                        datasets: [{ 
                            label: '% Meta', 
                            data: [], 
                            backgroundColor: [],
                            borderRadius: 8,
                            barPercentage: 0.7
                        }] 
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 200,
                                ticks: { callback: (value) => value + '%' }
                            }
                        }
                    }
                });
            }

            const admCanvas = document.getElementById('admRankingChart');
            if (admCanvas) {
                admRankingChart = new Chart(admCanvas, {
                    type: 'bar',
                    data: { 
                        labels: [], 
                        datasets: [{ 
                            label: 'Faturamento (R$)', 
                            data: [], 
                            backgroundColor: '#2e7d32',
                            borderRadius: 8,
                            barPercentage: 0.7
                        }] 
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: (value) => 'R$ ' + (value/1000).toFixed(0) + 'k' }
                            }
                        }
                    }
                });
            }

            const canaisCanvas = document.getElementById('canaisPorAdmChart');
            if (canaisCanvas) {
                canaisPorAdmChart = new Chart(canaisCanvas, {
                    type: 'bar',
                    data: { 
                        labels: [], 
                        datasets: [
                            { label: 'Auto', data: [], backgroundColor: '#4361ee', borderRadius: 6, barPercentage: 0.8, categoryPercentage: 0.9 },
                            { label: 'Delivery', data: [], backgroundColor: '#f72585', borderRadius: 6, barPercentage: 0.8, categoryPercentage: 0.9 },
                            { label: 'Viagem', data: [], backgroundColor: '#4cc9f0', borderRadius: 6, barPercentage: 0.8, categoryPercentage: 0.9 },
                            { label: 'Balc√£o', data: [], backgroundColor: '#ffd166', borderRadius: 6, barPercentage: 0.8, categoryPercentage: 0.9 }
                        ] 
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: (value) => 'R$ ' + (value/1000).toFixed(0) + 'k' }
                            }
                        }
                    }
                });
            }
        }

        // Inicializar ao carregar
        document.addEventListener('DOMContentLoaded', function() {
            inicializarGraficos();
            // Os dados j√° ser√£o carregados pela IIFE acima
        });
    </script>
</body>
</html>
